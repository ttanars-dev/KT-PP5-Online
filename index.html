<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KT|PP5 Online System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style id="print-styles">
	
	    .swal2-container {
            z-index: 60000 !important;
        }
		
		/* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30000; 
            backdrop-filter: blur(2px);
            transition: opacity 0.3s ease;
        }		
		
	
        /* 1. กำหนดค่าเริ่มต้นหน้ากระดาษและตัวนับเลขหน้า */
        @page {
            size: A4 portrait;
            margin: 0;
        }

		/* ส่วนที่แก้ไข/เพิ่มเติมใน @media print */
		@media print {
			thead {
				display: table-header-group !important; /* บังคับให้หัวตารางแสดงทุกหน้า */
			}

			.print-table-header-info {
				display: table-row !important; /* แสดงแถวข้อมูลหัวรายงานเฉพาะตอนพิมพ์ */
				background-color: white !important;
			}

			#report-print-header {
				display: none !important; /* ซ่อนหัวรายงานแบบเดิมที่เป็น div ด้านนอก */
			}
		}
			
		/* ซ่อนแถวหัวรายงานในหน้าจอปกติ */
		.print-table-header-info {
			display: none;
		}

        :root {
            --bs-primary: #0d6efd;
            --bs-secondary: #6c757d;
            --bs-success: #198754;
            --bs-info: #0dcaf0;
            --bs-warning: #ffc107;
            --bs-danger: #dc3545;
            --bs-light: #f8f9fa;
            --bs-dark: #212529;
            
            /* Modern Gradients */
            --grad-primary: linear-gradient(135deg, #0d6efd 0%, #004aad 100%);
            --grad-success: linear-gradient(135deg, #198754 0%, #0a5131 100%);
            --grad-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --grad-settings: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            --grad-danger: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8;
        }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--bs-light);
            border-top: 5px solid var(--bs-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-score {
            transition: all 0.1s;
            min-width: 28px;
            padding: 2px 1px;
            line-height: 1;
            font-size: 11px;
        }
        .input-score:focus {
            outline: 2px solid var(--bs-primary);
            background-color: #eff6ff;
        }
        .input-error {
            border-color: var(--bs-danger) !important;
            background-color: #fef2f2 !important;
            color: var(--bs-danger);
        }
        .input-fail {
            background-color: #fff7ed !important;
            border-color: #f97316 !important;
            color: #ea580c;
        }
        
        /* Button Zoom & Hover Styles */
        button, label.btn-success {
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease !important;
        }
        button:not(.modal-btn):hover, label.btn-success:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0.9;
        }
        button:active {
            transform: scale(0.98);
        }
        
        /* Modal Button Overrides (No Zoom) */
        .modal-btn:hover {
            transform: none !important;
        }

        /* Modern Gradient Buttons */
        .btn-grad-grading { background: var(--grad-primary) !important; color: white; }
        .btn-grad-achievement { background: var(--grad-success) !important; color: white; }
        .btn-grad-students { background: var(--grad-warning) !important; color: white; }
        .btn-grad-settings { background: var(--grad-settings) !important; color: white; }
        .btn-grad-save { background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important; color: white; }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .view-section { display: none; }
        .view-active { display: block; }

        /* Grading Table Specific Styles */
        #studentTableBody tr {
            transition: background-color 0.15s;
        }
        #studentTableBody tr:hover {
            background-color: #bfdbfe !important; /* Clear Hover Color Blue-200 */
        }
        
        .student-photo-container {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .student-photo-container:hover {
            transform: scale(1.4);
            z-index: 10;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
        }

        @media print {
            .no-print { display: none !important; }
            body { 
                background-color: white; 
                padding: 0; 
                margin: 0; 
                width: 100% !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            body.print-portrait { width: 210mm; }
            body.print-landscape { width: 297mm; }

            .max-w-full { 
                border: none; 
                box-shadow: none; 
                width: 100% !important; 
                max-width: 100% !important; 
                margin: 0 !important;
            }
            .shadow-lg { box-shadow: none !important; }
            .rounded-xl { border-radius: 0 !important; }
            table { 
                border-collapse: collapse !important; 
                width: 100% !important;
                border: 1px solid black !important;
                font-size: 10pt;
            }
            th, td { 
                border: 1px solid black !important; 
                color: black !important;
                padding: 2px !important;
            }
            thead {
                background-color: #f3f4f6 !important;
                display: table-header-group;
            }
            tr { page-break-inside: avoid; }
            .overflow-x-auto { overflow: visible !important; }

            body:not(.print-cover-mode):not(.print-achievement-mode) #cover-print-container { display: none !important; }
            body:not(.print-achievement-mode) #achievement-print-container { display: none !important; }

            body.print-cover-mode .view-section,
            body.print-cover-mode #report-print-header,
            body.print-cover-mode #summary-section,
            body.print-cover-mode #grading-pagination,
            body.print-achievement-mode .view-section,
            body.print-achievement-mode #report-print-header,
            body.print-achievement-mode #summary-section,
            body.print-achievement-mode #grading-pagination { display: none !important; }
            
            body.print-cover-mode { width: 100% !important; margin: 0 auto; height: 100vh; overflow: hidden; }
            body.print-cover-mode #cover-print-container { display: block; width: 100%; padding: 0; margin: 0; }
            
            body.print-achievement-mode { width: 100% !important; margin: 0 auto; min-height: 100vh; }
            body.print-achievement-mode #achievement-print-container { display: block; width: 100%; padding: 0; margin: 0; }
            body.print-achievement-mode #app-body-container { border: none !important; box-shadow: none !important; }

            .cover-compact-table th, .cover-compact-table td {
                padding: 2px 2px !important;
                font-size: 9pt !important;
                line-height: 1.1;
            }
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }
        .student-modal-content {
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px;
        }
        .modal-header-bg { background-color: var(--bs-primary); }
        .modal-input { border: 1.5px solid #e2e8f0; border-radius: 0.5rem; padding: 0.5rem 0.75rem; width: 100%; outline: none; transition: border-color 0.2s; font-size: 0.95rem; }
        .modal-input:focus { border-color: var(--bs-primary); }
        
        .photo-box { border: 2px dashed #cbd5e1; border-radius: 0.75rem; width: 100px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #94a3b8; background-color: white; transition: all 0.2s; }
        .photo-box:hover { border-color: var(--bs-primary); background-color: #f8fafc; }

        #cover-print-container, #achievement-print-container { display: none; }
        
        .cover-table td, .cover-table th { border: 1px solid black; padding: 3px; text-align: center; font-size: 10pt; }
        .cover-label { font-weight: normal; }
        .cover-value { font-weight: bold; border-bottom: 1px dotted black; padding: 0 4px; }
        .summary-table td { border: 1px solid #cbd5e1; padding: 4px 8px; text-align: center; }
        
        .sig-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 20px; width: 100%; }
        .sig-box { display: flex; flex-direction: column; align-items: center; }
        .sig-line-wrapper { display: flex; align-items: flex-end; width: 100%; margin-bottom: 2px; }
        .sig-label { white-space: nowrap; margin-right: 4px; font-size: 10pt; }
        .sig-dotted-line { flex-grow: 1; border-bottom: 1px dotted black; height: 16px; }
        .sig-position { margin-left: 4px; font-size: 10pt; }
        .sig-name-under { text-align: center; font-size: 10pt; margin-top: 1px; }

        .chart-bar-container { display: flex; flex-direction: column; justify-content: flex-end; align-items: center; height: 100%; width: 100%; transition: height 0.5s ease; }
        .chart-gradient-4 { background: linear-gradient(to top, #15803d, #4ade80); }
        .chart-gradient-3-5 { background: linear-gradient(to top, #0f766e, #2dd4bf); }
        .chart-gradient-3 { background: linear-gradient(to top, #0369a1, #38bdf8); }
        .chart-gradient-2-5 { background: linear-gradient(to top, #4338ca, #818cf8); }
        .chart-gradient-2 { background: linear-gradient(to top, #7e22ce, #c084fc); }
        .chart-gradient-1-5 { background: linear-gradient(to top, #db2777, #f472b6); }
        .chart-gradient-1 { background: linear-gradient(to top, #ea580c, #fb923c); }
        .chart-gradient-0 { background: linear-gradient(to top, #b91c1c, #f87171); }

        .ach-table th { background-color: #f3f4f6; font-size: 8pt; vertical-align: middle; text-align: center; border: 1px solid black; }
        .ach-table td { border: 1px solid black; font-size: 8pt; text-align: center; padding: 3px; }
        
        .ach-graph-container { width: 100%; height: 200px; display: flex; align-items: flex-end; gap: 4px; padding-bottom: 20px; border-bottom: 1px solid #ccc; position: relative; }
        .ach-bar { background-color: var(--bs-primary); min-width: 10px; flex-grow: 1; position: relative; transition: height 0.3s; }
        .ach-bar-label { position: absolute; bottom: -20px; left: 0; right: 0; text-align: center; font-size: 8pt; }
        .ach-bar-val { position: absolute; top: -15px; left: 0; right: 0; text-align: center; font-size: 8pt; font-weight: bold; }
        
        .settings-tab-btn.active { color: var(--bs-primary); border-bottom: 2px solid var(--bs-primary); }

        /* Bootstrap helper classes override */
        .btn-primary { background-color: var(--bs-primary) !important; }
        .btn-success { background-color: var(--bs-success) !important; }
        .btn-danger { background-color: var(--bs-danger) !important; }
        .btn-warning { background-color: var(--bs-warning) !important; color: #000 !important; }
        .btn-info { background-color: var(--bs-info) !important; color: #000 !important; }
        .btn-secondary { background-color: var(--bs-secondary) !important; }
        .app-banner {
            width: 100%;
            max-height: 300px; 
            object-fit: cover; 
            border-radius: 0.5rem;
            margin-bottom: 1.5rem; 
        }

		.marquee-container {
				overflow: hidden;
				white-space: nowrap;
				position: relative;
			}
			
			.marquee-text {
				display: inline-block;
				padding-left: 100%; /* เริ่มต้นจากขวาสุด */
				animation: scroll-text 15s linear infinite; /* ความเร็ว 15 วินาที */
			}

			/* หยุดวิ่งเมื่อเอาเมาส์ไปชี้ */
			.marquee-container:hover .marquee-text {
				animation-play-state: paused;
			}

			@keyframes scroll-text {
				0% { transform: translateX(0); }
				100% { transform: translateX(-100%); }
			}
		
    </style>
</head>
<body class="border-primary p-1 md:p-1 print-portrait" id="app-body">

    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <p class="mt-4 font-bold text-slate-600">กำลังดำเนินการ...</p>
    </div>

			<!-- Login Modal -->
			<div id="login-modal" class="fixed inset-0 z-[9999] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center font-['Sarabun'] hidden">
				<!-- ปรับความกว้างจาก max-w-md เป็น max-w-2xl -->
				<div class="bg-white w-full max-w-xl rounded-xl shadow-xl overflow-hidden border border-slate-200 p-6 transform transition-all scale-100 relative">
					
					<div class="text-center mb-2">
						<div class="w-36 h-36 flex items-center justify-center mx-auto">
							<img src="https://lh3.googleusercontent.com/d/17nowPco3WNP-0d9lFZG_VQkc-vm46mQc" class="max-w-full max-h-full object-contain" alt="School Logo">
						</div>
						
						<h2 class="text-2xl font-bold text-slate-800 mb-2">KT | PP5 Online System</h2>
						
						<div class="text-center mt-2 mb-2 no-print marquee-container" style="color:#000000; font-size: 16px; margin-top: 2px; margin-bottom: 2px;">
								<h3 class="marquee-text" style="margin-top: 2px; margin-bottom: 2px;">
									ยินดีต้อนรับเข้าสู่ระบบบันทึกคะแนนออนไลน์ :: ออกแบบและพัฒนาโดย KT | Tanasarn Sirak
								</h3>
							</div>
					</div>
					<hr class="mt-4 mb-4 border-t-4 border-rose-400">
					<div class="space-y-2">
						<!-- จัดวาง Username และ Password ให้อยู่คู่กันด้วย Grid -->
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่อผู้ใช้ (Username)</label>
								<div class="relative">
									<i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 "></i>
									<input type="text" id="login-username" class="w-full pl-10 pr-4 py-2 bg-lime-200 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 font-bold transition-all" placeholder="ระบุชื่อผู้ใช้">
								</div>
							</div>

							<div>
								<label class="block text-xs font-bold text-slate-500 uppercase mb-1">รหัสผ่าน (Password)</label>
								<div class="relative">
									<i class="fa-solid fa-key absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
									<input type="password" id="login-password" class="w-full pl-10 pr-4 py-2 bg-lime-200 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 font-bold transition-all" placeholder="ระบุรหัสผ่าน">
								</div>
							</div>
						</div>

						<div class="pt-2">
							<label class="block text-xs font-bold text-slate-500 uppercase mb-1">รหัสความปลอดภัย (CAPTCHA)</label>
							<div class="flex gap-3">
								<div id="captcha-display" class="w-1/2 bg-slate-800 rounded-lg flex items-center justify-center relative overflow-hidden select-none group cursor-pointer border-2 border-slate-600" onclick="generateCaptcha()" title="คลิกเพื่อเปลี่ยนรหัส">
									<span id="captcha-text" class="text-xl font-bold text-white tracking-[0.2em] font-mono z-10" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5); letter-spacing: 4px;">ABCD</span>
									<div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent"></div>
									<div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/50">
										<i class="fa-solid fa-arrows-rotate text-white"></i>
									</div>
								</div>
								<input type="text" id="login-captcha" class="w-1/2 px-4 py-1 bg-lime-200 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold uppercase tracking-widest text-lg" placeholder="ระบุรหัส" maxlength="6">
							</div>
						</div>
					</div>

					<div class="flex justify-center gap-4 mt-3">
						<button onclick="performLogin(this)" class="group w-full px-3 py-2 rounded bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold shadow-lg shadow-blue-200 hover:shadow-blue-300 transform hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
							<i class="fa-solid fa-right-to-bracket"></i> เข้าสู่ระบบ
						</button>
					</div>
					<hr class="mt-2 mb-2"></hr>
					 <div class="mt-0 text-center">
						<footer style="text-align: center;background-color:#faff99; padding: 10px 0; margin-top: auto; border-top: 1px solid #e0e0e0; font-size: 0.9em; color: #555; width: 100%;">
							:: Created and Develop by KT|Tanasarn Sirak ::
							<div class="container text-center">
							<a href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"><i class="fa-solid fa-comments"></i></a> <a style="color:red;text-decoration:none;font-size:12px" href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"> สอบถาม/แจ้งปัญหา :: <span style="font-size:12px;color:black">KT | Tanasarn Sirak ©2569 </a>
							</div>
						</footer>
					</div>
				</div>
			</div>


    <div id="app-body-container" class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 px-5 py-5">
        <div class="text-center no-print"> 
            <img src="https://lh5.googleusercontent.com/d/1DBhme8tV9w2WKbbcE_Ula9mjvK-KrJBv" 
                     alt="Form Banner" 
                     class="app-banner img-fluid"
                     onerror="this.onerror=null;this.src='https://lh5.googleusercontent.com/d/1DBhme8tV9w2WKbbcE_Ula9mjvK-KrJBv';">
        </div>
			
		<div class="text-center mt-3 mb-3 no-print">
            <marquee behavior="scroll" direction="left" style="color:#000000; font-size: 18px;margin-top: 2px; margin-bottom: 2px;" onmouseover="this.stop();" onmouseout="this.start();"><h3 style="margin-top: 2px; margin-bottom: 4px;"> ยินดีต้อนรับเข้าสู่ระบบบันทึกคะแนนออนไลน์ :: ออกแบบและพัฒนาโดย KT | Tanasarn Sirak </h3></marquee>
		</div>
		
        <!-- ส่วนพิมพ์ปก -->
        <div id="cover-print-container" class="text-black bg-white font-['Sarabun']">
            <div class="flex justify-between items-start mb-1 px-4 pt-4">
                <div class="w-[80px] shrink-0"></div> 
                <div class="text-center flex-grow">
                    <div class="mx-auto mb-1 w-28 h-28 flex items-center justify-center">
                        <img src="https://lh3.googleusercontent.com/d/1kefVKvkBvHwQf6b5-X64He_L43uJKR5M" class="max-w-full max-h-full object-contain" alt="School Logo">
                    </div>
                    <h1 class="text-xl font-bold mb-0.5" id="cover-school-name">โรงเรียนปากช่อง</h1>
                    <p class="text-sm" id="cover-affiliation">สำนักงานเขตพื้นที่การศึกษามัธยมศึกษานครราชสีมา</p>
                </div>
                <div class="border-[1.5px] border-black px-2 py-0.5 font-bold text-base whitespace-nowrap mt-2">
                    ปพ.5 : พ
                </div>
            </div>
            
            <div class="text-center mb-1.5">
                <h2 class="text-lg font-bold">แบบบันทึกผลการเรียนประจำรายวิชา</h2>
            </div>

            <div class="grid grid-cols-2 gap-y-0.5 mb-2 text-[10pt] px-6 font-['Sarabun']">
                <div><span class="cover-label">ระดับชั้น</span> <span id="cover-grade-level" class="cover-value min-w-[60px] inline-block text-center">-</span> <span class="cover-label ml-2">ห้อง</span> <span id="cover-room" class="cover-value min-w-[40px] inline-block text-center">-</span></div>
                <div class="text-right"><span class="cover-label">ปีการศึกษา</span> <span id="cover-year" class="cover-value min-w-[60px] inline-block text-center">-</span> <span class="cover-label ml-2">ภาคเรียนที่</span> <span id="cover-semester" class="cover-value min-w-[30px] inline-block text-center">-</span></div>
                
                <div class="col-span-2"><span class="cover-label">กลุ่มสาระการเรียนรู้</span> <span id="cover-head-dept-name" class="cover-value min-w-[320px] inline-block">-</span></div>
                
                <div class="col-span-2">
                    <span class="cover-label">รายวิชา</span> <span id="cover-subject-name" class="cover-value min-w-[384px] inline-block">-</span>
                    <span class="cover-label ml-6">รหัสวิชา</span> <span id="cover-course-code" class="cover-value min-w-[85px] inline-block text-center">-</span>
                </div>
                
                <div class="col-span-2 flex gap-2">
                    <div><span class="cover-label">ลักษณะวิชา</span> <span id="cover-subject-type" class="cover-value min-w-[100px] inline-block text-center">-</span></div>
                    <div class="flex-grow">
                        <span class="cover-label" style="margin-left: 50px;">เวลาเรียน</span> <span id="cover-hours" class="cover-value min-w-[40px] inline-block text-center">-</span> <span class="cover-label">ชั่วโมง/สัปดาห์</span>
                        <span class="cover-label" style="margin-left: 50px;">จำนวน</span> <span id="cover-credits" class="cover-value min-w-[40px] inline-block text-center">-</span> <span class="cover-label">หน่วยกิต</span>
                    </div>
                </div>
                
                <div class="col-span-2">
                    <span class="cover-label">ครูผู้สอน</span> <span id="cover-teacher-name" class="cover-value min-w-[210px] inline-block">-</span>
                    <span class="cover-label ml-3">ครูที่ปรึกษา</span> <span id="advisor-name" class="cover-value min-w-[315px] inline-block">-</span>
                </div>
            </div>

            <div class="px-4 mb-1.5">
                <div class="text-[9pt] font-bold mb-0.5">1. สรุปผลการประเมินผลสัมฤทธิ์ทางการเรียน</div>
                <table class="w-full cover-table font-['Sarabun'] cover-compact-table">
                    <thead>
                        <tr class="bg-gray-100">
                            <td rowspan="2" class="w-12 font-bold">จำนวน<br>นักเรียน</td>
                            <td colspan="8" class="font-bold">ระดับผลการเรียน (เฉลี่ย <span id="cover-avg-grade" class="underline">-</span>)</td>
                            <td colspan="5" class="font-bold">ผลการประเมิน</td>
                        </tr>
                        <tr class="bg-gray-5 text-[9pt]">
                            <td class="w-7">4</td><td class="w-7">3.5</td><td class="w-7">3</td><td class="w-7">2.5</td><td class="w-7">2</td><td class="w-7">1.5</td><td class="w-7">1</td><td class="w-7">0</td>
                            <td class="w-7">ร</td><td class="w-7">มส</td><td class="w-7">มก</td><td class="w-7">ผ</td><td class="w-7">มผ</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="h-5">
                            <td rowspan="2" id="cover-total-stu" class="text-base font-bold">-</td>
                            <td id="cover-stat-4">-</td><td id="cover-stat-3.5">-</td><td id="cover-stat-3">-</td><td id="cover-stat-2.5">-</td><td id="cover-stat-2">-</td><td id="cover-stat-1.5">-</td><td id="cover-stat-1">-</td><td id="cover-stat-0">-</td>
                            <td id="stat-cover-ร">-</td><td id="stat-cover-มส">-</td><td id="stat-cover-มก">-</td><td id="stat-cover-ผ">-</td><td id="stat-cover-มผ">-</td>
                        </tr>
                        <tr class="text-[8pt] h-4">
                            <td id="cover-pct-4">-</td><td id="cover-pct-3.5">-</td><td id="cover-pct-3">-</td><td id="cover-pct-2.5">-</td><td id="cover-pct-2">-</td><td id="cover-pct-1.5">-</td><td id="cover-pct-1">-</td><td id="cover-pct-0">-</td>
                            <td id="cover-pct-ร">-</td><td id="cover-pct-มส">-</td><td id="cover-pct-มก">-</td><td id="cover-pct-ผ">-</td><td id="cover-pct-มผ">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- สรุปผลอื่นๆ -->
            <div class="px-4 flex gap-2 mb-2">
                <div class="flex-1">
                    <div class="text-[9pt] font-bold mb-0.5 text-left">2. ประเมินการอ่านฯ</div>
                    <table class="w-full cover-table font-['Sarabun'] cover-compact-table">
                        <thead>
                            <tr class="bg-gray-100 text-[8pt]">
                                <th class="w-8">ระดับ</th>
                                <th>3</th><th>2</th><th>1</th><th>0</th>
                                <th class="w-8">รวม</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">คน</td>
                                <td id="read-3">-</td><td id="read-2">-</td><td id="read-1">-</td><td id="read-0">-</td>
                                <td id="read-total">-</td>
                            </tr>
                            <tr>
                                <td class="font-bold">%</td>
                                <td id="read-pct-3">-</td><td id="read-pct-2">-</td><td id="read-pct-1">-</td><td id="read-pct-0">-</td>
                                <td id="read-pct-total">100</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="flex-1">
                    <div class="text-[9pt] font-bold mb-0.5 text-left">3. คุณลักษณะฯ</div>
                    <table class="w-full cover-table font-['Sarabun'] cover-compact-table">
                        <thead>
                            <tr class="bg-gray-100 text-[8pt]">
                                <th class="w-8">ระดับ</th>
                                <th>3</th><th>2</th><th>1</th><th>0</th>
                                <th class="w-8">รวม</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">คน</td>
                                <td id="attr-3">-</td><td id="attr-2">-</td><td id="attr-1">-</td><td id="attr-0">-</td>
                                <td id="attr-total">-</td>
                            </tr>
                            <tr>
                                <td class="font-bold">%</td>
                                <td id="attr-pct-3">-</td><td id="attr-pct-2">-</td><td id="attr-pct-1">-</td><td id="attr-pct-0">-</td>
                                <td id="attr-pct-total">100</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex-1">
                    <div class="text-[9pt] font-bold mb-0.5 text-left">4. สมรรถนะสำคัญ</div>
                    <table class="w-full cover-table font-['Sarabun'] cover-compact-table">
                        <thead>
                            <tr class="bg-gray-100 text-[8pt]">
                                <th class="w-8">ระดับ</th>
                                <th>3</th><th>2</th><th>1</th><th>0</th>
                                <th class="w-8">รวม</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">คน</td>
                                <td id="comp-3">-</td><td id="comp-2">-</td><td id="comp-1">-</td><td id="comp-0">-</td>
                                <td id="comp-total">-</td>
                            </tr>
                            <tr>
                                <td class="font-bold">%</td>
                                <td id="comp-pct-3">-</td><td id="comp-pct-2">-</td><td id="comp-pct-1">-</td><td id="comp-pct-0">-</td>
                                <td id="comp-pct-total">100</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="px-4 mb-3 mt-1">
                <div class="text-[9pt] font-bold mb-0.5 text-left border-l-4 border-indigo-600 pl-2">สรุปผลสัมฤทธิ์ทางการเรียน (ร้อยละของนักเรียนตามระดับผลการเรียน)</div>
                <div class="h-[100px] w-full flex items-end justify-between px-2 pt-4 pb-0 border-b border-l border-slate-300 relative bg-white gap-2">
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-4" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-4" class="w-full rounded-t-sm chart-gradient-4 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">4</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-3.5" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-3.5" class="w-full rounded-t-sm chart-gradient-3-5 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">3.5</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-3" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-3" class="w-full rounded-t-sm chart-gradient-3 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">3</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-2.5" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-2.5" class="w-full rounded-t-sm chart-gradient-2-5 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">2.5</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-2" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-2" class="w-full rounded-t-sm chart-gradient-2 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">2</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-1.5" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-1.5" class="w-full rounded-t-sm chart-gradient-1-5 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">1.5</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-1" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-1" class="w-full rounded-t-sm chart-gradient-1 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">1</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-0" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-0" class="w-full rounded-t-sm chart-gradient-0 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">0</span></div>
                </div>
            </div>

            <div class="px-4 border-[1.5px] border-black py-1.5 rounded-lg mx-4">
                <div class="font-bold mb-7 text-sm underline text-center">การอนุมัติผลการเรียน</div>
                <div class="sig-grid text-[10pt] font-['Sarabun']">
                    
                    <div class="sig-box mb-7">
                        <div class="sig-line-wrapper">
                            <span class="sig-label">ลงชื่อ</span>
                            <div class="sig-dotted-line"></div>
                            <span class="sig-position">ครูผู้สอน</span>
                        </div>
                        <div class="sig-name-under">( <span id="sig-cover-teacher">-</span> )</div>
                    </div>

                    <div class="sig-box mb-7">
                        <div class="sig-line-wrapper">
                            <span class="sig-label">ลงชื่อ</span>
                            <div class="sig-dotted-line"></div>
                            <span class="sig-position">หัวหน้ากลุ่มสาระฯ</span>
                        </div>
                        <div class="sig-name-under">( <span id="sig-cover-head-dept">-</span> )</div>
                    </div>

                    <div class="sig-box mb-7">
                        <div class="sig-line-wrapper">
                            <span class="sig-label">ลงชื่อ</span>
                            <div class="sig-dotted-line"></div>
                            <span class="sig-position">หัวหน้างานวัดผล</span>
                        </div>
                        <div class="sig-name-under">( <span id="sig-cover-head-eval">-</span> )</div>
                    </div>

                    <div class="sig-box mb-7">
                        <div class="sig-line-wrapper">
                            <span class="sig-label">ลงชื่อ</span>
                            <div class="sig-dotted-line"></div>
                            <span class="sig-position">รองฯ ฝ่ายวิชาการ</span>
                        </div>
                        <div class="sig-name-under">( <span id="sig-cover-deputy">-</span> )</div>
                    </div>
                </div>

                <div class="flex items-center gap-4 pt-2 mt-1 border-t border-dotted border-gray-300">
                    <div class="flex flex-col gap-0.5 ml-1 text-[9pt]">
                    <div class="flex items-center gap-2 font-bold"><div class="w-3.5 h-3.5 border-[1.5px] border-black"></div> อนุมัติ   
						<div class="w-3.5 h-3.5 border-[1.5px] border-black ms-4"></div> ไม่อนุมัติ</div>
                        
                    </div>
                    <div class="flex-grow flex flex-col items-center">
                        <div class="flex items-end w-[240px] mb-0.5 mt-7">
                            <span class="mr-2 text-[10pt]">ลงชื่อ</span>
                            <div class="border-b border-dotted border-black flex-grow h-4"></div>
                        </div>
                        <div class="font-bold text-center text-[10pt] mb-0.5">( <span id="sig-cover-director">-</span> )</div>
                        <div class="font-bold text-sm text-center">ผู้อำนวยการโรงเรียนปากช่อง</div>
						<div class="cover-value min-w-[180px] inline-block mt-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ส่วนพิมพ์รายงานผลสัมฤทธิ์ -->
        <div id="achievement-print-container" class="font-['Sarabun'] text-black p-4">
            <h2 class="text-xl font-bold text-center mb-1">สรุปผลสัมฤทธิ์ทางการเรียนของผู้เรียน กลุ่มสาระการเรียนรู้<span id="ach-dept-name"></span></h2>
            <div class="text-center font-bold mb-1">
                ครูผู้สอน <span id="ach-teacher-name"></span> ภาคเรียนที่ <span id="ach-sem"></span> ปีการศึกษา <span id="ach-year"></span>
            </div>
            <div class="text-center font-bold mb-4">
                <span id="ach-school-name">โรงเรียนปากช่อง</span> อำเภอปากช่อง จังหวัดนครราชสีมา
            </div>

            <table class="w-full ach-table mb-4 border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th rowspan="2" style="width: 80px;">รหัสวิชา</th>
                        <th rowspan="2">ชั้น</th>
                        <th rowspan="2" class="w-10">จำนวน<br>นักเรียน</th>
                        <th colspan="10">จำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
                        <th rowspan="2" class="w-8">รวม</th>
                        <th colspan="10">ร้อยละจำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
                        <th rowspan="2" class="w-10">ร้อยละ<br>รวม</th>
                        <th rowspan="2" class="w-10">A.V.</th>
                        <th rowspan="2" class="w-10">S.D.</th>
                        <th rowspan="2" class="w-10">%ผ่านเกณฑ์</th>
                        <th rowspan="2" class="w-12">%ระดับ<br>ดีขึ้นไป</th>
                        <th rowspan="2" class="w-12">%ไม่ผ่าน<br>เกณฑ์</th>
                        <th rowspan="2" class="w-16">สรุป<br>ผลสัมฤทธิ์</th>
                    </tr>
                    <tr class="bg-gray-50">
                        <th class="w-6">4.0</th><th class="w-6">3.5</th><th class="w-6">3.0</th><th class="w-6">2.5</th><th class="w-6">2.0</th><th class="w-6">1.5</th><th class="w-6">1.0</th><th class="w-6">0</th><th class="w-6">ร</th><th class="w-6">มส</th>
                        <th class="w-8">4.0</th><th class="w-8">3.5</th><th class="w-8">3.0</th><th class="w-8">2.5</th><th class="w-8">2.0</th><th class="w-8">1.5</th><th class="w-8">1.0</th><th class="w-8">0</th><th class="w-8">ร</th><th class="w-8">มส</th>
                    </tr>
                </thead>
                <tbody id="ach-table-body"></tbody>
                <tfoot id="ach-table-foot" class="font-bold bg-gray-50"></tfoot>
            </table>

            <div class="mb-4 text-[9pt] px-4">
                <div class="grid grid-cols-3 gap-x-8 gap-y-1">
                    <div>1. ร้อยละค่าเป้าหมายระดับสถานศึกษา: <span id="ach-target-school-pct" class="font-bold">-</span></div>
                    <div>2. ร้อยละค่าเป้าหมายระดับกลุ่มสาระฯ: <span id="ach-target-dept-pct" class="font-bold">-</span></div>
                    <div>3. ร้อยละค่าเป้าหมายระดับสาขาวิชา: <span id="ach-target-subject-pct" class="font-bold">-</span></div>
                    <div>4. ผลการเรียนเฉลี่ยระดับสถานศึกษา &ge; <span id="ach-target-school-gpa" class="font-bold">-</span></div>
                    <div>5. ผลการเรียนเฉลี่ยระดับกลุ่มสาระฯ &ge; <span id="ach-target-dept-gpa" class="font-bold">-</span></div>
                    <div>6. ผลการเรียนเฉลี่ยระดับสาขาวิชา &ge; <span id="ach-target-subject-gpa" class="font-bold">-</span></div>
                </div>
            </div>

            <div class="flex gap-4 mb-4 h-[240px]">
                <div class="flex-1 border border-gray-300 p-2 relative">
                    <div class="text-[10pt] font-bold text-center mb-2">กราฟแสดงร้อยละของจำนวนนักเรียนต่อผลการเรียน</div>
                    <div id="ach-chart-1" class="ach-graph-container"></div>
                    <div class="text-center text-[9pt] mt-1">ผลการเรียน</div>
                </div>
                <div class="flex-1 border border-gray-300 p-2 relative">
                    <div class="text-[10pt] font-bold text-center mb-2">กราฟแสดงจำนวนนักเรียนต่อผลการเรียน</div>
                    <div id="ach-chart-2" class="ach-graph-container"></div>
                    <div class="text-center text-[9pt] mt-1">ผลการเรียน</div>
                </div>
            </div>

            <div class="flex justify-end mt-8 pr-16">
                <div class="text-center">
                    <div class="mb-1 mt-2">ลงชื่อ ........................................................... ครูผู้สอน</div>
                    <div class="font-bold">( <span id="ach-sign-teacher">-</span> )</div>
                </div>
            </div>
        </div>

        <!-- รายงานพิมพ์หัวตารางนักเรียน -->
        <div id="report-print-header" class="hidden print:block p-4 mb-2">
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1"></div>
                <div class="flex-1 text-center">
                    <h2 class="text-xl font-bold text-black" id="print-school-name">โรงเรียนปากช่อง</h2>
                </div>
                <div class="flex-1 text-right text-[10px] text-black">
                    <div>หน้าที่ 1 จาก 1 หน้า</div>
                    <div>พิมพ์วันที่ <span id="print-date-now">-</span></div>
                </div>
            </div>
            <div class="text-center text-[13px] text-black space-y-1 font-['Sarabun']">
                <div class="font-bold">
                    วิชา <span id="print-subject-code" class="px-1 font-bold text-blue-900">-</span> 
                    <span id="print-subject-name" class="px-1 font-bold text-blue-900">-</span> 
                    <span id="print-subject-credits" class="px-1 font-bold text-blue-900">-</span> นก. 
                    ภาคเรียนที่ <span id="print-semester" class="px-1">-</span> 
                    ปีการศึกษา <span id="print-year" class="px-1">-</span> 
                    ระดับชั้น <span id="print-grade-level" class="px-1">-</span> 
                    กลุ่มที่ <span id="print-room-group" class="px-1">-</span>
                </div>
                <div class="pt-1">
                    ครูผู้สอน <span id="print-teacher-name" class="px-1 font-bold">-</span> 
                    <span class="inline-block w-8"></span>
                    ครูที่ปรึกษา <span id="print-advisor-name" class="px-1 font-bold">-</span>
                </div>
            </div>
        </div>

        <!-- Header ระบบ -->
        <div class="bg-[#0d6efd] p-6 text-white no-print shadow-inner font-['Sarabun']">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold mb-1" id="header-subject-name">ระบบจัดการข้อมูลและผลการเรียน</h1>
                    <p class="text-indigo-100 opacity-90 text-sm">
                        ครูผู้สอน: <span id="display-teacher-name">-</span> | 
                        รหัสวิชา: <span id="display-course-code">-</span> |
                        ภาคเรียนที่: <span id="display-semester">-</span> |
                        ปีการศึกษา: <span id="display-academic-year">-</span>
                    </p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="switchView('grading')" class="nav-btn btn-grad-grading px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-list-check"></i>
                        บันทึกคะแนน
                    </button>
                    <button onclick="switchView('achievement')" class="nav-btn btn-grad-achievement px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-chart-line"></i>
                        สรุปผลสัมฤทธิ์
                    </button>
                    <button onclick="switchView('students')" class="nav-btn btn-grad-students px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-users-gear"></i>
                        จัดการนักเรียน
                    </button>
                    <button onclick="switchView('settings')" class="nav-btn btn-grad-settings px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-gear"></i>
                        ตั้งค่าวิชา
                    </button>
					<!-- ปุ่มออกจากระบบ (เพิ่มใหม่) -->
                    <button onclick="logoutSystem()" class="nav-btn bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-md">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- หน้าบันทึกคะแนน -->
        <div id="grading-view" class="view-section view-active font-['Sarabun']">
            <div class="p-4 bg-slate-50 border-b flex flex-wrap items-center gap-4 no-print">
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">รายวิชา:</label>
                    <select id="select-subject" onchange="changeActiveSubject(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
                </div>
                <div class="flex items-center gap-2">
                    <label class="text-xs font-bold text-slate-500 uppercase">ห้องเรียน:</label>
                    <select id="select-class" onchange="changeActiveClass(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
                </div>
                <div class="flex items-center gap-2 px-3 py-1 bg-blue-50 rounded-lg border border-blue-100 shadow-sm font-['Sarabun']">
                    <label class="text-[10px] font-bold text-[#0d6efd] uppercase">ครูที่ปรึกษา:</label>
                    <span id="display-advisor-name" class="text-sm font-bold text-[#0d6efd]">-</span>
                </div>
                
                <!-- ย้ายปุ่มบันทึกคะแนนมาไว้ที่นี่ -->
                <button onclick="saveScores()" class="btn-grad-save px-6 py-1.5 text-white rounded-lg font-medium shadow-md font-['Sarabun'] font-bold text-sm uppercase">
                    <i class="fa-solid fa-floppy-disk"></i> บันทึกคะแนน
                </button>

                <div class="text-[10px] text-slate-400 font-bold uppercase italic ml-auto">* จ = จริง, ก = แก้ไข</div>
            </div>

            <!-- ย้ายปุ่มส่งออกและพิมพ์มาไว้ที่นี่และจัดกลาง -->
            <div class="p-4 flex flex-wrap justify-center items-center gap-3 no-print bg-white border-b border-slate-100">
                <button onclick="exportToCSV()" class="btn-grad-achievement px-4 py-2 text-white rounded-lg font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-file-csv"></i> CSV
                </button>
                <button onclick="exportToExcel()" class="bg-[#198754] text-white px-4 py-2 rounded-lg hover:bg-[#157347] font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-file-excel"></i> Excel
                </button>
                <button onclick="printAchievementSummary()" class="btn-grad-students px-4 py-2 text-white rounded-lg font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-chart-simple"></i> พิมพ์สรุปผลสัมฤทธิ์
                </button>
                <button onclick="printCover()" class="bg-[#212529] text-white px-4 py-2 rounded-lg hover:bg-black font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-book"></i> พิมพ์ปก ปพ. 5
                </button>
                <button onclick="printReport('all')" class="bg-rose-600 text-white px-4 py-2 rounded-lg hover:bg-rose-700 font-medium shadow-sm flex items-center gap-2 font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-file-pdf"></i> พิมพ์รายงาน ปพ. (จ และ ก)
                </button>
                <!-- ปุ่มพิมพ์รายงาน ปพ แบบที่ 2 (สีน้ำเงิน) -->
                <button onclick="printReport('max')" class="bg-[#0d6efd] text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium shadow-sm flex items-center gap-2 font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-file-invoice"></i> พิมพ์รายงาน ปพ. (ค่าสูงสุด)
                </button>
            </div>


            <div id="grading-pagination" class="p-4 bg-white border-t flex flex-col md:flex-row justify-between items-center gap-4 no-print border-slate-200">
                <div class="flex items-center gap-4 text-xs text-slate-500 font-['Sarabun']">
                    <div class="flex items-center gap-2">
                        แสดง 
                        <select onchange="changePageLength(this.value)" class="border rounded p-1 bg-white text-[10px] font-bold outline-none">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div id="grading-pagination-info"></div>
                </div>
                <div id="grading-pagination-controls" class="flex items-center gap-1"></div>
            </div>
			
			<div id="report-main-content" class="overflow-x-auto">
                <table class="w-full text-sm text-left border-collapse border border-slate-300">
                    <thead id="tableHeader" class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-indigo-300 font-bold"></thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>

            <div id="summary-section" class="p-6 print:p-0 bg-white border-t space-y-4 border-slate-200 font-['Sarabun']">
                <div class="flex flex-col lg:flex-row items-start justify-between gap-8">
                    <div class="flex-grow w-full lg:w-auto">
                        <div class="grid grid-cols-3 text-[13px] font-bold text-slate-700 mb-2 px-1 print:px-0 print:mt-4">
                            <div>รวมจำนวนนักเรียน <span id="sum-total-stu" class="text-[#0d6efd] font-bold">0</span> คน</div>
                            <div class="text-center">ผลการเรียนระดับดีขึ้นไปร้อยละ <span id="sum-good-pct" class="text-[#198754] font-bold">0.00</span></div>
                            <div class="text-right">ผลการเรียนเฉลี่ยร้อยละ <span id="sum-avg-pct" class="text-[#0d6efd] font-bold">0.00</span></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs border-collapse summary-table border-black font-['Sarabun']">
                                <tr class="bg-slate-50 font-bold text-slate-600">
                                    <td class="bg-slate-100 min-w-[120px] border-black">สรุปสถิติประเมินผล</td>
                                    <td class="w-10 border-black">4</td><td class="w-10 border-black">3.5</td><td class="w-10 border-black">3</td><td class="w-10 border-black">2.5</td><td class="w-10 border-black">2</td><td class="w-10 border-black">1.5</td><td class="w-10 border-black">1</td><td class="w-10 border-black">0</td><td class="w-10 border-black">ร</td><td class="w-10 border-black">มส</td><td class="w-10 border-black">ผ</td><td class="w-10 border-black">มผ</td>
                                </tr>
                                <tr class="font-medium text-slate-800">
                                    <td class="bg-slate-50 font-bold border-black">จำนวน</td>
                                    <td id="stat-4" class="border-black">-</td><td id="stat-3.5" class="border-black">-</td><td id="stat-3" class="border-black">-</td><td id="stat-2.5" class="border-black">-</td><td id="stat-2" class="border-black">-</td><td id="stat-1.5" class="border-black">-</td><td id="stat-1" class="border-black">-</td><td id="stat-0" class="border-black">-</td><td id="stat-ร" class="border-black">-</td><td id="stat-มส" class="border-black">-</td><td id="stat-ผ" class="border-black">-</td><td id="stat-มผ" class="border-black">-</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="text-sm text-slate-700 w-full lg:w-[400px] shrink-0 lg:pt-7">
                        <div class="flex items-end justify-center lg:justify-end gap-1 mb-2 whitespace-nowrap">
                            <span>ลงชื่อ</span>
                            <div class="flex-grow border-b border-dotted border-black mb-1.5 mx-1 min-w-[180px]"></div>
                            <span>ครูผู้สอน</span>
                        </div>
                        <div class="text-center mt-1 font-bold">( <span id="sig-teacher-name">-</span> )</div>
                        <div class="text-center mt-2 font-bold" id="sig-date">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- หน้าสรุปผลสัมฤทธิ์ (Web view) -->
        <div id="achievement-view" class="view-section p-8 bg-slate-50 font-['Sarabun']">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800 uppercase tracking-tighter flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-[#0d6efd]"></i>
                    สรุปผลสัมฤทธิ์ทางการเรียน (ทุกรายวิชา)
                </h2>
			<div class="flex flex-wrap gap-2">
						<select id="ach-filter-subject" onchange="changeAchFilterSubject(this.value)" class="border rounded-lg px-3 py-2 text-sm font-bold text-slate-700 bg-white shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
							<option value="all">ทุกรายวิชา</option>
						</select>
						
						<select id="ach-filter-room" onchange="changeAchFilterRoom(this.value)" class="border rounded-lg px-3 py-2 text-sm font-bold text-slate-700 bg-white shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
							<option value="all">ทุกห้องเรียน</option>
						</select>

						<button onclick="printAchievementSummary()" class="btn-grad-students px-5 py-2 text-white rounded-lg font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-sm">
							<i class="fa-solid fa-print"></i> พิมพ์รายงาน
						</button>
					</div>
				</div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
                     <div><span class="font-bold text-slate-500 block text-xs uppercase mb-1">กลุ่มสาระการเรียนรู้</span><span id="view-ach-dept-name" class="font-bold text-lg text-slate-800">-</span></div>
                     <div><span class="font-bold text-slate-500 block text-xs uppercase mb-1">ครูผู้สอน</span><span id="view-ach-teacher-name" class="font-bold text-lg text-slate-800">-</span></div>
                     <div><span class="font-bold text-slate-500 block text-xs uppercase mb-1">ภาคเรียน/ปีการศึกษา</span><span class="font-bold text-lg text-slate-800"><span id="view-ach-sem"></span> / <span id="view-ach-year"></span></span></div>
                     <div><span class="font-bold text-slate-500 block text-xs uppercase mb-1">โรงเรียน</span><span id="view-ach-school-name" class="font-bold text-lg text-slate-800">โรงเรียนปากช่อง</span></div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full ach-table mb-4 border-collapse">
                        <thead>
                            <tr class="bg-blue-50 text-slate-800">
                                <th rowspan="2" style="width: 80px;" class="border-slate-300">รหัสวิชา</th>
                                <th rowspan="2" class="border-slate-300">ชั้น</th>
                                <th rowspan="2" class="w-10 border-slate-300">จำนวน<br>นักเรียน</th>
                                <th colspan="10" class="border-slate-300 bg-blue-100">จำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
                                <th rowspan="2" class="w-8 border-slate-300 bg-slate-100">รวม</th>
                                <th colspan="10" class="border-slate-300 bg-green-50">ร้อยละจำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
                                <th rowspan="2" class="w-10 border-slate-300 bg-slate-100">ร้อยละ<br>รวม</th>
                                <th rowspan="2" class="w-10 border-slate-300">X-Bar</th>
                                <th rowspan="2" class="w-10 border-slate-300">S.D.</th>
                                <th rowspan="2" class="w-10 border-slate-300">%ผ่านเกณฑ์</th>
                                <th rowspan="2" class="w-12 border-slate-300">%ระดับ<br>ดีขึ้นไป</th>
                                <th rowspan="2" class="w-12 border-slate-300">%ไม่ผ่าน<br>เกณฑ์</th>
                                <th rowspan="2" class="w-16 border-slate-300">สรุป<br>ผลสัมฤทธิ์</th>
                            </tr>
                            <tr class="bg-white">
                                <th class="w-6 border-slate-300 text-xs">4.0</th><th class="w-6 border-slate-300 text-xs">3.5</th><th class="w-6 border-slate-300 text-xs">3.0</th><th class="w-6 border-slate-300 text-xs">2.5</th><th class="w-6 border-slate-300 text-xs">2.0</th><th class="w-6 border-slate-300 text-xs">1.5</th><th class="w-6 border-slate-300 text-xs">1.0</th><th class="w-6 border-slate-300 text-xs">0</th><th class="w-6 border-slate-300 text-xs">ร</th><th class="w-6 border-slate-300 text-xs">มส</th>
                                <th class="w-8 border-slate-300 text-xs">4.0</th><th class="w-8 border-slate-300 text-xs">3.5</th><th class="w-8 border-slate-300 text-xs">3.0</th><th class="w-8 border-slate-300 text-xs">2.5</th><th class="w-8 border-slate-300 text-xs">2.0</th><th class="w-8 border-slate-300 text-xs">1.5</th><th class="w-8 border-slate-300 text-xs">1.0</th><th class="w-8 border-slate-300 text-xs">0</th><th class="w-8 border-slate-300 text-xs">ร</th><th class="w-8 border-slate-300 text-xs">มส</th>
                            </tr>
                        </thead>
                        <tbody id="view-ach-table-body" class="bg-white"></tbody>
                        <tfoot id="view-ach-table-foot" class="font-bold bg-slate-50 border-t-2 border-slate-300"></tfoot>
                    </table>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                     <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="text-[12pt] font-bold text-left mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-column text-emerald-500"></i>
                            กราฟเปรียบเทียบร้อยละจำนวนนักเรียนแยกตามระดับผลการเรียน
                        </div>
                        <div id="view-ach-chart-1" class="ach-graph-container h-[250px]"></div>
                        <div class="text-center text-xs mt-2 text-slate-500 font-bold uppercase tracking-wider">ระดับผลการเรียน</div>
                     </div>
                     <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="text-[12pt] font-bold text-left mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-column text-emerald-500"></i>
                            กราฟเปรียบเทียบจำนวนนักเรียนแยกตามระดับผลการเรียน
                        </div>
                        <div id="view-ach-chart-2" class="ach-graph-container h-[250px]"></div>
                        <div class="text-center text-xs mt-2 text-slate-500 font-bold uppercase tracking-wider">ระดับผลการเรียน</div>
                     </div>
                </div>

                <!-- กล่องวิเคราะห์ผลสัมฤทธิ์ตามตัวอย่าง -->
                <div id="ach-analysis-container" class="mt-8 p-5 bg-emerald-50/50 border-2 border-dashed border-emerald-200 rounded-2xl">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center flex-shrink-0">
                            <i class="fa-regular fa-lightbulb text-amber-400 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-emerald-800 text-base mb-1">วิเคราะห์การกระจายตัวของผลสัมฤทธิ์ทางการเรียน:</h4>
                            <p id="ach-analysis-text" class="text-emerald-700 text-sm leading-relaxed">
                                กราฟนี้แสดงความหนาแน่นของจำนวนนักเรียนในแต่ละระดับผลการเรียน หากแท่งสูงต่างกันมากในแต่ละระดับ แสดงว่ามีการกระจายแบบเป็นกลุ่ม (เช่น นักเรียนส่วนใหญ่กองอยู่ที่ระดับผลการเรียนสูง) หากความสูงใกล้เคียงกัน แสดงว่ามีการกระจายตัวแบบสม่ำเสมอในทุกระดับผลการเรียน
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- หน้าจัดการนักเรียน -->
        <div id="students-view" class="view-section p-6 font-['Sarabun']">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 font-['Sarabun']">
                <h2 class="text-xl font-bold text-slate-800">จัดการรายชื่อนักเรียน</h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="downloadStudentTemplate()" class="btn-secondary text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition font-['Sarabun']">
                        <i class="fa-solid fa-file-lines"></i> เทมเพลต
                    </button>
                    <label class="btn-grad-achievement text-white px-4 py-2 rounded-lg text-sm font-bold cursor-pointer flex items-center gap-2 transition font-['Sarabun']">
                        <i class="fa-solid fa-file-import"></i> นำเข้า Excel <input type="file" class="hidden" onchange="simulateExcelImport(this)">
                    </label>
                    <button onclick="openStudentModal()" class="btn-grad-grading text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 font-['Sarabun'] cursor-pointer">
                        <i class="fa-solid fa-user-plus"></i> เพิ่มนักเรียนใหม่
                    </button>
                </div>
            </div>

            <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-200 flex flex-wrap gap-4 items-center">
                <div class="flex-grow min-w-[200px]">
                    <input type="text" id="search-student" oninput="initStudentTable()" placeholder="ค้นหารหัส หรือ ชื่อนักเรียน..." class="w-full border rounded-lg p-2 text-sm font-['Sarabun']">
                </div>
                <select id="filter-student-status" onchange="initStudentTable()" class="border rounded-lg p-2 text-sm bg-white font-['Sarabun']">
                    <option value="">ทุกสถานะ</option>
                    <option value="ปกติ">ปกติ</option>
                    <option value="ขาดเรียนนาน">ขาดเรียนนาน</option>
                    <option value="ลาออก">ลาออก</option>
                    <option value="สำเร็จการศึกษา">สำเร็จการศึกษา</option>
                </select>
                <select id="filter-student-room" onchange="initStudentTable()" class="border rounded-lg p-2 text-sm bg-white font-['Sarabun']">
                    <option value="">ทุกห้อง</option>
                </select>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-[12px] font-bold border-b border-slate-200 font-['Sarabun']">
                        <tr>
                            <th class="px-4 py-3 w-16 text-center border-r">รูป</th>
                            <th class="px-4 py-3 w-24 text-center border-r">รหัส</th>
                            <th class="px-4 py-3 w-32 text-center border-r">เลขบัตรประชาชน</th>
                            <th class="px-4 py-3 text-center border-r">ชื่อ-นามสกุล</th>
                            <th class="px-4 py-3 w-16 text-center border-r">เพศ</th>
                            <th class="px-4 py-3 w-20 text-center border-r">ห้อง</th>
                            <th class="px-4 py-3 w-16 text-center border-r">เลขที่</th>
                            <th class="px-4 py-3 w-24 text-center border-r">ปีที่เข้า</th>
                            <th class="px-4 py-3 w-32 text-center border-r">สถานะ</th>
                            <th class="px-4 py-3 w-24 text-center no-print">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body"></tbody>
                </table>
            </div>
            
            <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-4 no-print font-['Sarabun']">
                <div class="flex items-center gap-4 text-xs text-slate-500 font-['Sarabun']">
                    <div class="flex items-center gap-2">
                        แสดง 
                        <select onchange="changePageLength(this.value)" class="border rounded p-1 bg-white text-[10px] font-bold outline-none">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div id="student-pagination-info"></div>
                </div>
                <div id="student-pagination-controls" class="flex gap-1"></div>
            </div>
        </div>

        <!-- หน้าตั้งค่าวิชา -->
        <div id="settings-view" class="view-section p-8 bg-slate-50 font-['Sarabun']">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2 border-b border-slate-200 pb-3 uppercase tracking-tighter">จัดการรายวิชาและโครงสร้างคะแนน</h2>
            <div class="grid grid-cols-1 xl:grid-cols-4 gap-8 font-['Sarabun']">
                <div class="xl:col-span-1 bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-[#0d6efd] uppercase text-[16px]">รายการวิชาที่สอน</h3>
                        <button onclick="addNewSubject()" class="text-[#0d6efd] font-bold text-xs hover:text-blue-800"><i class="fa-solid fa-plus"></i> เพิ่มวิชา</button>
                    </div>
                    <div id="subject-list-container" class="space-y-2 flex-grow overflow-y-auto max-h-[600px]"></div>
                </div>

                <div id="subject-editor" class="xl:col-span-3 bg-white p-8 rounded-xl shadow-sm border border-slate-200 opacity-50 pointer-events-none transition-opacity duration-300">
                    <!-- Tab Navigation -->
                    <div class="flex border-b border-slate-200 mb-6 gap-2 no-print overflow-x-auto">
                        <button onclick="switchSettingsTab('tab-school')" id="btn-tab-school" class="settings-tab-btn active px-4 py-2 font-bold text-[12px] text-slate-500 border-b-2 border-transparent transition-all hover:text-[#0d6efd]">1. ข้อมูลสถานศึกษา</button>
                        <button onclick="switchSettingsTab('tab-targets')" id="btn-tab-targets" class="settings-tab-btn px-4 py-2 text-[12px] font-bold text-slate-500 border-b-2 border-transparent transition-all hover:text-[#0d6efd]">2. กำหนดค่าเป้าหมาย</button>
                        <button onclick="switchSettingsTab('tab-subject')" id="btn-tab-subject" class="settings-tab-btn px-4 py-2 text-[12px] font-bold text-slate-500 border-b-2 border-transparent transition-all hover:text-[#0d6efd]">3. รายวิชาและคะแนน</button>
                    </div>

                    <!-- Content Tab 1: ข้อมูลสถานศึกษาและบุคลากร -->
                    <div id="tab-school" class="settings-tab-content">
                        <h3 class="font-bold text-[16px] text-[#0d6efd] uppercase text-xs tracking-widest mb-6 border-l-4 border-[#0d6efd] pl-3">ข้อมูลสถานศึกษาและบุคลากร</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-10 font-['Sarabun']">
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ชื่อโรงเรียน</label><input type="text" id="edit-school-name" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-slate-50 font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">สังกัด/เขตพื้นที่</label><input type="text" id="edit-affiliation" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-slate-50 font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ผู้อำนวยการ</label><input type="text" id="edit-director" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-slate-50 font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">รองฯ ฝ่ายวิชาการ</label><input type="text" id="edit-deputy-director" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-slate-50 font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">หัวหน้างานวัดผล</label><input type="text" id="edit-head-evaluation" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-slate-50 font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">หัวหน้ากลุ่มสาระฯ</label><input type="text" id="edit-head-department" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-slate-50 font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ครูผู้สอน</label><input type="text" id="edit-teacher" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-slate-50 font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">กลุ่มสาระการเรียนรู้</label><input type="text" id="edit-head-dept-name" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-slate-50 font-['Sarabun']"></div>
                            
                            <div class="md:col-span-2 lg:col-span-3">
                                <label class="block text-[12px] font-bold text-[#0d6efd] uppercase mb-2">รายชื่อครูที่ปรึกษา (ตามห้อง)</label>
                                <div id="dynamic-advisors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 bg-blue-50/30 p-4 rounded-xl border border-blue-100/50"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Content Tab 2: กำหนดค่าเป้าหมายผลสัมฤทธิ์ -->
                    <div id="tab-targets" class="settings-tab-content hidden">
                        <h3 class="font-bold text-[16px] text-[#0d6efd] uppercase text-xs tracking-widest mb-6 border-l-4 border-[#0d6efd] pl-3">กำหนดค่าเป้าหมายผลสัมฤทธิ์</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 font-['Sarabun'] bg-blue-50/20 p-6 rounded-xl border border-blue-100">
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ร้อยละเป้าหมาย (สถานศึกษา)</label><input type="number" id="edit-target-school-pct" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ร้อยละเป้าหมาย (กลุ่มสาระฯ)</label><input type="number" id="edit-target-dept-pct" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ร้อยละเป้าหมาย (สาขาวิชา)</label><input type="number" id="edit-target-subject-pct" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">เกรดเฉลี่ยเป้าหมาย (สถานศึกษา)</label><input type="number" step="0.01" id="edit-target-school-gpa" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">เกรดเฉลี่ยเป้าหมาย (กลุ่มสาระฯ)</label><input type="number" step="0.01" id="edit-target-dept-gpa" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">เกรดเฉลี่ยเป้าหมาย (สาขาวิชา)</label><input type="number" step="0.01" id="edit-target-subject-gpa" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                        </div>
                    </div>

                    <!-- Content Tab 3: การตั้งค่ารายวิชาและโครงสร้างคะแนน -->
                    <div id="tab-subject" class="settings-tab-content hidden">
                        <h3 class="font-bold text-[16px] text-[#0d6efd] uppercase text-xs tracking-widest mb-6 border-l-4 border-[#0d6efd] pl-3">การตั้งค่ารายวิชา</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 font-['Sarabun']">
                            <div class="lg:col-span-2"><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ชื่อวิชา</label><input type="text" id="edit-subject-name" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">รหัสวิชา</label><input type="text" id="edit-course-code" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div>
                                <label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ลักษณะวิชา</label>
                                <select id="edit-subject-type" onchange="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']">
                                    <option value="พื้นฐาน">พื้นฐาน</option>
                                    <option value="เพิ่มเติม">เพิ่มเติม</option>
                                </select>
                            </div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">หน่วยกิต</label><input type="number" step="0.5" id="edit-credits" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">เวลาเรียน (ชม./สัปดาห์)</label><input type="number" step="0.5" id="edit-hours" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ห้องที่สอน (คั่นด้วย ,)</label><input type="text" id="edit-classes" oninput="handleClassesChange()" class="w-full border p-2 rounded text-sm font-['Sarabun']" placeholder="ม.4/1, ม.4/2"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ภาคเรียนที่</label><input type="number" id="edit-semester" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[12px] font-bold text-slate-400 uppercase mb-1">ปีการศึกษา</label><input type="number" id="edit-academic-year" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                        </div>

                        <div class="bg-blue-50/50 p-6 rounded-xl border border-blue-100 mb-8">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 font-['Sarabun']">
                                <div><label class="block text-[12px] font-bold text-slate-500 uppercase mb-1 font-bold">กลางภาค (เต็ม):</label><input type="number" id="edit-mid-max" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-bold text-[#0d6efd] font-['Sarabun']"></div>
                                <div><label class="block text-[12px] font-bold text-slate-500 uppercase mb-1">กลางภาค (%):</label><input type="number" id="edit-mid-pass-pct" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                                <div><label class="block text-[12px] font-bold text-slate-500 uppercase mb-1 font-bold">ปลายภาค (เต็ม):</label><input type="number" id="edit-fin-max" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-bold text-[#0d6efd] font-['Sarabun']"></div>
                                <div><label class="block text-[12px] font-bold text-slate-500 uppercase mb-1">ปลายภาค (%):</label><input type="number" id="edit-fin-pass-pct" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm font-['Sarabun']"></div>
                            </div>
                        </div>

                        <div class="bg-white border-2 border-slate-100 p-6 rounded-xl mb-8 shadow-inner font-['Sarabun']">
                            <div class="flex justify-between items-center mb-6">
                                <h4 class="text-xs font-bold text-[12px] text-slate-700 uppercase font-['Sarabun']">โครงสร้างคะแนนรายหน่วย</h4>
                                <button onclick="addNewUnitToCurrent()" class="btn-grad-grading text-[12px] text-white px-3 py-1 rounded-md text-[10px] font-bold font-['Sarabun']">+ เพิ่มหน่วย</button>
                            </div>
                            <div id="units-editor-list" class="space-y-3 font-['Sarabun']"></div>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 mt-4">
                        <button onclick="deleteCurrentSubject()" class="bg-rose-600 text-[12px] text-white px-5 py-2.5 rounded-lg font-medium shadow-sm flex items-center font-['Sarabun'] font-bold text-sm"><i class="fa-solid fa-trash-can"> ลบรายวิชา</i></button>
                        <button onclick="applySettings()" class="btn-grad-grading text-white px-10 py-2 rounded-xl transition shadow-lg font-bold text-sm uppercase font-['Sarabun']"><i class="fa-solid fa-check"></i> บันทึกและยืนยัน</button>
                    </div>
                </div>
            </div>
        </div>
		
        <!-- ปรับแต่งส่วน Footer ใหม่ตามคำขอ -->
		<footer style="text-align: center; background-color:#faff99; padding: 20px 0; margin-top: auto; border-top: 1px solid #e0e0e0; font-size: 0.9em; color: #555; width: 100%;" class="no-print">
            <div class="container mx-auto flex flex-col items-center gap-2">
                <div class="w-full text-center">:: Created and Develop by KT | Tanasarn Sirak ::</div>
                
                <div class="w-full text-center">
                    <a href="https://line.me/ti/p/3F7VGrqgUr" target="_blank" style="text-decoration:none;" class="inline-flex items-center gap-1 justify-center">
                        <i class="fa-solid fa-comments" style="color:#007bff;"></i>
                        <span style="color:red; font-size:12px"> สอบถาม/แจ้งปัญหา :: </span>
                        <span style="font-size:12px; color:black">KT | Tanasarn Sirak © 2569</span>
                    </a>
                </div>

                <div class="w-full text-center flex items-center justify-center gap-2">
                    <span style="font-size: 14px; font-weight: 500;">:: จำนวนผู้ใช้งาน ::</span>
                    <a href="https://www.freecounterstat.com" title="website counter" class="inline-block">
                        <img src="https://counter1.optistats.ovh/private/freecounterstat.php?c=uwgfnf4ee1nu15h57t14a9pnpf2h58za" border="0" title="website counter" alt="website counter" style="display: block; height: 24px;">
                    </a>
                </div>
            </div>
		</footer>
		
    </div>

    <!-- Modal จัดการข้อมูลนักเรียน -->
    <div id="student-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay no-print">
        <div class="bg-white w-full student-modal-content overflow-hidden flex flex-col font-['Sarabun']">
            <div class="modal-header-bg p-4 flex justify-between items-center text-white">
                <h2 id="modal-title" class="text-xl font-bold ml-1 font-['Sarabun']">แก้ไขข้อมูลนักเรียน</h2>
                <button onclick="closeStudentModal()" class="modal-btn hover:bg-white/20 p-1.5 rounded-full transition font-['Sarabun']">
                    <i class="fa-solid fa-xmark fa-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="flex gap-6 mb-5">
                    <div class="flex-shrink-0">
                        <div onclick="triggerImageUpload()" class="photo-box relative group overflow-hidden font-['Sarabun']">
                            <img id="modal-stu-img-preview" class="hidden w-full h-full object-cover rounded-lg">
                            <div id="image-upload-placeholder" class="text-center font-['Sarabun']">
                                <i class="fa-solid fa-camera fa-2x mb-1 opacity-50"></i>
                                <span class="text-[10px] font-bold font-['Sarabun'] block">แนบรูป</span>
                            </div>
                            <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity font-['Sarabun']"><span class="text-white text-[9px] font-bold">เปลี่ยนรูป</span></div>
                        </div>
                        <input type="file" id="modal-stu-image-input" class="hidden" accept="image/*" onchange="handleImagePreview(this)">
                    </div>
                    <div class="flex-grow space-y-1 font-['Sarabun']">
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-0.5">รหัสนักเรียน</label><input type="text" id="modal-stu-id" class="modal-input font-bold text-slate-800 font-['Sarabun'] py-1"></div>
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-0.5">เลขบัตรประชาชน</label><input type="text" id="modal-stu-national-id" class="modal-input text-slate-800 font-['Sarabun'] py-1" placeholder="13 หลัก"></div>
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-0.5">ชื่อ-นามสกุล</label><input type="text" id="modal-stu-name" class="modal-input font-['Sarabun'] py-1"></div>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-3 mb-5 font-['Sarabun']">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ชั้น/ห้อง</label><input type="text" id="modal-stu-room" class="modal-input text-center font-['Sarabun']"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">เลขที่</label><input type="number" id="modal-stu-number" class="modal-input text-center font-['Sarabun']"></div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">เพศ</label>
                        <select id="modal-stu-gender" class="modal-input bg-white font-['Sarabun'] text-center">
                            <option value="ชาย">ชาย</option>
                            <option value="หญิง">หญิง</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ปีที่เข้า</label><input type="number" id="modal-stu-year" class="modal-input text-center font-['Sarabun']"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1 font-['Sarabun']">สถานะภาพ</label><select id="modal-stu-status" class="modal-input bg-white font-['Sarabun']"><option value="ปกติ">ปกติ</option><option value="ขาดเรียนนาน">ขาดเรียนนาน</option><option value="ลาออก">ลาออก</option><option value="สำเร็จการศึกษา">สำเร็จการศึกษา</option></select></div>
            </div>
            <div class="p-6 pt-0 flex justify-end gap-2 items-center font-['Sarabun']">
                <input type="hidden" id="modal-student-uid">
                <button onclick="closeStudentModal()" class="bg-rose-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-sm flex items-center font-['Sarabun'] font-bold text-sm">ยกเลิก</button>
                <button onclick="saveStudent()" class="bg-blue-500 text-white px-5 py-2.5 rounded-lg font-medium shadow-sm flex items-center font-['Sarabun'] font-bold text-sm">บันทึกข้อมูล</button>
            </div>
        </div>
    </div>

<script>
		const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
		
// แก้ไขฟังก์ชันนี้ (เพิ่มบรรทัด zIndex)
		function showLoading() { 
			const overlay = document.getElementById('loading-overlay');
			overlay.style.zIndex = '50000'; // บังคับให้สูงกว่า Login Modal (9999) และ SweetAlert (20000)
			overlay.style.display = 'flex'; 
		}

		function hideLoading() { 
			document.getElementById('loading-overlay').style.display = 'none'; 
		}
		function showNotification(msg, type = 'success') { Toast.fire({ icon: type, title: msg }); }

		function getStatusStyle(status) { 
			const styles = { 'ปกติ': 'bg-emerald-100 text-emerald-700', 'ขาดเรียนนาน': 'bg-orange-100 text-orange-700', 'ลาออก': 'bg-rose-100 text-rose-700', 'สำเร็จการศึกษา': 'bg-blue-100 text-blue-700' }; 
			return styles[status] || 'bg-slate-100 text-slate-700'; 
		}

		function viewStudentPhoto(uid) {
			const s = students.find(x => x.uid === uid);
			if (!s) return;
			const placeholderImg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23cbd5e1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' /%3E%3C/svg%3E`;
			Swal.fire({
				width: '380px',
				padding: '0',
				html: `
				<div class="flex flex-col items-center font-['Sarabun'] p-6">
					<div class="mb-4">
						<img src="${s.image || placeholderImg}" class="w-40 h-40 object-cover rounded-[2rem] shadow-xl border-4 border-white">
					</div>
					<div class="text-2xl font-bold text-slate-800 mb-0.5 leading-tight text-center">${s.name}</div>
					<div class="text-lg text-indigo-600 font-bold mb-0 leading-tight">รหัส: ${s.id}</div>
					<div class="text-sm text-slate-500 font-bold mb-4 leading-tight">เลขบัตรประชาชน: ${s.nationalId || '-'}</div>
					<div class="w-full bg-lime-200 py-3 px-2 rounded-2xl border border-slate-100 mb-6 text-[13px] text-slate-500 font-medium flex justify-center gap-1">
						ห้อง ${s.room} | เลขที่ ${s.number} | เพศ ${s.gender} | สถานะ: <span class="${getStatusTextColor(s.status)} font-bold">${s.status}</span>
					</div>
					<button onclick="Swal.close()" class="modal-btn w-2/3 bg-[#0d6efd] text-white py-3 rounded-2xl text-xl font-bold transition hover:bg-blue-700">ปิดหน้าต่าง</button>
				</div>`,
				showConfirmButton: false,
				customClass: { popup: 'rounded-[2.5rem]', htmlContainer: 'p-0' }
			});
		}

		function getStatusTextColor(status) { const colors = { 'ปกติ': 'text-emerald-600', 'ขาดเรียนนาน': 'text-orange-600', 'ลาออก': 'text-rose-600', 'สำเร็จการศึกษา': 'text-blue-600' }; return colors[status] || 'text-slate-600'; }

		// MOCK DATA (Will be overwritten by Google Apps Script)
		let subjects = [];
		const generateUID = () => Math.random().toString(36).substr(2, 9);
		let students = [];
		let scoreData = {}; 
		
		let activeSubjectId = ""; 
		let activeClassName = ""; 
		let editingSubjectId = null;
		let currentGradingPage = 1; let currentStudentPage = 1; let rowsPerPage = 10;
		let currentPrintMode = 'all';

		// --- New Global Variables for Achievement Filter ---
		let achFilterSubject = 'all';
		let achFilterRoom = 'all';
		
		// --- Helper Function: Get Active Students In Class ---
		function getActiveStudentsInClass(className) {
			if (!className) return [];
			const targetRoom = String(className).trim();
			return students.filter(s => {
				if (!s.room) return false;
				const sRoom = String(s.room).trim();
				const sStatus = String(s.status || "").trim();
				return sRoom === targetRoom && (sStatus === 'ปกติ' || sStatus === '');
			});
		}

		// --- Filter Management Functions ---
		function updateAchFilters() {
			const subSelect = document.getElementById('ach-filter-subject');
			const roomSelect = document.getElementById('ach-filter-room');
			
			// Update Subject Dropdown
			if (subSelect) {
				let subHtml = '<option value="all">ทุกรายวิชา</option>';
				subjects.forEach(s => {
					subHtml += `<option value="${s.id}" ${s.id === achFilterSubject ? 'selected' : ''}>${s.code} ${s.name}</option>`;
				});
				subSelect.innerHTML = subHtml;
			}

			// Update Room Dropdown based on selected subject
			if (roomSelect) {
				let allRooms = new Set();
				subjects.forEach(s => {
					if (achFilterSubject === 'all' || s.id === achFilterSubject) {
						if (s.classes) s.classes.forEach(c => allRooms.add(c));
					}
				});

				// Sort rooms naturally
				const sortedRooms = Array.from(allRooms).sort((a, b) => 
					a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
				);

				let roomHtml = '<option value="all">ทุกห้องเรียน</option>';
				sortedRooms.forEach(r => {
					roomHtml += `<option value="${r}" ${r === achFilterRoom ? 'selected' : ''}>${r}</option>`;
				});
				roomSelect.innerHTML = roomHtml;
			}
		}

		function changeAchFilterSubject(val) {
			achFilterSubject = val;
			achFilterRoom = 'all'; // Reset room when subject changes
			updateAchFilters();
			initAchievementView();
		}

		function changeAchFilterRoom(val) {
			achFilterRoom = val;
			initAchievementView();
		}

		function switchView(view) {
			showLoading();
			setTimeout(() => {
				try {
					document.querySelectorAll('.view-section').forEach(v => v.classList.remove('view-active'));
					const viewEl = document.getElementById(view + '-view');
					if (viewEl) viewEl.classList.add('view-active');
					
					document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('opacity-100', 'shadow-inner'));
					
					if (view === 'grading') { updateGradingFilters(); updateDisplayHeader(); initTable(); } 
					else if (view === 'students') { updateStudentFilters(); initStudentTable(); } 
					else if (view === 'settings') { renderSettingsSubjects(); }
					else if (view === 'achievement') { 
						updateAchFilters(); // Initialize filters
						initAchievementView(); 
					}
				} catch (err) {
					console.error("View switch error:", err);
				} finally {
					hideLoading();
				}
			}, 300);
		}

		function switchSettingsTab(tabId) {
			document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.add('hidden'));
			document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
			document.getElementById(tabId).classList.remove('hidden');
			document.getElementById('btn-' + tabId).classList.add('active');
		}

		function initAchievementView() {
			// Determine target subject for header display
			const targetSub = (achFilterSubject !== 'all') 
				? subjects.find(s => s.id === achFilterSubject) 
				: (subjects[0] || {});

			const deptEl = document.getElementById('view-ach-dept-name');
			const teachEl = document.getElementById('view-ach-teacher-name');
			const semEl = document.getElementById('view-ach-sem');
			const yearEl = document.getElementById('view-ach-year');
			const schoolEl = document.getElementById('view-ach-school-name');

			if(deptEl) deptEl.innerText = (achFilterSubject === 'all') ? "รวมทุกรายวิชา" : (targetSub.departmentName || "-");
			if(teachEl) teachEl.innerText = targetSub.teacher || "-";
			if(semEl) semEl.innerText = targetSub.semester || "-";
			if(yearEl) yearEl.innerText = targetSub.year || "-";
			if(schoolEl) schoolEl.innerText = targetSub.schoolName || "โรงเรียนปากช่อง";

			const tbody = document.getElementById('view-ach-table-body');
			const tfoot = document.getElementById('view-ach-table-foot');
			if(!tbody) return;
			tbody.innerHTML = '';
			if(tfoot) tfoot.innerHTML = '';

			let grandTotalStudents = 0;
			let grandGradeCounts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
			let grandPassedCount = 0;
			let grandGoodCount = 0;
			let grandFailCount = 0;
			let grandTotalScores = 0; 
			let grandScoreList = []; 

			subjects.forEach(sub => {
				// Apply Subject Filter
				if (achFilterSubject !== 'all' && sub.id !== achFilterSubject) return;

				if(!sub || !sub.classes) return;
				sub.classes.forEach(cls => {
					// Apply Room Filter
					if (achFilterRoom !== 'all' && cls !== achFilterRoom) return;

					const clsStudents = getActiveStudentsInClass(cls);
					if (clsStudents.length === 0) return;
					const total = clsStudents.length;
					let counts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
					let passedCount = 0; let goodCount = 0; let failCount = 0; let classScores = []; let classTotalScore = 0;

					clsStudents.forEach(stu => {
						const totalScore = calculateStudentTotalBySub(sub, stu.uid, cls);
						const rem = getStoredScore(sub.id, cls, stu.uid, 'remark', "");
						let grade = rem || computeGradeBySub(sub, totalScore);
						if (grade === '4') grade = '4.0'; if (grade === '3') grade = '3.0'; if (grade === '2') grade = '2.0'; if (grade === '1') grade = '1.0';
						if (counts.hasOwnProperty(grade)) counts[grade]++;
						if (!rem) {
							const gVal = parseFloat(grade); 
							if(!isNaN(gVal)) {
								classScores.push(gVal); 
								classTotalScore += gVal;
								if (gVal >= 1.0) passedCount++; 
								if (gVal >= 3.0) goodCount++; 
								if (gVal === 0) failCount++;
							}
						} else if (rem === 'ผ') { passedCount++; }
					});

					grandTotalStudents += total; grandPassedCount += passedCount; grandGoodCount += goodCount; grandFailCount += failCount;
					Object.keys(counts).forEach(k => grandGradeCounts[k] += counts[k]); grandScoreList = grandScoreList.concat(classScores); grandTotalScores += classTotalScore;
					const classAvg = classScores.length > 0 ? (classTotalScore / classScores.length).toFixed(2) : '0.00';
					const classSD = calculateSD(classScores).toFixed(2);
					const passPct = total > 0 ? ((passedCount / total) * 100).toFixed(1) : '0.0';
					const goodPct = total > 0 ? ((goodCount / total) * 100).toFixed(1) : '0.0';
					const failPct = total > 0 ? ((failCount / total) * 100).toFixed(1) : '0.0';
					const conclusionHtml = parseFloat(classAvg) >= (sub.targetDeptGPA || 2.55) ? '<span class="text-green-600 font-bold">ผ่านเกณฑ์</span>' : '<span class="text-red-600 font-bold">ไม่ผ่านเกณฑ์</span>';

					let rowHtml = `<tr class="border-b border-slate-100"><td>${sub.code}</td><td>${cls}</td><td>${total}</td>`;
					['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => rowHtml += `<td>${counts[g]}</td>`);
					rowHtml += `<td class="bg-gray-50 font-bold">${total}</td>`;
					['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => { const pct = total > 0 ? ((counts[g] / total) * 100).toFixed(1) : '0.0'; rowHtml += `<td>${pct}</td>`; });
					rowHtml += `<td class="font-bold">100.0</td><td>${classAvg}</td><td>${classSD}</td><td>${passPct}</td><td>${goodPct}</td><td>${failPct}</td><td>${conclusionHtml}</td></tr>`;
					tbody.innerHTML += rowHtml;
				});
			});

			if (tfoot) {
				const grandAvg = grandScoreList.length > 0 ? (grandTotalScores / grandScoreList.length).toFixed(2) : '0.00';
				const grandSD = calculateSD(grandScoreList).toFixed(2);
				const grandPassPct = grandTotalStudents > 0 ? ((grandPassedCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
				const grandGoodPct = grandTotalStudents > 0 ? ((grandGoodCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
				const grandFailPct = grandTotalStudents > 0 ? ((grandFailCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
				const grandConclusionHtml = parseFloat(grandAvg) >= (targetSub.targetDeptGPA || 2.55) ? '<span class="text-green-600 font-bold">ผ่านเกณฑ์</span>' : '<span class="text-red-600 font-bold">ไม่ผ่านเกณฑ์</span>';

				let footHtml = `<tr><td colspan="2">สรุปผลรวม</td><td>${grandTotalStudents}</td>`;
				['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => footHtml += `<td>${grandGradeCounts[g]}</td>`);
				footHtml += `<td>${grandTotalStudents}</td>`;
				['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => { const pct = grandTotalStudents > 0 ? ((grandGradeCounts[g] / grandTotalStudents) * 100).toFixed(1) : '0.0'; footHtml += `<td>${pct}</td>`; });
				footHtml += `<td>100.0</td><td>${grandAvg}</td><td>${grandSD}</td><td>${grandPassPct}</td><td>${grandGoodPct}</td><td>${grandFailPct}</td><td>${grandConclusionHtml}</td></tr>`;
				tfoot.innerHTML = footHtml;

				updateAchAnalysis(grandGradeCounts, grandTotalStudents);
			}
			
			generateAchChart(grandGradeCounts, grandTotalStudents, 'view-ach-chart-1'); 
			generateAchChart(grandGradeCounts, grandTotalStudents, 'view-ach-chart-2', false);
		}

		function updateAchAnalysis(counts, total) {
			const analysisEl = document.getElementById('ach-analysis-text');
			if(!analysisEl || total === 0) return;
			
			let maxCount = 0;
			let maxGrade = '';
			['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0'].forEach(g => {
				if((counts[g] || 0) > maxCount) {
					maxCount = counts[g];
					maxGrade = g;
				}
			});

			const maxPct = (maxCount / total) * 100;
			let analysisText = `กราฟนี้แสดงความหนาแน่นของจำนวนนักเรียนแยกตามระดับผลการเรียน โดยพบว่านักเรียนส่วนใหญ่ (${maxPct.toFixed(1)}%) มีผลการเรียนอยู่ในระดับ ${maxGrade} `;
			
			if(maxPct > 50) {
				analysisText += `ซึ่งแสดงถึงการกระจายแบบ "กลุ่ม (Clumped)" อย่างชัดเจนที่ช่วงระดับคะแนนนี้ `;
			} else if(maxPct < 25) {
				analysisText += `ซึ่งมีการกระจายตัวค่อนข้าง "สม่ำเสมอ (Uniform)" ในหลายระดับชั้นคะแนน `;
			} else {
				analysisText += `เป็นการกระจายตัวแบบปกติที่มีกลุ่มเป้าหมายหลักในช่วงคะแนนดังกล่าว `;
			}

			analysisEl.innerText = analysisText;
		}

		function printAchievementSummary() {
			showLoading();
			setTimeout(() => {
				const sub = (achFilterSubject !== 'all') 
					? subjects.find(s => s.id === achFilterSubject) 
					: (subjects[0] || {});
				
				setPrintOrientation('landscape', '0cm 0cm 0cm 0cm'); 
				
				document.getElementById('ach-target-school-pct').innerText = sub.targetSchoolPct || "60";
				document.getElementById('ach-target-dept-pct').innerText = sub.targetDeptPct || "55";
				document.getElementById('ach-target-subject-pct').innerText = sub.targetSubjectPct || "50";
				document.getElementById('ach-target-school-gpa').innerText = (sub.targetSchoolGPA || 3.00).toFixed(2);
				document.getElementById('ach-target-dept-gpa').innerText = (sub.targetDeptGPA || 2.55).toFixed(2);
				document.getElementById('ach-target-subject-gpa').innerText = (sub.targetSubjectGPA || 2.50).toFixed(2);
				document.getElementById('ach-sign-teacher').innerText = sub.teacher || "-";

				const container = document.getElementById('achievement-print-container');
				const headerInfo = container.querySelectorAll('h2, .text-center.font-bold.mb-1, .text-center.font-bold.mb-4');
				headerInfo.forEach(el => el.style.display = 'none');

				const tbody = document.getElementById('ach-table-body'); 
				const tfoot = document.getElementById('ach-table-foot');
				const thead = container.querySelector('table thead');
				
				thead.innerHTML = `
					<tr class="print-table-header-info">
						<th colspan="31" class="border-b border-black p-4 text-black font-['Sarabun']" style="background-color: white !important;">
								<div class="text-center">
								<h2 class="text-xl font-bold mb-1">สรุปผลสัมฤทธิ์ทางการเรียนของผู้เรียน ${(achFilterSubject === 'all') ? "รวมทุกรายวิชา" : "กลุ่มสาระการเรียนรู้ " + (sub.departmentName || "-")}</h2>
								<div class="font-bold mb-1">ครูผู้สอน ${sub.teacher || "-"} ภาคเรียนที่ ${sub.semester || "-"} ปีการศึกษา ${sub.year || "-"}</div>
								<div class="font-bold mb-1">${sub.schoolName || "โรงเรียนปากช่อง"} อำเภอปากช่อง จังหวัดนครราชสีมา</div>
							</div>
						</th>
					</tr>
					<tr>
						<th rowspan="2" style="width: 60px;">รหัสวิชา</th>
						<th rowspan="2">ชั้น</th>
						<th rowspan="2" class="w-10">จำนวน<br>นักเรียน</th>
						<th colspan="10">จำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
						<th rowspan="2" class="w-8">รวม</th>
						<th colspan="10">ร้อยละจำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
						<th rowspan="2" class="w-10">ร้อยละ<br>รวม</th>
						<th rowspan="2" class="w-10">A.V.</th>
						<th rowspan="2" class="w-10">S.D.</th>
						<th rowspan="2" class="w-10">%ผ่านเกณฑ์</th>
						<th rowspan="2" class="w-12">%ระดับ<br>ดีขึ้นไป</th>
						<th rowspan="2" class="w-12">%ไม่ผ่าน<br>เกณฑ์</th>
						<th rowspan="2" class="w-16">สรุป<br>ผลสัมฤทธิ์</th>
					</tr>
					<tr>
						<th class="w-6">4.0</th><th class="w-6">3.5</th><th class="w-6">3.0</th><th class="w-6">2.5</th><th class="w-6">2.0</th><th class="w-6">1.5</th><th class="w-6">1.0</th><th class="w-6">0</th><th class="w-6">ร</th><th class="w-6">มส</th>
						<th class="w-8">4.0</th><th class="w-8">3.5</th><th class="w-8">3.0</th><th class="w-8">2.5</th><th class="w-8">2.0</th><th class="w-8">1.5</th><th class="w-8">1.0</th><th class="w-8">0</th><th class="w-8">ร</th><th class="w-8">มส</th>
					</tr>
				`;

				tbody.innerHTML = ''; tfoot.innerHTML = '';
				let grandTotalStudents = 0; let grandGradeCounts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
				let grandPassedCount = 0; let grandGoodCount = 0; let grandFailCount = 0; let grandTotalScores = 0; let grandScoreList = []; 

				subjects.forEach(sItem => {
					if (achFilterSubject !== 'all' && sItem.id !== achFilterSubject) return;

					sItem.classes.forEach(cls => {
						if (achFilterRoom !== 'all' && cls !== achFilterRoom) return;

						const clsStudents = getActiveStudentsInClass(cls);
						if (clsStudents.length === 0) return;
						const total = clsStudents.length;
						let counts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
						let passedCount = 0; let goodCount = 0; let failCount = 0; let classScores = []; let classTotalScore = 0;
						clsStudents.forEach(stu => {
							const totalScore = calculateStudentTotalBySub(sItem, stu.uid, cls);
							const rem = getStoredScore(sItem.id, cls, stu.uid, 'remark', "");
							let grade = rem || computeGradeBySub(sItem, totalScore);
							if (grade === '4') grade = '4.0'; if (grade === '3') grade = '3.0'; if (grade === '2') grade = '2.0'; if (grade === '1') grade = '1.0';
							if (counts.hasOwnProperty(grade)) counts[grade]++;
							if (!rem) { const gVal = parseFloat(grade); if(!isNaN(gVal)) { classScores.push(gVal); classTotalScore += gVal; if (gVal >= 1.0) passedCount++; if (gVal >= 3.0) goodCount++; if (gVal === 0) failCount++; } } else if (rem === 'ผ') { passedCount++; }
						});
						grandTotalStudents += total; grandPassedCount += passedCount; grandGoodCount += goodCount; grandFailCount += failCount;
						Object.keys(counts).forEach(k => grandGradeCounts[k] += counts[k]); grandScoreList = grandScoreList.concat(classScores); grandTotalScores += classTotalScore;
						const classAvg = classScores.length > 0 ? (classTotalScore / classScores.length).toFixed(2) : '0.00';
						const classSD = calculateSD(classScores).toFixed(2);
						const passPct = total > 0 ? ((passedCount / total) * 100).toFixed(1) : '0.0';
						const goodPct = total > 0 ? ((goodCount / total) * 100).toFixed(1) : '0.0';
						const failPct = total > 0 ? ((failCount / total) * 100).toFixed(1) : '0.0';
						const conclusionHtml = parseFloat(classAvg) >= (sItem.targetDeptGPA || 2.55) ? '<span class="text-green-600 font-bold">ผ่านเกณฑ์</span>' : '<span class="text-red-600 font-bold">ไม่ผ่านเกณฑ์</span>';
						let rowHtml = `<tr><td>${sItem.code}</td><td>${cls}</td><td>${total}</td>`;
						['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => rowHtml += `<td>${counts[g]}</td>`);
						rowHtml += `<td class="bg-gray-50 font-bold">${total}</td>`;
						['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => { const pct = total > 0 ? ((counts[g] / total) * 100).toFixed(1) : '0.0'; rowHtml += `<td>${pct}</td>`; });
						rowHtml += `<td class="font-bold">100.0</td><td>${classAvg}</td><td>${classSD}</td><td>${passPct}</td><td>${goodPct}</td><td>${failPct}</td><td>${conclusionHtml}</td></tr>`;
						tbody.innerHTML += rowHtml;
					});
				});
				const grandAvg = grandScoreList.length > 0 ? (grandTotalScores / grandScoreList.length).toFixed(2) : '0.00';
				const grandSD = calculateSD(grandScoreList).toFixed(2);
				const grandPassPct = grandTotalStudents > 0 ? ((grandPassedCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
				const grandGoodPct = grandTotalStudents > 0 ? ((grandGoodCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
				const grandFailPct = grandTotalStudents > 0 ? ((grandFailCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
				const grandConclusionHtml = parseFloat(grandAvg) >= (sub.targetDeptGPA || 2.55) ? '<span class="text-green-600 font-bold">ผ่านเกณฑ์</span>' : '<span class="text-red-600 font-bold">ไม่ผ่านเกณฑ์</span>';
				let footHtml = `<tr><td colspan="2">สรุปผลรวม</td><td>${grandTotalStudents}</td>`;
				['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => footHtml += `<td>${grandGradeCounts[g]}</td>`);
				footHtml += `<td>${grandTotalStudents}</td>`;
				['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => { const pct = grandTotalStudents > 0 ? ((grandGradeCounts[g] / grandTotalStudents) * 100).toFixed(1) : '0.0'; footHtml += `<td>${pct}</td>`; });
				footHtml += `<td>100.0</td><td>${grandAvg}</td><td>${grandSD}</td><td>${grandPassPct}</td><td>${grandGoodPct}</td><td>${grandFailPct}</td><td>${grandConclusionHtml}</td></tr>`;
				tfoot.innerHTML = footHtml;
				
				generateAchChart(grandGradeCounts, grandTotalStudents, 'ach-chart-1'); 
				generateAchChart(grandGradeCounts, grandTotalStudents, 'ach-chart-2', false); 
				
				document.body.classList.add('print-achievement-mode');
				hideLoading();
				window.print();
				
				setTimeout(() => { 
					document.body.classList.remove('print-achievement-mode'); 
					setPrintOrientation('portrait'); 
				}, 500);
			}, 500);
		}

		function calculateStudentTotalBySub(sub, uid, cls) {
			let sum = 0; const s = scoreData[sub.id]?.[cls]?.[uid] || {};
			sub.units.forEach(u => sum += Math.max(s[`u${u.id}_r`] || 0, s[`u${u.id}_e`] || 0));
			sum += Math.max(s['mid_r'] || 0, s['mid_e'] || 0); sum += Math.max(s['fin_r'] || 0, s['fin_e'] || 0);
			return parseFloat(sum.toFixed(2));
		}

		function computeGradeBySub(sub, s) {
			let m = 0; sub.units.forEach(u => m += u.max); m += sub.midMax + sub.finMax;
			if (m === 0) return '0'; const pct = (s/m)*100;
			if (pct >= 80) return '4'; if (pct >= 75) return '3.5'; if (pct >= 70) return '3'; if (pct >= 65) return '2.5'; if (pct >= 60) return '2'; if (pct >= 55) return '1.5'; if (pct >= 50) return '1'; return '0';
		}

		function calculateSD(data) {
			const n = data.length; if (n === 0) return 0;
			const mean = data.reduce((a, b) => a + b, 0) / n;
			const variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
			return Math.sqrt(variance);
		}

		function generateAchChart(counts, total, elementId, isPct = true) {
			const container = document.getElementById(elementId); 
			if(!container) return;
			container.innerHTML = '';
			const labels = ['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร'];
			let maxVal = 0;
			labels.forEach(l => {
				let val = counts[l] || 0; if (isPct && total > 0) val = (val / total) * 100;
				if (val > maxVal) maxVal = val;
			});
			if (maxVal === 0) maxVal = 1;
			labels.forEach(l => {
				let val = counts[l] || 0; let displayVal = val;
				if (isPct) { val = total > 0 ? (val / total) * 100 : 0; displayVal = val.toFixed(1); }
				const heightPct = (val / maxVal) * 80;
				const barWrap = document.createElement('div');
				barWrap.className = 'ach-bar'; barWrap.style.height = Math.max(heightPct, 1) + '%'; 
				barWrap.style.backgroundColor = getGradeColorCode(l);
				const valLabel = document.createElement('div'); valLabel.className = 'ach-bar-val'; valLabel.innerText = displayVal;
				const txtLabel = document.createElement('div'); txtLabel.className = 'ach-bar-label'; txtLabel.innerText = l;
				barWrap.appendChild(valLabel); barWrap.appendChild(txtLabel); container.appendChild(barWrap);
			});
		}

		function getGradeColorCode(g) {
			if(parseFloat(g) >= 3) return '#15803d'; if(parseFloat(g) >= 2) return '#ca8a04';
			if(parseFloat(g) >= 1) return '#db2777'; return '#dc2626';
		}

		function changePageLength(val) { rowsPerPage = parseInt(val); currentGradingPage = 1; currentStudentPage = 1; const activeView = document.querySelector('.view-section.view-active').id; if (activeView === 'grading-view') initTable(); else if (activeView === 'students-view') initStudentTable(); }
		
		function updateStudentFilters() { 
					const roomFilter = document.getElementById('filter-student-room'); 
					const rooms = [...new Set(students.map(s => s.room))].sort((a, b) => 
						a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
					); 
					
					if(roomFilter) roomFilter.innerHTML = '<option value="">ทุกห้อง</option>' + rooms.map(r => `<option value="${r}">${r}</option>`).join(''); 
		}

		function initStudentTable() {
			const listBody = document.getElementById('student-list-body'); const search = document.getElementById('search-student').value.toLowerCase(); const statusFilter = document.getElementById('filter-student-status').value; const roomFilter = document.getElementById('filter-student-room').value;
			let filtered = students.filter(s => (s.id.includes(search) || s.name.toLowerCase().includes(search) || (s.nationalId && s.nationalId.includes(search))) && (statusFilter === "" || s.status === statusFilter) && (roomFilter === "" || s.room === roomFilter));
			const total = filtered.length; if (currentStudentPage > Math.ceil(total / rowsPerPage)) currentStudentPage = Math.ceil(total / rowsPerPage) || 1;
			const start = (currentStudentPage - 1) * rowsPerPage;
			if(listBody) listBody.innerHTML = filtered.slice(start, start + rowsPerPage).map((s, i) => `<tr class="border-b odd:bg-white even:bg-[#FFFF99] hover:bg-blue-50 transition border-slate-200"><td class="px-4 py-2 text-center border-r"><div onclick="viewStudentPhoto('${s.uid}')" class="student-photo-container w-10 h-10 bg-slate-200 rounded-full mx-auto overflow-hidden border cursor-pointer font-['Sarabun']">${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user fa-lg mt-3 text-slate-400"></i>'}</div></td><td class="px-4 py-2 text-center font-bold text-slate-600 border-r font-['Sarabun']">${s.id}</td><td class="px-4 py-2 text-center text-slate-500 font-medium border-r font-['Sarabun']">${s.nationalId || '-'}</td><td class="px-4 py-2 text-slate-700 font-medium border-r font-['Sarabun']">${s.name}</td><td class="px-4 py-2 text-center text-slate-500 font-bold border-r font-['Sarabun']">${s.gender || '-'}</td><td class="px-4 py-2 text-center text-slate-500 font-bold border-r font-['Sarabun']">${s.room}</td><td class="px-4 py-2 text-center text-slate-500 border-r font-['Sarabun']">${s.number}</td><td class="px-4 py-2 text-center text-slate-400 border-r font-['Sarabun']">${s.admissionYear}</td><td class="px-4 py-2 text-center border-r font-['Sarabun'] font-bold"><span class="px-2 py-0.5 rounded-full text-[10px] ${getStatusStyle(s.status)} font-['Sarabun']">${s.status}</span></td><td class="px-4 py-2 text-center flex justify-center gap-2 no-print font-['Sarabun']"><button onclick="editStudentInfo('${s.uid}')" class="text-[#0d6efd] font-bold p-1.5 rounded transition cursor-pointer hover:bg-blue-50"><i class="fa-solid fa-pen-to-square"></i></button><button onclick="deleteStudentInfo('${s.uid}')" class="text-[#dc3545] font-bold p-1.5 rounded transition cursor-pointer hover:bg-red-50"><i class="fa-solid fa-trash-can"></i></button></td></tr>`).join('');
			renderGeneralPagination('student-pagination', total, currentStudentPage, p => { currentStudentPage = p; initStudentTable(); });
		}

		function triggerImageUpload() { document.getElementById('modal-stu-image-input').click(); }
		function handleImagePreview(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { const preview = document.getElementById('modal-stu-img-preview'); const placeholder = document.getElementById('image-upload-placeholder'); preview.src = e.target.result; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); }; reader.readAsDataURL(input.files[0]); } }
		function editStudentInfo(uid) { openStudentModal(uid); }
		
		function openStudentModal(uid = null) {
			const modal = document.getElementById('student-modal'); const preview = document.getElementById('modal-stu-img-preview'); const placeholder = document.getElementById('image-upload-placeholder'); modal.classList.remove('hidden');
			if (uid) { 
				const s = students.find(x => x.uid === uid); 
				document.getElementById('modal-title').innerText = 'แก้ไขข้อมูลนักเรียน'; document.getElementById('modal-student-uid').value = uid; document.getElementById('modal-stu-id').value = s.id; document.getElementById('modal-stu-national-id').value = s.nationalId || ''; document.getElementById('modal-stu-name').value = s.name; document.getElementById('modal-stu-room').value = s.room; document.getElementById('modal-stu-number').value = s.number; document.getElementById('modal-stu-gender').value = s.gender || 'ชาย'; document.getElementById('modal-stu-year').value = s.admissionYear; document.getElementById('modal-stu-status').value = s.status; 
				if (s.image) { preview.src = s.image; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); } else { preview.classList.add('hidden'); placeholder.classList.remove('hidden'); } 
			} else { 
				document.getElementById('modal-title').innerText = 'เพิ่มข้อมูลนักเรียนใหม่'; document.getElementById('modal-student-uid').value = ''; document.getElementById('modal-stu-id').value = ''; document.getElementById('modal-stu-national-id').value = ''; document.getElementById('modal-stu-name').value = ''; document.getElementById('modal-stu-room').value = activeClassName || 'ม.4/1'; document.getElementById('modal-stu-number').value = students.length + 1; document.getElementById('modal-stu-gender').value = 'ชาย'; document.getElementById('modal-stu-year').value = 2568; document.getElementById('modal-stu-status').value = 'ปกติ'; preview.classList.add('hidden'); placeholder.classList.remove('hidden'); 
			}
		}
		function closeStudentModal() { document.getElementById('student-modal').classList.add('hidden'); }
		
		// ---------- API INTERFACE WITH WEB APP URL ----------
		const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxr0syKODlRWHkaK7DXeaGTahV4NdY4XjsrRR2qYTY0mJcP1kSoKOJrk0VuXR07TVU5/exec";

		async function callBackend(action, data) {
			try {
				if (action === 'getBackendData') {
					const response = await fetch(WEBAPP_URL + '?action=getBackendData');
					if (!response.ok) throw new Error('Network response was not ok');
					const json = await response.json();
					return json;
				}
				
				const params = new URLSearchParams();
				params.append('payload', JSON.stringify({ action: action, data: data }));
				
				const response = await fetch(WEBAPP_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
					body: params
				});
				
				if (!response.ok) throw new Error('Network response was not ok');
				const json = await response.json();
				return json;
			} catch (error) {
				console.error('API Error:', error);
				throw error;
			}
		}

		function saveStudent() {
			showLoading();
			const uid = document.getElementById('modal-student-uid').value; const stuId = document.getElementById('modal-stu-id').value; const name = document.getElementById('modal-stu-name').value; if (!stuId || !name) { hideLoading(); Swal.fire('ข้อผิดพลาด', 'กรุณากรอกข้อมูลให้ครบ', 'error'); return; }
			const img = !document.getElementById('modal-stu-img-preview').classList.contains('hidden') ? document.getElementById('modal-stu-img-preview').src : null;
			const data = { uid: uid || generateUID(), id: stuId, nationalId: document.getElementById('modal-stu-national-id').value, name, room: document.getElementById('modal-stu-room').value, number: parseInt(document.getElementById('modal-stu-number').value) || 0, gender: document.getElementById('modal-stu-gender').value, admissionYear: parseInt(document.getElementById('modal-stu-year').value) || 2568, status: document.getElementById('modal-stu-status').value, image: img };
			
			callBackend('saveStudent', data)
			.then(function(res) {
				if(res.result === 'error') throw new Error(res.message);
				if (uid) { const idx = students.findIndex(x => x.uid === uid); students[idx] = data; showNotification('แก้ไขสำเร็จ'); } 
				else { students.push(data); showNotification('เพิ่มสำเร็จ'); } 
				closeStudentModal(); 
				initStudentTable();
				hideLoading();
			})
			.catch(function(e) {
				hideLoading();
				Swal.fire('Error', e.message, 'error');
			});
		}

		function deleteStudentInfo(uid) { 
			Swal.fire({ title: 'ยืนยันการลบ?', icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ', confirmButtonColor: '#dc3545' }).then(r => { 
				if (r.isConfirmed) { 
					showLoading();
					callBackend('deleteStudent', uid)
					.then(function(res) {
						if(res.result === 'error') throw new Error(res.message);
						students = students.filter(s => s.uid !== uid); 
						initStudentTable(); 
						showNotification('ลบเรียบร้อย', 'info'); 
						hideLoading();
					})
					.catch(function(e){
							hideLoading();
							Swal.fire('Error', e.message, 'error');
					});
				} 
			}); 
		}

		function renderSettingsSubjects() {
			const container = document.getElementById('subject-list-container');
			if (!container) return;
			container.innerHTML = subjects.map(s => `<div onclick="editSubject('${s.id}')" class="p-4 border-2 rounded-xl cursor-pointer transition ${editingSubjectId === s.id ? 'bg-blue-50 border-[#0d6efd]' : 'bg-slate-50 border-transparent hover:border-slate-200'} font-['Sarabun']"><div class="font-bold text-sm text-slate-800 font-bold font-['Sarabun']">${s.code}</div><div class="text-[11px] font-medium text-slate-600 truncate">${s.name}</div></div>`).join('');
		}

		function handleClassesChange() { updateCurrentSubjectData(); const sub = subjects.find(s => s.id === editingSubjectId); if (sub) renderAdvisorInputs(sub); }
		function renderAdvisorInputs(sub) {
			const container = document.getElementById('dynamic-advisors-container'); if (!container) return;
			if (!sub.classes || sub.classes.length === 0) { container.innerHTML = '<p class="text-slate-400 text-xs italic font-[\'Sarabun\']">กรุณาระบุ \'ห้องที่สอน\'</p>'; return; }
			if (!sub.advisors) sub.advisors = {};
			container.innerHTML = sub.classes.map(cls => `<div class="bg-white p-2 rounded-lg border border-blue-100 shadow-sm font-['Sarabun']"><label class="block text-[12px] font-bold text-[#0d6efd] uppercase mb-1">ครูที่ปรึกษา (${cls})</label><input type="text" value="${sub.advisors[cls] || ''}" oninput="updateAdvisorData('${cls}', this.value)" class="w-full border p-1.5 rounded focus:ring-1 focus:ring-[#0d6efd] outline-none text-xs bg-slate-50/50 font-['Sarabun']" placeholder="ชื่อครูที่ปรึกษา"></div>`).join('');
		}
		function updateAdvisorData(cls, name) { const sub = subjects.find(s => s.id === editingSubjectId); if (sub) { if (!sub.advisors) sub.advisors = {}; sub.advisors[cls] = name; } }

		function editSubject(id) {
			editingSubjectId = id; const sub = subjects.find(s => s.id === id); const editor = document.getElementById('subject-editor'); editor.classList.remove('opacity-50', 'pointer-events-none');
			document.getElementById('edit-school-name').value = sub.schoolName || ""; document.getElementById('edit-affiliation').value = sub.affiliation || ""; document.getElementById('edit-director').value = sub.director || ""; document.getElementById('edit-deputy-director').value = sub.deputyDirector || ""; document.getElementById('edit-head-evaluation').value = sub.headEvaluation || ""; document.getElementById('edit-head-department').value = sub.headDepartment || ""; document.getElementById('edit-teacher').value = sub.teacher || ""; document.getElementById('edit-head-dept-name').value = sub.departmentName || "";
			document.getElementById('edit-subject-name').value = sub.name; document.getElementById('edit-course-code').value = sub.code; document.getElementById('edit-subject-type').value = sub.type || "พื้นฐาน"; document.getElementById('edit-credits').value = sub.credits; document.getElementById('edit-hours').value = sub.hours || 0; document.getElementById('edit-classes').value = sub.classes.join(', '); document.getElementById('edit-semester').value = sub.semester || 1; document.getElementById('edit-academic-year').value = sub.year;
			document.getElementById('edit-target-school-pct').value = sub.targetSchoolPct || 60; document.getElementById('edit-target-dept-pct').value = sub.targetDeptPct || 55; document.getElementById('edit-target-subject-pct').value = sub.targetSubjectPct || 50; document.getElementById('edit-target-school-gpa').value = sub.targetSchoolGPA || 3.00; document.getElementById('edit-target-dept-gpa').value = sub.targetDeptGPA || 2.55; document.getElementById('edit-target-subject-gpa').value = sub.targetSubjectGPA || 2.50;
			document.getElementById('edit-mid-max').value = sub.midMax; document.getElementById('edit-mid-pass-pct').value = sub.midPassPct; document.getElementById('edit-fin-max').value = sub.finMax; document.getElementById('edit-fin-pass-pct').value = sub.finPassPct;
			renderAdvisorInputs(sub); renderUnitEditorRows(sub); renderSettingsSubjects(); switchSettingsTab('tab-school');
		}

		function renderUnitEditorRows(sub) { 
			const container = document.getElementById('units-editor-list'); if (!container) return;
			container.innerHTML = sub.units.map((u, i) => `<div class="flex items-center gap-4 p-3 bg-slate-50 rounded-lg border border-slate-100 hover:bg-blue-50/30 transition shadow-sm font-['Sarabun']"><span class="text-[12px] font-bold text-slate-400 w-6 font-bold">#${i+1}</span><div class="flex-grow"><label class="text-[12px] uppercase block mb-0.5">เต็ม:</label><input type="number" value="${u.max}" onchange="updateUnitValue(${i}, 'max', this.value)" class="w-full border rounded p-1 text-sm font-bold text-[#0d6efd] font-['Sarabun']"></div><div class="flex-grow"><label class="text-[12px] uppercase block mb-0.5">ผ่าน (%):</label><input type="number" value="${u.passPct}" onchange="updateUnitValue(${i}, 'passPct', this.value)" class="w-full border rounded p-1 text-sm bg-white font-['Sarabun']"></div><button onclick="removeUnitFromSubject(${i})" class="text-rose-400 hover:text-rose-600 self-end mb-1"><i class="fa-solid fa-trash-can"></i></button></div>`).join(''); 
		}

		function updateUnitValue(i, f, v) { const sub = subjects.find(s => s.id === editingSubjectId); if (sub) sub.units[i][f] = parseFloat(v) || 0; }
		function addNewUnitToCurrent() { const sub = subjects.find(s => s.id === editingSubjectId); if (sub) { const nId = sub.units.length > 0 ? Math.max(...sub.units.map(u => u.id)) + 1 : 1; sub.units.push({ id: nId, max: 10, passPct: 50 }); renderUnitEditorRows(sub); } }
		function removeUnitFromSubject(i) { const sub = subjects.find(s => s.id === editingSubjectId); if (sub && sub.units.length > 1) { sub.units.splice(i, 1); renderUnitEditorRows(sub); } }
		
		function updateCurrentSubjectData() {
			if (!editingSubjectId) return; const sub = subjects.find(s => s.id === editingSubjectId);
			sub.schoolName = document.getElementById('edit-school-name').value; sub.affiliation = document.getElementById('edit-affiliation').value; sub.director = document.getElementById('edit-director').value; sub.deputyDirector = document.getElementById('edit-deputy-director').value; sub.headEvaluation = document.getElementById('edit-head-evaluation').value; sub.headDepartment = document.getElementById('edit-head-department').value; sub.teacher = document.getElementById('edit-teacher').value; sub.departmentName = document.getElementById('edit-head-dept-name').value;
			sub.name = document.getElementById('edit-subject-name').value; sub.code = document.getElementById('edit-course-code').value; sub.type = document.getElementById('edit-subject-type').value; sub.credits = parseFloat(document.getElementById('edit-credits').value) || 0; sub.hours = parseFloat(document.getElementById('edit-hours').value) || 0; sub.semester = parseInt(document.getElementById('edit-semester').value) || 1; sub.year = parseInt(document.getElementById('edit-academic-year').value) || 2568; sub.classes = document.getElementById('edit-classes').value.split(',').map(c => c.trim()).filter(c => c !== "");
			sub.targetSchoolPct = parseFloat(document.getElementById('edit-target-school-pct').value) || 0; sub.targetDeptPct = parseFloat(document.getElementById('edit-target-dept-pct').value) || 0; sub.targetSubjectPct = parseFloat(document.getElementById('edit-target-subject-pct').value) || 0; sub.targetSchoolGPA = parseFloat(document.getElementById('edit-target-school-gpa').value) || 0; sub.targetDeptGPA = parseFloat(document.getElementById('edit-target-dept-gpa').value) || 0; sub.targetSubjectGPA = parseFloat(document.getElementById('edit-target-subject-gpa').value) || 0;
			sub.midMax = parseFloat(document.getElementById('edit-mid-max').value) || 0; sub.midPassPct = parseFloat(document.getElementById('edit-mid-pass-pct').value) || 0; sub.finMax = parseFloat(document.getElementById('edit-fin-max').value) || 0; sub.finPassPct = parseFloat(document.getElementById('edit-fin-pass-pct').value) || 0;
		}

		function addNewSubject() { 
			const id = "s" + Date.now(); 
			const template = subjects[0] || {};
			const newSub = {
				...template, 
				id, 
				name: "วิชาใหม่", 
				code: "รหัสวิชา",
				classes: [],
				advisors: {},
				units: [{ id: 1, max: 10, passPct: 50 }] 
			};
			subjects.push(newSub); 
			editSubject(id); 
			switchSettingsTab('tab-subject'); 
			showNotification('เพิ่มรายวิชาแล้ว กรุณากำหนดโครงสร้างคะแนน'); 
		}
		
		function deleteCurrentSubject() { if (!editingSubjectId) return; Swal.fire({ title: 'ลบรายวิชา?', icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ', confirmButtonColor: '#dc3545' }).then(r => { if (r.isConfirmed) { subjects = subjects.filter(s => s.id !== editingSubjectId); editingSubjectId = null; document.getElementById('subject-editor').classList.add('opacity-50', 'pointer-events-none'); renderSettingsSubjects(); showNotification('ลบเรียบร้อย', 'info'); applySettings(); } }); }
		
		function applySettings() { 
			showLoading();
			callBackend('saveSubjects', subjects)
			.then(function(res) {
				if(res.result === 'error') throw new Error(res.message);
				showNotification('บันทึกสำเร็จ'); 
				switchView('grading');
				hideLoading();
			})
			.catch(function(e) {
				hideLoading();
				Swal.fire('Error', e.message, 'error');
			});
		}

		function setPrintOrientation(orientation, pageMargin = '1cm 1cm 1cm 1cm') {
			const styleTag = document.getElementById('print-styles');
			let pageSize = `A4 ${orientation}`;
			const newStyle = styleTag.innerHTML.replace(/@page\s*{[^}]*}/, 
				`@page { size: ${pageSize}; margin: ${pageMargin} !important; }`);
			styleTag.innerHTML = newStyle;
			document.body.classList.remove('print-portrait', 'print-landscape');
			document.body.classList.add(`print-${orientation}`);
		}

		function printReport(mode = 'all') {
			const orientation = 'landscape';
			setPrintOrientation(orientation, '1.25cm 0cm 1cm 0cm');
			document.body.classList.remove('print-cover-mode');
			document.body.classList.remove('print-achievement-mode');
			currentPrintMode = mode;
			initTable();
			setTimeout(() => {
				window.print();
				setTimeout(() => {
					currentPrintMode = 'all';
					initTable();
				}, 500);
			}, 200);
		}

		function printCover() {
			showLoading();
			setTimeout(() => {
				const sub = subjects.find(s => s.id === activeSubjectId); 
				if (!sub) { hideLoading(); return; }
				const orientation = 'portrait'; 
				setPrintOrientation(orientation, '0cm 0cm 0cm 1cm');
				document.getElementById('cover-school-name').innerText = sub.schoolName || "โรงเรียนปากช่อง";
				document.getElementById('cover-affiliation').innerText = sub.affiliation || "-";
				document.getElementById('cover-grade-level').innerText = activeClassName.split('/')[0];
				document.getElementById('cover-room').innerText = activeClassName.split('/')[1] || activeClassName;
				document.getElementById('cover-year').innerText = sub.year;
				document.getElementById('cover-semester').innerText = sub.semester;
				document.getElementById('cover-subject-name').innerText = sub.name;
				document.getElementById('cover-course-code').innerText = sub.code;
				document.getElementById('cover-subject-type').innerText = sub.type || "พื้นฐาน";
				document.getElementById('cover-hours').innerText = sub.hours || "0";
				document.getElementById('cover-credits').innerText = sub.credits || "0";
				document.getElementById('cover-teacher-name').innerText = sub.teacher;
				document.getElementById('advisor-name').innerText = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
				document.getElementById('cover-head-dept-name').innerText = sub.departmentName || "-";
				const classStudents = getActiveStudentsInClass(activeClassName);
				const totalStudents = classStudents.length; 
				document.getElementById('cover-total-stu').innerText = totalStudents;
				const stats = ['4', '3.5', '3', '2.5', '2', '1.5', '1', '0', 'ร', 'มส', 'ผ', 'มผ'];
				let totalGradePoints = 0; let totalEvaluated = 0;
				stats.forEach(s => {
					const countText = document.getElementById(`stat-${s}`).innerText;
					const count = countText === '-' ? 0 : parseInt(countText);
					const targetId = (['ร', 'มส', 'ผ', 'มผ'].includes(s)) ? `stat-cover-${s}` : `cover-stat-${s}`;
					const el = document.getElementById(targetId); if (el) el.innerText = count === 0 ? '-' : count;
					const pct = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(2) : "0.00";
					const pctEl = document.getElementById(`cover-pct-${s}`); if (pctEl) pctEl.innerText = pct;
					if (!isNaN(parseFloat(s))) { totalGradePoints += (count * parseFloat(s)); totalEvaluated += count; }
					if (!['ร', 'มส', 'ผ', 'มผ'].includes(s)) {
						const barEl = document.getElementById(`chart-bar-${s}`); const valEl = document.getElementById(`chart-val-${s}`);
						if (barEl && valEl) { barEl.style.height = pct + '%'; valEl.innerText = pct > 0 ? Math.round(pct) + '%' : ''; }
					}
				});
				document.getElementById('cover-avg-grade').innerText = totalEvaluated > 0 ? (totalGradePoints / totalEvaluated).toFixed(2) : "0.00";
				const populateMockTable = (prefix, total) => {
					if(total === 0) return; const c3 = Math.floor(total * 0.7); const c2 = Math.floor(total * 0.2); const c1 = total - c3 - c2; const c0 = 0;
					const setData = (lvl, val) => { document.getElementById(`${prefix}-${lvl}`).innerText = val || '-'; document.getElementById(`${prefix}-pct-${lvl}`).innerText = val > 0 ? ((val/total)*100).toFixed(2) : '0.00'; };
					setData(3, c3); setData(2, c2); setData(1, c1); setData(0, c0); document.getElementById(`${prefix}-total`).innerText = total;
				};
				populateMockTable('read', totalStudents); populateMockTable('attr', totalStudents); populateMockTable('comp', totalStudents);
				document.getElementById('sig-cover-teacher').innerText = sub.teacher; 
				document.getElementById('sig-cover-head-dept').innerText = sub.headDepartment || "-"; 
				document.getElementById('sig-cover-head-eval').innerText = sub.headEvaluation || "-"; 
				document.getElementById('sig-cover-deputy').innerText = sub.deputyDirector || "-"; 
				document.getElementById('sig-cover-director').innerText = sub.director || "-";
				document.body.classList.add('print-cover-mode'); 
				hideLoading(); 
				window.print();
				setTimeout(() => { 
					document.body.classList.remove('print-cover-mode'); 
					setPrintOrientation('portrait'); 
				}, 500);
			}, 500);
		}

		function updateGradingFilters() {
			const subSelect = document.getElementById('select-subject'); const classSelect = document.getElementById('select-class');
			if(subSelect) subSelect.innerHTML = subjects.map(s => `<option value="${s.id}" ${s.id === activeSubjectId ? 'selected' : ''}>${s.code} ${s.name}</option>`).join('');
			let sub = subjects.find(s => s.id === activeSubjectId);
			if (!sub && subjects.length > 0) {
					activeSubjectId = subjects[0].id;
					sub = subjects[0];
			}
			if (sub) { 
				if (!sub.classes.includes(activeClassName)) {
					activeClassName = sub.classes[0]; 
				}
				if(classSelect) {
					classSelect.innerHTML = sub.classes.map(c => `<option value="${c}" ${c === activeClassName ? 'selected' : ''}>${c}</option>`).join(''); 
					classSelect.value = activeClassName;
				}
			}
		}
		
		function updateDisplayHeader() { 
			const sub = subjects.find(s => s.id === activeSubjectId); 
			if (sub) { 
				document.getElementById('display-teacher-name').innerText = sub.teacher; document.getElementById('display-course-code').innerText = sub.code;
				document.getElementById('display-semester').innerText = sub.semester || "-"; document.getElementById('display-academic-year').innerText = sub.year || "-";
				document.getElementById('header-subject-name').innerText = `บันทึกผลการเรียน: ${sub.name}`; document.getElementById('sig-teacher-name').innerText = sub.teacher;
				const now = new Date(); const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
				const fullThaiDate = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;
				document.getElementById('sig-date').innerText = fullThaiDate; document.getElementById('print-date-now').innerText = fullThaiDate;
				document.getElementById('print-school-name').innerText = sub.schoolName || "โรงเรียนปากช่อง";
				document.getElementById('print-subject-code').innerText = sub.code; document.getElementById('print-subject-name').innerText = sub.name;
				document.getElementById('print-subject-credits').innerText = sub.credits; document.getElementById('print-year').innerText = sub.year;
				document.getElementById('print-semester').innerText = sub.semester || 1; document.getElementById('print-grade-level').innerText = activeClassName.split('/')[0];
				document.getElementById('print-room-group').innerText = activeClassName.split('/')[1] || activeClassName;
				document.getElementById('print-teacher-name').innerText = sub.teacher;
				const currentAdvisor = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
				document.getElementById('print-advisor-name').innerText = currentAdvisor; document.getElementById('display-advisor-name').innerText = currentAdvisor;
			} 
		}

		function changeActiveSubject(id) { activeSubjectId = id; currentGradingPage = 1; updateGradingFilters(); updateDisplayHeader(); initTable(); }
		function changeActiveClass(cls) { activeClassName = cls; currentGradingPage = 1; initTable(); updateDisplayHeader(); }
		
		function initTable() { 
			const sub = subjects.find(s => s.id === activeSubjectId); 
			if (!sub) return; 
			const classStudents = getActiveStudentsInClass(activeClassName);
			renderHeader(sub); 
			renderRows(sub, classStudents); 
			renderGeneralPagination('grading-pagination', classStudents.length, currentGradingPage, p => { currentGradingPage = p; initTable(); }); 
			updateAchievementSummary(sub, classStudents); 
		}

		function renderHeader(sub) {
			const header = document.getElementById('tableHeader');
			let unitsHtml = '';
			let totalMax = 0;
			const totalCols = 10 + sub.units.length;
			const isMax = currentPrintMode === 'max';
			sub.units.forEach(u => { 
				totalMax += u.max; 
				unitsHtml += `<th class="px-1 py-3 text-center bg-blue-50 border-r min-w-[75px] font-bold">
					<div class="mb-1 text-blue-800 text-xs">หน่วย ${u.id}</div>
					<div class="bg-white rounded-[30px] px-2 py-0.5 shadow-sm inline-block min-w-[50px] text-[11px] text-gray-800 font-bold mb-1 border border-blue-100">${u.max} | ${(u.max * u.passPct) / 100}</div>
					${isMax ? '<div class="text-[10px] pt-1.5 font-bold text-blue-600">คะแนน</div>' : 
					`<div class="flex justify-center gap-1 text-[10px] border-t pt-1.5 font-bold">
						<span class="w-6 h-6 flex items-center justify-center bg-white rounded-full shadow-sm border border-slate-200 text-slate-700">จ</span>
						<span class="w-6 h-6 flex items-center justify-center bg-red-500 text-white rounded-full shadow-sm">ก</span>
					</div>`}
				</th>`; 
			});
			totalMax += sub.midMax + sub.finMax;
			const midHeader = isMax ? '<div class="text-[10px] pt-1.5 font-bold text-blue-600">คะแนน</div>' : '<div class="flex justify-center gap-1 text-[10px] border-t pt-1.5 font-bold"><span class="w-6 h-6 flex items-center justify-center bg-white rounded-full shadow-sm border border-slate-200 text-slate-700">จ</span><span class="w-6 h-6 flex items-center justify-center bg-red-500 text-white rounded-full shadow-sm">ก</span></div>';
			const finHeader = isMax ? '<div class="text-[10px] pt-1.5 font-bold text-blue-600">คะแนน</div>' : '<div class="flex justify-center gap-1 text-[10px] border-t pt-1.5 font-bold"><span class="w-6 h-6 flex items-center justify-center bg-white rounded-full shadow-sm border border-slate-200 text-slate-700">จ</span><span class="w-6 h-6 flex items-center justify-center bg-red-500 text-white rounded-full shadow-sm">ก</span></div>';
			const currentAdvisor = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
			const now = new Date();
			const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
			const printDate = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;

			header.innerHTML = `
				<tr class="print-table-header-info">
					<th colspan="${totalCols}" class="p-4 border-b-2 border-black">
						<div class="flex justify-between items-start mb-2">
							<div class="flex-1"></div>
							<div class="flex-1 text-center">
								<h2 class="text-xl font-bold text-black">${sub.schoolName || 'โรงเรียนปากช่อง'}</h2>
							</div>
							<div class="flex-1 text-right text-[10px] text-black font-normal">
								<div class="page-number-display"></div>
								<div>พิมพ์วันที่ ${printDate}</div>
							</div>
						</div>
						<div class="text-center text-[13px] text-black space-y-1 font-['Sarabun'] font-bold">
							<div>
								วิชา <span class="text-blue-900">${sub.code}</span> 
								<span class="text-blue-900">${sub.name}</span> 
								<span class="text-blue-900">${sub.credits}</span> นก. 
								ภาคเรียนที่ <span>${sub.semester || 1}</span> 
								ปีการศึกษา <span>${sub.year}</span> 
								ระดับชั้น <span>${activeClassName.split('/')[0]}</span> 
								กลุ่มที่ <span>${activeClassName.split('/')[1] || activeClassName}</span>
							</div>
							<div class="pt-1">
								ครูผู้สอน <span>${sub.teacher}</span> 
								<span class="inline-block w-8"></span>
								ครูที่ปรึกษา <span>${currentAdvisor}</span>
							</div>
						</div>
					</th>
				</tr>
				<tr class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-indigo-300 font-bold">
					<th class="px-2 py-6 text-center w-8 border-r text-sm font-bold">ที่</th>
					<th class="px-2 py-6 w-10 text-center border-r text-sm font-bold print:hidden">รูป</th>
					<th class="px-2 py-6 w-20 border-r text-center text-sm font-bold">รหัส</th>
					<th class="px-2 py-6 w-48 border-r text-sm font-bold">ชื่อ-นามสกุล</th>
					${unitsHtml}
					<th class="px-1 py-3 text-center bg-blue-50 border-r min-w-[80px] font-bold">
						<div class="mb-1 text-blue-800 text-xs">กลางภาค</div>
						<div class="bg-white rounded-[30px] px-2 py-0.5 shadow-sm inline-block min-w-[50px] text-[11px] text-gray-800 font-bold mb-1 border border-blue-100">${sub.midMax} | ${(sub.midMax * sub.midPassPct) / 100}</div>
						${midHeader}
					</th>
					<th class="px-1 py-3 text-center bg-blue-50 border-r min-w-[80px] font-bold">
						<div class="mb-1 text-blue-800 text-xs">ปลายภาค</div>
						<div class="bg-white rounded-[30px] px-2 py-0.5 shadow-sm inline-block min-w-[50px] text-[11px] text-gray-800 font-bold mb-1 border border-blue-100">${sub.finMax} | ${(sub.finMax * sub.finPassPct) / 100}</div>
						${finHeader}
					</th>
					<th class="px-2 py-6 text-center bg-yellow-50 font-bold border-r text-sm font-bold">รวม (${totalMax})</th>
					<th class="px-2 py-6 text-center bg-blue-50 font-bold border-r text-sm font-bold">%</th>
					<th class="px-2 py-6 text-center bg-green-50 font-bold border-r text-sm font-bold">เกรด</th>
					<th class="px-2 py-6 text-center bg-gray-50 font-bold text-sm border-r font-bold no-print">Remark</th>
				</tr>`;
		}
		
		function renderRows(sub, list) {
			const tbody = document.getElementById('studentTableBody');
			if (list.length === 0) {
				tbody.innerHTML = `<tr><td colspan="100%" class="text-center py-8 text-red-500 font-bold">
					<div class="flex flex-col items-center gap-2">
						<i class="fa-solid fa-circle-exclamation fa-2x"></i>
						<span>ไม่พบข้อมูลนักเรียนในห้อง ${activeClassName}</span>
						<span class="text-xs text-gray-500 font-normal">
							(สาเหตุที่พบบ่อย: ชื่อห้องในเมนู "ตั้งค่าวิชา" ไม่ตรงกับ "ห้องของนักเรียน" หรือ สถานะนักเรียนไม่ใช่ "ปกติ")
						</span>
					</div>
				</td></tr>`;
				return;
			}
			const start = (currentGradingPage - 1) * rowsPerPage; const paginated = list.slice(start, start + rowsPerPage);
			const isMax = currentPrintMode === 'max';
			tbody.innerHTML = paginated.map((s, local) => {
				const globalIdx = start + local; let units = '';
				sub.units.forEach(u => {
					const r = getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_r`);
					const e = getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_e`);
					const passMark = (u.max * u.passPct) / 100;
					if (isMax) {
						const val = Math.max(r, e);
						units += `<td class="px-0.5 py-1 text-center border-r font-bold text-sm text-gray-800">${val || '-'}</td>`;
					} else {
						const rBg = r < passMark ? 'bg-yellow-300' : 'bg-white';
						units += `<td class="px-0.5 py-1 text-center border-r"><div class="flex justify-center items-center gap-1 font-bold">
							<input type="number" value="${r}" onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'u${u.id}_r', this.value, ${globalIdx})" class="input-score text-center border rounded-full ${rBg} w-[28px] h-[24px] font-bold shadow-sm">
							<span class="text-slate-300">|</span>
							<input type="number" value="${e}" onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'u${u.id}_e', this.value, ${globalIdx})" class="input-score text-center border rounded-full bg-red-500 text-white w-[28px] h-[24px] font-bold shadow-sm placeholder-white/50">
						</div></td>`;
					}
				});
				const t = calculateStudentTotal(sub, s.uid), p = calculateStudentPct(sub, t), rem = getStoredScore(activeSubjectId, activeClassName, s.uid, 'remark', ""), grd = rem || computeGrade(sub, t);
				let passedUnitsCount = 0;
				sub.units.forEach(u => {
					if (Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_r`), getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_e`)) >= (u.max * u.passPct / 100)) passedUnitsCount++;
				});
				const statusIconHtml = generateStatusIcon(passedUnitsCount, sub.units.length);
				const midR = getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_r');
				const midE = getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_e');
				const finR = getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_r');
				const finE = getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_e');
				const midPassMark = (sub.midMax * sub.midPassPct) / 100;
				const finPassMark = (sub.finMax * sub.finPassPct) / 100;
				let midCell, finCell;
				if (isMax) {
					midCell = `<td class="px-0.5 py-1 text-center border-r font-bold text-sm text-gray-800">${Math.max(midR, midE) || '-'}</td>`;
					finCell = `<td class="px-0.5 py-1 text-center border-r font-bold text-sm text-gray-800">${Math.max(finR, finE) || '-'}</td>`;
				} else {
					midCell = `<td class="px-0.5 py-1 text-center border-r border-indigo-50"><div class="flex justify-center items-center gap-1 font-bold">
						<input type="number" value="${midR}" onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'mid_r', this.value, ${globalIdx})" class="input-score text-center border rounded-full ${midR < midPassMark ? 'bg-yellow-300' : 'bg-white'} w-[28px] h-[24px] font-bold shadow-sm">
						<span class="text-slate-300">|</span>
						<input type="number" value="${midE}" onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'mid_e', this.value, ${globalIdx})" class="input-score text-center border rounded-full bg-red-500 text-white w-[28px] h-[24px] font-bold shadow-sm">
					</div></td>`;
					finCell = `<td class="px-0.5 py-1 text-center border-r border-indigo-50"><div class="flex justify-center items-center gap-1 font-bold">
						<input type="number" value="${finR}" onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'fin_r', this.value, ${globalIdx})" class="input-score text-center border rounded-full ${finR < finPassMark ? 'bg-yellow-300' : 'bg-white'} w-[28px] h-[24px] font-bold shadow-sm">
						<span class="text-slate-300">|</span>
						<input type="number" value="${finE}" onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'fin_e', this.value, ${globalIdx})" class="input-score text-center border rounded-full bg-red-500 text-white w-[28px] h-[24px] font-bold shadow-sm">
					</div></td>`;
				}
				return `<tr class="grading-row border-b odd:bg-white even:bg-[#FFFF99] transition-colors"><td class="px-2 py-1 text-center text-gray-400 border-r text-[11px] font-bold">${globalIdx + 1}</td><td class="px-1 py-1 border-r text-center print:hidden"><div onclick="viewStudentPhoto('${s.uid}')" class="student-photo-container w-6 h-6 bg-slate-100 rounded-full mx-auto overflow-hidden border cursor-pointer transition-transform">${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user text-[10px] text-slate-300 mt-1"></i>'}</div></td><td class="px-2 py-1 text-gray-600 border-r text-[11px] text-center font-bold">${s.id}</td><td class="px-2 py-1 text-gray-700 border-r text-[11px] truncate max-w-[140px] font-bold"><span id="status-icon-wrapper-${globalIdx}">${statusIconHtml}</span> ${s.name}</td>${units}${midCell}${finCell}
				<td class="px-2 py-1 text-center font-bold bg-yellow-50/40 border-r text-[12px]" id="total-${globalIdx}">${t}</td><td class="px-2 py-1 text-center font-bold text-[#0d6efd] bg-blue-50/40 border-r text-[11px]" id="pct-${globalIdx}">${p}%</td><td class="px-2 py-1 text-center font-bold bg-green-50/30 border-r text-[12px] ${getGradeColor(grd)}" id="grade-${globalIdx}">${grd}</td><td class="px-1 py-1 text-center border-r no-print"><span class="hidden print:inline-block font-bold">${rem}</span><select onchange="updateScore(this, '${s.uid}', 'remark', this.value, ${globalIdx})" class="no-print text-[10px] border border-slate-200 rounded bg-white py-0.5"><option value="" ${rem === "" ? "selected" : ""}>-</option><option value="ร" ${rem === "ร" ? "selected" : ""}>ร</option><option value="มส" ${rem === "มส" ? "selected" : ""}>มส</option><option value="ผ" ${rem === "ผ" ? "selected" : ""}>ผ</option><option value="มผ" ${rem === "มผ" ? "selected" : ""}>มผ</option></select></td></tr>`;
			}).join('');
			setTimeout(() => { document.querySelectorAll('.input-score').forEach(el => syncInputWidth(el)); }, 0);
		}

		function generateStatusIcon(passedCount, totalCount) {
			let colorClass = 'text-red-500';
			let pingClass = 'bg-red-400';
			let iconClass = 'fa-circle-xmark';
			let title = 'ไม่ผ่านเกณฑ์ทุกหน่วย';
			if (passedCount === totalCount) {
				colorClass = 'text-green-500';
				pingClass = 'bg-green-400';
				iconClass = 'fa-circle-check';
				title = 'ผ่านเกณฑ์ทุกหน่วย';
			} else if (passedCount > 0) {
				colorClass = 'text-yellow-500';
				pingClass = 'bg-yellow-400';
				iconClass = 'fa-circle-exclamation';
				title = 'ผ่านเกณฑ์บางหน่วย';
			}
			return `
				<span class="relative inline-flex mr-1.5">
					<span class="animate-ping absolute inline-flex h-full w-full rounded-full ${pingClass} opacity-75"></span>
					<i class="fa-solid ${iconClass} ${colorClass} relative text-[10px]" title="${title}"></i>
				</span>
			`;
		}

		function renderGeneralPagination(prefix, total, current, callback) {
			const totalPages = Math.ceil(total / rowsPerPage) || 1; 
			const infoEl = document.getElementById(prefix + '-info'); 
			if (infoEl) infoEl.innerText = `แสดง ${total === 0 ? 0 : ((current-1)*rowsPerPage)+1}-${Math.min(current*rowsPerPage, total)} จาก ${total}`;
			
			const ctrlEl = document.getElementById(prefix + '-controls'); 
			if (!ctrlEl) return;

			let h = `<button onclick="(${callback})(${current - 1})" ${current === 1 ? 'disabled' : ''} class="pagination-btn px-3 py-1 border rounded bg-white shadow-sm font-bold hover:bg-slate-50 text-xs flex items-center gap-1">
						<i class="fa-solid fa-chevron-left text-[10px]"></i> ก่อนหน้า
					</button>`;

			for (let i = 1; i <= totalPages; i++) { 
				if (i === 1 || i === totalPages || (i >= current - 1 && i <= current + 1)) {
					h += `<button onclick="(${callback})(${i})" class="px-3 py-1 border rounded ${current === i ? 'bg-[#0d6efd] text-white font-bold' : 'bg-white shadow-sm hover:bg-slate-50'} font-bold text-xs">${i}</button>`; 
				} else if (Math.abs(i - current) === 2) {
					h += `<span class="px-1 text-slate-400">...</span>`; 
				}
			}

			h += `<button onclick="(${callback})(${current + 1})" ${current === totalPages ? 'disabled' : ''} class="pagination-btn px-3 py-1 border rounded bg-white shadow-sm font-bold hover:bg-slate-50 text-xs flex items-center gap-1">
						ถัดไป <i class="fa-solid fa-chevron-right text-[10px]"></i>
				</button>`;
				
			ctrlEl.innerHTML = h;
		}

		function getStoredScore(sid, r, uid, fid, def = 0) { return scoreData[sid]?.[r]?.[uid]?.[fid] ?? def; }

		// [ส่วนที่แก้ไข/ตรวจสอบ] ฟังก์ชันจัดการการกรอกคะแนนและการแสดงผลทันที

		/**
		 * ฟังก์ชันเรียกเมื่อมีการพิมพ์คะแนน (oninput)
		 * ทำหน้าที่: อัปเดตข้อมูลในตัวแปร scoreData และสั่งให้คำนวณหน้าจอใหม่
		 */
		function updateScore(el, uid, fid, val, idx) {
			const sub = subjects.find(s => s.id === activeSubjectId); 
			if (!scoreData[activeSubjectId]) scoreData[activeSubjectId] = {};
			if (!scoreData[activeSubjectId][activeClassName]) scoreData[activeSubjectId][activeClassName] = {}; 
			if (!scoreData[activeSubjectId][activeClassName][uid]) scoreData[activeSubjectId][activeClassName][uid] = {};
			
			// กรณีเลือก Remark (ร, มส, ผ, มผ)
			if (fid === 'remark') { 
				scoreData[activeSubjectId][activeClassName][uid][fid] = val; 
				// อัปเดตการแสดงผลทันที (รวมถึงสีเกรด)
				updateScoreDisplay(uid, idx, sub, fid, el, 0, 0); 
				return; 
			} 

			// ตรวจสอบคะแนนเต็ม
			let maxScore = 0;
			let passPct = 50;
			
			if (fid.startsWith('u')) { 
				const unitId = parseInt(fid.substring(1, fid.indexOf('_'))); 
				const unit = sub.units.find(u => u.id === unitId); 
				if (unit) { maxScore = unit.max; passPct = unit.passPct; } 
			} else if (fid.includes('mid')) { 
				maxScore = sub.midMax; passPct = sub.midPassPct; 
			} else if (fid.includes('fin')) { 
				maxScore = sub.finMax; passPct = sub.finPassPct; 
			}

			const numericVal = parseFloat(val) || 0;

			// แจ้งเตือนถ้ากรอกเกินคะแนนเต็ม
			if (numericVal > maxScore) { 
				Swal.fire({ 
					icon: 'warning', 
					title: 'คะแนนเกิน', 
					text: `คะแนนเต็มคือ ${maxScore} คะแนน`, 
					confirmButtonText: 'ตกลง' 
				}); 
				el.value = 0; 
				scoreData[activeSubjectId][activeClassName][uid][fid] = 0; 
				updateScoreDisplay(uid, idx, sub, fid, el, maxScore, passPct); 
				return; 
			}

			// บันทึกค่าลงตัวแปรหลัก
			scoreData[activeSubjectId][activeClassName][uid][fid] = numericVal; 
			
			// เรียกฟังก์ชันคำนวณและแสดงผลทันที
			updateScoreDisplay(uid, idx, sub, fid, el, maxScore, passPct);
		}

		/**
		 * ฟังก์ชันคำนวณและอัปเดตหน้าจอ (DOM) ทันที
		 * ทำหน้าที่: รวมคะแนน, ตัดเกรด, เปลี่ยนสีช่องคะแนน/เกรด
		 */
		function updateScoreDisplay(uid, idx, sub, fid, el, maxScore, passPct) {
			// 1. คำนวณคะแนนรวมและเกรดใหม่ ณ ขณะนั้น
			const t = calculateStudentTotal(sub, uid);
			const p = calculateStudentPct(sub, t);
			const rem = scoreData[activeSubjectId][activeClassName][uid]?.remark || "";
			const g = rem || computeGrade(sub, t); // ถ้ามี Remark ให้ใช้ Remark ถ้าไม่มีให้ใช้เกรดที่คำนวณได้

			// 2. อ้างอิง Element บนหน้าเว็บตาม ID
			const tEl = document.getElementById(`total-${idx}`);
			const pEl = document.getElementById(`pct-${idx}`);
			const gEl = document.getElementById(`grade-${idx}`);

			// 3. อัปเดตข้อความในตารางทันที
			if (tEl) tEl.innerText = t; 
			if (pEl) pEl.innerText = p + "%"; 
			if (gEl) { 
				gEl.innerText = g; 
				// อัปเดตสีของเกรด (เขียว/แดง/ม่วง ฯลฯ)
				gEl.className = `px-2 py-1 text-center font-bold bg-green-50/30 border-r text-[12px] ${getGradeColor(g)}`; 
			}

			// 4. เปลี่ยนสีช่องกรอกคะแนน (ผ่าน/ไม่ผ่าน)
			if (el && fid.endsWith('_r')) {
				const numericVal = scoreData[activeSubjectId][activeClassName][uid][fid] || 0;
				const passMark = (maxScore * passPct) / 100;
				if (numericVal < passMark) {
					el.classList.remove('bg-white');
					el.classList.add('bg-yellow-300'); // สีเหลืองถ้าตก
				} else {
					el.classList.remove('bg-yellow-300');
					el.classList.add('bg-white');
				}
			}

			// 5. อัปเดตไอคอนสถานะ (ผ่านทุกหน่วยหรือไม่)
			const iconWrapper = document.getElementById(`status-icon-wrapper-${idx}`);
			if (iconWrapper) {
				let passedUnitsCount = 0;
				sub.units.forEach(u => {
					const r = getStoredScore(activeSubjectId, activeClassName, uid, `u${u.id}_r`);
					const e = getStoredScore(activeSubjectId, activeClassName, uid, `u${u.id}_e`);
					if (Math.max(r, e) >= (u.max * u.passPct / 100)) passedUnitsCount++;
				});
				iconWrapper.innerHTML = generateStatusIcon(passedUnitsCount, sub.units.length);
			}

			// 6. อัปเดตแถบสรุปด้านล่าง (จำนวนคน, เกรดเฉลี่ย)
			updateAchievementSummary(sub, getActiveStudentsInClass(activeClassName));
		}

		function updateAchievementSummary(sub, classStudents) {
			const counts = { '4': 0, '3.5': 0, '3': 0, '2.5': 0, '2': 0, '1.5': 0, '1': 0, '0': 0, 'ร': 0, 'มส': 0, 'ผ': 0, 'มผ': 0 };
			let totalPct = 0; let goodCount = 0;
			classStudents.forEach(stu => {
				const t = calculateStudentTotal(sub, stu.uid); const p = calculateStudentPct(sub, t); const rem = getStoredScore(activeSubjectId, activeClassName, stu.uid, 'remark', ""); const g = rem || computeGrade(sub, t);
				if (counts.hasOwnProperty(g)) counts[g]++; totalPct += p; if (!rem && parseFloat(computeGrade(sub, t)) >= 3) goodCount++;
			});
			const avgPct = classStudents.length > 0 ? (totalPct / classStudents.length).toFixed(2) : "0.00";
			const goodPct = classStudents.length > 0 ? (goodCount / classStudents.length * 100).toFixed(2) : "0.00";
			const totalStuEl = document.getElementById('sum-total-stu');
			const avgPctEl = document.getElementById('sum-avg-pct');
			const goodPctEl = document.getElementById('sum-good-pct');
			if(totalStuEl) totalStuEl.innerText = classStudents.length; 
			if(avgPctEl) avgPctEl.innerText = avgPct; 
			if(goodPctEl) goodPctEl.innerText = goodPct;
			Object.keys(counts).forEach(g => { const el = document.getElementById(`stat-${g}`); if (el) el.innerText = counts[g] > 0 ? counts[g] : "-"; });
		}

		function calculateStudentTotal(sub, uid) { return calculateStudentTotalBySub(sub, uid, activeClassName); }
		function calculateStudentPct(sub, s) { let m = 0; sub.units.forEach(u => m += u.max); m += sub.midMax + sub.finMax; return m === 0 ? 0 : parseFloat(((s/m)*100).toFixed(2)); }
		function computeGrade(sub, s) { return computeGradeBySub(sub, s); }
		function getGradeColor(g) { if (g === "ร") return "text-purple-600"; if (g === "มส") return "text-red-800"; if (g === "ผ") return "text-emerald-700"; if (g === "มผ") return "text-rose-700"; return (parseFloat(g) < 1) ? "text-[#dc3545]" : "text-[#198754]"; }
		function syncInputWidth(el) { el.style.width = ((el.value?.toString().length || 1) * 7 + 15) + 'px'; }
		
		function saveScores() { 
			showLoading();
            
            // 1. ดึงข้อมูลวิชาปัจจุบัน เพื่อใช้ในการคำนวณเกรด
            const sub = subjects.find(s => s.id === activeSubjectId);
            if (!sub) {
                hideLoading();
                Swal.fire('Error', 'ไม่พบข้อมูลรายวิชา', 'error');
                return;
            }

            // 2. วนลูปคำนวณ Total และ Grade ของนักเรียนทุกคนที่มีคะแนน
            // ตรวจสอบว่ามีข้อมูลคะแนนของวิชานี้และห้องนี้หรือไม่
            if (scoreData[activeSubjectId] && scoreData[activeSubjectId][activeClassName]) {
                const studentsInRoom = scoreData[activeSubjectId][activeClassName];
                
                for (const uid in studentsInRoom) {
                    // คำนวณคะแนนรวม (ใช้ฟังก์ชันที่มีอยู่แล้ว)
                    const totalScore = calculateStudentTotal(sub, uid);
                    
                    // คำนวณเกรด (ใช้ฟังก์ชันที่มีอยู่แล้ว)
                    // ตรวจสอบ Remark ก่อน ถ้ามีให้ใช้ Remark ถ้าไม่มีให้คำนวณเกรด
                    const remark = studentsInRoom[uid].remark || "";
                    const grade = remark || computeGrade(sub, totalScore);
                    
                    // เพิ่มค่าลงใน Object ที่จะส่งไปบันทึก
                    scoreData[activeSubjectId][activeClassName][uid]['total'] = totalScore;
                    scoreData[activeSubjectId][activeClassName][uid]['grade'] = grade;
                }
            }
			
			callBackend('saveScores', scoreData)
			.then(function(res) {
				if(res.result === 'error') throw new Error(res.message);
				hideLoading();
				Swal.fire({ title: 'สำเร็จ', text: 'บันทึกเรียบร้อย (แยกชีตรายห้องแล้ว)', icon: 'success', timer: 1500, showConfirmButton: false }); 
			})
			.catch(function(e) {
				hideLoading();
				Swal.fire('Error', 'บันทึกไม่สำเร็จ: ' + e.message, 'error');
			});
		}

		function downloadStudentTemplate() {
			let csvContent = "\uFEFFเลขบัตรประชาชน,เลขประจำตัว,ชื่อ สกุล,ชั้น,เลขที่,เพศ,รูป,สถานะนักเรียน,ปีที่เข้าศึกษา\n";
			csvContent += "1234567890123,99999,ตัวอย่าง ชื่อ-สกุล,ม.4/1,1,ชาย,,ปกติ,2568";
			downloadFile(csvContent, 'Template_Students.csv', 'text/csv;charset=utf-8;');
		}

        function exportToCSV() {
            const sub = subjects.find(s => s.id === activeSubjectId); if (!sub) return;
            const classStudents = getActiveStudentsInClass(activeClassName);
            let csvContent = "\uFEFF"; csvContent += `"${sub.schoolName} - วิชา ${sub.code} ${sub.name} ห้อง ${activeClassName}"\n`;
            let headers = ["เลขที่", "รหัส", "ชื่อ-นามสกุล"]; sub.units.forEach(u => headers.push(`หน่วย ${u.id}`)); headers.push("กลางภาค", "ปลายภาค", "รวม", "ร้อยละ", "เกรด", "หมายเหตุ");
            csvContent += headers.join(",") + "\n";
            classStudents.forEach((s, index) => {
                let row = [index + 1, s.id, `"${s.name}"`]; sub.units.forEach(u => { const r = getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_r`), e = getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_e`); row.push(Math.max(r, e)); });
                const mid = Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_r'), getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_e')), fin = Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_r'), getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_e')), total = calculateStudentTotal(sub, s.uid), pct = calculateStudentPct(sub, total), rem = getStoredScore(activeSubjectId, activeClassName, s.uid, 'remark', ""), grade = rem || computeGrade(sub, total);
                row.push(mid, fin, total, pct, grade, rem); csvContent += row.join(",") + "\n";
            });
            downloadFile(csvContent, `Score_${sub.code}_${activeClassName}.csv`, 'text/csv;charset=utf-8;');
        }

        function exportToExcel() {
            const sub = subjects.find(s => s.id === activeSubjectId); if (!sub) return;
            const classStudents = getActiveStudentsInClass(activeClassName);
            let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><table><thead><tr><th colspan="${6+sub.units.length}" style="text-align:center;">${sub.schoolName} - วิชา ${sub.code} ${sub.name} ห้อง ${activeClassName}</th></tr><tr><th>เลขที่</th><th>รหัส</th><th>ชื่อ-นามสกุล</th>`;
            sub.units.forEach(u => html += `<th>หน่วย ${u.id}</th>`); html += `<th>กลางภาค</th><th>ปลายภาค</th><th>รวม</th><th>ร้อยละ</th><th>เกรด</th><th>หมายเหตุ</th></tr></thead><tbody>`;
            classStudents.forEach((s, index) => {
                const total = calculateStudentTotal(sub, s.uid), pct = calculateStudentPct(sub, total), rem = getStoredScore(activeSubjectId, activeClassName, s.uid, 'remark', ""), grade = rem || computeGrade(sub, total);
                html += `<tr><td>${index+1}</td><td>${s.id}</td><td>${s.name}</td>`;
                sub.units.forEach(u => { const val = Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_r`), getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_e`)); html += `<td>${val}</td>`; });
                html += `<td>${Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_r'), getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_e'))}</td><td>${Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_r'), getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_e'))}</td><td>${total}</td><td>${pct}</td><td>${grade}</td><td>${rem}</td></tr>`;
            });
            html += `</tbody></table></body></html>`;
            downloadFile(html, `Score_${sub.code}_${activeClassName}.xls`, 'application/vnd.ms-excel');
        }

        function downloadFile(content, fileName, mimeType) { const blob = new Blob([content], { type: mimeType }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

// --- ส่วนของระบบ Login และ Captcha (เพิ่มใหม่) ---
    let generatedCaptcha = '';
    let currentUser = null;

    function generateCaptcha() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // ตัดตัวอักษรที่สับสนง่ายออก (I, 1, O, 0)
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        generatedCaptcha = result;
        const capEl = document.getElementById('captcha-text');
        if(capEl) capEl.innerText = result;
        const capIn = document.getElementById('login-captcha');
        if(capIn) capIn.value = '';
    }

    // ฟังก์ชันล้างค่าฟอร์ม Login (ปรับปรุงให้ล้าง Style สีแดงด้วย)
    function clearLoginForm() {
        const inputs = ['login-username', 'login-password', 'login-captcha'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.value = '';
                // รีเซ็ต Style กลับเป็นปกติ
                el.classList.remove('border-red-500', 'bg-red-50');
                el.classList.add('border-slate-200', 'bg-slate-50');
            }
        });
        generateCaptcha();
    }

// ฟังก์ชันตรวจสอบและเข้าสู่ระบบ (แก้ไขเพิ่ม Loading Overlay)
    function performLogin(btn) {
        const userEl = document.getElementById('login-username');
        const passEl = document.getElementById('login-password');
        const captEl = document.getElementById('login-captcha');
        
        const userIn = userEl.value.trim();
        const passIn = passEl.value.trim();
        const captIn = captEl.value.trim().toUpperCase();

        // 1. รีเซ็ต Style เดิมก่อนเริ่มตรวจสอบ
        [userEl, passEl, captEl].forEach(el => {
            el.classList.remove('border-red-500', 'bg-red-50');
            el.classList.add('border-slate-200', 'bg-slate-50');
        });

        // 2. ตรวจสอบข้อมูลว่าง
        let isValid = true;
        if (!userIn) {
            userEl.classList.remove('border-slate-200', 'bg-slate-50');
            userEl.classList.add('border-red-500', 'bg-red-50');
            isValid = false;
        }
        if (!passIn) {
            passEl.classList.remove('border-slate-200', 'bg-slate-50');
            passEl.classList.add('border-red-500', 'bg-red-50');
            isValid = false;
        }
        if (!captIn) {
            captEl.classList.remove('border-slate-200', 'bg-slate-50');
            captEl.classList.add('border-red-500', 'bg-red-50');
            isValid = false;
        }

        if (!isValid) {
            Swal.fire({
                icon: 'warning',
                title: 'ข้อมูลไม่ครบถ้วน',
                text: 'กรุณาระบุ ชื่อผู้ใช้, รหัสผ่าน และรหัส CAPTCHA ให้ครบ',
                confirmButtonColor: '#0d6efd',
                confirmButtonText: 'ตกลง'
            });
            return;
        }

        // 3. ตรวจสอบ CAPTCHA
        if (captIn !== generatedCaptcha) {
            captEl.classList.remove('border-slate-200', 'bg-slate-50');
            captEl.classList.add('border-red-500', 'bg-red-50');
            
            Swal.fire({
                icon: 'error',
                title: 'รหัส CAPTCHA ไม่ถูกต้อง',
                text: 'กรุณาตรวจสอบรหัสความปลอดภัยอีกครั้ง',
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'ลองใหม่'
            }).then(() => {
                generateCaptcha();
                captEl.value = '';
                captEl.focus();
            });
            return;
        }

        // 4. ส่งข้อมูลไปตรวจสอบกับ Backend
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> กำลังตรวจสอบ...';
        btn.disabled = true;
        
        // --- เพิ่มส่วนนี้: แสดง Loading Overlay ---
        showLoading(); 
        // ------------------------------------

callBackend('login', { username: userIn, password: passIn })
        .then(res => {
            // 1. ลบ hideLoading() บรรทัดนี้ออก (เพื่อให้ฉากหลังยังหมุนอยู่)
            
            btn.innerHTML = originalText;
            btn.disabled = false;

            if (res.result === 'success') {
                currentUser = res.user;
                document.getElementById('login-modal').classList.add('hidden'); 
                
                // 2. แสดง SweetAlert (ตอนนี้จะอยู่บน Loading Overlay แล้วเพราะแก้ CSS ข้อ 1)
                Swal.fire({
                    icon: 'success',
                    title: 'เข้าสู่ระบบสำเร็จ',
                    text: `ยินดีต้อนรับ คุณ ${currentUser.name} (${currentUser.role})`,
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    // 3. เมื่อ SweetAlert หายไป ค่อยสั่งซ่อน Loading หรือโหลดข้อมูลต่อ
                    // ในที่นี้ loadSystemData() จะจัดการเรื่อง Loading ต่อเอง
                    loadSystemData(); 
                });
                
            } else {
                // กรณี Error สั่งซ่อน Loading ได้เลย
                hideLoading();

                userEl.classList.remove('border-slate-200', 'bg-slate-50');
                userEl.classList.add('border-red-500', 'bg-red-50');
                
                passEl.classList.remove('border-slate-200', 'bg-slate-50');
                passEl.classList.add('border-red-500', 'bg-red-50');

                Swal.fire({
                    icon: 'error',
                    title: 'เข้าสู่ระบบไม่สำเร็จ',
                    text: res.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง',
                    confirmButtonColor: '#dc3545',
                    confirmButtonText: 'ลองใหม่'
                }).then(() => {
                    generateCaptcha();
                    passEl.value = ''; 
                });
            }
        })
        .catch(err => {
            // [แก้ไขจุดที่ 3] : กรณีเกิด Error ก็ต้องซ่อน Loading ก่อนเช่นกัน
            hideLoading();

            btn.innerHTML = originalText;
            btn.disabled = false;
            
            Swal.fire('System Error', err.message, 'error');
        });
    }

    // --- แก้ไข window.onload เป็นแบบใหม่ ---
    window.onload = function() {
        // 1. สร้าง Captcha ทันทีที่เปิดเว็บ
        generateCaptcha();
        
        // 2. แสดง Login Modal (เอา class hidden ออก)
        document.getElementById('login-modal').classList.remove('hidden');
        
        // *หมายเหตุ: เราจะไม่เรียก getBackendData ที่นี่แล้ว จะย้ายไปใน loadSystemData แทน
    };

    // --- ฟังก์ชันโหลดข้อมูล (ย้ายโค้ดเดิมจาก window.onload มาไว้ที่นี่) ---
    function loadSystemData() {
        showLoading();
        callBackend('getBackendData')
        .then(function(data) {
            // Populate data from Backend
            students = data.students;
            if (data.subjects && data.subjects.length > 0) {
                subjects = data.subjects;
                // FIX: Ensure default selection
                if(!activeSubjectId) {
                     activeSubjectId = subjects[0].id;
                     if(subjects[0].classes.length > 0) {
                         activeClassName = subjects[0].classes[0];
                     }
                }
            } else {
                // Default subject if none exists (ใช้ข้อมูล Mockup เดิมของคุณ)
                subjects = [{ 
                    id: "s1", name: "เคมี 2", code: "ว31222", type: "พื้นฐาน", credits: 1.5, hours: 3.0,
                    schoolName: "โรงเรียนปากช่อง", affiliation: "สำนักงานเขตพื้นที่การศึกษามัธยมศึกษานครราชสีมา",
                    director: "นายประหยัด รักษ์ดี", deputyDirector: "นางสมพร มั่นคง", headEvaluation: "นายวิชัย วัดผล", headDepartment: "นางใจดี สอนวิทย์",
                    teacher: "นายธนสาร สีรักษ์", departmentName: "วิทยาศาสตร์และเทคโนโลยี",
                    advisors: { "ม.4/1": "นางสาวสมหญิง ใจดี", "ม.4/2": "นายบุญส่ง มุ่งมั่น" },
                    semester: 1, year: 2568, gradeLevel: "ม.4", classes: ["ม.4/1", "ม.4/2"], 
                    units: [{ id: 1, max: 12, passPct: 50 }, { id: 2, max: 6, passPct: 50 }, { id: 3, max: 12, passPct: 50 }], 
                    midMax: 20, midPassPct: 50, finMax: 20, finPassPct: 50,
                    targetSchoolPct: 60, targetDeptPct: 55, targetSubjectPct: 50,
                    targetSchoolGPA: 3.00, targetDeptGPA: 2.55, targetSubjectGPA: 2.50
                }];
                activeSubjectId = "s1";
                activeClassName = "ม.4/1";
            }
            scoreData = data.scoreData || {};

            // Initialize Frontend
            setTimeout(() => {
                updateGradingFilters(); updateDisplayHeader(); updateStudentFilters(); initTable(); initStudentTable(); 
                hideLoading();
            }, 500);

        })
        .catch(function(e) {
            hideLoading();
            console.error(e);
            Swal.fire('Error', 'Cannot connect to backend: ' + e.message, 'error');
        });
    }


    // ฟังก์ชันออกจากระบบ (เพิ่มใหม่)
    function logoutSystem() {
        Swal.fire({
            title: 'ยืนยันการออกจากระบบ?',
            text: "คุณต้องการออกจากระบบใช่หรือไม่",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'ใช่, ออกจากระบบ',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                // ส่ง Log ไปยัง Backend (ถ้ามี user login อยู่)
                if (currentUser && currentUser.username) {
                    // ส่ง request แบบไม่รอผลลัพธ์ (Fire and forget) เพื่อความรวดเร็ว
                    callBackend('logout', { username: currentUser.username });
                }
                
                // ล้างค่าผู้ใช้ปัจจุบัน
                currentUser = null;
                
                // แสดง Modal Login อีกครั้ง
                document.getElementById('login-modal').classList.remove('hidden');
                
                // ล้างฟอร์ม Login และรีเซ็ต Captcha
                clearLoginForm();
                
                // แจ้งเตือน
                Swal.fire({
                    icon: 'success',
                    title: 'ออกจากระบบสำเร็จ',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        });
    }

	</script>
</body>
</html>
