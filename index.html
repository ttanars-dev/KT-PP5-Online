
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KT|PP5 Online System</title>
	<link rel="shortcut icon" type="image/png" href="https://lh3.googleusercontent.com/d/1kggNSqMxuYIPZQs6hPt3pt7C5WbVQQIa">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
	<script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/flatpickr.min.js"></script>
	<script src="https://npmcdn.com/flatpickr@4.6.13/dist/l10n/th.js"></script>
    <style id="print-styles">
		/* จัดกึ่งกลางหัวตารางหน้าบันทึกคะแนนงาน */
		#taskTableHeader th {
			text-align: center !important;
		}
		/* --- แก้ไขเส้นตารางหน้าบันทึกคะแนน และ คะแนนงาน ให้เป็นสี #0a0a0a --- */

		/* 1. บังคับเส้นขอบของตาราง, หัวตาราง (th), และข้อมูล (td) ในหน้า Grading และ Task */
		#grading-view table,
		#grading-view table th,
		#grading-view table td,
		#task-grading-view table,
		#task-grading-view table th,
		#task-grading-view table td {
			border: 1px solid #0a0a0a !important;
			border-color: #0a0a0a !important;
			border-collapse: collapse !important; /* รวมเส้นขอบให้คมชัด */
		}

		/* 2. จัดการเส้นแบ่งภายในส่วนหัวตาราง (เช่น เส้นแบ่งระหว่าง คะแนนเต็ม | ผ่าน) */
		/* Selector นี้จะเจาะจงไปที่ div ที่มี class border ภายใน th */
		#grading-view table thead th div[class*="border"],
		#task-grading-view table thead th div[class*="border"] {
			border-color: #0a0a0a !important;
		}

		/* 3. (ทางเลือก) หากต้องการให้เส้นขอบ Input กรอกคะแนนเป็นสีเดียวกันด้วย */
		#grading-view input.input-score,
		#task-grading-view input.input-score {
			border-color: #0a0a0a !important;
		}

		/* 1. บังคับเส้นขอบตารางในหน้า อ่าน-คิด-เขียน, สมรรถนะ, คุณลักษณะ */
		#rw-view table, 
		#competency-view table, 
		#attribute-view table {
			border-collapse: collapse !important; /* ให้เส้นรวมเป็นเส้นเดียว */
		}

		/* 2. จัดการเส้นขอบของ "หัวตาราง (th)" และ "ข้อมูล (td)" */
		#rw-view table th, #rw-view table td,
		#competency-view table th, #competency-view table td,
		#attribute-view table th, #attribute-view table td {
			border: 1px solid #0a0a0a !important; /* บังคับมีเส้นขอบ 4 ด้าน สีดำเข้ม */
		}

		/* 3. (เพิ่มเติม) หากต้องการแก้หน้าบันทึกคะแนนหลักด้วย ให้เพิ่มส่วนนี้ */
		#grading-view table th, #grading-view table td,
		#task-grading-view table th, #task-grading-view table td {
			border-color: #0a0a0a !important;
		}
			
	
		/* ปรับแต่ง Datepicker ให้เข้ากับ Theme */
		.flatpickr-calendar { 
			font-family: 'Sarabun', sans-serif; 
			z-index: 60005 !important; /* [เพิ่ม] ต้องสูงกว่า Modal (60000) */
		}
		.flatpickr-current-month { font-size: 110%; }
		.flatpickr-months .flatpickr-month { height: 40px; }
		
		span.flatpickr-weekday { font-weight: bold; }
		.swal2-container {
		z-index: 99999 !important; /* ปรับให้สูงกว่าทุกอย่างเพื่อให้ Alert แจ้งเตือนอยู่บนสุดเสมอ */
}
		/* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: none; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30000; 
            backdrop-filter: blur(2px);
            transition: opacity 0.3s ease;
        }			
	
        /* 1. กำหนดค่าเริ่มต้นหน้ากระดาษและตัวนับเลขหน้า */
        @page {
            size: A4 portrait;
            margin: 0;
        }


		@media print {
			/* 1. บังคับส่วนหัวตารางให้แสดงทุกหน้า */
			thead {
				display: table-header-group !important;
			}

			/* 2. จัดการแถวข้อมูล */
			tr {
				page-break-inside: avoid !important; /* ป้องกันแถวขาดกลางหน้า */
				break-inside: avoid !important;
			}

			/* 3. จัดการแถวข้อมูลหัวรายงาน (ยุบรวมจากที่เขียนซ้ำ) */
			.print-table-header-info {
				display: table-row !important; 
				background-color: white !important;
				-webkit-print-color-adjust: exact; /* บังคับให้สีพื้นหลังพิมพ์ออกมาด้วย */
			}

			/* 4. ซ่อนส่วนที่ไม่เกี่ยวข้อง */
			#report-print-header, 
			#loading-overlay {
				display: none !important;
			}

			/* [เพิ่มเติม] เพื่อความชัวร์สำหรับตารางที่ซับซ้อน */
			table {
				border-collapse: collapse;
				width: 100%;
			}
		}
			
		/* ซ่อนแถวหัวรายงานในหน้าจอปกติ */
		.print-table-header-info {
			display: none;
		}

		/* ใช้ @media screen เพื่อให้มีผลเฉพาะหน้าจอคอมพิวเตอร์ (ไม่กระทบตอนพิมพ์) */
		@media screen {
			/* ลบเส้นขอบทั้งหมดในส่วนหัวตาราง */
			#tableHeader th {
				border: none !important;       /* ลบเส้นขอบ */
				border-right: none !important; /* ย้ำลบเส้นขอบขวา */
				border-top: none !important;   /* ย้ำลบเส้นขอบบน */
				border-left: none !important;  /* ย้ำลบเส้นขอบซ้าย */
				box-shadow: none !important;   /* ลบเงา (ถ้ามี) */
			}

			/* ถ้าต้องการให้เหลือเส้นขอบล่างเส้นเดียว (เพื่อแบ่งหัวตารางกับเนื้อหา) ให้เปิดบรรทัดล่างนี้ */
			/* #tableHeader th { border-bottom: 2px solid #e2e8f0 !important; } */
			
			/* ลบสีพื้นหลังของเส้นแบ่ง (ถ้ามี) */
			#tableHeader tr {
				border: none !important;
			}
		}

        :root {
            --bs-primary: #0d6efd;
            --bs-secondary: #6c757d;
            --bs-success: #198754;
            --bs-info: #0dcaf0;
            --bs-warning: #ffc107;
            --bs-danger: #dc3545;
            --bs-light: #f8f9fa;
            --bs-dark: #212529;
            
            /* Modern Gradients */
            --grad-primary: linear-gradient(135deg, #0d6efd 0%, #004aad 100%);
            --grad-success: linear-gradient(135deg, #198754 0%, #0a5131 100%);
            --grad-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --grad-settings: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
            --grad-danger: linear-gradient(135deg, #dc3545 0%, #a71d2a 100%);
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f0f4f8;
        }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
            transition: opacity 0.3s ease;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--bs-light);
            border-top: 5px solid var(--bs-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .input-score {
            transition: all 0.1s;
            min-width: 28px;
            padding: 2px 1px;
            line-height: 1;
            font-size: 12px;
			border: 1px solid #000000 !important; /* บังคับให้ขอบเป็นสีดำเข้ม */
        }
        .input-score:focus {
            outline: 2px solid var(--bs-primary);
            background-color: #eff6ff;
        }
        .input-error {
            border-color: var(--bs-danger) !important;
            background-color: #fef2f2 !important;
            color: var(--bs-danger);
        }
        .input-fail {
            background-color: #fff7ed !important;
            border-color: #f97316 !important;
            color: #ea580c;
        }
        
        /* Button Zoom & Hover Styles */
        button, label.btn-success {
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease !important;
        }
        button:not(.modal-btn):hover, label.btn-success:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0.9;
        }
        button:active {
            transform: scale(0.98);
        }
        
        /* Modal Button Overrides (No Zoom) */
        .modal-btn:hover {
            transform: none !important;
        }

        /* Modern Gradient Buttons */
        .btn-grad-grading { background: var(--grad-primary) !important; color: white; }
        .btn-grad-achievement { background: var(--grad-success) !important; color: white; }
        .btn-grad-students { background: var(--grad-warning) !important; color: white; }
        .btn-grad-settings { background: var(--grad-settings) !important; color: white; }
        .btn-grad-save { background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%) !important; color: white; }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .view-section { display: none; }
        .view-active { display: block; }

        /* Grading Table Specific Styles */
        #studentTableBody tr {
            transition: background-color 0.15s;
        }
        #studentTableBody tr:hover {
            background-color: #bfdbfe !important; /* Clear Hover Color Blue-200 */
        }
        
        .student-photo-container {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .student-photo-container:hover {
            transform: scale(1.4);
            z-index: 10;
            box-shadow: 0 8px 16px rgba(0,0,0,0.25);
        }

        @media print {
            .no-print { display: none !important; }
            body { 
                background-color: white; 
                padding: 0; 
                margin: 0; 
                width: 100% !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            body.print-portrait { width: 210mm; }
            body.print-landscape { width: 297mm; }

            .max-w-full { 
                border: none; 
                box-shadow: none; 
                width: 100% !important; 
                max-width: 100% !important; 
                margin: 0 !important;
            }
            .shadow-lg { box-shadow: none !important; }
            .rounded-xl { border-radius: 0 !important; }
            table { 
                border-collapse: collapse !important; 
                width: 100% !important;
                border: 1px solid black !important;
                font-size: 10pt;
            }
            th, td { 
                border: 1px solid black !important; 
                color: black !important;
                padding: 2px !important;
            }
            thead {
                background-color: #f3f4f6 !important;
                display: table-header-group;
            }
            tr { page-break-inside: avoid; }
            .overflow-x-auto { overflow: visible !important; }

            body:not(.print-cover-mode):not(.print-achievement-mode) #cover-print-container { display: none !important; }
            body:not(.print-achievement-mode) #achievement-print-container { display: none !important; }

            body.print-cover-mode .view-section,
            body.print-cover-mode #report-print-header,
            body.print-cover-mode #summary-section,
            body.print-cover-mode #grading-pagination,
            body.print-achievement-mode .view-section,
            body.print-achievement-mode #report-print-header,
            body.print-achievement-mode #summary-section,
            body.print-achievement-mode #grading-pagination { display: none !important; }
            
            body.print-cover-mode { width: 100% !important; margin: 0 auto; height: 100vh; overflow: hidden; }
            body.print-cover-mode #cover-print-container { display: block; width: 100%; padding: 0; margin: 0; }
            
            body.print-achievement-mode { width: 100% !important; margin: 0 auto; min-height: 100vh; }
            body.print-achievement-mode #achievement-print-container { display: block; width: 100%; padding: 0; margin: 0; }
            body.print-achievement-mode #app-body-container { border: none !important; box-shadow: none !important; }

            .cover-compact-table th, .cover-compact-table td {
                padding: 2px 2px !important;
                font-size: 9pt !important;
                line-height: 1.1;
            }
        }

        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
        }
        .student-modal-content {
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px;
        }
        .modal-header-bg { background-color: var(--bs-primary); }
        .modal-input { border: 1.5px solid #e2e8f0; border-radius: 0.5rem; padding: 0.5rem 0.75rem; width: 100%; outline: none; transition: border-color 0.2s; font-size: 0.95rem; }
        .modal-input:focus { border-color: var(--bs-primary); }
        
        .photo-box { border: 2px dashed #cbd5e1; border-radius: 0.75rem; width: 100px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: #94a3b8; background-color: white; transition: all 0.2s; }
        .photo-box:hover { border-color: var(--bs-primary); background-color: #f8fafc; }

        #cover-print-container, #achievement-print-container { display: none; }
        
        .cover-table td, .cover-table th { border: 1px solid black; padding: 3px; text-align: center; font-size: 10pt; }
        .cover-label { font-weight: normal; }
        .cover-value { font-weight: bold; border-bottom: 1px dotted black; padding: 0 4px; }
        .summary-table td { border: 1px solid #cbd5e1; padding: 4px 8px; text-align: center; }
        
        .sig-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 20px; width: 100%; }
        .sig-box { display: flex; flex-direction: column; align-items: center; }
        .sig-line-wrapper { display: flex; align-items: flex-end; width: 100%; margin-bottom: 2px; }
        .sig-label { white-space: nowrap; margin-right: 4px; font-size: 10pt; }
        .sig-dotted-line { flex-grow: 1; border-bottom: 1px dotted black; height: 16px; }
        .sig-position { margin-left: 4px; font-size: 10pt; }
        .sig-name-under { text-align: center; font-size: 10pt; margin-top: 1px; }

        .chart-bar-container { display: flex; flex-direction: column; justify-content: flex-end; align-items: center; height: 100%; width: 100%; transition: height 0.5s ease; }
        .chart-gradient-4 { background: linear-gradient(to top, #15803d, #4ade80); }
        .chart-gradient-3-5 { background: linear-gradient(to top, #0f766e, #2dd4bf); }
        .chart-gradient-3 { background: linear-gradient(to top, #0369a1, #38bdf8); }
        .chart-gradient-2-5 { background: linear-gradient(to top, #4338ca, #818cf8); }
        .chart-gradient-2 { background: linear-gradient(to top, #7e22ce, #c084fc); }
        .chart-gradient-1-5 { background: linear-gradient(to top, #db2777, #f472b6); }
        .chart-gradient-1 { background: linear-gradient(to top, #ea580c, #fb923c); }
        .chart-gradient-0 { background: linear-gradient(to top, #b91c1c, #f87171); }

        .ach-table th { background-color: #f3f4f6; font-size: 8pt; vertical-align: middle; text-align: center; border: 1px solid black; }
        .ach-table td { border: 1px solid black; font-size: 8pt; text-align: center; padding: 3px; }
        
        .ach-graph-container { width: 100%; height: 200px; display: flex; align-items: flex-end; gap: 4px; padding-bottom: 20px; border-bottom: 1px solid #ccc; position: relative; }
        .ach-bar { background-color: var(--bs-primary); min-width: 10px; flex-grow: 1; position: relative; transition: height 0.3s; }
        .ach-bar-label { position: absolute; bottom: -20px; left: 0; right: 0; text-align: center; font-size: 8pt; }
        .ach-bar-val { position: absolute; top: -15px; left: 0; right: 0; text-align: center; font-size: 8pt; font-weight: bold; }
        
        .settings-tab-btn.active { color: var(--bs-primary); border-bottom: 2px solid var(--bs-primary); }

        /* Bootstrap helper classes override */
        .btn-primary { background-color: var(--bs-primary) !important; }
        .btn-success { background-color: var(--bs-success) !important; }
        .btn-danger { background-color: var(--bs-danger) !important; }
        .btn-warning { background-color: var(--bs-warning) !important; color: #000 !important; }
        .btn-info { background-color: var(--bs-info) !important; color: #000 !important; }
        .btn-secondary { background-color: var(--bs-secondary) !important; }
        .app-banner {
            width: 100%;
            max-height: 300px; 
            object-fit: cover; 
            border-radius: 0.5rem;
            margin-bottom: 1.5rem; 
        }

		.marquee-container {
				overflow: hidden;
				white-space: nowrap;
				position: relative;
			}
			
			.marquee-text {
				display: inline-block;
				padding-left: 100%; /* เริ่มต้นจากขวาสุด */
				animation: scroll-text 15s linear infinite; /* ความเร็ว 15 วินาที */
			}

			/* หยุดวิ่งเมื่อเอาเมาส์ไปชี้ */
			.marquee-container:hover .marquee-text {
				animation-play-state: paused;
			}

			@keyframes scroll-text {
				0% { transform: translateX(0); }
				100% { transform: translateX(-100%); }
			}
		

			.ach-table thead tr:first-child th {
				background-color: #fcd34d !important; /* รหัสสีของ bg-amber-300 */
				color: #0f172a !important; /* สีตัวอักษร text-slate-900 */
			}

			.ach-table thead tr:last-child th {
				background-color: #fef3c7 !important; /* รหัสสีของ bg-amber-100 */
			}
			/* 2. บังคับเส้นขอบของ "กล่องคะแนนเต็ม" (ที่แสดง คะแนนเต็ม | ผ่าน) ในหัวตารางให้เป็นสีดำ */
			.view-section table thead th div[class*="border"] {
			border-color: #000000 !important;
			}
			/* 1. บังคับเส้นขอบของเซลล์หัวตาราง (Grid) ให้เป็นสีดำและมีเส้นรอบด้าน */
			/*.view-section table thead th {
            border: 1px solid #000000 !important;
            border-color: #000000 !important;
			}*/

			/* --- เพิ่มโค้ดส่วนนี้ลงในครับ --- */

			/* 1. บังคับให้ปุ่มและลิงก์ทุกตัวเป็นรูปมือ */
			button, a, input[type="button"], input[type="submit"] {
				cursor: pointer !important;
			}

			/* 2. บังคับให้ Element ที่มี onclick เป็นรูปมือทั้งหมด (แก้ปัญหา div ที่คลิกได้) */
			[onclick] {
				cursor: pointer !important;
			}

			/* 3. ยกเว้นเฉพาะส่วนที่ถูกสั่งปิดการทำงาน (Disabled) */
			[disabled], .pointer-events-none {
				cursor: default !important;
			}


			.bg-score-3 { background-color: #86efac !important; color: #14532d; } /* สีเขียว */
			.bg-score-2 { background-color: #fde047 !important; color: #854d0e; } /* สีเหลือง */
			.bg-score-1 { background-color: #fdba74 !important; color: #9a3412; } /* สีส้ม */
			.bg-score-0 { background-color: #f87171 !important; color: #7f1d1d; } /* สีแดง */
			
			
			/* --- New Features: Connection Monitor & UI --- */
			#connection-monitor {
				position: fixed;
				top: 10px;
				right: 10px;
				background: rgba(255, 255, 255, 0.95);
				padding: 8px 15px;
				border-radius: 30px;
				box-shadow: 0 4px 15px rgba(0,0,0,0.15);
				display: flex;
				align-items: center;
				gap: 12px;
				z-index: 100000; /* สูงสุด */
				font-family: 'Sarabun', sans-serif;
				font-size: 12px;
				border: 1px solid #e2e8f0;
				transition: all 0.3s ease;
			}

			#connection-monitor:hover {
				transform: translateY(2px);
				box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			}

			.conn-dot {
				width: 10px;
				height: 10px;
				border-radius: 50%;
				display: inline-block;
				box-shadow: 0 0 0 2px rgba(255,255,255,0.8);
			}
			.conn-good { background-color: #22c55e; box-shadow: 0 0 8px #22c55e; }
			.conn-fair { background-color: #eab308; box-shadow: 0 0 8px #eab308; }
			.conn-poor { background-color: #ef4444; box-shadow: 0 0 8px #ef4444; }
			.conn-offline { background-color: #64748b; animation: pulse-gray 2s infinite; }

			.speed-text { font-weight: bold; color: #334155; display: flex; flex-direction: column; line-height: 1.1; }
			.speed-val { font-size: 10px; color: #64748b; }

			.queue-badge {
				background: #f97316;
				color: white;
				padding: 1px 6px;
				border-radius: 10px;
				font-size: 10px;
				font-weight: bold;
				display: none; /* ซ่อนถ้าไม่มีคิว */
				animation: bounce 1s infinite;
			}

			@keyframes pulse-gray { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
			@keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }

			/* Notification Bar เมื่อเน็ตหลุด */
			#offline-alert-bar {
				position: fixed;
				top: 0; left: 0; width: 100%;
				background: #ef4444;
				color: white;
				text-align: center;
				padding: 4px;
				font-size: 12px;
				font-weight: bold;
				z-index: 100001;
				display: none;
				transform: translateY(-100%);
				transition: transform 0.3s;
			}
			#offline-alert-bar.show { transform: translateY(0); display: block; }
			
    </style>
	<script>
    // ทำให้ Browser ค้างเมื่อเปิด DevTools
    setInterval(function(){
        debugger;
    }, 1000);
	</script>
</head>
<body class="border-primary p-1 md:p-1 print-portrait" id="app-body">


		<div id="offline-alert-bar">
			<i class="fa-solid fa-wifi-slash"></i> ขาดการเชื่อมต่ออินเทอร์เน็ต - ระบบกำลังทำงานในโหมด Offline (บันทึกข้อมูลลงเครื่อง)
		</div>

		<div id="connection-monitor" class="no-print">
			<div id="conn-status-dot" class="conn-dot conn-good"></div>
			<div class="speed-text">
				<span id="conn-ping">Ping: -- ms</span>
				<span id="conn-speed" class="speed-val">-- Mbps</span>
			</div>
			<div id="sync-queue-badge" class="queue-badge" title="รายการรอส่งข้อมูล">
				<i class="fa-solid fa-cloud-arrow-up"></i> <span id="queue-count">0</span>
			</div>
		</div>


    <!-- Loading Overlay -->
		<div id="loading-overlay">
				
				<div class="mb-4">
					<img src="https://cdn-icons-gif.flaticon.com/13373/13373711.gif" 
						 alt="Loading..." 
						 class="w-20 h-20 object-contain drop-shadow-md">
				</div>

				<div class="w-80 bg-gray-200 rounded-full dark:bg-gray-700 shadow-inner border border-slate-200 p-1">
					<div id="loading-progress-bar" 
						 class="bg-gradient-to-r from-blue-500 to-indigo-600 text-xs font-bold text-white text-center p-1.5 leading-none rounded-full animate-progress-stripes shadow-sm tracking-wide transition-all duration-300 ease-out" 
						 style="width: 0%">
						 0%
					</div>
				</div>
				
				<p class="mt-2 text-xs font-bold text-slate-500 animate-pulse">กำลังประมวลผลข้อมูล...</p>
			</div>

			<!-- Login Modal -->
			<div id="login-modal" class="fixed inset-0 z-[9999] bg-slate-900/90 backdrop-blur-sm flex items-center justify-center font-['Sarabun'] hidden">
				<!-- ปรับความกว้างจาก max-w-md เป็น max-w-2xl -->
				<div class="bg-white w-full max-w-xl rounded-xl shadow-xl overflow-hidden border border-slate-200 p-6 transform transition-all scale-100 relative">
					
					<div class="text-center mb-2">
						<div class="w-36 h-36 flex items-center justify-center mx-auto">
							<img src="https://lh3.googleusercontent.com/d/17nowPco3WNP-0d9lFZG_VQkc-vm46mQc" class="max-w-full max-h-full object-contain" alt="School Logo">
						</div>
						
						<h2 class="text-2xl font-bold text-slate-800 mb-2">KT | PP5 Online System</h2>
						
						<div class="text-center mt-2 mb-2 no-print marquee-container" style="color:#000000; font-size: 16px; margin-top: 2px; margin-bottom: 2px;">
								<h3 class="marquee-text" style="margin-top: 2px; margin-bottom: 2px;">
									ยินดีต้อนรับเข้าสู่ระบบบันทึกคะแนนออนไลน์ :: ออกแบบและพัฒนาโดย KT | Tanasarn Sirak
								</h3>
							</div>
					</div>
					<hr class="mt-4 mb-4 border-t-4 border-rose-400">
					<div class="space-y-2">
						<!-- จัดวาง Username และ Password ให้อยู่คู่กันด้วย Grid -->
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่อผู้ใช้ (Username)</label>
								<div class="relative">
									<i class="fa-solid fa-user absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 "></i>
									<input type="text" id="login-username" class="w-full pl-10 pr-4 py-2 bg-lime-200 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 font-bold transition-all" placeholder="ระบุชื่อผู้ใช้">
								</div>
							</div>

							<div>
								<label class="block text-xs font-bold text-slate-500 uppercase mb-1">รหัสผ่าน (Password)</label>
								<div class="relative">
									<i class="fa-solid fa-key absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
									
									<input type="password" id="login-password" class="w-full pl-10 pr-10 py-2 bg-lime-200 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-slate-700 font-bold transition-all" placeholder="ระบุรหัสผ่าน">
									
									<i id="toggle-password-icon" onclick="togglePasswordVisibility()" class="fa-solid fa-eye absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 cursor-pointer hover:text-slate-600 transition-colors" title="แสดง/ซ่อนรหัสผ่าน"></i>
								</div>
							</div>
						</div>

						<div class="pt-2">
							<label class="block text-xs font-bold text-slate-500 uppercase mb-1">รหัสความปลอดภัย (CAPTCHA)</label>
							<div class="flex gap-3">
								<div id="captcha-display" class="w-1/2 bg-slate-800 rounded-lg flex items-center justify-center relative overflow-hidden select-none group cursor-pointer border-2 border-slate-600" onclick="generateCaptcha()" title="คลิกเพื่อเปลี่ยนรหัส">
									<span id="captcha-text" class="text-xl font-bold text-white tracking-[0.2em] font-mono z-10" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5); letter-spacing: 4px;">ABCD</span>
									<div class="absolute inset-0 bg-gradient-to-tr from-white/10 to-transparent"></div>
									<div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity bg-black/50">
										<i class="fa-solid fa-arrows-rotate text-white"></i>
									</div>
								</div>
								<input type="text" id="login-captcha" class="w-1/2 px-4 py-1 bg-lime-200 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold uppercase tracking-widest text-lg" placeholder="ระบุรหัส" maxlength="6">
							</div>
						</div>
					</div>

					<div class="flex gap-3 mt-3">
						<button onclick="performLogin(this)" class="group w-1/2 px-3 py-2 rounded bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold shadow-lg shadow-blue-200 hover:shadow-blue-300 transform hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
							<i class="fa-solid fa-right-to-bracket"></i> เข้าสู่ระบบ
						</button>

						<label class="w-1/2 flex items-center gap-2 cursor-pointer select-none justify-start pl-1">
							<input type="checkbox" id="login-remember" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
							<span class="text-xs font-bold text-slate-500 uppercase">จดจำการเข้าสู่ระบบ</span>
						</label>
					</div>
					<hr class="mt-2 mb-2"></hr>
					 <div class="mt-0 text-center">
						<footer style="text-align: center;background-color:#faff99; padding: 10px 0; margin-top: auto; border-top: 1px solid #e0e0e0; font-size: 0.9em; color: #555; width: 100%;">
							:: Created and Develop by KT|Tanasarn Sirak ::
							<div class="container text-center">
							<a href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"><i class="fa-solid fa-comments"></i></a> <a style="color:red;text-decoration:none;font-size:12px" href="https://line.me/ti/p/3F7VGrqgUr" target="_blank"> สอบถาม/แจ้งปัญหา :: <span style="font-size:12px;color:black">KT | Tanasarn Sirak ©2569 </a>
							</div>
						</footer>
					</div>
				</div>
			</div>


    <div id="app-body-container" class="max-w-full mx-auto bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200 px-5 py-5">
        <div class="text-center no-print"> 
            <img src="https://lh5.googleusercontent.com/d/1IP4VCENwM2RGpT93ananc9hfioLuJ3rY" 
                     alt="Form Banner" 
                     class="app-banner img-fluid"
                     onerror="this.onerror=null;this.src='https://lh5.googleusercontent.com/d/1IP4VCENwM2RGpT93ananc9hfioLuJ3rY';">
        </div>
			
		<div class="text-center mt-3 mb-3 no-print">
            <marquee behavior="scroll" direction="left" style="color:#000000; font-size: 18px;margin-top: 2px; margin-bottom: 2px;" onmouseover="this.stop();" onmouseout="this.start();"><h3 style="margin-top: 2px; margin-bottom: 4px;"> ยินดีต้อนรับเข้าสู่ระบบบันทึกคะแนนออนไลน์ :: ออกแบบและพัฒนาโดย KT | Tanasarn Sirak </h3></marquee>
		</div>
		
        <!-- ส่วนพิมพ์ปก -->
        <div id="cover-print-container" class="text-black bg-white font-['Sarabun']">
            <div class="flex justify-between items-start mb-1 px-4 pt-4">
                <div class="w-[80px] shrink-0"></div> 
                <div class="text-center flex-grow">
                    <div class="mx-auto mb-1 w-28 h-28 flex items-center justify-center">
                        <img src="https://lh3.googleusercontent.com/d/1kefVKvkBvHwQf6b5-X64He_L43uJKR5M" class="max-w-full max-h-full object-contain" alt="School Logo">
                    </div>
                    <h1 class="text-xl font-bold mb-0.5" id="cover-school-name">โรงเรียนปากช่อง</h1>
                    <p class="text-sm" id="cover-affiliation">สำนักงานเขตพื้นที่การศึกษามัธยมศึกษานครราชสีมา</p>
                </div>
				<div id="cover-doc-type" class="border-[1.5px] border-black px-2 py-0.5 font-bold text-base whitespace-nowrap mt-2">
					ปพ.5 : พ
				</div>
            </div>
            
            <div class="text-center mb-1.5">
                <h2 class="text-lg font-bold">แบบบันทึกผลการเรียนประจำรายวิชา</h2>
            </div>

            <div class="grid grid-cols-2 gap-y-0.5 mb-2 text-[10pt] px-6 font-['Sarabun']">
                <div><span class="cover-label">ระดับชั้น</span> <span id="cover-grade-level" class="cover-value min-w-[60px] inline-block text-center">-</span> <span class="cover-label ml-2">ห้อง</span> <span id="cover-room" class="cover-value min-w-[40px] inline-block text-center">-</span></div>
                <div class="text-right"><span class="cover-label">ปีการศึกษา</span> <span id="cover-year" class="cover-value min-w-[60px] inline-block text-center">-</span> <span class="cover-label ml-2">ภาคเรียนที่</span> <span id="cover-semester" class="cover-value min-w-[30px] inline-block text-center">-</span></div>
                
                <div class="col-span-2"><span class="cover-label">กลุ่มสาระการเรียนรู้</span> <span id="cover-head-dept-name" class="cover-value min-w-[320px] inline-block">-</span></div>
                
                <div class="col-span-2">
                    <span class="cover-label">รายวิชา</span> <span id="cover-subject-name" class="cover-value min-w-[384px] inline-block">-</span>
                    <span class="cover-label ml-6">รหัสวิชา</span> <span id="cover-course-code" class="cover-value min-w-[85px] inline-block text-center">-</span>
                </div>
                
                <div class="col-span-2 flex gap-2">
                    <div><span class="cover-label">ลักษณะวิชา</span> <span id="cover-subject-type" class="cover-value min-w-[100px] inline-block text-center">-</span></div>
                    <div class="flex-grow">
                        <span class="cover-label" style="margin-left: 50px;">เวลาเรียน</span> <span id="cover-hours" class="cover-value min-w-[40px] inline-block text-center">-</span> <span class="cover-label">ชั่วโมง/สัปดาห์</span>
                        <span class="cover-label" style="margin-left: 50px;">จำนวน</span> <span id="cover-credits" class="cover-value min-w-[40px] inline-block text-center">-</span> <span class="cover-label">หน่วยกิต</span>
                    </div>
                </div>
                
                <div class="col-span-2">
                    <span class="cover-label">ครูผู้สอน</span> <span id="cover-teacher-name" class="cover-value min-w-[210px] inline-block">-</span>
                    <span class="cover-label ml-3">ครูที่ปรึกษา</span> <span id="advisor-name" class="cover-value min-w-[315px] inline-block">-</span>
                </div>
            </div>

            <div class="px-4 mb-1.5">
                <div class="text-[9pt] font-bold mb-0.5">1. สรุปผลการประเมินผลสัมฤทธิ์ทางการเรียน</div>
                <table class="w-full cover-table font-['Sarabun'] cover-compact-table">
                    <thead>
                        <tr class="bg-gray-100">
                            <td rowspan="2" class="w-12 font-bold">จำนวน<br>นักเรียน</td>
                            <td colspan="8" class="font-bold">ระดับผลการเรียน (เฉลี่ย <span id="cover-avg-grade" class="underline">-</span>)</td>
                            <td colspan="5" class="font-bold">ผลการประเมิน</td>
                        </tr>
                        <tr class="bg-gray-5 text-[9pt]">
                            <td class="w-7">4</td><td class="w-7">3.5</td><td class="w-7">3</td><td class="w-7">2.5</td><td class="w-7">2</td><td class="w-7">1.5</td><td class="w-7">1</td><td class="w-7">0</td>
                            <td class="w-7">ร</td><td class="w-7">มส</td><td class="w-7">มก</td><td class="w-7">ผ</td><td class="w-7">มผ</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="h-5">
                            <td rowspan="2" id="cover-total-stu" class="text-base font-bold">-</td>
                            <td id="cover-stat-4">-</td><td id="cover-stat-3.5">-</td><td id="cover-stat-3">-</td><td id="cover-stat-2.5">-</td><td id="cover-stat-2">-</td><td id="cover-stat-1.5">-</td><td id="cover-stat-1">-</td><td id="cover-stat-0">-</td>
                            <td id="stat-cover-ร">-</td><td id="stat-cover-มส">-</td><td id="stat-cover-มก">-</td><td id="stat-cover-ผ">-</td><td id="stat-cover-มผ">-</td>
                        </tr>
                        <tr class="text-[8pt] h-4">
                            <td id="cover-pct-4">-</td><td id="cover-pct-3.5">-</td><td id="cover-pct-3">-</td><td id="cover-pct-2.5">-</td><td id="cover-pct-2">-</td><td id="cover-pct-1.5">-</td><td id="cover-pct-1">-</td><td id="cover-pct-0">-</td>
                            <td id="cover-pct-ร">-</td><td id="cover-pct-มส">-</td><td id="cover-pct-มก">-</td><td id="cover-pct-ผ">-</td><td id="cover-pct-มผ">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- สรุปผลอื่นๆ -->
            <div class="px-4 flex gap-2 mb-2">
                <div class="flex-1">
                    <div class="text-[9pt] font-bold mb-0.5 text-left">2. ประเมินการอ่านฯ</div>
                    <table class="w-full cover-table font-['Sarabun'] cover-compact-table">
                        <thead>
                            <tr class="bg-gray-100 text-[8pt]">
                                <th class="w-8">ระดับ</th>
                                <th>3</th><th>2</th><th>1</th><th>0</th>
                                <th class="w-8">รวม</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">คน</td>
                                <td id="cover-read-3">-</td><td id="cover-read-2">-</td><td id="cover-read-1">-</td><td id="cover-read-0">-</td>
                                <td id="cover-read-total">-</td>
                            </tr>
                            <tr>
                                <td class="font-bold">%</td>
                                <td id="cover-read-pct-3">-</td><td id="cover-read-pct-2">-</td><td id="cover-read-pct-1">-</td><td id="cover-read-pct-0">-</td>
                                <td id="cover-read-pct-total">100</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="flex-1">
                    <div class="text-[9pt] font-bold mb-0.5 text-left">3. คุณลักษณะฯ</div>
                    <table class="w-full cover-table font-['Sarabun'] cover-compact-table">
                        <thead>
                            <tr class="bg-gray-100 text-[8pt]">
                                <th class="w-8">ระดับ</th>
                                <th>3</th><th>2</th><th>1</th><th>0</th>
                                <th class="w-8">รวม</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">คน</td>
                                <td id="cover-attr-3">-</td><td id="cover-attr-2">-</td><td id="cover-attr-1">-</td><td id="cover-attr-0">-</td>
                                <td id="cover-attr-total">-</td>
                            </tr>
                            <tr>
                                <td class="font-bold">%</td>
                                <td id="cover-attr-pct-3">-</td><td id="cover-attr-pct-2">-</td><td id="cover-attr-pct-1">-</td><td id="cover-attr-pct-0">-</td>
                                <td id="cover-attr-pct-total">100</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="flex-1">
                    <div class="text-[9pt] font-bold mb-0.5 text-left">4. สมรรถนะสำคัญ</div>
                    <table class="w-full cover-table font-['Sarabun'] cover-compact-table">
                        <thead>
                            <tr class="bg-gray-100 text-[8pt]">
                                <th class="w-8">ระดับ</th>
                                <th>3</th><th>2</th><th>1</th><th>0</th>
                                <th class="w-8">รวม</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td class="font-bold">คน</td>
                                <td id="cover-comp-3">-</td><td id="cover-comp-2">-</td><td id="cover-comp-1">-</td><td id="cover-comp-0">-</td>
                                <td id="cover-comp-total">-</td>
                            </tr>
                            <tr>
                                <td class="font-bold">%</td>
                                <td id="cover-comp-pct-3">-</td><td id="cover-comp-pct-2">-</td><td id="cover-comp-pct-1">-</td><td id="cover-comp-pct-0">-</td>
                                <td id="cover-comp-pct-total">100</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="px-4 mb-3 mt-1">
                <div class="bg-yellow-400 py-2 text-[9pt] font-bold mb-0.5 text-left border-l-4 border-indigo-600 pl-2">สรุปผลสัมฤทธิ์ทางการเรียน (ร้อยละของนักเรียนตามระดับผลการเรียน)</div>
                <div class="h-[100px] w-full flex items-end justify-between px-2 pt-4 pb-0 border-b border-l border-slate-300 relative bg-white gap-2">
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-4" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-4" class="w-full rounded-t-sm chart-gradient-4 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">4</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-3.5" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-3.5" class="w-full rounded-t-sm chart-gradient-3-5 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">3.5</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-3" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-3" class="w-full rounded-t-sm chart-gradient-3 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">3</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-2.5" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-2.5" class="w-full rounded-t-sm chart-gradient-2-5 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">2.5</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-2" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-2" class="w-full rounded-t-sm chart-gradient-2 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">2</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-1.5" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-1.5" class="w-full rounded-t-sm chart-gradient-1-5 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">1.5</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-1" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-1" class="w-full rounded-t-sm chart-gradient-1 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">1</span></div>
                    <div class="flex-1 flex flex-col justify-end items-center h-full group relative"><span id="chart-val-0" class="text-[9px] font-bold mb-0.5 z-10">0%</span><div id="chart-bar-0" class="w-full rounded-t-sm chart-gradient-0 shadow-sm relative" style="height: 0%;"></div><span class="text-[9px] font-bold mt-1 text-slate-700">0</span></div>
                </div>
            </div>

            <div class="px-4 border-[1.5px] border-black py-1.5 rounded-lg mx-4">
                <div class="font-bold mb-7 text-sm underline text-center">การอนุมัติผลการเรียน</div>
                <div class="sig-grid text-[10pt] font-['Sarabun']">
                    
                    <div class="sig-box mb-7">
                        <div class="sig-line-wrapper">
                            <span class="sig-label">ลงชื่อ</span>
                            <div class="sig-dotted-line"></div>
                            <span class="sig-position">ครูผู้สอน</span>
                        </div>
                        <div class="sig-name-under">( <span id="sig-cover-teacher">-</span> )</div>
                    </div>

                    <div class="sig-box mb-7">
                        <div class="sig-line-wrapper">
                            <span class="sig-label">ลงชื่อ</span>
                            <div class="sig-dotted-line"></div>
                            <span class="sig-position">หัวหน้ากลุ่มสาระฯ</span>
                        </div>
                        <div class="sig-name-under">( <span id="sig-cover-head-dept">-</span> )</div>
                    </div>

                    <div class="sig-box mb-7">
                        <div class="sig-line-wrapper">
                            <span class="sig-label">ลงชื่อ</span>
                            <div class="sig-dotted-line"></div>
                            <span class="sig-position">หัวหน้างานวัดผล</span>
                        </div>
                        <div class="sig-name-under">( <span id="sig-cover-head-eval">-</span> )</div>
                    </div>

                    <div class="sig-box mb-7">
                        <div class="sig-line-wrapper">
                            <span class="sig-label">ลงชื่อ</span>
                            <div class="sig-dotted-line"></div>
                            <span class="sig-position">รองฯ ฝ่ายวิชาการ</span>
                        </div>
                        <div class="sig-name-under">( <span id="sig-cover-deputy">-</span> )</div>
                    </div>
                </div>

                <div class="flex items-center gap-4 pt-2 mt-1 border-t border-dotted border-gray-300">
                    <div class="flex flex-col gap-0.5 ml-1 text-[9pt]">
                    <div class="flex items-center gap-2 font-bold"><div class="w-3.5 h-3.5 border-[1.5px] border-black"></div> อนุมัติ   
						<div class="w-3.5 h-3.5 border-[1.5px] border-black ms-4"></div> ไม่อนุมัติ</div>
                        
                    </div>
                    <div class="flex-grow flex flex-col items-center">
                        <div class="flex items-end w-[240px] mb-0.5 mt-7">
                            <span class="mr-2 text-[10pt]">ลงชื่อ</span>
                            <div class="border-b border-dotted border-black flex-grow h-4"></div>
                        </div>
                        <div class="font-bold text-center text-[10pt] mb-0.5">( <span id="sig-cover-director">-</span> )</div>
                        <div class="font-bold text-sm text-center">ผู้อำนวยการโรงเรียนปากช่อง</div>
						<div class="cover-value min-w-[180px] inline-block mt-6"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ส่วนพิมพ์รายงานผลสัมฤทธิ์ -->
        <div id="achievement-print-container" class="font-['Sarabun'] text-black p-4">
            <h2 class="text-xl font-bold text-center mb-1">สรุปผลสัมฤทธิ์ทางการเรียนของผู้เรียน กลุ่มสาระการเรียนรู้<span id="ach-dept-name"></span></h2>
            <div class="text-center font-bold mb-1">
                ครูผู้สอน <span id="ach-teacher-name"></span> ภาคเรียนที่ <span id="ach-sem"></span> ปีการศึกษา <span id="ach-year"></span>
            </div>
            <div class="text-center font-bold mb-4">
                <span id="ach-school-name">โรงเรียนปากช่อง</span> อำเภอปากช่อง จังหวัดนครราชสีมา
            </div>

            <table class="w-full ach-table mb-4 border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th rowspan="2" style="width: 80px;">รหัสวิชา</th>
                        <th rowspan="2">ชั้น</th>
                        <th rowspan="2" class="w-10">จำนวน<br>นักเรียน</th>
                        <th colspan="10">จำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
                        <th rowspan="2" class="w-8">รวม</th>
                        <th colspan="10">ร้อยละจำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
                        <th rowspan="2" class="w-10">ร้อยละ<br>รวม</th>
                        <th rowspan="2" class="w-10">A.V.</th>
                        <th rowspan="2" class="w-10">S.D.</th>
                        <th rowspan="2" class="w-10">%ผ่านเกณฑ์</th>
                        <th rowspan="2" class="w-12">%ระดับ<br>ดีขึ้นไป</th>
                        <th rowspan="2" class="w-12">%ไม่ผ่าน<br>เกณฑ์</th>
                        <th rowspan="2" class="w-16">สรุป<br>ผลสัมฤทธิ์</th>
                    </tr>
                    <tr class="bg-gray-50">
                        <th class="w-6">4.0</th><th class="w-6">3.5</th><th class="w-6">3.0</th><th class="w-6">2.5</th><th class="w-6">2.0</th><th class="w-6">1.5</th><th class="w-6">1.0</th><th class="w-6">0</th><th class="w-6">ร</th><th class="w-6">มส</th>
                        <th class="w-8">4.0</th><th class="w-8">3.5</th><th class="w-8">3.0</th><th class="w-8">2.5</th><th class="w-8">2.0</th><th class="w-8">1.5</th><th class="w-8">1.0</th><th class="w-8">0</th><th class="w-8">ร</th><th class="w-8">มส</th>
                    </tr>
                </thead>
                <tbody id="ach-table-body"></tbody>
                <tfoot id="ach-table-foot" class="font-bold bg-gray-50"></tfoot>
            </table>

            <div class="mb-4 text-[9pt] px-4">
                <div class="grid grid-cols-3 gap-x-8 gap-y-1">
                    <div>1. ร้อยละค่าเป้าหมายระดับสถานศึกษา: <span id="ach-target-school-pct" class="font-bold">-</span></div>
                    <div>2. ร้อยละค่าเป้าหมายระดับกลุ่มสาระฯ: <span id="ach-target-dept-pct" class="font-bold">-</span></div>
                    <div>3. ร้อยละค่าเป้าหมายระดับสาขาวิชา: <span id="ach-target-subject-pct" class="font-bold">-</span></div>
                    <div>4. ผลการเรียนเฉลี่ยระดับสถานศึกษา &ge; <span id="ach-target-school-gpa" class="font-bold">-</span></div>
                    <div>5. ผลการเรียนเฉลี่ยระดับกลุ่มสาระฯ &ge; <span id="ach-target-dept-gpa" class="font-bold">-</span></div>
                    <div>6. ผลการเรียนเฉลี่ยระดับสาขาวิชา &ge; <span id="ach-target-subject-gpa" class="font-bold">-</span></div>
                </div>
            </div>

            <div class="flex gap-4 mb-4 h-[240px]">
                <div class="flex-1 border border-gray-300 p-2 relative">
                    <div class="text-[10pt] font-bold text-center mb-2">กราฟแสดงร้อยละของจำนวนนักเรียนต่อผลการเรียน</div>
                    <div id="ach-chart-1" class="ach-graph-container"></div>
                    <div class="text-center text-[9pt] mt-1">ผลการเรียน</div>
                </div>
                <div class="flex-1 border border-gray-300 p-2 relative">
                    <div class="text-[10pt] font-bold text-center mb-2">กราฟแสดงจำนวนนักเรียนต่อผลการเรียน</div>
                    <div id="ach-chart-2" class="ach-graph-container"></div>
                    <div class="text-center text-[9pt] mt-1">ผลการเรียน</div>
                </div>
            </div>

            <div class="flex justify-end mt-8 pr-16">
                <div class="text-center">
                    <div class="mb-1 mt-2">ลงชื่อ ........................................................... ครูผู้สอน</div>
                    <div class="font-bold">( <span id="ach-sign-teacher">-</span> )</div>
                </div>
            </div>
        </div>

        <!-- รายงานพิมพ์หัวตารางนักเรียน -->
        <div id="report-print-header" class="hidden print:block p-4 mb-2">
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1"></div>
                <div class="flex-1 text-center">
                    <h2 class="text-xl font-bold text-black" id="print-school-name">โรงเรียนปากช่อง</h2>
                </div>
                <div class="flex-1 text-right text-[10px] text-black">
                    <div>หน้าที่ 1 จาก 1 หน้า</div>
                    <div>พิมพ์วันที่ <span id="print-date-now">-</span></div>
                </div>
            </div>
            <div class="text-center text-[13px] text-black space-y-1 font-['Sarabun']">
                <div class="font-bold">
                    วิชา <span id="print-subject-code" class="px-1 font-bold text-blue-900">-</span> 
                    <span id="print-subject-name" class="px-1 font-bold text-blue-900">-</span> 
                    <span id="print-subject-credits" class="px-1 font-bold text-blue-900">-</span> นก. 
                    ภาคเรียนที่ <span id="print-semester" class="px-1">-</span> 
                    ปีการศึกษา <span id="print-year" class="px-1">-</span> 
                    ระดับชั้น <span id="print-grade-level" class="px-1">-</span> 
                    กลุ่มที่ <span id="print-room-group" class="px-1">-</span>
                </div>
                <div class="pt-1">
                    ครูผู้สอน <span id="print-teacher-name" class="px-1 font-bold">-</span> 
                    <span class="inline-block w-8"></span>
                    ครูที่ปรึกษา <span id="print-advisor-name" class="px-1 font-bold">-</span>
                </div>
            </div>
        </div>

        <!-- Header ระบบ -->
        <div class="bg-[#0d6efd] p-6 text-white no-print shadow-inner font-['Sarabun']">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold mb-1" id="header-subject-name">ระบบจัดการข้อมูลและผลการเรียน</h1>
                    <p class="text-indigo-100 opacity-90 text-sm">
                        ครูผู้สอน: <span id="display-teacher-name">-</span> | 
                        รหัสวิชา: <span id="display-course-code">-</span> |
                        ภาคเรียนที่: <span id="display-semester">-</span> |
                        ปีการศึกษา: <span id="display-academic-year">-</span>
                    </p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="switchView('grading')" class="nav-btn btn-grad-grading px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-list-check"></i>
                        บันทึกคะแนน
                    </button>
					<button onclick="switchView('task-grading')" class="nav-btn bg-gradient-to-r from-orange-500 to-amber-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
						<i class="fa-solid fa-clipboard-list"></i>
						บันทึกคะแนนงาน
					</button>
					<button onclick="switchView('rw')" class="nav-btn bg-gradient-to-r from-pink-500 to-rose-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
						<i class="fa-solid fa-book-open-reader"></i> อ่าน/คิด/เขียน
					</button>

					<button onclick="switchView('competency')" class="nav-btn bg-gradient-to-r from-teal-500 to-cyan-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
						<i class="fa-solid fa-brain"></i> สมรรถนะ
					</button>

					<button onclick="switchView('attribute')" class="nav-btn bg-gradient-to-r from-yellow-500 to-amber-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
						<i class="fa-solid fa-star"></i> คุณลักษณะฯ
					</button>
                    <button onclick="switchView('achievement')" class="nav-btn btn-grad-achievement px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-chart-line"></i>
                        สรุปผลสัมฤทธิ์
                    </button>
                    <button onclick="switchView('students')" class="nav-btn btn-grad-students px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-users-gear"></i>
                        จัดการนักเรียน
                    </button>
					<button onclick="switchView('staff')" class="nav-btn bg-gradient-to-r from-teal-500 to-emerald-600 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
					<i class="fa-solid fa-user-tie"></i>
					จัดการบุคลากร
					</button>
					
					<button onclick="switchView('calendar')" class="nav-btn bg-gradient-to-r from-violet-500 to-purple-600 px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2 text-white shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
						<i class="fa-regular fa-calendar-days"></i>
						ปฏิทินวิชาการ
					</button>
			
                    <button onclick="switchView('settings')" class="nav-btn btn-grad-settings px-4 py-2 rounded-lg text-sm font-bold transition flex items-center gap-2">
                        <i class="fa-solid fa-gear"></i>
                        ตั้งค่าวิชา
                    </button>
					<div class="ml-auto flex items-center gap-3 pl-4 border-l border-gray-300">
					
					<div class="flex items-center gap-2">
						
						<div class="flex items-center gap-1.5 bg-green-50 text-green-700 px-2 py-0.5 rounded-full border border-green-200 shadow-sm">
							<span class="relative flex h-2 w-2">
							  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
							  <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
							</span>
							<span class="text-[10px] font-bold uppercase tracking-wide">Online</span>
							<span class="text-slate-300 text-sm font-light mx-0">|</span>
							<div id="current-user-name" class="text-sm font-bold text-gray-800">
											รอโหลดข้อมูล...
							</div>
						</div>



					</div>

					<button onclick="logoutSystem()" class="group flex items-center gap-2 bg-white hover:bg-red-50 text-red-600 border border-gray-200 hover:border-red-300 px-3 py-1 rounded-lg text-sm font-medium transition-all shadow-sm ml-2" title="ออกจากระบบ">
						<i class="fa-solid fa-power-off text-xs transition-transform group-hover:scale-110"></i>
						<span class="hidden md:inline text-xs">ออก</span>
					</button>
					
				</div>
                </div>
            </div>
        </div>

        <!-- หน้าบันทึกคะแนน -->
        <div id="grading-view" class="view-section view-active font-['Sarabun']">
			<div class="p-4 bg-slate-50 border-b flex flex-wrap items-center gap-4 no-print">
				<div class="flex items-center gap-2 font-bold text-sm text-[#0d6efd]">
					<i class="fa-solid fa-list-check"></i> 
					<span>บันทึกคะแนน</span>
					<span class="text-slate-300 text-lg font-light mx-2">|</span>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">รายวิชา:</label>
					<select id="select-subject" onchange="changeActiveSubject(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">ห้องเรียน:</label>
					<select id="select-class" onchange="changeActiveClass(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2 px-3 py-1 bg-blue-50 rounded-lg border border-blue-100 shadow-sm font-['Sarabun']">
					<label class="text-[10px] font-bold text-[#0d6efd] uppercase">ครูที่ปรึกษา:</label>
					<span id="display-advisor-name" class="text-sm font-bold text-[#0d6efd]">-</span>
				</div>
			</div>

            <!-- ย้ายปุ่มส่งออกและพิมพ์มาไว้ที่นี่และจัดกลาง -->
            <div class="p-4 flex flex-wrap justify-center items-center gap-3 no-print bg-white border-b border-slate-100">
                <button onclick="exportToCSV()" class="btn-grad-achievement px-4 py-2 text-white rounded-lg font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-file-csv"></i> CSV
                </button>
                <button onclick="exportToExcel()" class="bg-[#198754] text-white px-4 py-2 rounded-lg hover:bg-[#157347] font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-file-excel"></i> Excel
                </button>
                <button onclick="printAchievementSummary()" class="btn-grad-students px-4 py-2 text-white rounded-lg font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-chart-simple"></i> พิมพ์สรุปผลสัมฤทธิ์
                </button>
                <button onclick="printCover()" class="bg-[#212529] text-white px-4 py-2 rounded-lg hover:bg-black font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-book"></i> พิมพ์ปก ปพ. 5
                </button>
                <button onclick="printReport('all')" class="bg-rose-600 text-white px-4 py-2 rounded-lg hover:bg-rose-700 font-medium shadow-sm flex items-center gap-2 font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-file-pdf"></i> พิมพ์รายงาน ปพ. (จ และ ก)
                </button>
                <!-- ปุ่มพิมพ์รายงาน ปพ แบบที่ 2 (สีน้ำเงิน) -->
                <button onclick="printReport('max')" class="bg-[#0d6efd] text-white px-4 py-2 rounded-lg hover:bg-blue-700 font-medium shadow-sm flex items-center gap-2 font-['Sarabun'] font-bold text-xs">
                    <i class="fa-solid fa-file-invoice"></i> พิมพ์รายงาน ปพ. (ค่าสูงสุด)
                </button>
				
				<div class="text-[12px] text-red-600 font-bold italic ml-auto">*หมายเหตุ : จ = คะแนนสอบจริง, ก = คะแนนแก้ไข</div>
            </div>


			<div id="grading-pagination" class="p-4 bg-white border-t flex flex-col md:flex-row justify-between items-center gap-4 no-print border-slate-200">
				<div class="flex items-center gap-4 text-xs text-slate-500 font-['Sarabun']">
					<div class="flex items-center gap-2">
						แสดง 
						<select onchange="changePageLength(this.value)" class="border rounded p-1 bg-white text-[10px] font-bold outline-none">
							<option value="5">5</option>
							<option value="10" selected>10</option>
							<option value="20">20</option>
							<option value="50">50</option>
						</select>
					</div>
					<div id="grading-pagination-info"></div>
				</div>

				<div class="flex items-center gap-2">
					<button onclick="saveScores()" class="btn-grad-save px-6 py-1.5 text-white rounded-lg font-medium shadow-md font-['Sarabun'] font-bold text-sm uppercase hover:shadow-lg transition-all transform hover:-translate-y-0.5">
						<i class="fa-solid fa-floppy-disk"></i> บันทึก
					</button>
					<button onclick="refreshGrades()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-1.5 rounded-lg font-medium shadow-md font-['Sarabun'] font-bold text-sm uppercase transition-all transform hover:-translate-y-0.5 active:scale-95">
						<i class="fa-solid fa-arrows-rotate"></i> รีเฟรช
					</button>
					<div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8">
						<label class="relative inline-flex items-center cursor-pointer group">
							<input type="checkbox" id="toggle-task-col" class="sr-only peer" checked onchange="toggleTaskColumn(this.checked)">
							<div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
							<span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-blue-600 transition-colors">แสดงคะแนนงาน</span>
						</label>
					</div>
					<div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8 no-print">
						<label class="relative inline-flex items-center cursor-pointer group">
							<input type="checkbox" class="sr-only peer" onchange="toggleShowAllRows(this.checked)">
							<div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
							<span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-blue-600 transition-colors">แสดงทั้งหมด</span>
						</label>
					</div>
					
				</div>

				<div id="grading-pagination-controls" class="flex items-center gap-1"></div>
			</div>
			
			<div id="report-main-content" class="overflow-x-auto">
                <table class="w-full text-sm text-left border-collapse border border-slate-300">
                    <thead id="tableHeader" class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-indigo-300 font-bold"></thead>
                    <tbody id="studentTableBody"></tbody>
                </table>
            </div>

			<div id="summary-section" class="p-6 print:p-0 bg-white border-t space-y-4 border-slate-200 font-['Sarabun']">
                <div class="flex flex-col lg:flex-row print:flex-row items-start justify-between print:justify-start gap-8 print:gap-16">
                    
                    <div class="flex-grow w-full lg:w-auto print:flex-grow-0 print:w-auto">
                        <div class="grid grid-cols-3 text-[13px] font-bold text-slate-700 mb-2 px-1 print:px-0 print:mt-4">
                            <div>รวมจำนวนนักเรียน <span id="sum-total-stu" class="text-[#0d6efd] font-bold">0</span> คน</div>
                            <div class="text-center">ผลการเรียนระดับดีขึ้นไปร้อยละ <span id="sum-good-pct" class="text-[#198754] font-bold">0.00</span></div>
                            <div class="text-right">ผลการเรียนเฉลี่ยร้อยละ <span id="sum-avg-pct" class="text-[#0d6efd] font-bold">0.00</span></div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs border-collapse summary-table border-black font-['Sarabun']">
                                <tr class="bg-slate-50 font-bold text-slate-600">
                                    <td class="bg-slate-100 min-w-[120px] border-black">สรุปสถิติประเมินผล</td>
                                    <td class="w-10 border-black">4</td><td class="w-10 border-black">3.5</td><td class="w-10 border-black">3</td><td class="w-10 border-black">2.5</td><td class="w-10 border-black">2</td><td class="w-10 border-black">1.5</td><td class="w-10 border-black">1</td><td class="w-10 border-black">0</td><td class="w-10 border-black">ร</td><td class="w-10 border-black">มส</td><td class="w-10 border-black">ผ</td><td class="w-10 border-black">มผ</td>
                                </tr>
                                <tr class="font-medium text-slate-800">
                                    <td class="bg-slate-50 font-bold border-black">จำนวน</td>
                                    <td id="stat-4" class="border-black">-</td><td id="stat-3.5" class="border-black">-</td><td id="stat-3" class="border-black">-</td><td id="stat-2.5" class="border-black">-</td><td id="stat-2" class="border-black">-</td><td id="stat-1.5" class="border-black">-</td><td id="stat-1" class="border-black">-</td><td id="stat-0" class="border-black">-</td><td id="stat-ร" class="border-black">-</td><td id="stat-มส" class="border-black">-</td><td id="stat-ผ" class="border-black">-</td><td id="stat-มผ" class="border-black">-</td>
                                </tr>
								<tr class="font-medium text-slate-800">
									<td class="bg-slate-50 font-bold border-black">ร้อยละ</td>
									<td id="stat-pct-4" class="border-black">-</td><td id="stat-pct-3.5" class="border-black">-</td><td id="stat-pct-3" class="border-black">-</td><td id="stat-pct-2.5" class="border-black">-</td><td id="stat-pct-2" class="border-black">-</td><td id="stat-pct-1.5" class="border-black">-</td><td id="stat-pct-1" class="border-black">-</td><td id="stat-pct-0" class="border-black">-</td><td id="stat-pct-ร" class="border-black">-</td><td id="stat-pct-มส" class="border-black">-</td><td id="stat-pct-ผ" class="border-black">-</td><td id="stat-pct-มผ" class="border-black">-</td>
								</tr>
                            </table>
                        </div>
                    </div>

                    <div class="text-sm text-slate-700 w-full lg:w-[400px] print:w-auto shrink-0 lg:pt-7 print:pt-6">
                        <div class="flex items-end justify-center lg:justify-end gap-1 mb-2 whitespace-nowrap">
                            <span>ลงชื่อ</span>
                            <div class="flex-grow border-b border-dotted border-black mb-1.5 mx-1 min-w-[180px]"></div>
                            <span>ครูผู้สอน</span>
                        </div>
                        <div class="text-center mt-1 font-bold">( <span id="sig-teacher-name">-</span> )</div>
                        <div class="text-center mt-2 font-bold" id="sig-date">-</div>
                    </div>
                </div>
            </div>
        </div>
		
		<div id="task-grading-view" class="view-section font-['Sarabun'] ">
			<div class="p-4 bg-slate-50 border-b flex flex-wrap items-center gap-4 no-print">
				<div class="flex items-center gap-2 font-bold text-sm text-orange-600">
					<i class="fa-solid fa-clipboard-list"></i> 
					<span>บันทึกคะแนนงาน</span>
					<span class="text-slate-300 text-lg font-light mx-2">|</span>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">รายวิชา:</label>
					<select id="select-subject-task" onchange="changeActiveSubject(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">ห้องเรียน:</label>
					<select id="select-class-task" onchange="changeActiveClass(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				 <div class="flex items-center gap-2 px-3 py-1 bg-blue-50 rounded-lg border border-blue-100 shadow-sm font-['Sarabun']">
					<label class="text-[10px] font-bold text-[#0d6efd] uppercase">ครูที่ปรึกษา:</label>
					<span id="display-advisor-task" class="text-sm font-bold text-[#0d6efd]">-</span>
				</div>

			</div>

			<div id="task-pagination" class="p-4 bg-white border-b flex flex-col md:flex-row justify-between items-center gap-4 no-print border-slate-200">
				<div class="flex items-center gap-4 text-xs text-slate-500 font-['Sarabun']">
					<div class="flex items-center gap-2">
						แสดง 
						<select onchange="changePageLength(this.value)" class="border rounded p-1 bg-white text-[10px] font-bold outline-none">
							<option value="10" selected>10</option>
							<option value="20">20</option>
							<option value="50">50</option>
						</select>
					</div>
					<div id="task-pagination-info"></div>
				</div>

				<div class="flex items-center gap-2">
					<button onclick="saveScores()" class="btn-grad-save px-6 py-1.5 text-white rounded-lg font-medium shadow-md font-['Sarabun'] font-bold text-sm uppercase hover:shadow-lg transition-all transform hover:-translate-y-0.5">
						<i class="fa-solid fa-floppy-disk"></i> บันทึกคะแนนงาน
					</button>
					<button onclick="initTaskTable()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-1.5 rounded-lg font-medium shadow-md font-['Sarabun'] font-bold text-sm uppercase transition-all transform hover:-translate-y-0.5">
						<i class="fa-solid fa-arrows-rotate"></i> รีเฟรช
					</button>
					<div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8 no-print">
						<label class="relative inline-flex items-center cursor-pointer group">
							<input type="checkbox" class="sr-only peer" onchange="toggleShowAllRows(this.checked)">
							<div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
							<span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-blue-600 transition-colors">แสดงทั้งหมด</span>
						</label>
					</div>
				</div>

				<div id="task-pagination-controls" class="flex items-center gap-1"></div>
			</div>
			
			<div class="overflow-x-auto">
				<table class="w-full text-sm text-left border-collapse border border-slate-300 mb-3">
				<thead id="taskTableHeader" class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-indigo-300 font-bold text-center"></thead>
					<tbody id="taskTableBody"></tbody>
				</table>
			</div>
			<div id="task-summary-section" class="p-6 bg-white border-t space-y-4 border-slate-200 font-['Sarabun'] no-print">
				<div class="flex flex-col lg:flex-row items-start justify-between gap-8">
					<div class="flex-grow w-full lg:w-auto overflow-x-auto">
						<div class="grid grid-cols-3 text-[13px] font-bold text-slate-700 mb-2 px-1 min-w-[600px]">
							<div>รวมจำนวนนักเรียน <span id="task-stat-total-head" class="text-[#0d6efd] font-bold">0</span> คน</div>
							<div class="text-center">ส่งงานครบทุกชิ้นร้อยละ <span id="task-complete-pct" class="text-[#198754] font-bold">0.00</span></div>
							<div class="text-right">คะแนนงานเฉลี่ย <span id="task-avg-score" class="text-[#0d6efd] font-bold">0.00</span></div>
						</div>
						<table class="w-full text-xs border-collapse summary-table border-black font-['Sarabun'] min-w-[600px]">
							<thead id="task-summary-head" class="bg-slate-50 font-bold text-slate-600 text-center"></thead>
							<tbody id="task-summary-body" class="text-center"></tbody>
						</table>
					</div>

					<div class="text-sm text-slate-700 w-full lg:w-[400px] shrink-0 lg:pt-7">
						<div class="flex items-end justify-center lg:justify-end gap-1 mb-2 whitespace-nowrap">
							<span>ลงชื่อ</span>
							<div class="flex-grow border-b border-dotted border-black mb-1.5 mx-1 min-w-[180px]"></div>
							<span>ครูผู้สอน</span>
						</div>
						<div class="text-center mt-1 font-bold">( <span id="task-sig-teacher">-</span> )</div>
						<div class="text-center mt-2 font-bold" id="task-sig-date">-</div>
					</div>
				</div>
			</div>
		</div>
		
		<div id="rw-view" class="view-section font-['Sarabun']">
			<div class="p-4 bg-slate-50 border-b flex flex-wrap items-center gap-4 no-print">
				<div class="flex items-center gap-2 font-bold text-sm text-pink-600">
					<i class="fa-solid fa-book-open-reader"></i> 
					<span>อ่าน/คิด/เขียน</span>
					<span class="text-slate-300 text-lg font-light mx-2">|</span>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">รายวิชา:</label>
					<select id="select-subject-rw" onchange="changeActiveSubject(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">ห้องเรียน:</label>
					<select id="select-class-rw" onchange="changeActiveClass(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2 px-3 py-1 bg-blue-50 rounded-lg border border-blue-100 shadow-sm font-['Sarabun']">
					<label class="text-[10px] font-bold text-[#0d6efd] uppercase">ครูที่ปรึกษา:</label>
					<span id="display-advisor-rw" class="text-sm font-bold text-[#0d6efd]">-</span>
				</div>

			</div>
			
			<div class="p-4 bg-white border-b flex justify-between items-center gap-4 no-print border-slate-200">
				<div class="flex items-center gap-4 text-xs text-slate-500">
					แสดง <select onchange="changePageLength(this.value)" class="border rounded p-1 font-bold"><option value="10">10</option><option value="20">20</option><option value="50">50</option></select>
					<div id="rw-pagination-info"></div>
				</div>
				<div class="flex items-center gap-2">
					<button onclick="saveScores()" class="btn-grad-save px-6 py-1.5 text-white rounded-lg font-bold text-sm uppercase hover:shadow-lg transition-all transform hover:-translate-y-0.5">
						<i class="fa-solid fa-floppy-disk"></i> บันทึก
					</button>
					<button onclick="initRWTable()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-1.5 rounded-lg font-medium shadow-md font-bold text-sm uppercase transition-all">
						<i class="fa-solid fa-arrows-rotate"></i> รีเฟรช
					</button>
				</div>
				<div id="rw-pagination-controls" class="flex gap-1"></div>
			</div>

			<div class="overflow-x-auto">
				<table class="w-full text-sm text-left border-collapse border border-slate-300">
					<thead id="rwTableHeader" class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-pink-300 font-bold"></thead>
					<tbody id="rwTableBody"></tbody>
				</table>
			</div>
			<div id="rw-summary-section" class="p-6 bg-white border-t space-y-4 border-slate-200 font-['Sarabun'] no-print">
				<div class="flex flex-col lg:flex-row items-start justify-between gap-8">
					<div class="flex-grow w-full lg:w-auto">
						<div class="grid grid-cols-3 text-[13px] font-bold text-slate-700 mb-2 px-1">
							<div>รวมจำนวนนักเรียน <span id="rw-stat-total-head" class="text-[#0d6efd] font-bold">0</span> คน</div>
							<div class="text-center">ผลการประเมินระดับดีขึ้นไปร้อยละ <span id="rw-good-pct" class="text-[#198754] font-bold">0.00</span></div>
							<div class="text-right">ผลการประเมินเฉลี่ย <span id="rw-avg-score" class="text-[#0d6efd] font-bold">0.00</span></div>
						</div>
						<div class="overflow-x-auto">
							<table class="w-full text-xs border-collapse summary-table border-black font-['Sarabun']">
								<tr class="bg-slate-50 font-bold text-slate-600 text-center">
									<td class="bg-slate-100 min-w-[120px] border border-black p-2">สรุปสถิติประเมินผล</td>
									<td class="w-16 border border-black p-2">3</td>
									<td class="w-16 border border-black p-2">2</td>
									<td class="w-16 border border-black p-2">1</td>
									<td class="w-16 border border-black p-2">0</td>
									<td class="w-16 border border-black p-2 bg-slate-100">รวม</td>
								</tr>
								<tr class="font-medium text-slate-800 text-center">
									<td class="bg-slate-50 font-bold border border-black p-2 text-left">จำนวน</td>
									<td id="rw-stat-3" class="border border-black p-2">-</td>
									<td id="rw-stat-2" class="border border-black p-2">-</td>
									<td id="rw-stat-1" class="border border-black p-2">-</td>
									<td id="rw-stat-0" class="border border-black p-2">-</td>
									<td id="rw-stat-total" class="border border-black p-2 font-bold bg-slate-100">-</td>
								</tr>
								<tr class="font-medium text-slate-800 text-center">
									<td class="bg-slate-50 font-bold border border-black p-2 text-left">ร้อยละ</td>
									<td id="rw-pct-3" class="border border-black p-2">-</td>
									<td id="rw-pct-2" class="border border-black p-2">-</td>
									<td id="rw-pct-1" class="border border-black p-2">-</td>
									<td id="rw-pct-0" class="border border-black p-2">-</td>
									<td id="rw-pct-total" class="border border-black p-2 font-bold bg-slate-100">100.00</td>
								</tr>
							</table>
						</div>
					</div>

					<div class="text-sm text-slate-700 w-full lg:w-[400px] shrink-0 lg:pt-7">
						<div class="flex items-end justify-center lg:justify-end gap-1 mb-2 whitespace-nowrap">
							<span>ลงชื่อ</span>
							<div class="flex-grow border-b border-dotted border-black mb-1.5 mx-1 min-w-[180px]"></div>
							<span>ครูผู้สอน</span>
						</div>
						<div class="text-center mt-1 font-bold">( <span id="rw-sig-teacher">-</span> )</div>
						<div class="text-center mt-2 font-bold" id="rw-sig-date">-</div>
					</div>
				</div>
			</div>
		</div>

		<div id="competency-view" class="view-section font-['Sarabun']">
			<div class="p-4 bg-slate-50 border-b flex flex-wrap items-center gap-4 no-print">
				<div class="flex items-center gap-2 font-bold text-sm text-teal-600">
					<i class="fa-solid fa-brain"></i> 
					<span>สมรรถนะ</span>
					<span class="text-slate-300 text-lg font-light mx-2">|</span>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">รายวิชา:</label>
					<select id="select-subject-comp" onchange="changeActiveSubject(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">ห้องเรียน:</label>
					<select id="select-class-comp" onchange="changeActiveClass(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2 px-3 py-1 bg-blue-50 rounded-lg border border-blue-100 shadow-sm font-['Sarabun']">
					<label class="text-[10px] font-bold text-[#0d6efd] uppercase">ครูที่ปรึกษา:</label>
					<span id="display-advisor-comp" class="text-sm font-bold text-[#0d6efd]">-</span>
				</div>

			</div>
			<div class="p-4 bg-white border-b flex justify-between items-center gap-4 no-print border-slate-200">
				<div class="flex items-center gap-4 text-xs text-slate-500">
					แสดง <select onchange="changePageLength(this.value)" class="border rounded p-1 font-bold"><option value="10">10</option><option value="20">20</option><option value="50">50</option></select>
					<div id="comp-pagination-info"></div>
				</div>
				<div class="flex items-center gap-2">
					<button onclick="saveScores()" class="btn-grad-save px-6 py-1.5 text-white rounded-lg font-bold text-sm uppercase hover:shadow-lg transition-all transform hover:-translate-y-0.5"><i class="fa-solid fa-floppy-disk"></i> บันทึก</button>
					<button onclick="initCompetencyTable()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-1.5 rounded-lg font-medium shadow-md font-bold text-sm uppercase transition-all"><i class="fa-solid fa-arrows-rotate"></i> รีเฟรช</button>
				</div>
				<div id="comp-pagination-controls" class="flex gap-1"></div>
			</div>
			<div class="overflow-x-auto">
				<table class="w-full text-sm text-left border-collapse border border-slate-300">
					<thead id="compTableHeader" class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-teal-300 font-bold"></thead>
					<tbody id="compTableBody"></tbody>
				</table>
			</div>
			<div id="comp-summary-section" class="p-6 bg-white border-t space-y-4 border-slate-200 font-['Sarabun'] no-print">
				<div class="flex flex-col lg:flex-row items-start justify-between gap-8">
					<div class="flex-grow w-full lg:w-auto">
						<div class="grid grid-cols-3 text-[13px] font-bold text-slate-700 mb-2 px-1">
							<div>รวมจำนวนนักเรียน <span id="comp-stat-total-head" class="text-[#0d6efd] font-bold">0</span> คน</div>
							<div class="text-center">ผลการประเมินระดับดีขึ้นไปร้อยละ <span id="comp-good-pct" class="text-[#198754] font-bold">0.00</span></div>
							<div class="text-right">ผลการประเมินเฉลี่ย <span id="comp-avg-score" class="text-[#0d6efd] font-bold">0.00</span></div>
						</div>
						<div class="overflow-x-auto">
							<table class="w-full text-xs border-collapse summary-table border-black font-['Sarabun']">
								<tr class="bg-slate-50 font-bold text-slate-600 text-center">
									<td class="bg-slate-100 min-w-[120px] border border-black p-2">สรุปสถิติประเมินผล</td>
									<td class="w-16 border border-black p-2">3</td>
									<td class="w-16 border border-black p-2">2</td>
									<td class="w-16 border border-black p-2">1</td>
									<td class="w-16 border border-black p-2">0</td>
									<td class="w-16 border border-black p-2 bg-slate-100">รวม</td>
								</tr>
								<tr class="font-medium text-slate-800 text-center">
									<td class="bg-slate-50 font-bold border border-black p-2 text-left">จำนวน</td>
									<td id="comp-stat-3" class="border border-black p-2">-</td>
									<td id="comp-stat-2" class="border border-black p-2">-</td>
									<td id="comp-stat-1" class="border border-black p-2">-</td>
									<td id="comp-stat-0" class="border border-black p-2">-</td>
									<td id="comp-stat-total" class="border border-black p-2 font-bold bg-slate-100">-</td>
								</tr>
								<tr class="font-medium text-slate-800 text-center">
									<td class="bg-slate-50 font-bold border border-black p-2 text-left">ร้อยละ</td>
									<td id="comp-pct-3" class="border border-black p-2">-</td>
									<td id="comp-pct-2" class="border border-black p-2">-</td>
									<td id="comp-pct-1" class="border border-black p-2">-</td>
									<td id="comp-pct-0" class="border border-black p-2">-</td>
									<td id="comp-pct-total" class="border border-black p-2 font-bold bg-slate-100">100.00</td>
								</tr>
							</table>
						</div>
					</div>
					<div class="text-sm text-slate-700 w-full lg:w-[400px] shrink-0 lg:pt-7">
						<div class="flex items-end justify-center lg:justify-end gap-1 mb-2 whitespace-nowrap">
							<span>ลงชื่อ</span>
							<div class="flex-grow border-b border-dotted border-black mb-1.5 mx-1 min-w-[180px]"></div>
							<span>ครูผู้สอน</span>
						</div>
						<div class="text-center mt-1 font-bold">( <span id="comp-sig-teacher">-</span> )</div>
						<div class="text-center mt-2 font-bold" id="comp-sig-date">-</div>
					</div>
				</div>
			</div>
		</div>

		<div id="attribute-view" class="view-section font-['Sarabun']">
			<div class="p-4 bg-slate-50 border-b flex flex-wrap items-center gap-4 no-print">
				<div class="flex items-center gap-2 font-bold text-sm text-amber-600">
					<i class="fa-solid fa-star"></i> 
					<span>คุณลักษณะฯ</span>
					<span class="text-slate-300 text-lg font-light mx-2">|</span>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">รายวิชา:</label>
					<select id="select-subject-attr" onchange="changeActiveSubject(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2">
					<label class="text-xs font-bold text-slate-500 uppercase">ห้องเรียน:</label>
					<select id="select-class-attr" onchange="changeActiveClass(this.value)" class="border rounded p-1 text-sm bg-white outline-none font-['Sarabun']"></select>
				</div>
				<div class="flex items-center gap-2 px-3 py-1 bg-blue-50 rounded-lg border border-blue-100 shadow-sm font-['Sarabun']">
					<label class="text-[10px] font-bold text-[#0d6efd] uppercase">ครูที่ปรึกษา:</label>
					<span id="display-advisor-attr" class="text-sm font-bold text-[#0d6efd]">-</span>
				</div>

			</div>
			<div class="p-4 bg-white border-b flex justify-between items-center gap-4 no-print border-slate-200">
				<div class="flex items-center gap-4 text-xs text-slate-500">
					แสดง <select onchange="changePageLength(this.value)" class="border rounded p-1 font-bold"><option value="10">10</option><option value="20">20</option><option value="50">50</option></select>
					<div id="attr-pagination-info"></div>
				</div>
				<div class="flex items-center gap-2">
					<button onclick="saveScores()" class="btn-grad-save px-6 py-1.5 text-white rounded-lg font-bold text-sm uppercase hover:shadow-lg transition-all transform hover:-translate-y-0.5"><i class="fa-solid fa-floppy-disk"></i> บันทึก</button>
					<button onclick="initAttributeTable()" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-1.5 rounded-lg font-medium shadow-md font-bold text-sm uppercase transition-all"><i class="fa-solid fa-arrows-rotate"></i> รีเฟรช</button>
				</div>
				<div id="attr-pagination-controls" class="flex gap-1"></div>
			</div>
			<div class="overflow-x-auto">
				<table class="w-full text-sm text-left border-collapse border border-slate-300">
					<thead id="attrTableHeader" class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-yellow-300 font-bold"></thead>
					<tbody id="attrTableBody"></tbody>
				</table>
			</div>
			<div id="attr-summary-section" class="p-6 bg-white border-t space-y-4 border-slate-200 font-['Sarabun'] no-print">
				<div class="flex flex-col lg:flex-row items-start justify-between gap-8">
					<div class="flex-grow w-full lg:w-auto">
						<div class="grid grid-cols-3 text-[13px] font-bold text-slate-700 mb-2 px-1">
							<div>รวมจำนวนนักเรียน <span id="attr-stat-total-head" class="text-[#0d6efd] font-bold">0</span> คน</div>
							<div class="text-center">ผลการประเมินระดับดีขึ้นไปร้อยละ <span id="attr-good-pct" class="text-[#198754] font-bold">0.00</span></div>
							<div class="text-right">ผลการประเมินเฉลี่ย <span id="attr-avg-score" class="text-[#0d6efd] font-bold">0.00</span></div>
						</div>
						<div class="overflow-x-auto">
							<table class="w-full text-xs border-collapse summary-table border-black font-['Sarabun']">
								<tr class="bg-slate-50 font-bold text-slate-600 text-center">
									<td class="bg-slate-100 min-w-[120px] border border-black p-2">สรุปสถิติประเมินผล</td>
									<td class="w-16 border border-black p-2">3</td>
									<td class="w-16 border border-black p-2">2</td>
									<td class="w-16 border border-black p-2">1</td>
									<td class="w-16 border border-black p-2">0</td>
									<td class="w-16 border border-black p-2 bg-slate-100">รวม</td>
								</tr>
								<tr class="font-medium text-slate-800 text-center">
									<td class="bg-slate-50 font-bold border border-black p-2 text-left">จำนวน</td>
									<td id="attr-stat-3" class="border border-black p-2">-</td>
									<td id="attr-stat-2" class="border border-black p-2">-</td>
									<td id="attr-stat-1" class="border border-black p-2">-</td>
									<td id="attr-stat-0" class="border border-black p-2">-</td>
									<td id="attr-stat-total" class="border border-black p-2 font-bold bg-slate-100">-</td>
								</tr>
								<tr class="font-medium text-slate-800 text-center">
									<td class="bg-slate-50 font-bold border border-black p-2 text-left">ร้อยละ</td>
									<td id="attr-pct-3" class="border border-black p-2">-</td>
									<td id="attr-pct-2" class="border border-black p-2">-</td>
									<td id="attr-pct-1" class="border border-black p-2">-</td>
									<td id="attr-pct-0" class="border border-black p-2">-</td>
									<td id="attr-pct-total" class="border border-black p-2 font-bold bg-slate-100">100.00</td>
								</tr>
							</table>
						</div>
					</div>
					<div class="text-sm text-slate-700 w-full lg:w-[400px] shrink-0 lg:pt-7">
						<div class="flex items-end justify-center lg:justify-end gap-1 mb-2 whitespace-nowrap">
							<span>ลงชื่อ</span>
							<div class="flex-grow border-b border-dotted border-black mb-1.5 mx-1 min-w-[180px]"></div>
							<span>ครูผู้สอน</span>
						</div>
						<div class="text-center mt-1 font-bold">( <span id="attr-sig-teacher">-</span> )</div>
						<div class="text-center mt-2 font-bold" id="attr-sig-date">-</div>
					</div>
				</div>
			</div>
		</div>
		
		

        <!-- หน้าสรุปผลสัมฤทธิ์ (Web view) -->
        <div id="achievement-view" class="view-section p-8 bg-slate-50 font-['Sarabun']">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800 uppercase tracking-tighter flex items-center gap-2">
                    <i class="fa-solid fa-chart-pie text-[#0d6efd]"></i>
                    สรุปผลสัมฤทธิ์ทางการเรียน (ทุกรายวิชา)
                </h2>
			<div class="flex flex-wrap gap-2">
						<select id="ach-filter-subject" onchange="changeAchFilterSubject(this.value)" class="border rounded-lg px-3 py-2 text-sm font-bold text-slate-700 bg-white shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
							<option value="all">ทุกรายวิชา</option>
						</select>
						
						<select id="ach-filter-room" onchange="changeAchFilterRoom(this.value)" class="border rounded-lg px-3 py-2 text-sm font-bold text-slate-700 bg-white shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
							<option value="all">ทุกห้องเรียน</option>
						</select>

						<button onclick="resetAchievementFilter()" class="bg-slate-500 hover:bg-slate-600 text-white px-5 py-2 rounded-lg font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-sm">
							<i class="fa-solid fa-rotate-left"></i> รีเซ็ต
						</button>
					<button onclick="saveAchievements()" class="btn-grad-save px-5 py-2 text-white rounded-lg font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-sm hover:shadow-lg transform hover:-translate-y-0.5">
						<i class="fa-solid fa-floppy-disk"></i> บันทึกผลสมรรถนะ
					</button>
												
						<button onclick="printAchievementSummary()" class="btn-grad-students px-5 py-2 text-white rounded-lg font-medium shadow-sm flex items-center gap-2 transition font-['Sarabun'] font-bold text-sm">
							<i class="fa-solid fa-print"></i> พิมพ์รายงาน
						</button>
					</div>
				</div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 text-sm">
                     <div><span class="font-bold text-slate-500 block text-xs uppercase mb-1">กลุ่มสาระการเรียนรู้</span><span id="view-ach-dept-name" class="font-bold text-lg text-slate-800">-</span></div>
                     <div><span class="font-bold text-slate-500 block text-xs uppercase mb-1">ครูผู้สอน</span><span id="view-ach-teacher-name" class="font-bold text-lg text-slate-800">-</span></div>
                     <div><span class="font-bold text-slate-500 block text-xs uppercase mb-1">ภาคเรียน/ปีการศึกษา</span><span class="font-bold text-lg text-slate-800"><span id="view-ach-sem"></span> / <span id="view-ach-year"></span></span></div>
                     <div><span class="font-bold text-slate-500 block text-xs uppercase mb-1">โรงเรียน</span><span id="view-ach-school-name" class="font-bold text-lg text-slate-800">โรงเรียนปากช่อง</span></div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full ach-table mb-4 border-collapse">
                        <thead>
                            <tr class="bg-amber-300 text-slate-900 font-bold">
                                <th rowspan="2" style="width: 80px;" class="border-slate-300 border">รหัสวิชา</th>
                                <th rowspan="2" class="border-slate-300 border">ชั้น</th>
                                <th rowspan="2" class="w-10 border-slate-300 border">จำนวน<br>นักเรียน</th>
                                <th colspan="10" class="border-slate-300 border bg-white/20">จำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
                                <th rowspan="2" class="w-8 border-slate-300 border bg-white/20">รวม</th>
                                <th colspan="10" class="border-slate-300 border bg-white/20">ร้อยละจำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
                                <th rowspan="2" class="w-10 border-slate-300 border bg-white/20">ร้อยละ<br>รวม</th>
                                <th rowspan="2" class="w-10 border-slate-300 border">X-Bar</th>
                                <th rowspan="2" class="w-10 border-slate-300 border">S.D.</th>
                                <th rowspan="2" class="w-10 border-slate-300 border">%ผ่านเกณฑ์</th>
                                <th rowspan="2" class="w-12 border-slate-300 border">%ระดับ<br>ดีขึ้นไป</th>
                                <th rowspan="2" class="w-12 border-slate-300 border">%ไม่ผ่าน<br>เกณฑ์</th>
                                <th rowspan="2" class="w-16 border-slate-300 border">สรุป<br>ผลสัมฤทธิ์</th>
                            </tr>
                            <tr class="bg-amber-300 text-slate-800">
                                <th class="w-6 border-slate-300 border text-xs py-1">4.0</th><th class="w-6 border-slate-300 border text-xs">3.5</th><th class="w-6 border-slate-300 border text-xs">3.0</th><th class="w-6 border-slate-300 border text-xs">2.5</th><th class="w-6 border-slate-300 border text-xs">2.0</th><th class="w-6 border-slate-300 border text-xs">1.5</th><th class="w-6 border-slate-300 border text-xs">1.0</th><th class="w-6 border-slate-300 border text-xs">0</th><th class="w-6 border-slate-300 border text-xs">ร</th><th class="w-6 border-slate-300 border text-xs">มส</th>
                                <th class="w-8 border-slate-300 border text-xs">4.0</th><th class="w-8 border-slate-300 border text-xs">3.5</th><th class="w-8 border-slate-300 border text-xs">3.0</th><th class="w-8 border-slate-300 border text-xs">2.5</th><th class="w-8 border-slate-300 border text-xs">2.0</th><th class="w-8 border-slate-300 border text-xs">1.5</th><th class="w-8 border-slate-300 border text-xs">1.0</th><th class="w-8 border-slate-300 border text-xs">0</th><th class="w-8 border-slate-300 border text-xs">ร</th><th class="w-8 border-slate-300 border text-xs">มส</th>
                            </tr>
                        </thead>
                        <tbody id="view-ach-table-body" class="bg-white"></tbody>
                        <tfoot id="view-ach-table-foot" class="font-bold bg-amber-300 border-t-2 border-slate-300"></tfoot>
                    </table>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                     <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="text-[12pt] font-bold text-left mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-column text-emerald-500"></i>
                            กราฟเปรียบเทียบร้อยละจำนวนนักเรียนแยกตามระดับผลการเรียน
                        </div>
                        <div id="view-ach-chart-1" class="ach-graph-container h-[250px]"></div>
                        <div class="text-center text-xs mt-2 text-slate-500 font-bold uppercase tracking-wider">ระดับผลการเรียน</div>
                     </div>
                     <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="text-[12pt] font-bold text-left mb-4 text-slate-800 flex items-center gap-2">
                            <i class="fa-solid fa-chart-column text-emerald-500"></i>
                            กราฟเปรียบเทียบจำนวนนักเรียนแยกตามระดับผลการเรียน
                        </div>
                        <div id="view-ach-chart-2" class="ach-graph-container h-[250px]"></div>
                        <div class="text-center text-xs mt-2 text-slate-500 font-bold uppercase tracking-wider">ระดับผลการเรียน</div>
                     </div>
                </div>

                <!-- กล่องวิเคราะห์ผลสัมฤทธิ์ตามตัวอย่าง -->
                <div id="ach-analysis-container" class="mt-8 p-5 bg-emerald-50/50 border-2 border-dashed border-emerald-200 rounded-2xl">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 bg-white rounded-full shadow-sm flex items-center justify-center flex-shrink-0">
                            <i class="fa-regular fa-lightbulb text-amber-400 text-xl"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-emerald-800 text-base mb-1">วิเคราะห์การกระจายตัวของผลสัมฤทธิ์ทางการเรียน:</h4>
                            <p id="ach-analysis-text" class="text-emerald-700 text-sm leading-relaxed">
                                กราฟนี้แสดงความหนาแน่นของจำนวนนักเรียนในแต่ละระดับผลการเรียน หากแท่งสูงต่างกันมากในแต่ละระดับ แสดงว่ามีการกระจายแบบเป็นกลุ่ม (เช่น นักเรียนส่วนใหญ่กองอยู่ที่ระดับผลการเรียนสูง) หากความสูงใกล้เคียงกัน แสดงว่ามีการกระจายตัวแบบสม่ำเสมอในทุกระดับผลการเรียน
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

		<div id="staff-view" class="view-section p-6 font-['Sarabun']">
			<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
				<h2 class="text-xl font-bold text-slate-800">จัดการข้อมูลบุคลากร</h2>
				<button onclick="openStaffModal()" class="btn-grad-grading text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
					<i class="fa-solid fa-user-plus"></i> เพิ่มบุคลากรใหม่
				</button>
			</div>
			
            <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-200 flex flex-wrap gap-3 items-center">
                <div class="flex-grow min-w-[200px]">
                    <input type="text" id="search-staff" oninput="initStaffTable()" placeholder="ค้นหาชื่อ-สกุล..." class="w-full border rounded-lg p-2 text-sm font-['Sarabun']">
                </div>

				<div class="w-full md:w-auto">
					<select id="filter-staff-position" onchange="initStaffTable()" class="w-full border rounded-lg p-2 text-sm bg-white font-['Sarabun'] min-w-[160px]">
						<option value="">ทุกตำแหน่ง</option>
						</select>
				</div>

                <select id="filter-staff-dept" onchange="initStaffTable()" class="border rounded-lg p-2 text-sm bg-white font-['Sarabun']">
                    <option value="">ทุกกลุ่มสาระฯ</option>
                    <option value="ภาษาไทย">ภาษาไทย</option>
                    <option value="คณิตศาสตร์">คณิตศาสตร์</option>
                    <option value="วิทยาศาสตร์และเทคโนโลยี">วิทยาศาสตร์และเทคโนโลยี</option>
                    <option value="สังคมศึกษา ศาสนา และวัฒนธรรม">สังคมศึกษาฯ</option>
                    <option value="สุขศึกษาและพลศึกษา">สุขศึกษาและพลศึกษา</option>
                    <option value="ศิลปะ">ศิลปะ</option>
                    <option value="การงานอาชีพ">การงานอาชีพ</option>
                    <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>
                    <option value="กิจกรรมพัฒนาผู้เรียน">กิจกรรมพัฒนาผู้เรียน</option>
                    <option value="บริหารสถานศึกษา">บริหารสถานศึกษา</option>
                    <option value="บุคลากรทางการศึกษา">บุคลากรทางการศึกษา</option>
                </select>
                <select id="filter-staff-gender" onchange="initStaffTable()" class="border rounded-lg p-2 text-sm bg-white font-['Sarabun']">
                    <option value="">ทุกเพศ</option>
                    <option value="ชาย">ชาย</option>
                    <option value="หญิง">หญิง</option>
                </select>
                <select id="filter-staff-status" onchange="initStaffTable()" class="border rounded-lg p-2 text-sm bg-white font-['Sarabun']">
                    <option value="">ทุกสถานะ</option>
                    <option value="ปฏิบัติหน้าที่">ปฏิบัติหน้าที่</option>
                    <option value="ช่วยราชการ">ช่วยราชการ</option>
                    <option value="ลาศึกษาต่อ">ลาศึกษาต่อ</option>
                    <option value="ย้ายออก">ย้ายออก</option>
                    <option value="เกษียณอายุ">เกษียณอายุ</option>
                    <option value="ลาออก">ลาออก</option>
                </select>
            </div>

			<div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
				<div class="overflow-x-auto">
					<table class="w-full text-sm text-left border-collapse whitespace-nowrap">
						<thead class="bg-slate-50 text-slate-500 uppercase text-[12px] font-bold border-b border-slate-200">
							<tr>
								<th class="px-4 py-3 w-16 text-center border-r bg-slate-50 sticky left-0 z-10">รูป</th>
								<th class="px-4 py-3 text-center border-r min-w-[150px]">ชื่อ-นามสกุล</th>
								<th class="px-4 py-3 border-r text-center hidden md:table-cell">ตำแหน่ง</th>
								<th class="px-4 py-3 border-r text-center hidden lg:table-cell">งาน/กลุ่มสาระฯ</th>
								<th class="px-4 py-3 border-r text-center hidden lg:table-cell">เบอร์โทร</th>
								<th class="px-4 py-3 border-r text-center hidden xl:table-cell">เครื่องราชฯ</th>
								<th class="px-4 py-3 border-r text-center hidden xl:table-cell">ใบประกอบฯ</th>
								<th class="px-4 py-3 border-r text-center">สถานะ</th>
								<th class="px-4 py-3 text-center sticky right-0 bg-slate-50 z-10 border-l shadow-[-4px_0_8px_-4px_rgba(0,0,0,0.1)]">จัดการ</th>
							</tr>
						</thead>
						<tbody id="staff-list-body"></tbody>
					</table>
				</div>
			</div>

            <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-4 no-print font-['Sarabun']">
                <div class="flex items-center gap-4 text-xs text-slate-500 font-['Sarabun']">
                    <div class="flex items-center gap-2">
                        แสดง 
                        <select onchange="changePageLength(this.value)" class="border rounded p-1 bg-white text-[10px] font-bold outline-none">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div id="staff-pagination-info"></div>
                </div>
                <div id="staff-pagination-controls" class="flex gap-1"></div>
            </div>
		</div>


		<div id="calendar-view" class="view-section p-6 font-['Sarabun']">
			<div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
				<h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
					<i class="fa-solid fa-calendar-check text-purple-600"></i> ปฏิทินวิชาการและกิจกรรม
				</h2>
				<div class="flex gap-2">
					 <button onclick="renderCalendar()" class="bg-white border border-slate-200 text-slate-600 px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-slate-50 transition">
						วันนี้
					</button>
					<button onclick="openAddEventModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-purple-700 transition shadow-sm">
						<i class="fa-solid fa-plus"></i> เพิ่มกิจกรรม
					</button>
				</div>
			</div>

			<div class="md:grid md:grid-cols-2 md:divide-x md:divide-gray-200 bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
				<div class="p-6">
					<div class="flex items-center justify-between mb-6">
						<h2 class="flex-auto text-lg font-bold text-gray-900" id="calendar-month-year">
							</h2>
						<div class="flex items-center">
							<button type="button" onclick="changeMonth(-1)" class="-my-1.5 flex flex-none items-center justify-center p-1.5 text-gray-400 hover:text-gray-500">
								<i class="fa-solid fa-chevron-left"></i>
							</button>
							<button type="button" onclick="changeMonth(1)" class="-my-1.5 -mr-1.5 ml-2 flex flex-none items-center justify-center p-1.5 text-gray-400 hover:text-gray-500">
								<i class="fa-solid fa-chevron-right"></i>
							</button>
						</div>
					</div>
					<div class="grid grid-cols-7 text-center text-xs leading-6 text-gray-500 font-bold mb-2">
						<div>อา.</div><div>จ.</div><div>อ.</div><div>พ.</div><div>พฤ.</div><div>ศ.</div><div>ส.</div>
					</div>
					<div class="grid grid-cols-7 text-sm" id="calendar-days-grid">
						</div>
				</div>

				<div class="px-6 py-6 md:py-10">
					<h3 class="text-base font-bold leading-6 text-gray-900 mb-4">
						กิจกรรมในเดือนนี้ <span id="event-count-badge" class="ml-2 bg-purple-100 text-purple-600 text-xs px-2 py-0.5 rounded-full">0</span>
					</h3>
					<ol class="divide-y divide-gray-100 text-sm leading-6 custom-scrollbar overflow-y-auto max-h-[350px]" id="calendar-event-list">
						<li class="py-4 text-center text-gray-400 italic">ไม่มีกิจกรรมในเดือนนี้</li>
					</ol>
					
				</div>
			</div>
		</div>


        <!-- หน้าจัดการนักเรียน -->
        <div id="students-view" class="view-section p-6 font-['Sarabun']">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 font-['Sarabun']">
                <h2 class="text-xl font-bold text-slate-800">จัดการรายชื่อนักเรียน</h2>
                <div class="flex flex-wrap gap-2">
                    <button onclick="downloadStudentTemplate()" class="btn-secondary text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition font-['Sarabun']">
                        <i class="fa-solid fa-file-lines"></i> เทมเพลต
                    </button>
                    <label class="btn-grad-achievement text-white px-4 py-2 rounded-lg text-sm font-bold cursor-pointer flex items-center gap-2 transition font-['Sarabun']">
                        <i class="fa-solid fa-file-import"></i> นำเข้า Excel <input type="file" class="hidden" onchange="simulateExcelImport(this)">
                    </label>
                    <button onclick="openStudentModal()" class="btn-grad-grading text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 font-['Sarabun'] cursor-pointer">
                        <i class="fa-solid fa-user-plus"></i> เพิ่มนักเรียนใหม่
                    </button>
                </div>
            </div>

            <div class="bg-slate-50 p-4 rounded-xl mb-4 border border-slate-200 flex flex-wrap gap-4 items-center">
                <div class="flex-grow min-w-[200px]">
                    <input type="text" id="search-student" oninput="initStudentTable()" placeholder="ค้นหารหัส หรือ ชื่อนักเรียน..." class="w-full border rounded-lg p-2 text-sm font-['Sarabun']">
                </div>
                <select id="filter-student-status" onchange="initStudentTable()" class="border rounded-lg p-2 text-sm bg-white font-['Sarabun']">
                    <option value="">ทุกสถานะ</option>
                    <option value="ปกติ">ปกติ</option>
                    <option value="ขาดเรียนนาน">ขาดเรียนนาน</option>
                    <option value="ลาออก">ลาออก</option>
                    <option value="สำเร็จการศึกษา">สำเร็จการศึกษา</option>
                </select>
                <select id="filter-student-room" onchange="initStudentTable()" class="border rounded-lg p-2 text-sm bg-white font-['Sarabun']">
                    <option value="">ทุกห้อง</option>
                </select>
            </div>

            <div class="bg-white rounded-xl border border-slate-200 overflow-hidden shadow-sm">
                <table class="w-full text-sm text-left border-collapse">
                    <thead class="bg-slate-50 text-slate-500 uppercase text-[12px] font-bold border-b border-slate-200 font-['Sarabun']">
                        <tr>
                            <th class="px-4 py-3 w-16 text-center border-r">รูป</th>
                            <th class="px-4 py-3 w-24 text-center border-r">รหัส</th>
                            <th class="px-4 py-3 w-32 text-center border-r">เลขบัตรประชาชน</th>
                            <th class="px-4 py-3 text-center border-r">ชื่อ-นามสกุล</th>
                            <th class="px-4 py-3 w-16 text-center border-r">เพศ</th>
                            <th class="px-4 py-3 w-20 text-center border-r">ห้อง</th>
                            <th class="px-4 py-3 w-16 text-center border-r">เลขที่</th>
                            <th class="px-4 py-3 w-24 text-center border-r">ปีที่เข้า</th>
                            <th class="px-4 py-3 w-32 text-center border-r">สถานะ</th>
                            <th class="px-4 py-3 w-24 text-center no-print">จัดการ</th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body"></tbody>
                </table>
            </div>
            
            <div class="mt-4 flex flex-col md:flex-row justify-between items-center gap-4 no-print font-['Sarabun']">
                <div class="flex items-center gap-4 text-xs text-slate-500 font-['Sarabun']">
                    <div class="flex items-center gap-2">
                        แสดง 
                        <select onchange="changePageLength(this.value)" class="border rounded p-1 bg-white text-[10px] font-bold outline-none">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div id="student-pagination-info"></div>
                </div>
                <div id="student-pagination-controls" class="flex gap-1"></div>
            </div>
        </div>

        <!-- หน้าตั้งค่าวิชา -->
		<div id="settings-view" class="view-section p-6 bg-slate-50 font-['Sarabun']">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2 border-b border-slate-200 pb-3 uppercase tracking-tighter">
                <i class="fa-solid fa-sliders text-[#0d6efd]"></i> จัดการรายวิชาและโครงสร้างคะแนน
            </h2>
            
            <div class="flex flex-col md:flex-row gap-6 font-['Sarabun'] items-start">
                
                <div class="w-full md:w-[280px] lg:w-[320px] shrink-0 bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-col h-[600px] md:sticky md:top-4 z-10">
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-100">
                        <h3 class="font-bold text-[#0d6efd] uppercase text-[14px]">รายการวิชาที่สอน</h3>
                        <button onclick="addNewSubject()" class="bg-rose-500 hover:bg-rose-600 text-white px-3 py-1 rounded-lg shadow-sm font-bold text-[10px] transition transform hover:scale-105 duration-200">
                            <i class="fa-solid fa-plus"></i> เพิ่มวิชา
                        </button>
                    </div>
					<div id="subject-list-container" class="py-2 space-y-3 flex-grow overflow-y-auto px-2 pr-1 custom-scrollbar" style="max-height: 520px;"></div>
                </div>

                <div id="subject-editor" class="flex-grow w-full min-w-0 bg-white p-6 rounded-xl shadow-sm border border-slate-200 opacity-50 pointer-events-none transition-opacity duration-300 min-h-[600px]">
                    
                    <div class="flex border-b border-slate-200 mb-6 gap-2 no-print overflow-x-auto">
                        <button onclick="switchSettingsTab('tab-school')" id="btn-tab-school" class="settings-tab-btn active px-4 py-2 font-bold text-[13px] text-slate-500 border-b-2 border-transparent transition-all hover:text-[#0d6efd]">1. ข้อมูลสถานศึกษา</button>
                        <button onclick="switchSettingsTab('tab-targets')" id="btn-tab-targets" class="settings-tab-btn px-4 py-2 text-[13px] font-bold text-slate-500 border-b-2 border-transparent transition-all hover:text-[#0d6efd]">2. กำหนดค่าเป้าหมาย</button>
                        <button onclick="switchSettingsTab('tab-subject')" id="btn-tab-subject" class="settings-tab-btn px-4 py-2 text-[13px] font-bold text-slate-500 border-b-2 border-transparent transition-all hover:text-[#0d6efd]">3. รายวิชาและคะแนน</button>
                    </div>

                    <div id="tab-school" class="settings-tab-content">
                        <h3 class="font-bold text-[14px] text-[#0d6efd] uppercase tracking-wider mb-6 border-l-4 border-[#0d6efd] pl-3">ข้อมูลสถานศึกษาและบุคลากร</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5 mb-8 font-['Sarabun']">
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ชื่อโรงเรียน</label><input type="text" id="edit-school-name" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-lime-200 focus:ring-1 focus:ring-blue-500 outline-none font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">สังกัด/เขตพื้นที่</label><input type="text" id="edit-affiliation" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-lime-200 focus:ring-1 focus:ring-blue-500 outline-none font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ผู้อำนวยการ</label><input type="text" id="edit-director" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-lime-200 focus:ring-1 focus:ring-blue-500 outline-none font-['Sarabun']"></div>
                            
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">รองฯ ฝ่ายวิชาการ</label><input type="text" id="edit-deputy-director" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-lime-200 focus:ring-1 focus:ring-blue-500 outline-none font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">หัวหน้างานวัดผล</label><input type="text" id="edit-head-evaluation" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-lime-200 focus:ring-1 focus:ring-blue-500 outline-none font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">หัวหน้ากลุ่มสาระฯ</label><input type="text" id="edit-head-department" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-lime-200 focus:ring-1 focus:ring-blue-500 outline-none font-['Sarabun']"></div>
                            
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ครูผู้สอน</label><input type="text" id="edit-teacher" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-lime-200 focus:ring-1 focus:ring-blue-500 outline-none font-['Sarabun']"></div>
                            <div class="md:col-span-2"><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">กลุ่มสาระการเรียนรู้</label><input type="text" id="edit-head-dept-name" oninput="updateCurrentSubjectData()" class="w-full border p-2 rounded text-sm bg-lime-200 focus:ring-1 focus:ring-blue-500 outline-none font-['Sarabun']"></div>
                            
                            <div class="col-span-1 md:col-span-2 lg:col-span-3 mt-2">
                                <label class="block text-[12px] font-bold text-[#0d6efd] uppercase mb-2"><i class="fa-solid fa-users"></i> รายชื่อครูที่ปรึกษา (ตามห้อง)</label>
                                <div id="dynamic-advisors-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300"></div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-targets" class="settings-tab-content hidden">
                        <h3 class="font-bold text-[14px] text-[#0d6efd] uppercase tracking-wider mb-6 border-l-4 border-[#0d6efd] pl-3">กำหนดค่าเป้าหมายผลสัมฤทธิ์</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8 font-['Sarabun'] bg-blue-50/30 p-6 rounded-xl border border-blue-100">
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ร้อยละเป้าหมาย (สถานศึกษา)</label><input type="number" id="edit-target-school-pct" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ร้อยละเป้าหมาย (กลุ่มสาระฯ)</label><input type="number" id="edit-target-dept-pct" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ร้อยละเป้าหมาย (สาขาวิชา)</label><input type="number" id="edit-target-subject-pct" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div class="col-span-full border-t border-blue-200 my-1"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">เกรดเฉลี่ยเป้าหมาย (สถานศึกษา)</label><input type="number" step="0.01" id="edit-target-school-gpa" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">เกรดเฉลี่ยเป้าหมาย (กลุ่มสาระฯ)</label><input type="number" step="0.01" id="edit-target-dept-gpa" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">เกรดเฉลี่ยเป้าหมาย (สาขาวิชา)</label><input type="number" step="0.01" id="edit-target-subject-gpa" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                        </div>
                    </div>

                    <div id="tab-subject" class="settings-tab-content hidden">
                        <h3 class="font-bold text-[14px] text-[#0d6efd] uppercase tracking-wider mb-6 border-l-4 border-[#0d6efd] pl-3">การตั้งค่ารายวิชา</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5 mb-6 font-['Sarabun']">
                            <div class="md:col-span-2"><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ชื่อวิชา</label><input type="text" id="edit-subject-name" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-bold text-slate-700 font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">รหัสวิชา</label><input type="text" id="edit-course-code" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-bold text-slate-700 font-['Sarabun']"></div>
                            <div>
                                <label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ลักษณะวิชา</label>
                                <select id="edit-subject-type" onchange="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']">
                                    <option value="พื้นฐาน">พื้นฐาน</option>
                                    <option value="เพิ่มเติม">เพิ่มเติม</option>
                                </select>
                            </div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">หน่วยกิต</label><input type="number" step="0.5" id="edit-credits" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">เวลาเรียน (ชม./สัปดาห์)</label><input type="number" step="0.5" id="edit-hours" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div class="md:col-span-2"><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ห้องที่สอน (คั่นด้วย ,)</label><input type="text" id="edit-classes" oninput="handleClassesChange()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']" placeholder="ม.4/1, ม.4/2"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ภาคเรียนที่</label><input type="number" id="edit-semester" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                            <div><label class="block text-[11px] font-bold text-slate-400 uppercase mb-1">ปีการศึกษา</label><input type="number" id="edit-academic-year" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border p-2 rounded text-sm font-['Sarabun']"></div>
                        </div>

                        <div class="bg-indigo-50/50 p-5 rounded-xl border border-indigo-100 mb-6">
                            <h4 class="text-[12px] font-bold text-indigo-500 uppercase mb-3">คะแนนกลางภาค/ปลายภาค</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 font-['Sarabun']">
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 font-bold">กลางภาค (เต็ม):</label><input type="number" id="edit-mid-max" oninput="updateCurrentSubjectData();autoCalculateRatio()" class="w-full bg-lime-200 border border-indigo-200 p-2 rounded text-sm font-bold text-[#0d6efd] font-['Sarabun']"></div>
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">กลางภาค (%):</label><input type="number" id="edit-mid-pass-pct" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border border-indigo-200 p-2 rounded text-sm font-['Sarabun']"></div>
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1 font-bold">ปลายภาค (เต็ม):</label><input type="number" id="edit-fin-max" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border border-indigo-200 p-2 rounded text-sm font-bold text-[#0d6efd] font-['Sarabun']"></div>
                                <div><label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">ปลายภาค (%):</label><input type="number" id="edit-fin-pass-pct" oninput="updateCurrentSubjectData()" class="w-full bg-lime-200 border border-indigo-200 p-2 rounded text-sm font-['Sarabun']"></div>
                            </div>
                        </div>

						<div class="bg-emerald-50/50 p-5 rounded-xl border border-emerald-100 mb-4 font-['Sarabun']">
							<div class="flex items-center gap-2 mb-3 border-b border-emerald-200 pb-2">
								<i class="fa-solid fa-chart-pie text-emerald-600"></i>
								<h4 class="text-[13px] font-bold text-emerald-700 uppercase">อัตราส่วนคะแนน (ระหว่างภาค : ปลายภาค)</h4>
							</div>
							<div class="flex items-center gap-4">
								<div class="flex-1">
									<label class="block text-[11px] font-bold text-slate-500 uppercase mb-1">
										คะแนนระหว่างภาค (รวม)
									</label>
									<div class="relative">
										<input type="number" id="edit-ratio-between" readonly 
											class="w-full bg-slate-100 border border-slate-200 p-2 rounded text-sm font-bold text-emerald-600 font-['Sarabun'] text-center cursor-not-allowed">
										<span class="absolute right-3 top-2 text-xs text-slate-400 font-bold">คะแนน</span>
									</div>
									<p class="text-[10px] text-emerald-600 mt-1">
										<i class="fa-solid fa-link"></i> มาจาก รายหน่วย + ชิ้นงาน
									</p>
								</div>
								
								<div class="text-xl font-bold text-slate-300 mt-4">:</div>

								<div class="flex-1">
									<label class="block text-[11px] font-bold text-slate-500 uppercase mb-1">
										คะแนนปลายภาค
									</label>
									<div class="relative">
										<input type="number" id="edit-ratio-final" oninput="syncFinalScore(this.value)" placeholder="เช่น 20" 
											class="w-full bg-white border border-emerald-200 p-2 rounded text-sm font-bold text-emerald-600 font-['Sarabun'] text-center focus:ring-2 focus:ring-emerald-400 outline-none">
										<span class="absolute right-3 top-2 text-xs text-slate-400 font-bold">คะแนน</span>
									</div>
									<p class="text-[10px] text-slate-400 mt-1">* กำหนดคะแนนสอบปลายภาค</p>
								</div>
							</div>
						</div>


						 <div class="bg-indigo-50/50 p-5 rounded-xl border border-indigo-100 mb-4 font-['Sarabun']">
							<div class="flex items-center gap-2 mb-3 border-b border-indigo-200 pb-2">
								<i class="fa-solid fa-scale-balanced text-indigo-600"></i>
								<h4 class="text-[13px] font-bold text-indigo-700 uppercase">กำหนดสัดส่วนคะแนนเก็บ (Weight Ratio)</h4>
							</div>
							<div class="grid grid-cols-2 gap-6">
								<div>
									<label class="block text-[11px] font-bold text-slate-500 uppercase mb-1">
										น้ำหนักคะแนนรายหน่วย (Units)
									</label>
									<div class="relative">
										<input type="number" id="edit-weight-unit" readonly
											class="w-full bg-slate-100 border border-indigo-200 p-2 rounded text-sm font-bold text-indigo-600 font-['Sarabun'] text-center cursor-not-allowed">
										<span class="absolute right-3 top-2 text-xs text-slate-400 font-bold">คะแนน</span>
									</div>
									<p class="text-[10px] text-indigo-500 mt-1"><i class="fa-solid fa-calculator"></i> รวมจากโครงสร้างรายหน่วยอัตโนมัติ</p>
								</div>
								<div>
									<label class="block text-[11px] font-bold text-slate-500 uppercase mb-1">
										น้ำหนักคะแนนชิ้นงาน (Tasks)
									</label>
									<div class="relative">
										<input type="number" id="edit-weight-task" readonly
											class="w-full bg-slate-100 border border-indigo-200 p-2 rounded text-sm font-bold text-indigo-600 font-['Sarabun'] text-center cursor-not-allowed">
										<span class="absolute right-3 top-2 text-xs text-slate-400 font-bold">คะแนน</span>
									</div>
									 <p class="text-[10px] text-indigo-500 mt-1"><i class="fa-solid fa-calculator"></i> รวมจากโครงสร้างชิ้นงานอัตโนมัติ</p>
								</div>
							</div>
						</div>
						<div class="bg-white border-2 border-slate-100 p-5 rounded-xl mb-4 shadow-sm font-['Sarabun'] relative mt-4">
							<div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
								<h4 class="text-[13px] font-bold text-slate-600 uppercase font-['Sarabun']"><i class="fa-solid fa-list-ol"></i> โครงสร้างคะแนนรายหน่วย (Units)</h4>
								<button onclick="addNewUnitToCurrent()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded shadow-sm text-[11px] font-bold font-['Sarabun'] transition">+ เพิ่มหน่วย</button>
							</div>
							<div id="units-editor-list" class="space-y-2 font-['Sarabun'] max-h-[250px] overflow-y-auto pr-2 custom-scrollbar"></div>
						</div>

						<div class="bg-white border-2 border-slate-100 p-5 rounded-xl mb-4 shadow-sm font-['Sarabun'] relative mt-4">
							<div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2">
								<h4 class="text-[13px] font-bold text-amber-600 uppercase font-['Sarabun']"><i class="fa-solid fa-clipboard-check"></i> โครงสร้างคะแนนชิ้นงาน (Tasks)</h4>
								<button onclick="addNewTaskToCurrent()" class="bg-amber-500 hover:bg-amber-600 text-white px-3 py-1 rounded shadow-sm text-[11px] font-bold font-['Sarabun'] transition">+ เพิ่มงาน</button>
							</div>
							<div id="tasks-editor-list" class="space-y-2 font-['Sarabun'] max-h-[250px] overflow-y-auto pr-2 custom-scrollbar"></div>
						</div>
						
                    </div>

                    <div class="flex justify-between items-center pt-6 border-t border-slate-100 mt-6 bg-white sticky bottom-0 z-10">
                         <button onclick="deleteCurrentSubject()" class="bg-white border border-rose-200 text-rose-600 hover:bg-rose-50 px-4 py-2 rounded-lg font-medium shadow-sm flex items-center font-['Sarabun'] font-bold text-xs transition gap-2">
                            <i class="fa-solid fa-trash-can"></i> ลบรายวิชา
                        </button>
                        <button onclick="applySettings()" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-8 py-2.5 rounded-lg transition shadow-lg shadow-blue-200 font-bold text-sm flex items-center gap-2 font-['Sarabun'] transform hover:-translate-y-0.5">
                            <i class="fa-solid fa-floppy-disk"></i> บันทึกและยืนยัน
                        </button>
                    </div>
                </div>
            </div>
        </div>
		
        <!-- ปรับแต่งส่วน Footer ใหม่ตามคำขอ -->
		<footer style="text-align: center; background-color:#faff99; padding: 20px 0; margin-top: auto; border-top: 1px solid #e0e0e0; font-size: 0.9em; color: #555; width: 100%;" class="no-print">
            <div class="container mx-auto flex flex-col items-center gap-2">
                <div class="w-full text-center">:: Created and Develop by KT | Tanasarn Sirak ::</div>
                
                <div class="w-full text-center">
                    <a href="https://line.me/ti/p/3F7VGrqgUr" target="_blank" style="text-decoration:none;" class="inline-flex items-center gap-1 justify-center">
                        <i class="fa-solid fa-comments" style="color:#007bff;"></i>
                        <span style="color:red; font-size:12px"> สอบถาม/แจ้งปัญหา :: </span>
                        <span style="font-size:12px; color:black">KT | Tanasarn Sirak © 2569</span>
                    </a>
                </div>

                <div class="w-full text-center flex items-center justify-center gap-2">
                    <span style="font-size: 14px; font-weight: 500;">:: จำนวนผู้ใช้งาน ::</span>
                    <a href="https://www.freecounterstat.com" title="website counter" class="inline-block">
                        <img src="https://counter1.optistats.ovh/private/freecounterstat.php?c=uwgfnf4ee1nu15h57t14a9pnpf2h58za" border="0" title="website counter" alt="website counter" style="display: block; height: 24px;">
                    </a>
                </div>
            </div>
		</footer>
		
    </div>


   <!-- Modal จัดการบุคลากร -->
<div id="staff-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay no-print font-['Sarabun']">
    <div class="bg-white w-full student-modal-content overflow-hidden flex flex-col max-w-4xl rounded-2xl shadow-2xl h-[90vh]">
        <div class="modal-header-bg p-4 flex justify-between items-center text-white bg-gradient-to-r from-teal-600 to-emerald-600 shrink-0">
            <h2 class="text-xl font-bold ml-1 flex items-center gap-2">
                <i class="fa-solid fa-user-tie"></i> <span id="staff-modal-label">จัดการข้อมูลบุคลากร</span>
            </h2>
            <button onclick="closeStaffModal()" class="modal-btn hover:bg-white/20 p-1.5 rounded-full transition">
                <i class="fa-solid fa-xmark fa-xl"></i>
            </button>
        </div>
        
        <div class="p-6 overflow-y-auto custom-scrollbar flex-grow bg-slate-50">
            <div class="flex flex-col lg:flex-row gap-6">
                <div class="flex-shrink-0 mx-auto lg:mx-0">
                    <div onclick="triggerStaffImageUpload()" class="photo-box relative group overflow-hidden w-[140px] h-[140px] border-2 border-dashed border-slate-300 rounded-xl hover:border-emerald-500 transition cursor-pointer flex items-center justify-center bg-white shadow-sm">
                        <img id="modal-staff-img-preview" class="hidden w-full h-full object-cover">
                        <div id="staff-image-upload-placeholder" class="text-center">
                            <i class="fa-solid fa-camera fa-2x mb-2 text-slate-400"></i>
                            <span class="text-[10px] font-bold text-slate-500 block">อัปโหลดรูป</span>
                        </div>
                        <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                            <span class="text-white text-xs font-bold"><i class="fa-solid fa-pen"></i> แก้ไข</span>
                        </div>
                    </div>
                    <input type="file" id="modal-staff-image-input" class="hidden" accept="image/*" onchange="handleStaffImagePreview(this)">
                    <div class="text-center mt-2">
                        <button type="button" onclick="document.getElementById('modal-staff-img-preview').src=''; document.getElementById('modal-staff-img-preview').classList.add('hidden'); document.getElementById('staff-image-upload-placeholder').classList.remove('hidden');" class="text-[10px] text-red-500 hover:underline">ลบรูปภาพ</button>
                    </div>
                </div>

                <div class="flex-grow space-y-6">
                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-sm font-bold text-emerald-600 mb-3 uppercase border-b pb-1"><i class="fa-solid fa-id-card"></i> ข้อมูลทั่วไป</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <div class="col-span-1 md:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">ชื่อ - นามสกุล <span class="text-red-500">*</span></label>
                                <input type="text" id="modal-staff-name" class="modal-input" placeholder="นายสมชาย ใจดี">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">เพศ</label>
                                <select id="modal-staff-gender" class="modal-input bg-white text-center">
                                    <option value="ชาย">ชาย</option>
                                    <option value="หญิง">หญิง</option>
                                </select>
                            </div>
							<div>
								<label class="block text-xs font-bold text-slate-500 mb-1">วันเดือนปีเกิด</label>
								<input type="text" id="modal-staff-birth" class="modal-input text-center datepicker-th" placeholder="วว/ดด/ปปปป" onchange="autoCalculateRetireDate()">
							</div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">ตำแหน่ง/วิทยฐานะ</label>
                                <input type="text" id="modal-staff-position" class="modal-input" placeholder="ครูชำนาญการพิเศษ">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">กลุ่มสาระฯ</label>
                                <select id="modal-staff-dept" class="modal-input bg-white">
                                    <option value="">- ระบุ -</option>
                                    <option value="ภาษาไทย">ภาษาไทย</option>
                                    <option value="คณิตศาสตร์">คณิตศาสตร์</option>
                                    <option value="วิทยาศาสตร์และเทคโนโลยี">วิทยาศาสตร์และเทคโนโลยี</option>
                                    <option value="สังคมศึกษา ศาสนา และวัฒนธรรม">สังคมศึกษาฯ</option>
                                    <option value="สุขศึกษาและพลศึกษา">สุขศึกษาและพลศึกษา</option>
                                    <option value="ศิลปะ">ศิลปะ</option>
                                    <option value="การงานอาชีพ">การงานอาชีพ</option>
                                    <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>
                                    <option value="กิจกรรมพัฒนาผู้เรียน">กิจกรรมพัฒนาผู้เรียน</option>
                                    <option value="บริหารสถานศึกษา">บริหารสถานศึกษา</option>
                                    <option value="บุคลากรทางการศึกษา">บุคลากรทางการศึกษา</option>
                                </select>
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">ที่ปรึกษา (ห้อง)</label>
                                <input type="text" id="modal-staff-advisor" class="modal-input text-center" placeholder="ม.4/1">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">เบอร์โทรศัพท์</label>
                                <input type="text" id="modal-staff-phone" class="modal-input text-center" placeholder="08x-xxxxxxx">
                            </div>
                             <div class="col-span-1 md:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Email</label>
                                <input type="email" id="modal-staff-email" class="modal-input" placeholder="teacher@school.ac.th">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-sm font-bold text-blue-600 mb-3 uppercase border-b pb-1"><i class="fa-solid fa-certificate"></i> ข้อมูลวิชาชีพ</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                             <div class="col-span-1 md:col-span-3 lg:col-span-1">
                                <label class="block text-xs font-bold text-slate-500 mb-1">เลขที่ใบอนุญาต</label>
                                <input type="text" id="modal-staff-license-no" class="modal-input text-center" placeholder="621xxxxxxxxxx">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">วันหมดอายุ</label>
                                <input type="text" id="modal-staff-license-exp" class="modal-input text-center datepicker-th" placeholder="เลือกวันที่...">
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">สถานะใบอนุญาต</label>
                                <select id="modal-staff-license-status" class="modal-input bg-white text-center">
                                    <option value="ปกติ">ปกติ</option>
                                    <option value="ใกล้หมดอายุ">ใกล้หมดอายุ</option>
                                    <option value="หมดอายุ">หมดอายุ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                        <h3 class="text-sm font-bold text-yellow-600 mb-3 uppercase border-b pb-1"><i class="fa-solid fa-medal"></i> เครื่องราชอิสริยาภรณ์</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">
                            <div class="col-span-1 md:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">ชั้นสูงสุดที่ได้รับ</label>
                                <input type="text" id="modal-staff-royal-dec" class="modal-input" placeholder="ท.ช.">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">ปีที่ได้รับ</label>
                                <input type="text" id="modal-staff-royal-year" class="modal-input text-center" placeholder="2565">
                            </div>
                             <div>
                                <label class="block text-xs font-bold text-slate-500 mb-1">วันครบขอครั้งถัดไป</label>
                                <input type="text" id="modal-staff-next-dec" class="modal-input text-center datepicker-th" placeholder="เลือกวันที่...">
                            </div>
                             <div class="col-span-1 md:col-span-4">
                                <label class="block text-xs font-bold text-slate-500 mb-1">สถานะการขอ</label>
                                <select id="modal-staff-royal-status" class="modal-input bg-white">
                                    <option value="ยังไม่ถึงเกณฑ์">ยังไม่ถึงเกณฑ์</option>
                                    <option value="รอขอ">รอขอ</option>
                                    <option value="ขอแล้ว">ขอแล้ว</option>
                                    <option value="ได้รับแล้ว">ได้รับแล้ว</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
					<div class="bg-slate-100 p-4 rounded-xl border border-slate-200">
						<div class="grid grid-cols-1 md:grid-cols-3 gap-3"> <div>
								<label class="block text-xs font-bold text-slate-500 mb-1">วันที่ บรรจุ/ย้าย</label>
								<input type="text" id="modal-staff-date" class="modal-input text-center datepicker-th" placeholder="วว/ดด/ปปปป">
							</div>

							<div>
								<label class="block text-xs font-bold text-slate-500 mb-1">วันที่เกษียณอายุ</label>
								<input type="text" id="modal-staff-retire" class="modal-input text-center datepicker-th" placeholder="30 ก.ย. 2600">
							</div>

							<div>
								<label class="block text-xs font-bold text-slate-500 mb-1">สถานะบุคลากร</label>
								<select id="modal-staff-status" class="modal-input bg-white text-center font-bold text-blue-700">
									<option value="ปฏิบัติหน้าที่">ปฏิบัติหน้าที่</option>
									<option value="ช่วยราชการ">ช่วยราชการ</option>
									<option value="ลาศึกษาต่อ">ลาศึกษาต่อ</option>
									<option value="ย้ายออก">ย้ายออก</option>
									<option value="เกษียณอายุ">เกษียณอายุ</option>
									<option value="ลาออก">ลาออก</option>
								</select>
							</div>
						</div>
					</div>

                </div>
            </div>
        </div>

        <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-2 shrink-0">
            <input type="hidden" id="modal-staff-uid">
            <button onclick="closeStaffModal()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-5 py-2.5 rounded-lg font-bold text-sm transition">
                ยกเลิก
            </button>
            <button onclick="saveStaffData()" class="bg-gradient-to-r from-teal-500 to-emerald-600 hover:from-teal-600 hover:to-emerald-700 text-white px-6 py-2.5 rounded-lg font-bold text-sm shadow-md transition flex items-center gap-2">
                <i class="fa-solid fa-floppy-disk"></i> บันทึกข้อมูล
            </button>
        </div>
    </div>
</div>





    <!-- Modal จัดการข้อมูลนักเรียน -->
    <div id="student-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay no-print">
        <div class="bg-white w-full student-modal-content overflow-hidden flex flex-col font-['Sarabun']">
            <div class="modal-header-bg p-4 flex justify-between items-center text-white">
                <h2 id="modal-title" class="text-xl font-bold ml-1 font-['Sarabun']">แก้ไขข้อมูลนักเรียน</h2>
                <button onclick="closeStudentModal()" class="modal-btn hover:bg-white/20 p-1.5 rounded-full transition font-['Sarabun']">
                    <i class="fa-solid fa-xmark fa-xl"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="flex gap-6 mb-5">
                    <div class="flex-shrink-0">
                        <div onclick="triggerImageUpload()" class="photo-box relative group overflow-hidden font-['Sarabun']">
                            <img id="modal-stu-img-preview" class="hidden w-full h-full object-cover rounded-lg">
                            <div id="image-upload-placeholder" class="text-center font-['Sarabun']">
                                <i class="fa-solid fa-camera fa-2x mb-1 opacity-50"></i>
                                <span class="text-[10px] font-bold font-['Sarabun'] block">แนบรูป</span>
                            </div>
                            <div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity font-['Sarabun']"><span class="text-white text-[9px] font-bold">เปลี่ยนรูป</span></div>
                        </div>
                        <input type="file" id="modal-stu-image-input" class="hidden" accept="image/*" onchange="handleImagePreview(this)">
                    </div>
                    <div class="flex-grow space-y-1 font-['Sarabun']">
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-0.5">รหัสนักเรียน</label><input type="text" id="modal-stu-id" class="modal-input font-bold text-slate-800 font-['Sarabun'] py-1"></div>
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-0.5">เลขบัตรประชาชน</label><input type="text" id="modal-stu-national-id" class="modal-input text-slate-800 font-['Sarabun'] py-1" placeholder="13 หลัก"></div>
                        <div><label class="block text-[10px] font-bold text-slate-500 mb-0.5">ชื่อ-นามสกุล</label><input type="text" id="modal-stu-name" class="modal-input font-['Sarabun'] py-1"></div>
                    </div>
                </div>
                <div class="grid grid-cols-4 gap-3 mb-5 font-['Sarabun']">
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ชั้น/ห้อง</label><input type="text" id="modal-stu-room" class="modal-input text-center font-['Sarabun']"></div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">เลขที่</label><input type="number" id="modal-stu-number" class="modal-input text-center font-['Sarabun']"></div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">เพศ</label>
                        <select id="modal-stu-gender" class="modal-input bg-white font-['Sarabun'] text-center">
                            <option value="ชาย">ชาย</option>
                            <option value="หญิง">หญิง</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-500 mb-1">ปีที่เข้า</label><input type="number" id="modal-stu-year" class="modal-input text-center font-['Sarabun']"></div>
                </div>
                <div><label class="block text-xs font-bold text-slate-500 mb-1 font-['Sarabun']">สถานะภาพ</label><select id="modal-stu-status" class="modal-input bg-white font-['Sarabun']"><option value="ปกติ">ปกติ</option><option value="ขาดเรียนนาน">ขาดเรียนนาน</option><option value="ลาออก">ลาออก</option><option value="สำเร็จการศึกษา">สำเร็จการศึกษา</option></select></div>
            </div>
            <div class="p-6 pt-0 flex justify-end gap-2 items-center font-['Sarabun']">
                <input type="hidden" id="modal-student-uid">
                <button onclick="closeStudentModal()" class="bg-rose-600 text-white px-5 py-2.5 rounded-lg font-medium shadow-sm flex items-center font-['Sarabun'] font-bold text-sm">ยกเลิก</button>
                <button onclick="saveStudent()" class="bg-blue-500 text-white px-5 py-2.5 rounded-lg font-medium shadow-sm flex items-center font-['Sarabun'] font-bold text-sm">บันทึกข้อมูล</button>
            </div>
        </div>
    </div>


	<div id="calendar-modal" class="hidden fixed inset-0 z-[60000] flex items-center justify-center p-4 modal-overlay font-['Sarabun']">
		<div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
			
			<div class="modal-header-bg p-4 flex justify-between items-center text-white bg-gradient-to-r from-purple-600 to-indigo-600 shrink-0">
				<h2 class="text-xl font-bold ml-1 flex items-center gap-2">
					<i class="fa-regular fa-calendar-plus"></i> <span id="calendar-modal-title">เพิ่มกิจกรรมใหม่</span>
				</h2>
				<button onclick="closeCalendarModal()" class="hover:bg-white/20 p-1.5 rounded-full transition">
					<i class="fa-solid fa-xmark fa-xl"></i>
				</button>
			</div>

			<div class="p-6 overflow-y-auto custom-scrollbar flex-grow bg-slate-50">
				<form id="calendar-form" class="space-y-4">
					<input type="hidden" id="evt-id">
					
					<div>
						<label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่อกิจกรรม <span class="text-red-500">*</span></label>
						<input type="text" id="evt-title" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none" placeholder="ระบุชื่อกิจกรรม...">
					</div>

					<div>
						<label class="block text-xs font-bold text-slate-500 uppercase mb-1">รายละเอียด (พอสังเขป)</label>
						<textarea id="evt-desc" rows="2" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none" placeholder="รายละเอียดเพิ่มเติม..."></textarea>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						<div>
							<label class="block text-xs font-bold text-slate-500 uppercase mb-1">กลุ่มงาน/ฝ่าย</label>
							<select id="evt-group" class="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-purple-500 outline-none">
								<option value="วิชาการ">บริหารวิชาการ</option>
								<option value="งบประมาณ">บริหารงบประมาณ</option>
								<option value="บุคคล">บริหารงานบุคคล</option>
								<option value="ทั่วไป">บริหารทั่วไป</option>
								<option value="กิจการนักเรียน">กิจการนักเรียน</option>
								<option value="โครงการพิเศษ">โครงการพิเศษ</option>
								<option value="อื่น ๆ">อื่น ๆ</option>
							</select>
						</div>
						<div>
							<label class="block text-xs font-bold text-slate-500 uppercase mb-1">สถานที่จัดกิจกรรม</label>
							<input type="text" id="evt-location" class="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none" placeholder="เช่น หอประชุม, ห้องโสตฯ">
						</div>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-4 bg-purple-50 p-3 rounded-lg border border-purple-100">
                        <div>
                            <label class="block text-xs font-bold text-purple-700 uppercase mb-1"><i class="fa-regular fa-calendar"></i> วันที่เริ่ม</label>
                            <input type="text" id="evt-start" class="w-full border border-slate-300 rounded-lg p-2 text-center text-sm datepicker-th bg-white focus:ring-2 focus:ring-purple-500 outline-none" placeholder="วว ด.ด. ปปปป">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-purple-700 uppercase mb-1"><i class="fa-solid fa-calendar-check"></i> วันที่สิ้นสุด</label>
                            <input type="text" id="evt-end" class="w-full border border-slate-300 rounded-lg p-2 text-center text-sm datepicker-th bg-white focus:ring-2 focus:ring-purple-500 outline-none" placeholder="วว ด.ด. ปปปป">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-indigo-700 uppercase mb-1"><i class="fa-regular fa-clock"></i> เวลาเริ่มกิจกรรม</label>
                            <input type="text" id="evt-time-start" class="w-full border border-slate-300 rounded-lg p-2 text-center text-sm timepicker-th bg-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="08:30">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-indigo-700 uppercase mb-1"><i class="fa-solid fa-clock-rotate-left"></i> เวลาสิ้นสุด</label>
                            <input type="text" id="evt-time-end" class="w-full border border-slate-300 rounded-lg p-2 text-center text-sm timepicker-th bg-white focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="16:30">
                        </div>
                    </div>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-3">
						<div>
							<label class="block text-xs font-bold text-slate-400 uppercase mb-1">รหัสผู้บันทึก</label>
							<input type="text" id="evt-recorder-id" class="w-full border border-slate-200 bg-slate-100 rounded-lg p-2 text-sm text-slate-500 focus:ring-2 focus:ring-purple-500 outline-none" readonly>
						</div>
						<div>
							<label class="block text-xs font-bold text-slate-500 uppercase mb-1">ผู้รับผิดชอบโครงการ</label>
							<input type="text" id="evt-responsible" class="w-full border border-slate-300 rounded-lg p-2 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-purple-500 outline-none" placeholder="ระบุชื่อครู/ผู้รับผิดชอบ">
						</div>
					</div>
				</form>
			</div>

			<div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-2 shrink-0">
				<button onclick="closeCalendarModal()" class="bg-slate-200 hover:bg-slate-300 text-slate-700 px-5 py-2.5 rounded-lg font-bold text-sm transition">
					ยกเลิก
				</button>
				<button onclick="saveCalendarEvent()" class="bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white px-6 py-2.5 rounded-lg font-bold text-sm shadow-md transition flex items-center gap-2">
					<i class="fa-solid fa-floppy-disk"></i> บันทึกข้อมูล
				</button>
			</div>
		</div>
	</div>

<script>
	// ตัวแปรควบคุมการแสดงผล (false = แบ่งหน้าปกติ, true = แสดงทั้งหมด)
	let isShowAllRows = false;

	function toggleShowAllRows(checked) {
		// 1. อัปเดตตัวแปร Global
		isShowAllRows = checked;
		
		// 2. ตรวจสอบว่าปัจจุบันอยู่ที่หน้าไหน (View ไหน Active อยู่)
		const activeView = document.querySelector('.view-section.view-active')?.id;

		// 3. เรียกฟังก์ชัน Init ของหน้านั้นๆ เพื่อรีเฟรชตาราง
		if (activeView === 'task-grading-view') {
			initTaskTable(); // หน้าบันทึกคะแนนเก็บสะสม
		} else if (activeView === 'rw-view') {
			initRWTable(); // หน้าอ่าน คิดวิเคราะห์ เขียน
		} else if (activeView === 'competency-view') {
			initCompetencyTable(); // หน้าสมรรถนะฯ
		} else if (activeView === 'attribute-view') {
			initAttributeTable(); // หน้าคุณลักษณะฯ
		} else {
			// กรณีหน้าอื่นๆ หรือหน้าแรก
			initTable(); 
		}
	}

	// --- Global Variables (แก้ไขส่วนนี้บนสุดของ Script) ---

	// 1. ดึงค่าจาก localStorage ตอนโหลดหน้าเว็บ (ถ้าไม่มีค่าจะให้เป็น false)
	let isUseScoreRW = localStorage.getItem('isUseScoreRW') === 'true';
	let isUseScoreComp = localStorage.getItem('isUseScoreComp') === 'true';
	let isUseScoreAttr = localStorage.getItem('isUseScoreAttr') === 'true';

	// 2. ฟังก์ชัน Toggle พร้อมบันทึกค่าลง localStorage
	function toggleUseScoreRW(checked) { 
		isUseScoreRW = checked; 
		localStorage.setItem('isUseScoreRW', checked); // บันทึกสถานะล่าสุดลงเครื่อง
	}

	function toggleUseScoreComp(checked) { 
		isUseScoreComp = checked; 
		localStorage.setItem('isUseScoreComp', checked); // บันทึกสถานะล่าสุดลงเครื่อง
	}

	function toggleUseScoreAttr(checked) { 
		isUseScoreAttr = checked; 
		localStorage.setItem('isUseScoreAttr', checked); // บันทึกสถานะล่าสุดลงเครื่อง
	}
	// ------------------------------------------------
	
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
    
	// ตัวแปรสำหรับเก็บ Timer ของการจำลองโหลด
		let loadingInterval;

	function showLoading() { 
			const overlay = document.getElementById('loading-overlay');
			const bar = document.getElementById('loading-progress-bar');
			
			if (overlay && bar) {
				// [แก้ไข] เปลี่ยนจาก 50000 เป็น 70000 (เพื่อให้สูงกว่า Modal ที่เป็น 60000)
				overlay.style.zIndex = '70000'; 
				
				overlay.style.display = 'flex'; 
				
				// รีเซ็ตค่าเริ่มต้น
				let width = 0;
				bar.style.width = '0%';
				bar.innerText = '0%';
				
				// เคลียร์ Timer เก่า (ถ้ามี)
				if (loadingInterval) clearInterval(loadingInterval);

				// เริ่มจำลองเปอร์เซ็นต์ (Simulate Progress)
				loadingInterval = setInterval(() => {
					// ถ้ายังไม่ถึง 90% ให้เพิ่มทีละนิด
					if (width < 90) {
						// สุ่มเพิ่ม 1-5% เพื่อให้ดูเป็นธรรมชาติ
						width += Math.random() * 5; 
					} else {
						// ถ้าเกิน 90% แล้วให้ขยับช้าๆ มากๆ (รอ Server ตอบกลับ)
						if (width < 95) width += 0.1;
					}
					
					// อัปเดต UI
					bar.style.width = width + '%';
					bar.innerText = Math.round(width) + '%';
				}, 300); // อัปเดตทุก 0.3 วินาที
			}
		}

		function hideLoading() { 
			const overlay = document.getElementById('loading-overlay');
			const bar = document.getElementById('loading-progress-bar');

			if (loadingInterval) clearInterval(loadingInterval); // หยุดการจำลอง

			if (bar) {
				// เมื่อโหลดเสร็จจริง ให้พุ่งไป 100%
				bar.style.width = '100%';
				bar.innerText = '100%';
			}

			// รอ 500ms ให้คนเห็นว่าเต็ม 100% แล้วค่อยปิด
			setTimeout(() => {
				if (overlay) overlay.style.display = 'none'; 
				if (bar) {
					// รีเซ็ตกลับเป็น 0 รอไว้ครั้งหน้า
					bar.style.width = '0%';
					bar.innerText = '0%';
				}
			}, 500);
		}
    function showNotification(msg, type = 'success') { Toast.fire({ icon: type, title: msg }); }

    function getStatusStyle(status) { 
        const styles = { 'ปกติ': 'bg-emerald-100 text-emerald-700', 'ขาดเรียนนาน': 'bg-orange-100 text-orange-700', 'ลาออก': 'bg-rose-100 text-rose-700', 'สำเร็จการศึกษา': 'bg-blue-100 text-blue-700' }; 
        return styles[status] || 'bg-slate-100 text-slate-700'; 
    }

function viewStudentPhoto(uid) {
    const s = students.find(x => x.uid === uid);
    if (!s) return;
    
    const placeholderImg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23cbd5e1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' /%3E%3C/svg%3E`;
    
    Swal.fire({
        width: '380px',
        padding: '0',
        html: `
        <div class="flex flex-col items-center font-['Sarabun'] p-6">
            <div class="mb-4">
                <img onclick="viewFullStudentImage('${s.uid}')" 
                     src="${s.image || placeholderImg}" 
                     class="w-40 h-40 object-cover rounded-[2rem] shadow-xl border-4 border-white cursor-pointer hover:scale-105 transition-transform duration-200"
                     title="คลิกเพื่อดูรูปขยาย">
            </div>
            
            <div class="text-2xl font-bold text-slate-800 mb-0.5 leading-tight text-center">${s.name}</div>
            <div class="text-lg text-indigo-600 font-bold mb-0 leading-tight">รหัส: ${s.id}</div>
            <div class="text-sm text-slate-500 font-bold mb-4 leading-tight">เลขบัตรประชาชน: ${s.nationalId || '-'}</div>
            
            <div class="w-full bg-lime-200 py-3 px-2 rounded-2xl border border-slate-100 mb-6 text-[13px] text-slate-500 font-medium flex justify-center gap-1">
                ห้อง ${s.room} | เลขที่ ${s.number} | เพศ ${s.gender} | สถานะ: <span class="${getStatusTextColor(s.status)} font-bold">${s.status}</span>
            </div>
            <button onclick="Swal.close()" class="modal-btn w-2/3 bg-[#0d6efd] text-white py-3 rounded-2xl text-xl font-bold transition hover:bg-blue-700">ปิดหน้าต่าง</button>
        </div>`,
        showConfirmButton: false,
        customClass: { popup: 'rounded-[2.5rem]', htmlContainer: 'p-0' }
    });
}

    function getStatusTextColor(status) { const colors = { 'ปกติ': 'text-emerald-600', 'ขาดเรียนนาน': 'text-orange-600', 'ลาออก': 'text-rose-600', 'สำเร็จการศึกษา': 'text-blue-600' }; return colors[status] || 'text-slate-600'; }

    // DATA VARIABLES
    let subjects = [];
    const generateUID = () => Math.random().toString(36).substr(2, 9);
    let students = [];
    let scoreData = {}; 
    
    let activeSubjectId = ""; 
    let activeClassName = ""; 
    let editingSubjectId = null;
    let currentGradingPage = 1; let currentStudentPage = 1; let rowsPerPage = 10;
    let currentPrintMode = 'all';
	let currentStaffPage = 1;

    // Achievement Filter Variables
    let achFilterSubject = 'all';
    let achFilterRoom = 'all';
    
    // --- Helper Function: Get Active Students In Class ---
    function getActiveStudentsInClass(className) {
        if (!className) return [];
        const targetRoom = String(className).trim();
        return students.filter(s => {
            if (!s.room) return false;
            const sRoom = String(s.room).trim();
            const sStatus = String(s.status || "").trim();
            return sRoom === targetRoom && (sStatus === 'ปกติ' || sStatus === '');
        });
    }

    // --- Filter Management Functions ---
    function updateAchFilters() {
        const subSelect = document.getElementById('ach-filter-subject');
        const roomSelect = document.getElementById('ach-filter-room');
        
        if (subSelect) {
            let subHtml = '<option value="all">ทุกรายวิชา</option>';
            subjects.forEach(s => {
                subHtml += `<option value="${s.id}" ${s.id === achFilterSubject ? 'selected' : ''}>${s.code} ${s.name}</option>`;
            });
            subSelect.innerHTML = subHtml;
        }

        if (roomSelect) {
            let allRooms = new Set();
            subjects.forEach(s => {
                if (achFilterSubject === 'all' || s.id === achFilterSubject) {
                    if (s.classes) s.classes.forEach(c => allRooms.add(c));
                }
            });

            const sortedRooms = Array.from(allRooms).sort((a, b) => 
                a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
            );

            let roomHtml = '<option value="all">ทุกห้องเรียน</option>';
            sortedRooms.forEach(r => {
                roomHtml += `<option value="${r}" ${r === achFilterRoom ? 'selected' : ''}>${r}</option>`;
            });
            roomSelect.innerHTML = roomHtml;
        }
    }

    function changeAchFilterSubject(val) {
        achFilterSubject = val;
        achFilterRoom = 'all'; 
        updateAchFilters();
        initAchievementView();
    }

    function changeAchFilterRoom(val) {
        achFilterRoom = val;
        initAchievementView();
    }

	function switchView(view) {
        showLoading();
        setTimeout(() => {
            try {
                document.querySelectorAll('.view-section').forEach(v => v.classList.remove('view-active'));
                const viewEl = document.getElementById(view + '-view');
                if (viewEl) viewEl.classList.add('view-active');
                
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('opacity-100', 'shadow-inner'));
                
                if (view === 'grading') { 
                    updateGradingFilters(); 
                    updateDisplayHeader(); 
                    initTable(); 
                } 
                else if (view === 'students') { 
                    updateStudentFilters(); 
                    initStudentTable(); 
                } 
                else if (view === 'settings') { 
                    renderSettingsSubjects(); 
                }
                else if (view === 'achievement') { 
                    updateAchFilters();
                    initAchievementView(); 
                }
                // --- ส่วนที่เพิ่มใหม่ (ต้องต่อจาก achievement ทันที) ---
                else if (view === 'staff') { 
                    initStaffTable(); 
                }
                // ------------------------------------------------
                // [เพิ่มเงื่อนไขใหม่ตรงนี้]
				else if (view === 'calendar') {
					renderCalendar(); // เรียกฟังก์ชันวาดปฏิทิน
				}
				// ...
				// ค้นหา function switchView(view) แล้วเพิ่ม else if นี้เข้าไป
				else if (view === 'task-grading') {
					// ใช้ Logic เดียวกับ Grading แต่เปลี่ยนเป้าหมาย
					const subSelect = document.getElementById('select-subject-task');
					const classSelect = document.getElementById('select-class-task');
					
					// Copy Options มาใส่ (ประหยัดเวลาเขียนใหม่)
					if(subSelect) subSelect.innerHTML = subjects.map(s => `<option value="${s.id}" ${s.id === activeSubjectId ? 'selected' : ''}>${s.code} ${s.name}</option>`).join('');
					
					let sub = subjects.find(s => s.id === activeSubjectId);
					if (sub && classSelect) {
						classSelect.innerHTML = sub.classes.map(c => `<option value="${c}" ${c === activeClassName ? 'selected' : ''}>${c}</option>`).join('');
						classSelect.value = activeClassName;
					}
					
					initTaskTable(); // เรียกฟังก์ชันสร้างตารางงาน
				}
				
				else if (view === 'achievement') { 
					updateAchFilters();
					initAchievementView(); 
				}
				// --- เพิ่มใหม่ ---
				else if (view === 'rw') {
					updateCommonDropdowns('select-subject-rw', 'select-class-rw');
					initRWTable();
				}
				else if (view === 'competency') {
					updateCommonDropdowns('select-subject-comp', 'select-class-comp');
					initCompetencyTable();
				}
				else if (view === 'attribute') {
					updateCommonDropdowns('select-subject-attr', 'select-class-attr');
					initAttributeTable();
				}
				// --------------------
				else if (view === 'staff') { 
					initStaffTable(); 
				}
			
            } catch (err) {
                console.error("View switch error:", err);
            } finally {
                hideLoading();
            }
        }, 300);
    }

    function switchSettingsTab(tabId) {
        document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.add('hidden'));
        document.querySelectorAll('.settings-tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.remove('hidden');
        document.getElementById('btn-' + tabId).classList.add('active');
    }

	function initAchievementView() {
        const targetSub = (achFilterSubject !== 'all') 
            ? subjects.find(s => s.id === achFilterSubject) 
            : (subjects[0] || {});

        const deptEl = document.getElementById('view-ach-dept-name');
        const teachEl = document.getElementById('view-ach-teacher-name');
        const semEl = document.getElementById('view-ach-sem');
        const yearEl = document.getElementById('view-ach-year');
        const schoolEl = document.getElementById('view-ach-school-name');

        if(deptEl) deptEl.innerText = (achFilterSubject === 'all') ? "รวมทุกรายวิชา" : (targetSub.departmentName || "-");
        if(teachEl) teachEl.innerText = targetSub.teacher || "-";
        if(semEl) semEl.innerText = targetSub.semester || "-";
        if(yearEl) yearEl.innerText = targetSub.year || "-";
        if(schoolEl) schoolEl.innerText = targetSub.schoolName || "โรงเรียนปากช่อง";
        // --- [จุดที่แก้ไข: เปลี่ยน ID ให้ตรงกับ HTML ของคุณ] ---
        const tbody = document.getElementById('view-ach-table-body'); // แก้จาก ach-table-body เป็น view-ach-table-body
        const tfoot = document.getElementById('view-ach-table-foot'); // แก้จาก ach-table-foot เป็น view-ach-table-foot
        const thead = document.querySelector('#achievement-view table thead');
        // -----------------------------------------------------

// ค้นหาฟังก์ชันชื่อ initAchievementView() แล้วแก้ไขส่วน thead.innerHTML ดังนี้:

if (thead) {
    thead.innerHTML = `
        <tr class="bg-amber-100 text-slate-900 font-bold">
            <th rowspan="2" style="width: 80px;" class="border-slate-300 border p-2">รหัสวิชา</th>
            <th rowspan="2" class="border-slate-300 border p-2">ชั้น</th>
            <th rowspan="2" class="w-10 border-slate-300 border p-2">จำนวน<br>นักเรียน</th>
            <th colspan="10" class="border-slate-300 border bg-white/20 p-1">จำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
            <th rowspan="2" class="w-8 border-slate-300 border bg-white/20 p-2">รวม</th>
            <th colspan="10" class="border-slate-300 border bg-white/20 p-1">ร้อยละจำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
            <th rowspan="2" class="w-10 border-slate-300 border bg-white/20 p-2">ร้อยละ<br>รวม</th>
            <th rowspan="2" class="w-10 border-slate-300 border p-2">X-Bar</th>
            <th rowspan="2" class="w-10 border-slate-300 border p-2">S.D.</th>
            <th rowspan="2" class="w-10 border-slate-300 border p-2">%ผ่านเกณฑ์</th>
            <th rowspan="2" class="w-12 border-slate-300 border p-2">%ระดับ<br>ดีขึ้นไป</th>
            <th rowspan="2" class="w-12 border-slate-300 border p-2">%ไม่ผ่าน<br>เกณฑ์</th>
            <th rowspan="2" class="w-16 border-slate-300 border p-2">สรุป<br>ผลสัมฤทธิ์</th>
        </tr>
        <tr class="bg-amber-100 text-slate-800">
            <th class="w-6 border-slate-300 border text-xs py-1">4.0</th><th class="w-6 border-slate-300 border text-xs">3.5</th><th class="w-6 border-slate-300 border text-xs">3.0</th><th class="w-6 border-slate-300 border text-xs">2.5</th><th class="w-6 border-slate-300 border text-xs">2.0</th><th class="w-6 border-slate-300 border text-xs">1.5</th><th class="w-6 border-slate-300 border text-xs">1.0</th><th class="w-6 border-slate-300 border text-xs">0</th><th class="w-6 border-slate-300 border text-xs">ร</th><th class="w-6 border-slate-300 border text-xs">มส</th>
            <th class="w-8 border-slate-300 border text-xs">4.0</th><th class="w-8 border-slate-300 border text-xs">3.5</th><th class="w-8 border-slate-300 border text-xs">3.0</th><th class="w-8 border-slate-300 border text-xs">2.5</th><th class="w-8 border-slate-300 border text-xs">2.0</th><th class="w-8 border-slate-300 border text-xs">1.5</th><th class="w-8 border-slate-300 border text-xs">1.0</th><th class="w-8 border-slate-300 border text-xs">0</th><th class="w-8 border-slate-300 border text-xs">ร</th><th class="w-8 border-slate-300 border text-xs">มส</th>
        </tr>
    `;
}

        // สร้าง Body ตาราง
        if (tbody) {
            tbody.innerHTML = '';
            if (tfoot) tfoot.innerHTML = '';

            let grandTotalStudents = 0;
            let grandGradeCounts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
            let grandPassedCount = 0;
            let grandGoodCount = 0;
            let grandFailCount = 0;
            let grandTotalScores = 0;
            let grandScoreList = []; 

            subjects.forEach(sub => {
                if (achFilterSubject !== 'all' && sub.id !== achFilterSubject) return;

                sub.classes.forEach(cls => {
                    if (achFilterRoom !== 'all' && cls !== achFilterRoom) return;

                    const clsStudents = getActiveStudentsInClass(cls);
                    if (clsStudents.length === 0) return;

                    const total = clsStudents.length;
                    let counts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
                    let passedCount = 0;
                    let goodCount = 0;
                    let failCount = 0;
                    let classScores = [];
                    let classTotalScore = 0;
                    
                    clsStudents.forEach(stu => {
                        const totalScore = calculateStudentTotalBySub(sub, stu.uid, cls);
                        const rem = getStoredScore(sub.id, cls, stu.uid, 'remark', "");
                        let grade = rem || computeGradeBySub(sub, totalScore);
                        
                        if (grade === '4') grade = '4.0';
                        if (grade === '3') grade = '3.0';
                        if (grade === '2') grade = '2.0';
                        if (grade === '1') grade = '1.0';
                        
                        if (counts.hasOwnProperty(grade)) counts[grade]++;
                        
                        if (!rem) {
                            const gVal = parseFloat(grade);
                            if(!isNaN(gVal)) {
                                classScores.push(gVal);
                                classTotalScore += gVal;
                                if (gVal >= 1.0) passedCount++;
                                if (gVal >= 3.0) goodCount++;
                                if (gVal === 0) failCount++;
                            }
                        } else if (rem === 'ผ') {
                            passedCount++;
                        }
                    });
                    
                    grandTotalStudents += total;
                    grandPassedCount += passedCount;
                    grandGoodCount += goodCount;
                    grandFailCount += failCount;
                    Object.keys(counts).forEach(k => grandGradeCounts[k] += counts[k]);
                    grandScoreList = grandScoreList.concat(classScores);
                    grandTotalScores += classTotalScore;
                    
                    const classAvg = classScores.length > 0 ? (classTotalScore / classScores.length).toFixed(2) : '0.00';
                    const classSD = calculateSD(classScores).toFixed(2);
                    const passPct = total > 0 ? ((passedCount / total) * 100).toFixed(1) : '0.0';
                    const goodPct = total > 0 ? ((goodCount / total) * 100).toFixed(1) : '0.0';
                    const failPct = total > 0 ? ((failCount / total) * 100).toFixed(1) : '0.0';
                    const conclusionHtml = parseFloat(classAvg) >= (sub.targetDeptGPA || 2.55) ? '<span class="text-green-600 font-bold">ผ่านเกณฑ์</span>' : '<span class="text-red-600 font-bold">ไม่ผ่านเกณฑ์</span>';

                    let rowHtml = `<tr class="border-b border-slate-200 odd:bg-white even:bg-amber-100 hover:bg-amber-50 transition-colors text-sm text-slate-700"><td>${sub.code}</td><td>${cls}</td><td>${total}</td>`;
                    ['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => rowHtml += `<td>${counts[g]}</td>`);
                    rowHtml += `<td class="font-bold bg-black/5">${total}</td>`;
                    ['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => { const pct = total > 0 ? ((counts[g] / total) * 100).toFixed(1) : '0.0'; rowHtml += `<td>${pct}</td>`; });
                    rowHtml += `<td class="font-bold bg-black/5">100.0</td><td>${classAvg}</td><td>${classSD}</td><td>${passPct}</td><td>${goodPct}</td><td>${failPct}</td><td>${conclusionHtml}</td></tr>`;
                    tbody.innerHTML += rowHtml;
                });
            });

            // สร้าง Footer
            if (tfoot) {
                const grandAvg = grandScoreList.length > 0 ? (grandTotalScores / grandScoreList.length).toFixed(2) : '0.00';
                const grandSD = calculateSD(grandScoreList).toFixed(2);
                const grandPassPct = grandTotalStudents > 0 ? ((grandPassedCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
                const grandGoodPct = grandTotalStudents > 0 ? ((grandGoodCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
                const grandFailPct = grandTotalStudents > 0 ? ((grandFailCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
                
                const targetSub = (achFilterSubject !== 'all') ? subjects.find(s => s.id === achFilterSubject) : subjects[0];
                const grandConclusionHtml = parseFloat(grandAvg) >= (targetSub.targetDeptGPA || 2.55) ? '<span class="text-green-800 font-bold">ผ่านเกณฑ์</span>' : '<span class="text-red-700 font-bold">ไม่ผ่านเกณฑ์</span>';

                let footHtml = `<tr class="bg-lime-200 font-bold text-slate-900 border-t-2 border-slate-400"><td colspan="2" class="text-center">สรุปผลรวม</td><td>${grandTotalStudents}</td>`;
                ['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => footHtml += `<td>${grandGradeCounts[g]}</td>`);
                footHtml += `<td class="bg-black/10">${grandTotalStudents}</td>`;
                ['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => { const pct = grandTotalStudents > 0 ? ((grandGradeCounts[g] / grandTotalStudents) * 100).toFixed(1) : '0.0'; footHtml += `<td>${pct}</td>`; });
                footHtml += `<td class="bg-black/10">100.0</td><td>${grandAvg}</td><td>${grandSD}</td><td>${grandPassPct}</td><td>${grandGoodPct}</td><td>${grandFailPct}</td><td>${grandConclusionHtml}</td></tr>`;
                tfoot.innerHTML = footHtml;

                updateAchAnalysis(grandGradeCounts, grandTotalStudents);
            }
            
        generateAchChart(grandGradeCounts, grandTotalStudents, 'view-ach-chart-1'); 
        generateAchChart(grandGradeCounts, grandTotalStudents, 'view-ach-chart-2', false);
        }
    }

    function updateAchAnalysis(counts, total) {
        const analysisEl = document.getElementById('ach-analysis-text');
        if(!analysisEl || total === 0) return;
        
        let maxCount = 0;
        let maxGrade = '';
        ['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0'].forEach(g => {
            if((counts[g] || 0) > maxCount) {
                maxCount = counts[g];
                maxGrade = g;
            }
        });

        const maxPct = (maxCount / total) * 100;
        let analysisText = `กราฟนี้แสดงความหนาแน่นของจำนวนนักเรียนแยกตามระดับผลการเรียน โดยพบว่านักเรียนส่วนใหญ่ (${maxPct.toFixed(1)}%) มีผลการเรียนอยู่ในระดับ ${maxGrade} `;
        
        if(maxPct > 50) {
            analysisText += `ซึ่งแสดงถึงการกระจายแบบ "กลุ่ม (Clumped)" อย่างชัดเจนที่ช่วงระดับคะแนนนี้ `;
        } else if(maxPct < 25) {
            analysisText += `ซึ่งมีการกระจายตัวค่อนข้าง "สม่ำเสมอ (Uniform)" ในหลายระดับชั้นคะแนน `;
        } else {
            analysisText += `เป็นการกระจายตัวแบบปกติที่มีกลุ่มเป้าหมายหลักในช่วงคะแนนดังกล่าว `;
        }

        analysisEl.innerText = analysisText;
    }

	/* ============================================================
	   ฟังก์ชัน: พิมพ์สรุปผลสัมฤทธิ์ทางการเรียน (แก้ไข Loading ค้าง)
	   ============================================================ */
	function printAchievementSummary() {
		// 1. แสดง Loading เพื่อบอกผู้ใช้ว่ากำลังเตรียมเอกสาร
		showLoading();

		// ใช้ setTimeout เพื่อให้ Loading ขึ้นมาก่อนเริ่มทำงานหนัก
		setTimeout(() => {
			// ดึงข้อมูลวิชาที่เลือก (หรือวิชาแรกถ้าเลือกทั้งหมด)
			const sub = (achFilterSubject !== 'all') 
				? subjects.find(s => s.id === achFilterSubject) 
				: (subjects[0] || {});
			
			// 2. ตั้งค่าระยะขอบกระดาษแนวนอน (Landscape)
			// ขอบ: บน 0.2", ขวา 0", ล่าง 0", ซ้าย 0" (ปรับให้พอดีหน้า A4)
			setPrintOrientation('landscape', '0.2in 0in 0in 0in'); 
			
			// อัปเดตค่าเป้าหมายต่างๆ ลงใน HTML
			document.getElementById('ach-target-school-pct').innerText = sub.targetSchoolPct || "60";
			document.getElementById('ach-target-dept-pct').innerText = sub.targetDeptPct || "55";
			document.getElementById('ach-target-subject-pct').innerText = sub.targetSubjectPct || "50";
			document.getElementById('ach-target-school-gpa').innerText = (sub.targetSchoolGPA || 3.00).toFixed(2);
			document.getElementById('ach-target-dept-gpa').innerText = (sub.targetDeptGPA || 2.55).toFixed(2);
			document.getElementById('ach-target-subject-gpa').innerText = (sub.targetSubjectGPA || 2.50).toFixed(2);
			document.getElementById('ach-sign-teacher').innerText = sub.teacher || "-";

			// ซ่อนส่วนหัวข้อที่ไม่จำเป็นในหน้าพิมพ์ (Clean up header)
			const container = document.getElementById('achievement-print-container');
			const headerInfo = container.querySelectorAll('h2, .text-center.font-bold.mb-1, .text-center.font-bold.mb-4');
			headerInfo.forEach(el => el.style.display = 'none');

			const tbody = document.getElementById('ach-table-body'); 
			const tfoot = document.getElementById('ach-table-foot');
			const thead = container.querySelector('table thead');
			
			// 3. สร้าง Header ตารางใหม่สำหรับหน้าพิมพ์ (รวมข้อมูลโรงเรียน/ครูไว้ในนี้)
			thead.innerHTML = `
				<tr class="print-table-header-info">
					<th colspan="31" class="border-b border-black p-4 text-black font-['Sarabun']" style="background-color: white !important;">
							<div class="text-center">
							<h2 class="text-xl font-bold mb-1">สรุปผลสัมฤทธิ์ทางการเรียนของผู้เรียน ${(achFilterSubject === 'all') ? "รวมทุกรายวิชา" : "กลุ่มสาระการเรียนรู้ " + (sub.departmentName || "-")}</h2>
							<div class="font-bold mb-1">ครูผู้สอน ${sub.teacher || "-"} ภาคเรียนที่ ${sub.semester || "-"} ปีการศึกษา ${sub.year || "-"}</div>
							<div class="font-bold mb-1">${sub.schoolName || "โรงเรียนปากช่อง"} อำเภอปากช่อง จังหวัดนครราชสีมา</div>
						</div>
					</th>
				</tr>
				<tr>
					<th rowspan="2" style="width: 60px;">รหัสวิชา</th>
					<th rowspan="2">ชั้น</th>
					<th rowspan="2" class="w-10">จำนวน<br>นักเรียน</th>
					<th colspan="10">จำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
					<th rowspan="2" class="w-8">รวม</th>
					<th colspan="10">ร้อยละจำนวนนักเรียนจำแนกตามระดับผลการเรียน</th>
					<th rowspan="2" class="w-10">ร้อยละ<br>รวม</th>
					<th rowspan="2" class="w-10">A.V.</th>
					<th rowspan="2" class="w-10">S.D.</th>
					<th rowspan="2" class="w-10">%ผ่านเกณฑ์</th>
					<th rowspan="2" class="w-12">%ระดับ<br>ดีขึ้นไป</th>
					<th rowspan="2" class="w-12">%ไม่ผ่าน<br>เกณฑ์</th>
					<th rowspan="2" class="w-16">สรุป<br>ผลสัมฤทธิ์</th>
				</tr>
				<tr>
					<th class="w-6">4.0</th><th class="w-6">3.5</th><th class="w-6">3.0</th><th class="w-6">2.5</th><th class="w-6">2.0</th><th class="w-6">1.5</th><th class="w-6">1.0</th><th class="w-6">0</th><th class="w-6">ร</th><th class="w-6">มส</th>
					<th class="w-8">4.0</th><th class="w-8">3.5</th><th class="w-8">3.0</th><th class="w-8">2.5</th><th class="w-8">2.0</th><th class="w-8">1.5</th><th class="w-8">1.0</th><th class="w-8">0</th><th class="w-8">ร</th><th class="w-8">มส</th>
				</tr>
			`;

			// 4. คำนวณและสร้างแถวข้อมูล (Data Rows)
			tbody.innerHTML = ''; tfoot.innerHTML = '';
			let grandTotalStudents = 0; let grandGradeCounts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
			let grandPassedCount = 0; let grandGoodCount = 0; let grandFailCount = 0; let grandTotalScores = 0; let grandScoreList = []; 

			subjects.forEach(sItem => {
				if (achFilterSubject !== 'all' && sItem.id !== achFilterSubject) return;

				sItem.classes.forEach(cls => {
					if (achFilterRoom !== 'all' && cls !== achFilterRoom) return;

					const clsStudents = getActiveStudentsInClass(cls);
					if (clsStudents.length === 0) return;
					const total = clsStudents.length;
					let counts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
					let passedCount = 0; let goodCount = 0; let failCount = 0; let classScores = []; let classTotalScore = 0;
					
					clsStudents.forEach(stu => {
						const totalScore = calculateStudentTotalBySub(sItem, stu.uid, cls);
						const rem = getStoredScore(sItem.id, cls, stu.uid, 'remark', "");
						let grade = rem || computeGradeBySub(sItem, totalScore);
						if (grade === '4') grade = '4.0'; if (grade === '3') grade = '3.0'; if (grade === '2') grade = '2.0'; if (grade === '1') grade = '1.0';
						
						if (counts.hasOwnProperty(grade)) counts[grade]++;
						
						if (!rem) { 
							const gVal = parseFloat(grade); 
							if(!isNaN(gVal)) { 
								classScores.push(gVal); 
								classTotalScore += gVal; 
								if (gVal >= 1.0) passedCount++; 
								if (gVal >= 3.0) goodCount++; 
								if (gVal === 0) failCount++; 
							} 
						} else if (rem === 'ผ') { passedCount++; }
					});
					
					grandTotalStudents += total; grandPassedCount += passedCount; grandGoodCount += goodCount; grandFailCount += failCount;
					Object.keys(counts).forEach(k => grandGradeCounts[k] += counts[k]); grandScoreList = grandScoreList.concat(classScores); grandTotalScores += classTotalScore;
					
					const classAvg = classScores.length > 0 ? (classTotalScore / classScores.length).toFixed(2) : '0.00';
					const classSD = calculateSD(classScores).toFixed(2);
					const passPct = total > 0 ? ((passedCount / total) * 100).toFixed(1) : '0.0';
					const goodPct = total > 0 ? ((goodCount / total) * 100).toFixed(1) : '0.0';
					const failPct = total > 0 ? ((failCount / total) * 100).toFixed(1) : '0.0';
					const conclusionHtml = parseFloat(classAvg) >= (sItem.targetDeptGPA || 2.55) ? '<span class="text-green-600 font-bold">ผ่านเกณฑ์</span>' : '<span class="text-red-600 font-bold">ไม่ผ่านเกณฑ์</span>';
					
					let rowHtml = `<tr><td>${sItem.code}</td><td>${cls}</td><td>${total}</td>`;
					['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => rowHtml += `<td>${counts[g]}</td>`);
					rowHtml += `<td class="bg-gray-50 font-bold">${total}</td>`;
					['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => { const pct = total > 0 ? ((counts[g] / total) * 100).toFixed(1) : '0.0'; rowHtml += `<td>${pct}</td>`; });
					rowHtml += `<td class="font-bold">100.0</td><td>${classAvg}</td><td>${classSD}</td><td>${passPct}</td><td>${goodPct}</td><td>${failPct}</td><td>${conclusionHtml}</td></tr>`;
					tbody.innerHTML += rowHtml;
				});
			});

			const grandAvg = grandScoreList.length > 0 ? (grandTotalScores / grandScoreList.length).toFixed(2) : '0.00';
			const grandSD = calculateSD(grandScoreList).toFixed(2);
			const grandPassPct = grandTotalStudents > 0 ? ((grandPassedCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
			const grandGoodPct = grandTotalStudents > 0 ? ((grandGoodCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
			const grandFailPct = grandTotalStudents > 0 ? ((grandFailCount / grandTotalStudents) * 100).toFixed(1) : '0.0';
			const grandConclusionHtml = parseFloat(grandAvg) >= (sub.targetDeptGPA || 2.55) ? '<span class="text-green-600 font-bold">ผ่านเกณฑ์</span>' : '<span class="text-red-600 font-bold">ไม่ผ่านเกณฑ์</span>';
			
			let footHtml = `<tr><td colspan="2">สรุปผลรวม</td><td>${grandTotalStudents}</td>`;
			['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => footHtml += `<td>${grandGradeCounts[g]}</td>`);
			footHtml += `<td>${grandTotalStudents}</td>`;
			['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => { const pct = grandTotalStudents > 0 ? ((grandGradeCounts[g] / grandTotalStudents) * 100).toFixed(1) : '0.0'; footHtml += `<td>${pct}</td>`; });
			footHtml += `<td>100.0</td><td>${grandAvg}</td><td>${grandSD}</td><td>${grandPassPct}</td><td>${grandGoodPct}</td><td>${grandFailPct}</td><td>${grandConclusionHtml}</td></tr>`;
			tfoot.innerHTML = footHtml;
			
			// 5. ปรับความสูงกราฟอัตโนมัติ (เพื่อให้พอดีหน้า A4)
			const rowCount = tbody.querySelectorAll('tr').length;
			const chartContainer = document.getElementById('ach-chart-1').closest('.flex.gap-4');
			
			if (chartContainer) {
				// ความสูงมาตรฐาน 240px
				let dynamicHeight = 240;
				// ถ้ามีมากกว่า 7 แถว ให้ลดความสูงลง
				if (rowCount > 7) {
					dynamicHeight = Math.max(100, 240 - ((rowCount - 7) * 18));
				}
				chartContainer.style.height = `${dynamicHeight}px`;
			}

			// 6. สร้างกราฟ
			generateAchChart(grandGradeCounts, grandTotalStudents, 'ach-chart-1'); 
			generateAchChart(grandGradeCounts, grandTotalStudents, 'ach-chart-2', false); 
			
			// เข้าสู่โหมดพิมพ์ (ซ่อนเมนู/ส่วนเกินด้วย CSS)
			document.body.classList.add('print-achievement-mode');
			
			// --- [ส่วนสำคัญ: แก้ไข Loading ค้าง] ---
			hideLoading(); // สั่งซ่อน Loading ทันที

			// รอเวลาเล็กน้อย (500ms) ให้ UI อัปเดตเอา Overlay ออกไปจริงๆ แล้วค่อยสั่งพิมพ์
			setTimeout(() => {
				window.print();
				
				// คืนค่ากลับสู่โหมดปกติหลังพิมพ์เสร็จ
				setTimeout(() => { 
					document.body.classList.remove('print-achievement-mode'); 
					setPrintOrientation('portrait'); 
				}, 500);
			}, 500);
			
		}, 500); // ดีเลย์เริ่มต้นเพื่อให้ Loading แสดงผลสมบูรณ์ก่อนเริ่มคำนวณ
	}

	function calculateStudentTotalBySub(sub, uid, cls) {
		const s = (scoreData[sub.id] && scoreData[sub.id][cls] && scoreData[sub.id][cls][uid]) ? scoreData[sub.id][cls][uid] : {};
		
		// 1. คะแนนรายหน่วย (Unit)
		let rawUnitScore = 0;
		let maxUnitScore = 0;
		if (sub.units) {
			sub.units.forEach(u => {
				let val = 0;
				if(s[`u${u.id}_r`] !== undefined) {
					 val = Math.max(parseFloat(s[`u${u.id}_r`]) || 0, parseFloat(s[`u${u.id}_e`]) || 0);
				} else {
					 val = parseFloat(s[`u${u.id}`]) || 0;
				}
				rawUnitScore += val;
				maxUnitScore += u.max;
			});
		}

		// 2. คะแนนงาน (Task)
		let rawTaskScore = 0;
		let maxTaskScore = 0;
		if (sub.tasks) {
			sub.tasks.forEach(t => {
				const tr = parseFloat(s[`t${t.id}_r`]) || 0;
				const te = parseFloat(s[`t${t.id}_e`]) || 0;
				rawTaskScore += Math.max(tr, te);
				maxTaskScore += t.max;
			});
		}

		// 3. แปลงคะแนนตามสัดส่วน (ถ้ามี Weight) หรือใช้คะแนนดิบ (ถ้าไม่มี)
		let finalUnitScore = rawUnitScore;
		let finalTaskScore = rawTaskScore;

		// Unit Weight Logic
		if (sub.weightUnit && sub.weightUnit > 0) {
			if (maxUnitScore > 0) {
				finalUnitScore = (rawUnitScore / maxUnitScore) * sub.weightUnit;
			} else {
				finalUnitScore = 0;
			}
		}

		// Task Weight Logic
		if (sub.weightTask && sub.weightTask > 0) {
			if (maxTaskScore > 0) {
				finalTaskScore = (rawTaskScore / maxTaskScore) * sub.weightTask;
			} else {
				finalTaskScore = 0;
			}
		}

		// 4. รวมคะแนน (Unit + Task + Mid + Fin)
		let sum = finalUnitScore + finalTaskScore;
		
		// Midterm
		const midScore = Math.max(parseFloat(s['mid_r']) || 0, parseFloat(s['mid_e']) || 0);
		sum += midScore;

		// Final
		const finScore = Math.max(parseFloat(s['fin_r']) || 0, parseFloat(s['fin_e']) || 0);
		sum += finScore;

		return parseFloat(sum.toFixed(2));
	}

    function computeGradeBySub(sub, s) {
        let m = 0; sub.units.forEach(u => m += u.max); m += sub.midMax + sub.finMax;
        if (m === 0) return '0'; const pct = (s/m)*100;
        if (pct >= 80) return '4'; if (pct >= 75) return '3.5'; if (pct >= 70) return '3'; if (pct >= 65) return '2.5'; if (pct >= 60) return '2'; if (pct >= 55) return '1.5'; if (pct >= 50) return '1'; return '0';
    }

    function calculateSD(data) {
        const n = data.length; if (n === 0) return 0;
        const mean = data.reduce((a, b) => a + b, 0) / n;
        const variance = data.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / n;
        return Math.sqrt(variance);
    }

    function generateAchChart(counts, total, elementId, isPct = true) {
        const container = document.getElementById(elementId); 
        if(!container) return;
        container.innerHTML = '';
        const labels = ['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร'];
        let maxVal = 0;
        labels.forEach(l => {
            let val = counts[l] || 0; if (isPct && total > 0) val = (val / total) * 100;
            if (val > maxVal) maxVal = val;
        });
        if (maxVal === 0) maxVal = 1;
        labels.forEach(l => {
            let val = counts[l] || 0; let displayVal = val;
            if (isPct) { val = total > 0 ? (val / total) * 100 : 0; displayVal = val.toFixed(1); }
            const heightPct = (val / maxVal) * 80;
            const barWrap = document.createElement('div');
            barWrap.className = 'ach-bar'; barWrap.style.height = Math.max(heightPct, 1) + '%'; 
            barWrap.style.backgroundColor = getGradeColorCode(l);
            const valLabel = document.createElement('div'); valLabel.className = 'ach-bar-val'; valLabel.innerText = displayVal;
            const txtLabel = document.createElement('div'); txtLabel.className = 'ach-bar-label'; txtLabel.innerText = l;
            barWrap.appendChild(valLabel); barWrap.appendChild(txtLabel); container.appendChild(barWrap);
        });
    }

    function getGradeColorCode(g) {
        if(parseFloat(g) >= 3) return '#15803d'; if(parseFloat(g) >= 2) return '#ca8a04';
        if(parseFloat(g) >= 1) return '#db2777'; return '#dc2626';
    }

	function changePageLength(val) {
        rowsPerPage = parseInt(val);
        currentGradingPage = 1;
        currentStudentPage = 1;
        currentStaffPage = 1; // เพิ่มบรรทัดนี้

        const activeView = document.querySelector('.view-section.view-active').id;
        if (activeView === 'grading-view') initTable();
        else if (activeView === 'students-view') initStudentTable();
        else if (activeView === 'staff-view') initStaffTable(); // เพิ่มเงื่อนไขนี้
		else if (activeView === 'task-grading-view') initTaskTable();
		else if (activeView === 'rw-view') initRWTable();
		else if (activeView === 'competency-view') initCompetencyTable();
		else if (activeView === 'attribute-view') initAttributeTable();
    }
    
    function updateStudentFilters() { 
                const roomFilter = document.getElementById('filter-student-room'); 
                const rooms = [...new Set(students.map(s => s.room))].sort((a, b) => 
                    a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' })
                ); 
                
                if(roomFilter) roomFilter.innerHTML = '<option value="">ทุกห้อง</option>' + rooms.map(r => `<option value="${r}">${r}</option>`).join(''); 
    }

	let teachers = []; // เก็บข้อมูลครู

	function initStaffTable() {
		const listBody = document.getElementById('staff-list-body');
		
		// 1. รับค่าจากตัวกรองต่างๆ
		const search = document.getElementById('search-staff') ? document.getElementById('search-staff').value.toLowerCase() : '';
		
		// [แก้ไข] ดึงค่าจาก Dropdown (ค่า value ตรงๆ)
		const posFilter = document.getElementById('filter-staff-position') ? document.getElementById('filter-staff-position').value : '';
		
		const deptFilter = document.getElementById('filter-staff-dept') ? document.getElementById('filter-staff-dept').value : '';
		const genderFilter = document.getElementById('filter-staff-gender') ? document.getElementById('filter-staff-gender').value : '';
		const statusFilter = document.getElementById('filter-staff-status') ? document.getElementById('filter-staff-status').value : '';

		// 2. กรองข้อมูลจาก Array teachers
		let filtered = teachers.filter(t => {
			const matchName = t.name.toLowerCase().includes(search);
			
			// [แก้ไข] เปลี่ยนเงื่อนไขการกรองตำแหน่งเป็น Exact Match (ตรงกันเป๊ะๆ)
			const matchPos = posFilter === "" || (t.position || "") === posFilter;
			
			const matchDept = deptFilter === "" || (t.dept || "") === deptFilter;
			const matchGender = genderFilter === "" || (t.gender || "") === genderFilter;
			const matchStatus = statusFilter === "" || (t.status || "") === statusFilter;
			return matchName && matchPos && matchDept && matchGender && matchStatus;
		});

		// 3. คำนวณ Pagination
		const total = filtered.length; 
		if (currentStaffPage > Math.ceil(total / rowsPerPage)) currentStaffPage = Math.ceil(total / rowsPerPage) || 1;
		const start = (currentStaffPage - 1) * rowsPerPage;
		const paginated = filtered.slice(start, start + rowsPerPage);

		// 4. อัปเดตหัวตาราง (Thead) ให้ตรงกับข้อมูล
		const tableHead = document.querySelector('#staff-view thead tr');
		if (tableHead) {
			tableHead.innerHTML = `
				<th class="px-4 py-3 w-16 text-center border-r bg-slate-50 sticky left-0 z-10">รูป</th>
				<th class="px-4 py-3 text-center border-r min-w-[150px]">ชื่อ-นามสกุล</th>
				<th class="px-4 py-3 border-r text-center hidden md:table-cell">ตำแหน่ง</th>
				<th class="px-4 py-3 border-r text-center hidden lg:table-cell">กลุ่มสาระฯ</th>
				<th class="px-4 py-3 border-r text-center hidden xl:table-cell">เบอร์โทร</th>
				<th class="px-4 py-3 border-r text-center hidden xl:table-cell">เครื่องราชฯ</th>
				<th class="px-4 py-3 border-r text-center hidden 2xl:table-cell">ใบประกอบฯ</th>
				<th class="px-4 py-3 border-r text-center">สถานะ</th>
				<th class="px-4 py-3 text-center sticky right-0 bg-slate-50 z-10 shadow-[-4px_0_8px_-4px_rgba(0,0,0,0.1)] border-l">จัดการ</th>
			`;
		}

		// 5. สร้าง HTML ข้อมูลในตาราง
		if (filtered.length === 0) {
			listBody.innerHTML = `<tr><td colspan="9" class="px-4 py-8 text-center text-slate-500 font-bold">ไม่พบข้อมูลบุคลากรตามเงื่อนไข</td></tr>`;
		} else {
			listBody.innerHTML = paginated.map((t, i) => `
				<tr class="border-b hover:bg-slate-50 transition border-slate-200 group">
					<td class="px-4 py-2 text-center border-r bg-white sticky left-0 z-0 group-hover:bg-slate-50">
						<div onclick="viewStaffDetails('${t.uid}')" class="w-10 h-10 bg-slate-100 rounded-full mx-auto overflow-hidden border cursor-pointer transition-transform hover:scale-110">
							<img src="${t.image || 'https://via.placeholder.com/40'}" class="w-full h-full object-cover">
						</div>
					</td>
					
					<td class="px-4 py-2 font-bold text-slate-700 border-r text-left">
						<div class="truncate">${t.name}</div>
						<div class="text-[10px] text-slate-400 font-normal md:hidden">${t.position || '-'}</div>
					</td>
					
					<td class="px-4 py-2 text-center border-r hidden md:table-cell">${t.position || '-'}</td>
					<td class="px-4 py-2 text-center border-r hidden lg:table-cell">${t.dept || '-'}</td>
					<td class="px-4 py-2 text-center border-r hidden xl:table-cell text-slate-500">${t.phone || '-'}</td>
					<td class="px-4 py-2 text-center border-r hidden xl:table-cell text-xs font-bold text-blue-600">${t.royalDec || '-'}</td>
					
					<td class="px-4 py-2 text-center border-r hidden 2xl:table-cell">
					   ${t.licenseStatus === 'หมดอายุ' ? '<span class="text-red-500 font-bold text-xs"><i class="fa-solid fa-circle-exclamation"></i> หมดอายุ</span>' : 
						 t.licenseStatus === 'ใกล้หมดอายุ' ? '<span class="text-orange-500 font-bold text-xs"><i class="fa-solid fa-clock"></i> ใกล้หมด</span>' : 
						 '<span class="text-green-500 text-xs"><i class="fa-solid fa-check"></i> ปกติ</span>'}
					</td>
					
					<td class="px-4 py-2 text-center border-r">
						<span class="px-2 py-0.5 rounded-full text-[10px] font-bold ${getStaffStatusStyle(t.status)} whitespace-nowrap">
							${t.status}
						</span>
					</td>
					
					<td class="px-4 py-2 text-center flex justify-center gap-2 sticky right-0 bg-white z-0 group-hover:bg-slate-50 border-l shadow-[-4px_0_8px_-4px_rgba(0,0,0,0.1)]">
						<button onclick="viewStaffDetails('${t.uid}')" class="w-8 h-8 rounded-[12px] border border-slate-600 text-slate-600 flex items-center justify-center transition hover:bg-slate-200 hover:scale-110" title="รายละเอียด">
							<i class="fa-solid fa-list-ul"></i>
						</button>
						<button onclick="openStaffModal('${t.uid}')" class="w-8 h-8 rounded-[12px] border border-[#0d6efd] text-[#0d6efd] flex items-center justify-center transition hover:bg-blue-200 hover:scale-110" title="แก้ไข">
							<i class="fa-solid fa-pen-to-square"></i>
						</button>
						<button onclick="deleteStaff('${t.uid}')" class="w-8 h-8 rounded-[12px] border border-[#dc3545] text-[#dc3545] flex items-center justify-center transition hover:bg-red-200 hover:scale-110" title="ลบ">
							<i class="fa-solid fa-trash-can"></i>
						</button>
					</td>
				</tr>
			`).join('');
		}
		
		// 6. แสดงปุ่มเปลี่ยนหน้า
		renderGeneralPagination('staff-pagination', total, currentStaffPage, p => { currentStaffPage = p; initStaffTable(); });
	}

	// --- ฟังก์ชันบันทึกข้อมูล ---
	function saveStaff(data) {
		showLoading();
		callBackend('saveTeacher', data)
		.then(res => {
			loadSystemData(); // โหลดข้อมูลใหม่ทั้งหมด
			showNotification('บันทึกข้อมูลบุคลากรสำเร็จ');
		});
	}

	// ฟังก์ชันลบข้อมูล
	function deleteStaff(uid) {
		Swal.fire({ title: 'ยืนยันการลบ?', icon: 'warning', showCancelButton: true }).then(r => {
			if (r.isConfirmed) {
				showLoading();
				callBackend('deleteTeacher', uid).then(() => {
					loadSystemData();
					showNotification('ลบข้อมูลเรียบร้อย');
				});
			}
		});
	}
	
/* =========================================
   2. Function: เปิด Modal (เพิ่ม/แก้ไข)
   ========================================= */
function openStaffModal(uid = null) {
    const modal = document.getElementById('staff-modal');
    const preview = document.getElementById('modal-staff-img-preview');
    const placeholder = document.getElementById('staff-image-upload-placeholder');
    
    // --- Reset Form Fields (20 Fields) ---
    document.getElementById('modal-staff-uid').value = '';
    document.getElementById('modal-staff-name').value = '';
    document.getElementById('modal-staff-gender').value = 'ชาย';
    document.getElementById('modal-staff-position').value = '';
    document.getElementById('modal-staff-dept').value = '';
    document.getElementById('modal-staff-advisor').value = '';
    
    // Personal Info (Updated)
    document.getElementById('modal-staff-birth').value = '';  // Reset วันเกิด
    document.getElementById('modal-staff-phone').value = '';
    document.getElementById('modal-staff-email').value = '';
    
    // License Info
    document.getElementById('modal-staff-license-no').value = '';
    document.getElementById('modal-staff-license-exp').value = '';
    document.getElementById('modal-staff-license-status').value = 'ปกติ';
    
    // Royal Decoration Info
    document.getElementById('modal-staff-royal-dec').value = '';
    document.getElementById('modal-staff-royal-year').value = '';
    document.getElementById('modal-staff-next-dec').value = '';
    document.getElementById('modal-staff-royal-status').value = 'ยังไม่ถึงเกณฑ์';
    
    // Dates & Status
    document.getElementById('modal-staff-date').value = '';       // วันบรรจุ
    document.getElementById('modal-staff-retire').value = '';     // Reset วันเกษียณ
    document.getElementById('modal-staff-status').value = 'ปฏิบัติหน้าที่';
    
    // Reset Image
    preview.src = '';
    preview.classList.add('hidden');
    placeholder.classList.remove('hidden');

    // --- Check Mode (Add or Edit) ---
    if (uid) {
        // Edit Mode: Load Data
        const t = teachers.find(x => x.uid === uid);
        if (t) {
            document.getElementById('staff-modal-label').innerText = 'แก้ไขข้อมูลบุคลากร';
            document.getElementById('modal-staff-uid').value = t.uid;
            
            // Map Data to Inputs
            document.getElementById('modal-staff-name').value = t.name;
            document.getElementById('modal-staff-gender').value = t.gender || 'ชาย';
            document.getElementById('modal-staff-position').value = t.position || '';
            document.getElementById('modal-staff-dept').value = t.dept || '';
            document.getElementById('modal-staff-advisor').value = t.advisorRoom || '';
            
            document.getElementById('modal-staff-birth').value = t.birthDate || ''; // Load วันเกิด
            document.getElementById('modal-staff-phone').value = t.phone || '';
            document.getElementById('modal-staff-email').value = t.email || '';
            
            document.getElementById('modal-staff-license-no').value = t.licenseNo || '';
            document.getElementById('modal-staff-license-exp').value = t.licenseExp || '';
            document.getElementById('modal-staff-license-status').value = t.licenseStatus || 'ปกติ';
            
            document.getElementById('modal-staff-royal-dec').value = t.royalDec || '';
            document.getElementById('modal-staff-royal-year').value = t.royalYear || '';
            document.getElementById('modal-staff-next-dec').value = t.nextDecDate || '';
            document.getElementById('modal-staff-royal-status').value = t.royalStatus || 'ยังไม่ถึงเกณฑ์';

            document.getElementById('modal-staff-date').value = t.joinDate || '';
            document.getElementById('modal-staff-retire').value = t.retireDate || ''; // Load วันเกษียณ
            document.getElementById('modal-staff-status').value = t.status || 'ปฏิบัติหน้าที่';

            // Show Image if exists
            if (t.image) {
                preview.src = t.image;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
        }
    } else {
        // Add Mode
        document.getElementById('staff-modal-label').innerText = 'เพิ่มบุคลากรใหม่';
    }
    
    modal.classList.remove('hidden');
}

    function closeStaffModal() {
        document.getElementById('staff-modal').classList.add('hidden');
    }

    // --- ฟังก์ชันจัดการรูปภาพบุคลากร ---
    function triggerStaffImageUpload() {
        document.getElementById('modal-staff-image-input').click();
    }

    function handleStaffImagePreview(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById('modal-staff-img-preview');
                const placeholder = document.getElementById('staff-image-upload-placeholder');
                preview.src = e.target.result;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

	function saveStaffData() {
		const uid = document.getElementById('modal-staff-uid').value;
		const name = document.getElementById('modal-staff-name').value;
		
		// Validate Required Field
		if (!name) {
			Swal.fire('แจ้งเตือน', 'กรุณาระบุชื่อ-นามสกุล', 'warning');
			return;
		}

		showLoading();

		// Get Image Data
		const imgPreview = document.getElementById('modal-staff-img-preview');
		const img = (!imgPreview.classList.contains('hidden') && imgPreview.src) ? imgPreview.src : "";

		// Prepare Data Object (20 Columns)
		const data = {
			uid: uid || generateUID(),
			name: name,
			position: document.getElementById('modal-staff-position').value,
			dept: document.getElementById('modal-staff-dept').value,
			advisorRoom: document.getElementById('modal-staff-advisor').value,
			gender: document.getElementById('modal-staff-gender').value,
			image: img,
			
			// Personal Info
			birthDate: document.getElementById('modal-staff-birth').value,
			phone: document.getElementById('modal-staff-phone').value,
			email: document.getElementById('modal-staff-email').value,
			
			// License Info
			licenseNo: document.getElementById('modal-staff-license-no').value,
			licenseExp: document.getElementById('modal-staff-license-exp').value,
			licenseStatus: document.getElementById('modal-staff-license-status').value,
			
			// Royal Dec Info
			royalDec: document.getElementById('modal-staff-royal-dec').value,
			royalYear: document.getElementById('modal-staff-royal-year').value,
			nextDecDate: document.getElementById('modal-staff-next-dec').value,
			royalStatus: document.getElementById('modal-staff-royal-status').value,
			
			// Dates & Status
			joinDate: document.getElementById('modal-staff-date').value,
			retireDate: document.getElementById('modal-staff-retire').value,
			status: document.getElementById('modal-staff-status').value
		};

		// Send to Backend
		callBackend('saveTeacher', data)
		.then(function(res) {
			if (res.result === 'error') throw new Error(res.message);
			
			// Update Local Data immediately
			if (uid) {
				const idx = teachers.findIndex(x => x.uid === uid);
				if (idx !== -1) teachers[idx] = data;
				showNotification('แก้ไขข้อมูลสำเร็จ');
			} else {
				teachers.push(data);
				showNotification('เพิ่มข้อมูลสำเร็จ');
			}
			
			closeStaffModal();
			
			// [เพิ่มใหม่] อัปเดต Dropdown เผื่อมีการเพิ่มตำแหน่งใหม่
			if (typeof updateStaffPositionDropdown === 'function') {
				updateStaffPositionDropdown();
			}

			initStaffTable(); // Refresh Table
			hideLoading();
		})
		.catch(function(e) {
			hideLoading();
			Swal.fire('Error', e.message, 'error');
		});
	}

    // ฟังก์ชันสำหรับปุ่มแก้ไขในตาราง (เชื่อมกับปุ่มในตาราง HTML)
    function editStaff(uid) {
        openStaffModal(uid);
    }

	function initStudentTable() {
        const listBody = document.getElementById('student-list-body'); 
        const search = document.getElementById('search-student').value.toLowerCase(); 
        const statusFilter = document.getElementById('filter-student-status').value; 
        const roomFilter = document.getElementById('filter-student-room').value;
        
        // กรองข้อมูลนักเรียนตามเงื่อนไข (ค้นหา, สถานะ, ห้อง)
        let filtered = students.filter(s => (s.id.includes(search) || s.name.toLowerCase().includes(search) || (s.nationalId && s.nationalId.includes(search))) && (statusFilter === "" || s.status === statusFilter) && (roomFilter === "" || s.room === roomFilter));
        
        // จัดการ Pagination
        const total = filtered.length; 
        if (currentStudentPage > Math.ceil(total / rowsPerPage)) currentStudentPage = Math.ceil(total / rowsPerPage) || 1;
        const start = (currentStudentPage - 1) * rowsPerPage;
        
        // Render ตาราง
        if(listBody) listBody.innerHTML = filtered.slice(start, start + rowsPerPage).map((s, i) => `
            <tr class="border-b odd:bg-white even:bg-[#FFFF99] hover:bg-blue-50 transition border-slate-200">
                <td class="px-4 py-2 text-center border-r">
                    <div onclick="viewStudentPhoto('${s.uid}')" class="student-photo-container w-10 h-10 bg-slate-200 rounded-full mx-auto overflow-hidden border cursor-pointer font-['Sarabun']">
                        ${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user fa-lg mt-3 text-slate-400"></i>'}
                    </div>
                </td>
                <td class="px-4 py-2 text-center font-bold text-slate-600 border-r font-['Sarabun']">${s.id}</td>
                <td class="px-4 py-2 text-center text-slate-500 font-medium border-r font-['Sarabun']">${s.nationalId || '-'}</td>
                <td class="px-4 py-2 text-slate-700 font-medium border-r font-['Sarabun']">${s.name}</td>
                <td class="px-4 py-2 text-center text-slate-500 font-bold border-r font-['Sarabun']">${s.gender || '-'}</td>
                <td class="px-4 py-2 text-center text-slate-500 font-bold border-r font-['Sarabun']">${s.room}</td>
                <td class="px-4 py-2 text-center text-slate-500 border-r font-['Sarabun']">${s.number}</td>
                <td class="px-4 py-2 text-center text-slate-400 border-r font-['Sarabun']">${s.admissionYear}</td>
                <td class="px-4 py-2 text-center border-r font-['Sarabun'] font-bold">
                    <span class="px-2 py-0.5 rounded-full text-[10px] ${getStatusStyle(s.status)} font-['Sarabun']">${s.status}</span>
                </td>
                
                <td class="px-4 py-2 text-center flex justify-center gap-2 no-print font-['Sarabun']">
                    
                    <button onclick="viewStudentPhoto('${s.uid}')" class="w-8 h-8 rounded-[12px] border border-slate-600 text-slate-600 flex items-center justify-center transition hover:bg-slate-200 hover:scale-110" title="รายละเอียด">
                        <i class="fa-solid fa-list-ul"></i>
                    </button>

                    <button onclick="editStudentInfo('${s.uid}')" class="w-8 h-8 rounded-[12px] border border-[#0d6efd] text-[#0d6efd] flex items-center justify-center transition hover:bg-blue-200 hover:scale-110" title="แก้ไข">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>

                    <button onclick="deleteStudentInfo('${s.uid}')" class="w-8 h-8 rounded-[12px] border border-[#dc3545] text-[#dc3545] flex items-center justify-center transition hover:bg-red-200 hover:scale-110" title="ลบ">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                    
                </td>
            </tr>
        `).join('');
        
        // Render ตัวควบคุมหน้า (Pagination Controls)
        renderGeneralPagination('student-pagination', total, currentStudentPage, p => { currentStudentPage = p; initStudentTable(); });
    }

    function triggerImageUpload() { document.getElementById('modal-stu-image-input').click(); }
    function handleImagePreview(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { const preview = document.getElementById('modal-stu-img-preview'); const placeholder = document.getElementById('image-upload-placeholder'); preview.src = e.target.result; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); }; reader.readAsDataURL(input.files[0]); } }
    function editStudentInfo(uid) { openStudentModal(uid); }
    
    function openStudentModal(uid = null) {
        const modal = document.getElementById('student-modal'); const preview = document.getElementById('modal-stu-img-preview'); const placeholder = document.getElementById('image-upload-placeholder'); modal.classList.remove('hidden');
        if (uid) { 
            const s = students.find(x => x.uid === uid); 
            document.getElementById('modal-title').innerText = 'แก้ไขข้อมูลนักเรียน'; document.getElementById('modal-student-uid').value = uid; document.getElementById('modal-stu-id').value = s.id; document.getElementById('modal-stu-national-id').value = s.nationalId || ''; document.getElementById('modal-stu-name').value = s.name; document.getElementById('modal-stu-room').value = s.room; document.getElementById('modal-stu-number').value = s.number; document.getElementById('modal-stu-gender').value = s.gender || 'ชาย'; document.getElementById('modal-stu-year').value = s.admissionYear; document.getElementById('modal-stu-status').value = s.status; 
            if (s.image) { preview.src = s.image; preview.classList.remove('hidden'); placeholder.classList.add('hidden'); } else { preview.classList.add('hidden'); placeholder.classList.remove('hidden'); } 
        } else { 
            document.getElementById('modal-title').innerText = 'เพิ่มข้อมูลนักเรียนใหม่'; document.getElementById('modal-student-uid').value = ''; document.getElementById('modal-stu-id').value = ''; document.getElementById('modal-stu-national-id').value = ''; document.getElementById('modal-stu-name').value = ''; document.getElementById('modal-stu-room').value = activeClassName || 'ม.4/1'; document.getElementById('modal-stu-number').value = students.length + 1; document.getElementById('modal-stu-gender').value = 'ชาย'; document.getElementById('modal-stu-year').value = 2568; document.getElementById('modal-stu-status').value = 'ปกติ'; preview.classList.add('hidden'); placeholder.classList.remove('hidden'); 
        }
    }
    function closeStudentModal() { document.getElementById('student-modal').classList.add('hidden'); }
    
    // ---------- API INTERFACE WITH WEB APP URL ----------
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxWnbcdPQN_-a1QBcREpTwI47QP8jnmcSkMAroUzOKpoKc6gtEa6Va4_22cu6aApNCLqA/exec";

    async function callBackend(action, data) {
        try {
            if (action === 'getBackendData') {
                const response = await fetch(WEBAPP_URL + '?action=getBackendData');
                if (!response.ok) throw new Error('Network response was not ok');
                const json = await response.json();
                return json;
            }
            
            const params = new URLSearchParams();
            params.append('payload', JSON.stringify({ action: action, data: data }));
            
            const response = await fetch(WEBAPP_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: params
            });
            
            if (!response.ok) throw new Error('Network response was not ok');
            const json = await response.json();
            return json;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }

    function saveStudent() {
        showLoading();
        const uid = document.getElementById('modal-student-uid').value; const stuId = document.getElementById('modal-stu-id').value; const name = document.getElementById('modal-stu-name').value; if (!stuId || !name) { hideLoading(); Swal.fire('ข้อผิดพลาด', 'กรุณากรอกข้อมูลให้ครบ', 'error'); return; }
        const img = !document.getElementById('modal-stu-img-preview').classList.contains('hidden') ? document.getElementById('modal-stu-img-preview').src : null;
        const data = { uid: uid || generateUID(), id: stuId, nationalId: document.getElementById('modal-stu-national-id').value, name, room: document.getElementById('modal-stu-room').value, number: parseInt(document.getElementById('modal-stu-number').value) || 0, gender: document.getElementById('modal-stu-gender').value, admissionYear: parseInt(document.getElementById('modal-stu-year').value) || 2568, status: document.getElementById('modal-stu-status').value, image: img };
        
        callBackend('saveStudent', data)
        .then(function(res) {
            if(res.result === 'error') throw new Error(res.message);
            if (uid) { const idx = students.findIndex(x => x.uid === uid); students[idx] = data; showNotification('แก้ไขสำเร็จ'); } 
            else { students.push(data); showNotification('เพิ่มสำเร็จ'); } 
            closeStudentModal(); 
            initStudentTable();
            hideLoading();
        })
        .catch(function(e) {
            hideLoading();
            Swal.fire('Error', e.message, 'error');
        });
    }

    function deleteStudentInfo(uid) { 
        Swal.fire({ title: 'ยืนยันการลบ?', icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ', confirmButtonColor: '#dc3545' }).then(r => { 
            if (r.isConfirmed) { 
                showLoading();
                callBackend('deleteStudent', uid)
                .then(function(res) {
                    if(res.result === 'error') throw new Error(res.message);
                    students = students.filter(s => s.uid !== uid); 
                    initStudentTable(); 
                    showNotification('ลบเรียบร้อย', 'info'); 
                    hideLoading();
                })
                .catch(function(e){
                        hideLoading();
                        Swal.fire('Error', e.message, 'error');
                });
            } 
        }); 
    }

	function renderSettingsSubjects() {
		const container = document.getElementById('subject-list-container');
		if (!container) return;

		// ชุดสีพาสเทลสำหรับพื้นหลังวิชา (วนลูปใช้)
		const palettes = [
			"bg-orange-100 text-orange-800 border-orange-200",
			"bg-emerald-100 text-emerald-800 border-emerald-200",
			"bg-sky-100 text-sky-800 border-sky-200",
			"bg-purple-100 text-purple-800 border-purple-200",
			"bg-rose-100 text-rose-800 border-rose-200",
			"bg-amber-100 text-amber-800 border-amber-200",
			"bg-cyan-100 text-cyan-800 border-cyan-200",
			"bg-indigo-100 text-indigo-800 border-indigo-200"
		];

		container.innerHTML = subjects.map((s, index) => {
			// เลือกสีตามลำดับ Index
			const theme = palettes[index % palettes.length];
			const isActive = editingSubjectId === s.id;
			
			// แก้ไข: นำ scale-[1.02] ออกเมื่อ isActive เพื่อไม่ให้ล้นขอบ
			// และปรับระดับความลึกด้วย z-10 ให้เส้นขอบ (ring) แสดงผลได้ชัดเจนขึ้น
			const stateClass = isActive 
				? 'ring-2 ring-blue-500 shadow-lg z-10' 
				: 'hover:shadow-md border';

			return `
			<div onclick="editSubject('${s.id}')" 
				 class="group relative p-4 rounded-xl cursor-pointer transition-all duration-300 ease-out font-['Sarabun'] ${theme} ${stateClass}">
				
				<div class="flex justify-between items-start">
					<div class="font-bold text-sm mb-1">${s.code}</div>
					${isActive ? '<i class="fa-solid fa-circle-check text-blue-600 text-lg"></i>' : ''}
				</div>
				
				<div class="text-xs font-bold opacity-90 truncate pr-2">${s.name}</div>
				
				<div class="mt-2 h-1 w-8 rounded-full bg-current opacity-20 group-hover:w-full transition-all duration-500"></div>
			</div>`;
		}).join('');
	}

    function handleClassesChange() { updateCurrentSubjectData(); const sub = subjects.find(s => s.id === editingSubjectId); if (sub) renderAdvisorInputs(sub); }
	function renderAdvisorInputs(sub) {
		const container = document.getElementById('dynamic-advisors-container'); 
		if (!container) return;

		if (!sub.classes || sub.classes.length === 0) { 
			container.innerHTML = '<p class="text-slate-400 text-xs italic font-[\'Sarabun\']">กรุณาระบุ \'ห้องที่สอน\'</p>'; 
			return; 
		}

		if (!sub.advisors) sub.advisors = {};

		container.innerHTML = sub.classes.map(cls => `
			<div class="bg-white p-2 rounded-lg border border-blue-100 shadow-sm font-['Sarabun']">
				<label class="block text-[12px] font-bold text-[#0d6efd] uppercase mb-1">ครูที่ปรึกษา (${cls})</label>
				<input type="text" value="${sub.advisors[cls] || ''}" 
					oninput="updateAdvisorData('${cls}', this.value)" 
					class="w-full border p-1.5 rounded focus:ring-1 focus:ring-[#0d6efd] outline-none text-xs bg-lime-200 font-['Sarabun']" 
					placeholder="ชื่อครูที่ปรึกษา">
			</div>`).join('');
	}
    function updateAdvisorData(cls, name) { const sub = subjects.find(s => s.id === editingSubjectId); if (sub) { if (!sub.advisors) sub.advisors = {}; sub.advisors[cls] = name; } }

	function editSubject(id) {
		editingSubjectId = id; 
		const sub = subjects.find(s => s.id === id); 
		const editor = document.getElementById('subject-editor'); 
		
		// แสดง Modal (ลบ class ที่ซ่อนออก)
		editor.classList.remove('opacity-0', 'pointer-events-none');
		editor.classList.add('opacity-100', 'pointer-events-auto');
		
		// --- 1. ข้อมูลสถานศึกษาและผู้บริหาร ---
		document.getElementById('edit-school-name').value = sub.schoolName || "";
		document.getElementById('edit-affiliation').value = sub.affiliation || "";
		document.getElementById('edit-director').value = sub.director || "";
		document.getElementById('edit-deputy-director').value = sub.deputyDirector || "";
		document.getElementById('edit-head-evaluation').value = sub.headEvaluation || "";
		document.getElementById('edit-head-department').value = sub.headDepartment || "";
		document.getElementById('edit-teacher').value = sub.teacher || "";
		document.getElementById('edit-head-dept-name').value = sub.departmentName || "";

		// --- 2. ข้อมูลรายวิชาพื้นฐาน ---
		document.getElementById('edit-subject-name').value = sub.name;
		document.getElementById('edit-course-code').value = sub.code;
		document.getElementById('edit-subject-type').value = sub.type;
		document.getElementById('edit-credits').value = sub.credits;
		document.getElementById('edit-hours').value = sub.hours;
		document.getElementById('edit-semester').value = sub.semester;
		document.getElementById('edit-academic-year').value = sub.year;
		// แปลง Array classes เป็น String คั่นด้วยคอมม่า
		document.getElementById('edit-classes').value = sub.classes ? sub.classes.join(', ') : "";

		// --- 3. ค่าเป้าหมาย (Targets) ---
		document.getElementById('edit-target-school-pct').value = sub.targetSchoolPct || "";
		document.getElementById('edit-target-dept-pct').value = sub.targetDeptPct || "";
		document.getElementById('edit-target-subject-pct').value = sub.targetSubjectPct || "";
		document.getElementById('edit-target-school-gpa').value = sub.targetSchoolGPA || "";
		document.getElementById('edit-target-dept-gpa').value = sub.targetDeptGPA || "";
		document.getElementById('edit-target-subject-gpa').value = sub.targetSubjectGPA || "";

		// --- 4. เกณฑ์คะแนนสอบ (Midterm/Final) ---
		document.getElementById('edit-mid-max').value = sub.midMax;
		document.getElementById('edit-mid-pass-pct').value = sub.midPassPct;
		document.getElementById('edit-fin-max').value = sub.finMax;
		document.getElementById('edit-fin-pass-pct').value = sub.finPassPct;

		// --- 5. สัดส่วนคะแนน (Weight Settings) ---
		// โหลดค่าน้ำหนักคะแนนรายหน่วยและชิ้นงาน
		document.getElementById('edit-weight-unit').value = sub.weightUnit || "";
		document.getElementById('edit-weight-task').value = sub.weightTask || "";

		// --- 6. อัตราส่วนคะแนน (Ratio Settings) ---
		// โหลดคะแนนปลายภาคมาใส่ช่อง Ratio Final (เพราะมันคือค่าเดียวกัน)
		document.getElementById('edit-ratio-final').value = sub.finMax || "";

		// --- 7. เรียกฟังก์ชันสร้างตารางย่อย ---
		renderAdvisorInputs(sub);       // ตารางครูที่ปรึกษา
		renderUnitEditorRows(sub);      // ตารางโครงสร้างรายหน่วย
		renderTaskEditorRows(sub);      // ตารางโครงสร้างชิ้นงาน (Tasks)

		// --- 8. คำนวณตัวเลขอัตโนมัติ ---
		// สั่งคำนวณคะแนนระหว่างภาค (Ratio Between) ทันทีที่เปิดหน้าต่าง
		// เพื่อให้ตัวเลขรวม "หน่วย+งาน" ไปโชว์ในช่องสีเขียวทันที
		if(typeof autoCalculateRatio === 'function') {
			autoCalculateRatio();
		}

		// --- 9. ตั้งค่าการแสดงผลแท็บ ---
		renderSettingsSubjects();       // รีเฟรชรายการวิชาด้านซ้าย (ถ้ามี)
		switchSettingsTab('tab-school'); // เริ่มต้นที่แท็บแรก (ข้อมูลโรงเรียน)
	}

	function renderUnitEditorRows(sub) {
		const container = document.getElementById('units-editor-list');
		if (!container) return;
		
		if (!sub.units) sub.units = [];

		container.innerHTML = sub.units.map((u, i) => `
			<div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg border border-slate-200 mb-2 font-['Sarabun']">
				<span class="text-[10px] font-bold text-slate-500 w-4">#${i+1}</span>
				<div class="flex-grow">
					<label class="block text-[9px] text-slate-400 mb-0.5">ชื่อหน่วย</label>
					<input type="text" value="${u.name || ''}" placeholder="ชื่อหน่วย..."
						onchange="updateUnitProp(${i}, 'name', this.value)" 
						class="w-full border rounded p-1 text-xs font-['Sarabun'] focus:ring-1 focus:ring-blue-400 outline-none">
				</div>
				<div class="w-16">
					<label class="block text-[9px] text-slate-400 mb-0.5 text-center">เต็ม</label>
					<input type="number" value="${u.max}" placeholder="เต็ม"
						oninput="updateUnitProp(${i}, 'max', this.value)" 
						class="w-full border rounded p-1 text-xs text-center font-bold text-blue-600 font-['Sarabun']">
				</div>
				<div class="w-16">
					<label class="block text-[9px] text-slate-400 mb-0.5 text-center">ผ่าน(%)</label>
					<input type="number" value="${u.passPct || 50}" placeholder="%"
						onchange="updateUnitProp(${i}, 'passPct', this.value)" 
						class="w-full border rounded p-1 text-xs text-center font-['Sarabun']">
				</div>
				<button onclick="removeUnitFromSubject(${i})" class="text-rose-400 hover:text-rose-600 ml-1 mt-3 transition-colors">
					<i class="fa-solid fa-trash-can"></i>
				</button>
			</div>
		`).join('');

		// สั่งคำนวณน้ำหนักรวมทันทีหลังจากสร้างรายการเสร็จ
		if(typeof autoUpdateWeights === 'function') autoUpdateWeights();
	}

    function updateUnitValue(i, f, v) { const sub = subjects.find(s => s.id === editingSubjectId); if (sub) sub.units[i][f] = parseFloat(v) || 0; }
    function addNewUnitToCurrent() { const sub = subjects.find(s => s.id === editingSubjectId); if (sub) { const nId = sub.units.length > 0 ? Math.max(...sub.units.map(u => u.id)) + 1 : 1; sub.units.push({ id: nId, max: 10, passPct: 50 }); renderUnitEditorRows(sub); } }
    function removeUnitFromSubject(i) { const sub = subjects.find(s => s.id === editingSubjectId); if (sub && sub.units.length > 1) { sub.units.splice(i, 1); renderUnitEditorRows(sub); } }
    
	function updateCurrentSubjectData() {
		if (!editingSubjectId) return; 
		const sub = subjects.find(s => s.id === editingSubjectId);
		if (!sub) return;
		
		// --- 1. ข้อมูลโรงเรียนและผู้บริหาร ---
		sub.schoolName = document.getElementById('edit-school-name').value;
		sub.affiliation = document.getElementById('edit-affiliation').value;
		sub.director = document.getElementById('edit-director').value;
		sub.deputyDirector = document.getElementById('edit-deputy-director').value;
		sub.headEvaluation = document.getElementById('edit-head-evaluation').value;
		sub.headDepartment = document.getElementById('edit-head-department').value;
		sub.teacher = document.getElementById('edit-teacher').value;
		sub.departmentName = document.getElementById('edit-head-dept-name').value;

		// --- 2. ข้อมูลวิชาพื้นฐาน ---
		sub.name = document.getElementById('edit-subject-name').value;
		sub.code = document.getElementById('edit-course-code').value;
		sub.type = document.getElementById('edit-subject-type').value;
		sub.credits = parseFloat(document.getElementById('edit-credits').value) || 0;
		sub.hours = parseFloat(document.getElementById('edit-hours').value) || 0;
		sub.semester = parseInt(document.getElementById('edit-semester').value) || 1;
		sub.year = parseInt(document.getElementById('edit-academic-year').value) || 2568;
		
		// จัดการรายชื่อห้อง (Split ด้วยเครื่องหมายจุลภาค)
		sub.classes = document.getElementById('edit-classes').value.split(',').map(c => c.trim()).filter(c => c !== "");

		// --- 3. ค่าเป้าหมาย (Targets) ---
		sub.targetSchoolPct = parseFloat(document.getElementById('edit-target-school-pct').value) || 0;
		sub.targetDeptPct = parseFloat(document.getElementById('edit-target-dept-pct').value) || 0;
		sub.targetSubjectPct = parseFloat(document.getElementById('edit-target-subject-pct').value) || 0;
		sub.targetSchoolGPA = parseFloat(document.getElementById('edit-target-school-gpa').value) || 0;
		sub.targetDeptGPA = parseFloat(document.getElementById('edit-target-dept-gpa').value) || 0;
		sub.targetSubjectGPA = parseFloat(document.getElementById('edit-target-subject-gpa').value) || 0;

		// --- 4. เกณฑ์คะแนนสอบ (Mid/Final) ---
		sub.midMax = parseFloat(document.getElementById('edit-mid-max').value) || 0;
		sub.midPassPct = parseFloat(document.getElementById('edit-mid-pass-pct').value) || 0;
		sub.finMax = parseFloat(document.getElementById('edit-fin-max').value) || 0;
		sub.finPassPct = parseFloat(document.getElementById('edit-fin-pass-pct').value) || 0;
		
		// --- 5. [ใหม่] สัดส่วนคะแนน (Weight Settings) ---
		sub.weightUnit = parseFloat(document.getElementById('edit-weight-unit').value) || 0;
		sub.weightTask = parseFloat(document.getElementById('edit-weight-task').value) || 0;

		// (หมายเหตุ: ข้อมูล units และ tasks จะถูกอัปเดตผ่านฟังก์ชันย่อยของมันเองอยู่แล้ว ไม่ต้องทำในนี้)
	}

    function addNewSubject() { 
        const id = "s" + Date.now(); 
        const template = subjects[0] || {};
        const newSub = {
            ...template, 
            id, 
            name: "วิชาใหม่", 
            code: "รหัสวิชา",
            classes: [],
            advisors: {},
            units: [{ id: 1, max: 10, passPct: 50 }], 
			tasks: [] // เพิ่มบรรทัดนี้
        };
        subjects.push(newSub); 
        editSubject(id); 
        switchSettingsTab('tab-subject'); 
        showNotification('เพิ่มรายวิชาแล้ว กรุณากำหนดโครงสร้างคะแนน'); 
    }
    
    function deleteCurrentSubject() { if (!editingSubjectId) return; Swal.fire({ title: 'ลบรายวิชา?', icon: 'warning', showCancelButton: true, confirmButtonText: 'ลบ', confirmButtonColor: '#dc3545' }).then(r => { if (r.isConfirmed) { subjects = subjects.filter(s => s.id !== editingSubjectId); editingSubjectId = null; document.getElementById('subject-editor').classList.add('opacity-50', 'pointer-events-none'); renderSettingsSubjects(); showNotification('ลบเรียบร้อย', 'info'); applySettings(); } }); }
    
    function applySettings() { 
        showLoading();
        callBackend('saveSubjects', subjects)
        .then(function(res) {
            if(res.result === 'error') throw new Error(res.message);
            showNotification('บันทึกสำเร็จ'); 
            switchView('grading');
            hideLoading();
        })
        .catch(function(e) {
            hideLoading();
            Swal.fire('Error', e.message, 'error');
        });
    }

    function setPrintOrientation(orientation, pageMargin = '1cm 1cm 1cm 1cm') {
        const styleTag = document.getElementById('print-styles');
        let pageSize = `A4 ${orientation}`;
        const newStyle = styleTag.innerHTML.replace(/@page\s*{[^}]*}/, 
            `@page { size: ${pageSize}; margin: ${pageMargin} !important; }`);
        styleTag.innerHTML = newStyle;
        document.body.classList.remove('print-portrait', 'print-landscape');
        document.body.classList.add(`print-${orientation}`);
    }

	function printReport(mode = 'all') {
		const orientation = 'landscape';
		// --- ตั้งค่าระยะขอบ: บน 0.26", ขวา 0", ล่าง 0.26", ซ้าย 0" ---
		setPrintOrientation(orientation, '0.26in 0in 0.26in 0in');
		// -------------------------------------------------------------
		
		document.body.classList.remove('print-cover-mode');
		document.body.classList.remove('print-achievement-mode');
		currentPrintMode = mode;
		
		initTable(); // รีโหลดตารางเพื่อใช้ renderHeader แบบใหม่
		
		setTimeout(() => {
			window.print();
			setTimeout(() => {
				currentPrintMode = 'all';
				initTable(); // คืนค่าตารางกลับสู่ปกติ
			}, 500);
		}, 200);
	}

function printCover() {
    showLoading();
    setTimeout(() => {
        const sub = subjects.find(s => s.id === activeSubjectId);
        if (!sub) { hideLoading(); return; }
        
        const orientation = 'portrait'; 
        setPrintOrientation(orientation, '0cm 0cm 0cm 1cm');

        // --- ส่วน Header หน้าปก ---
        const gradeLevelStr = activeClassName.split('/')[0].trim();
        const docTypeEl = document.getElementById('cover-doc-type');
        if (docTypeEl) {
            docTypeEl.innerText = ['ม.1', 'ม.2', 'ม.3'].some(g => gradeLevelStr.includes(g)) ? 'ปพ.5 : บ' : 'ปพ.5 : พ';
        }
        
        // ใส่ข้อมูลทั่วไป
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
        setTxt('cover-school-name', sub.schoolName || "โรงเรียนปากช่อง");
        setTxt('cover-affiliation', sub.affiliation || "-");
        setTxt('cover-grade-level', activeClassName.split('/')[0]);
        setTxt('cover-room', activeClassName.split('/')[1] || activeClassName);
        setTxt('cover-year', sub.year);
        setTxt('cover-semester', sub.semester);
        setTxt('cover-subject-name', sub.name);
        setTxt('cover-course-code', sub.code);
        setTxt('cover-subject-type', sub.type || "พื้นฐาน");
        setTxt('cover-hours', sub.hours || "0");
        setTxt('cover-credits', sub.credits || "0");
        setTxt('cover-teacher-name', sub.teacher);
        setTxt('advisor-name', (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-");
        setTxt('cover-head-dept-name', sub.departmentName || "-");

        // -----------------------------------------------------------------------
        // 1. คำนวณผลสัมฤทธิ์ทางการเรียน (เกรด)
        // -----------------------------------------------------------------------
        const classStudents = getActiveStudentsInClass(activeClassName);
        const totalStudents = classStudents.length;
        setTxt('cover-total-stu', totalStudents);

        let stats = { '4':0, '3.5':0, '3':0, '2.5':0, '2':0, '1.5':0, '1':0, '0':0, 'ร':0, 'มส':0, 'ผ':0, 'มผ':0 };
        let evalCountsFromGrade = { 3: 0, 2: 0, 1: 0, 0: 0 }; 

        classStudents.forEach(stu => {
            const totalScore = calculateStudentTotalBySub(sub, stu.uid, activeClassName);
            const remark = getStoredScore(sub.id, activeClassName, stu.uid, 'remark', "");
            const gradeStr = remark || computeGradeBySub(sub, totalScore);
            
            if (stats.hasOwnProperty(gradeStr)) stats[gradeStr]++;

            let level = 1; 
            if (['ร', 'มส', 'มผ'].includes(gradeStr)) level = 0;
            else {
                const g = parseFloat(gradeStr);
                if (!isNaN(g)) {
                    if (g >= 3.5) level = 3;
                    else if (g >= 2.5) level = 2;
                    else if (g >= 0) level = 1;
                }
            }
            if (evalCountsFromGrade.hasOwnProperty(level)) evalCountsFromGrade[level]++;
        });

        // แสดงผลตารางเกรด
        let totalGradePoints = 0, totalEvaluated = 0;
        for (const [key, count] of Object.entries(stats)) {
            const targetId = (['ร', 'มส', 'ผ', 'มผ'].includes(key)) ? `stat-cover-${key}` : `cover-stat-${key}`;
            const el = document.getElementById(targetId);
            if (el) el.innerText = count === 0 ? '-' : count;

            const pct = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(2) : "0.00";
            const pctEl = document.getElementById(`cover-pct-${key}`);
            if (pctEl) pctEl.innerText = pct;

            if (!isNaN(parseFloat(key))) {
                totalGradePoints += (count * parseFloat(key));
                totalEvaluated += count;
            }

            if (!['ร', 'มส', 'ผ', 'มผ'].includes(key)) {
                const barEl = document.getElementById(`chart-bar-${key}`);
                const valEl = document.getElementById(`chart-val-${key}`);
                if (barEl && valEl) {
                    barEl.style.height = pct + '%';
                    valEl.innerText = pct > 0 ? Math.round(pct) + '%' : '';
                }
            }
        }
        setTxt('cover-avg-grade', totalEvaluated > 0 ? (totalGradePoints / totalEvaluated).toFixed(2) : "0.00");

        // -----------------------------------------------------------------------
        // 2. ฟังก์ชันช่วยอัปเดตตารางหน้าปก (แยกรายตาราง + ล็อกขนาด)
        // -----------------------------------------------------------------------
        const updateCoverSection = (coverPrefix, sourcePrefix, isUsingRealScore) => {
            if (isUsingRealScore) {
                // กรณีใช้คะแนนจริง
                if (typeof refreshRoomSummary === 'function') refreshRoomSummary(sourcePrefix); 
                
                [3, 2, 1, 0].forEach(lvl => {
                    const srcCount = document.getElementById(`${sourcePrefix}-stat-${lvl}`);
                    const srcPct = document.getElementById(`${sourcePrefix}-pct-${lvl}`);
                    const destCount = document.getElementById(`cover-${coverPrefix}-${lvl}`);
                    const destPct = document.getElementById(`cover-${coverPrefix}-pct-${lvl}`);

                    if (srcCount && destCount) destCount.innerText = srcCount.innerText;
                    if (srcPct && destPct) destPct.innerText = srcPct.innerText;
                });
                
                const srcTotal = document.getElementById(`${sourcePrefix}-stat-total`);
                const destTotal = document.getElementById(`cover-${coverPrefix}-total`);
                if(srcTotal && destTotal) destTotal.innerText = srcTotal.innerText;
                
                const destTotalPct = document.getElementById(`cover-${coverPrefix}-pct-total`);
                if(destTotalPct) destTotalPct.innerText = "100";

            } else {
                // กรณีอิงเกรด
                [3, 2, 1, 0].forEach(lvl => {
                    const count = evalCountsFromGrade[lvl];
                    const pct = totalStudents > 0 ? ((count / totalStudents) * 100).toFixed(2) : "0.00";
                    const destCount = document.getElementById(`cover-${coverPrefix}-${lvl}`);
                    const destPct = document.getElementById(`cover-${coverPrefix}-pct-${lvl}`);

                    if (destCount) destCount.innerText = count === 0 ? '-' : count;
                    if (destPct) destPct.innerText = pct;
                });

                const destTotal = document.getElementById(`cover-${coverPrefix}-total`);
                const destTotalPct = document.getElementById(`cover-${coverPrefix}-pct-total`);
                if(destTotal) destTotal.innerText = totalStudents;
                if(destTotalPct) destTotalPct.innerText = "100";
            }
        };

        // เรียกใช้งาน update ข้อมูล
        updateCoverSection('read', 'rw', isUseScoreRW);
        updateCoverSection('attr', 'attr', isUseScoreAttr);
        updateCoverSection('comp', 'comp', isUseScoreComp);

        // -----------------------------------------------------------------------
        // 3. [สำคัญ] ล็อกความกว้างคอลัมน์ด้วย JavaScript (Inline Style Override)
        // -----------------------------------------------------------------------
        const enforceTableWidths = () => {
            // รายชื่อ ID ของเซลล์ที่ต้องการล็อกขนาด (จำนวนคน, ร้อยละ)
            const targetIds = [];
            ['read', 'attr', 'comp'].forEach(prefix => {
                [3, 2, 1, 0].forEach(lvl => {
                    targetIds.push(`cover-${prefix}-${lvl}`);
                    targetIds.push(`cover-${prefix}-pct-${lvl}`);
                });
                targetIds.push(`cover-${prefix}-total`);
                targetIds.push(`cover-${prefix}-pct-total`);
            });

            targetIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    // กำหนด Style บังคับขนาด
                    el.style.width = '22px';           // กว้าง 60px
                    el.style.minWidth = '22px';        // ห้ามเล็กกว่า 60px
                    el.style.maxWidth = '32px';        // ห้ามใหญ่กว่า 60px
                    el.style.whiteSpace = 'nowrap';    // ห้ามตัดบรรทัด
                    el.style.overflow = 'hidden';      // ซ่อนส่วนเกิน
                    el.style.textAlign = 'center';     // จัดกึ่งกลาง
                    el.style.display = 'table-cell';   // บังคับเป็น cell
                }
            });
            
            // พยายามล็อก <th> ของตารางด้วย (สมมติว่าเป็นคอลัมน์ 2 และ 3)
            // คุณควรเพิ่ม class 'cover-eval-table' ให้กับ <table> ทั้ง 3 ใน HTML จะแม่นยำที่สุด
            // แต่ถ้าไม่ได้เพิ่ม โค้ดนี้จะพยายามหาทางอ้อม
            document.querySelectorAll('table').forEach(table => {
                // ตรวจสอบว่าเป็นตารางสรุปผลหรือไม่ (เช็คจากมีคำว่า "ดีเยี่ยม" ในตาราง)
                if(table.innerText.includes('ดีเยี่ยม')) {
                     const ths = table.querySelectorAll('th');
                     if(ths.length >= 3) {
                         ths[1].style.width = '22px';
                         ths[2].style.width = '22px';
                     }
                }
            });
        };

        enforceTableWidths();
        // -----------------------------------------------------------------------

        // ลายเซ็น
        setTxt('sig-cover-teacher', sub.teacher);
        setTxt('sig-cover-head-dept', sub.headDepartment || "-");
        setTxt('sig-cover-head-eval', sub.headEvaluation || "-");
        setTxt('sig-cover-deputy', sub.deputyDirector || "-");
        setTxt('sig-cover-director', sub.director || "-");

        document.body.classList.add('print-cover-mode');
        hideLoading();
        window.print();
        
        setTimeout(() => {
            document.body.classList.remove('print-cover-mode');
            setPrintOrientation('portrait');
        }, 500);
    }, 500);
}
    // ^--- ตรวจสอบว่ามีวงเล็บปีกกาปิดตัวนี้ครบถ้วน

	function updateGradingFilters() {
		// 1. ดึง Element Dropdown ของหน้า "บันทึกคะแนน" (เดิม)
		const subSelect = document.getElementById('select-subject'); 
		const classSelect = document.getElementById('select-class');
		
		// 2. ดึง Element Dropdown ของหน้า "บันทึกคะแนนงาน" (ใหม่)
		const subSelectTask = document.getElementById('select-subject-task');
		const classSelectTask = document.getElementById('select-class-task');

		// ตรวจสอบวิชาที่เลือกปัจจุบัน
		let sub = subjects.find(s => s.id === activeSubjectId);
		
		// ถ้าไม่เจอวิชา (เช่น เพิ่งโหลดระบบ) ให้เลือกวิชาแรกสุด
		if (!sub && subjects.length > 0) {
			activeSubjectId = subjects[0].id;
			sub = subjects[0];
		}

		// สร้าง HTML ตัวเลือกวิชา (Subject Options)
		const subOptions = subjects.map(s => `<option value="${s.id}" ${s.id === activeSubjectId ? 'selected' : ''}>${s.code} ${s.name}</option>`).join('');

		// อัปเดต Dropdown วิชาทั้ง 2 หน้าให้เหมือนกัน
		if(subSelect) subSelect.innerHTML = subOptions;
		if(subSelectTask) subSelectTask.innerHTML = subOptions; // อัปเดตหน้างานด้วย

		// จัดการตัวเลือกห้องเรียน (Class Options)
		if (sub) { 
			// ถ้าห้องที่เลือกอยู่เดิม ไม่มีในวิชาใหม่ที่เพิ่งเปลี่ยน -> ให้เด้งไปห้องแรกของวิชานั้น
			if (!sub.classes.includes(activeClassName)) {
				activeClassName = sub.classes[0] || ""; 
			}
			
			const classOptions = sub.classes.map(c => `<option value="${c}" ${c === activeClassName ? 'selected' : ''}>${c}</option>`).join('');

			// อัปเดต Dropdown ห้องเรียนในหน้า "บันทึกคะแนน"
			if(classSelect) {
				classSelect.innerHTML = classOptions; 
				classSelect.value = activeClassName;
			}
			
			// อัปเดต Dropdown ห้องเรียนในหน้า "บันทึกคะแนนงาน" (สำคัญ!)
			if(classSelectTask) {
				classSelectTask.innerHTML = classOptions; 
				classSelectTask.value = activeClassName;
			}
		}
	}
    
    function updateDisplayHeader() { 
        const sub = subjects.find(s => s.id === activeSubjectId); 
        if (sub) { 
            document.getElementById('display-teacher-name').innerText = sub.teacher; document.getElementById('display-course-code').innerText = sub.code;
            document.getElementById('display-semester').innerText = sub.semester || "-"; document.getElementById('display-academic-year').innerText = sub.year || "-";
            document.getElementById('header-subject-name').innerText = `บันทึกผลการเรียน: ${sub.name}`; document.getElementById('sig-teacher-name').innerText = sub.teacher;
            const now = new Date(); const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const fullThaiDate = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;
            document.getElementById('sig-date').innerText = fullThaiDate; document.getElementById('print-date-now').innerText = fullThaiDate;
            document.getElementById('print-school-name').innerText = sub.schoolName || "โรงเรียนปากช่อง";
            document.getElementById('print-subject-code').innerText = sub.code; document.getElementById('print-subject-name').innerText = sub.name;
            document.getElementById('print-subject-credits').innerText = sub.credits; document.getElementById('print-year').innerText = sub.year;
            document.getElementById('print-semester').innerText = sub.semester || 1; document.getElementById('print-grade-level').innerText = activeClassName.split('/')[0];
            document.getElementById('print-room-group').innerText = activeClassName.split('/')[1] || activeClassName;
            document.getElementById('print-teacher-name').innerText = sub.teacher;
            const currentAdvisor = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
            document.getElementById('print-advisor-name').innerText = currentAdvisor; document.getElementById('display-advisor-name').innerText = currentAdvisor;
        } 
    }

	// แก้ไขฟังก์ชันเปลี่ยนวิชา (ให้รองรับหน้าคะแนนงาน)
	function changeActiveSubject(id) { 
		activeSubjectId = id; 
		currentGradingPage = 1; 
		updateGradingFilters(); 
		updateDisplayHeader(); 
		
		// เช็คว่าอยู่หน้าไหน ให้โหลดตารางหน้านั้น
		const activeView = document.querySelector('.view-section.view-active')?.id;
		if (activeView === 'task-grading-view') {
			initTaskTable();
		} else {
			initTable(); 
		}
	}

// ฟังก์ชันเปลี่ยนห้องเรียน (ฉบับสมบูรณ์)
function changeActiveClass(cls) { 
    // 1. อัปเดตตัวแปร Global
    activeClassName = cls; 
    currentGradingPage = 1;

    // 2. อัปเดตส่วนหัวทันที (ชื่อครูที่ปรึกษา, ข้อมูลวิชา)
    // *ส่วนนี้แก้ปัญหาชื่อครูไม่เปลี่ยน*
    updateDisplayHeader();    

    // 3. ซิงค์ Dropdown ของหน้าอื่นๆ (อ่าน-คิด-เขียน, สมรรถนะ, คุณลักษณะ) ให้เป็นห้องเดียวกัน
    // (ทำงานเมื่อมีฟังก์ชัน updateCommonDropdowns ในระบบ)
    if (typeof updateCommonDropdowns === 'function') {
        ['rw', 'comp', 'attr'].forEach(t => {
            updateCommonDropdowns(`select-subject-${t}`, `select-class-${t}`);
        });
    }

    // 4. ตรวจสอบว่ากำลังใช้งานหน้าไหนอยู่ แล้วสั่งโหลดตารางหน้านั้นใหม่
    const activeView = document.querySelector('.view-section.view-active')?.id;
    
    if (activeView === 'rw-view') {
        initRWTable();           // โหลดตาราง อ่าน-คิด-เขียน
    } else if (activeView === 'competency-view') {
        initCompetencyTable();   // โหลดตาราง สมรรถนะ
    } else if (activeView === 'attribute-view') {
        initAttributeTable();    // โหลดตาราง คุณลักษณะ
    } else if (activeView === 'task-grading-view') {
        initTaskTable();         // โหลดตาราง คะแนนรายชิ้นงาน
    } else {
        initTable();             // โหลดตาราง บันทึกคะแนนหลัก (ค่าเริ่มต้น)
    } 
}
		
	function initTable() {
		const sub = subjects.find(s => s.id === activeSubjectId);
		if (!sub) return;

		const classStudents = getActiveStudentsInClass(activeClassName);
		
		// --- ส่วนจัดการ Pagination ---
		if (typeof isShowAllRows !== 'undefined' && isShowAllRows) {
			// กรณีเลือก "แสดงทั้งหมด" (Show All)
			const infoEl = document.getElementById('pagination-info');
			if(infoEl) infoEl.innerText = `แสดงทั้งหมด (${classStudents.length} คน)`;


			// 2. สร้างปุ่มจำลอง (ให้คงอยู่แต่กดไม่ได้)
			const ctrlEl = document.getElementById('grading-pagination-controls');
			if(ctrlEl) {
				ctrlEl.innerHTML = `
					<button disabled class="pagination-btn px-3 py-1 border rounded bg-slate-50 text-slate-400 cursor-not-allowed shadow-sm font-bold text-xs flex items-center gap-1 opacity-50">
						<i class="fa-solid fa-chevron-left text-[10px]"></i> ก่อนหน้า
					</button>
					<button class="px-3 py-1 border rounded bg-[#0d6efd] text-white font-bold text-xs">1</button>
					<button disabled class="pagination-btn px-3 py-1 border rounded bg-slate-50 text-slate-400 cursor-not-allowed shadow-sm font-bold text-xs flex items-center gap-1 opacity-50">
						ถัดไป <i class="fa-solid fa-chevron-right text-[10px]"></i>
					</button>
				`;
			}
		} else {
			// กรณีแบ่งหน้าปกติ (Pagination)
			// เรียกฟังก์ชันสร้างปุ่ม โดยส่ง id 'grading-pagination' ไปให้
			renderGeneralPagination('grading-pagination', classStudents.length, currentGradingPage, p => { 
				currentGradingPage = p; 
				initTable(); 
				updateAchievementSummary(sub, classStudents);
			});
		}

		renderHeader(sub);
		renderRows(sub, classStudents);
		updateAchievementSummary(sub, classStudents);
	}
function renderHeader(sub) {
    const header = document.getElementById('tableHeader');
    let unitsHtml = '';
    
    // ส่วนคำนวณคะแนนรวมต่างๆ
    let taskMaxDisplay = 0;
    if (sub.weightTask > 0) taskMaxDisplay = sub.weightTask; 
    else if (sub.tasks) sub.tasks.forEach(t => taskMaxDisplay += t.max);

    let totalSubjectMax = 0;
    if(sub.weightUnit > 0) totalSubjectMax += sub.weightUnit;
    else sub.units.forEach(u => totalSubjectMax += u.max);
    totalSubjectMax += taskMaxDisplay;
    totalSubjectMax += (sub.midMax + sub.finMax);

    // --- สร้าง HTML ส่วนคอลัมน์หน่วย (Units) ---
    if (currentPrintMode === 'max') {
        // << โหมดพิมพ์ค่าสูงสุด >> : แบบเรียบง่าย
        sub.units.forEach(u => { 
            unitsHtml += `<th class="px-1 py-3 text-center bg-white border-r border-black min-w-[50px] font-bold text-black text-[10px]" style="border: 1px solid black;">
                <div class="mb-1">หน่วย ${u.id}</div>
                <div>(${u.max})</div>
            </th>`; 
        });
    } else {
        // << โหมดปกติ >> : ปรับโครงสร้างให้พิมพ์ออกทุกหน้า (ลด Flexbox)
        sub.units.forEach(u => { 
            unitsHtml += `<th class="px-1 py-2 text-center bg-white border-r border-black min-w-[75px] font-bold align-top" style="border: 1px solid black;">
                <div style="font-size: 11px; margin-bottom: 2px;">หน่วย ${u.id}</div>
                <div style="border: 1px solid #0a0a0a; border-radius: 4px; padding: 1px 4px; margin: 0 auto 2px auto; display: inline-block; font-size: 10px; background-color: #f3f4f6;">
                    ${u.max} | ${(u.max * u.passPct) / 100}
                </div>
                <div style="font-size: 10px; border-top: 1px dotted #ccc; padding-top: 2px;">
                    จ | ก
                </div>
            </th>`; 
        });
    }

    // --- สร้าง HTML ส่วนคอลัมน์งาน/กลางภาค/ปลายภาค ---
    let midHtml, finHtml, taskHtml;

    if (currentPrintMode === 'max') {
         // แบบเรียบง่าย (Max Mode)
         taskHtml = `<th class="col-task-sum px-1 py-3 text-center bg-white border-r border-black min-w-[50px] font-bold text-black text-[10px]" style="border: 1px solid black; ${typeof isShowTaskCol !== 'undefined' && isShowTaskCol ? '' : 'display:none'}">
            <div class="mb-1">รวมงาน</div>
            <div>(${taskMaxDisplay})</div>
         </th>`;

         midHtml = `<th class="px-1 py-3 text-center bg-white border-r border-black min-w-[50px] font-bold text-black text-[10px]" style="border: 1px solid black;">
            <div class="mb-1">กลางภาค</div>
            <div>(${sub.midMax})</div>
        </th>`;
         
         finHtml = `<th class="px-1 py-3 text-center bg-white border-r border-black min-w-[50px] font-bold text-black text-[10px]" style="border: 1px solid black;">
            <div class="mb-1">ปลายภาค</div>
            <div>(${sub.finMax})</div>
        </th>`;
    } else {
         // แบบปกติ (Normal Mode) - ปรับโครงสร้าง
         taskHtml = `<th class="col-task-sum px-1 py-2 text-center bg-orange-50 border-r border-black min-w-[70px] font-bold align-top" style="border: 1px solid black; ${typeof isShowTaskCol !== 'undefined' && isShowTaskCol ? '' : 'display:none'}">
            <div style="font-size: 11px; margin-bottom: 2px; color: #9a3412;">รวมงาน</div>
            <div style="border: 1px solid #0a0a0a; border-radius: 4px; padding: 1px 4px; margin: 0 auto 2px auto; display: inline-block; font-size: 10px; background-color: white;">
                เต็ม ${taskMaxDisplay}
            </div>
            <div style="font-size: 9px; color: #ea580c;">(Auto)</div>
        </th>`;

         midHtml = `<th class="px-1 py-2 text-center bg-blue-50 border-r border-black min-w-[80px] font-bold align-top" style="border: 1px solid black;">
            <div style="font-size: 11px; margin-bottom: 2px; color: #1e40af;">กลางภาค</div>
            <div style="border: 1px solid #0a0a0a; border-radius: 4px; padding: 1px 4px; margin: 0 auto 2px auto; display: inline-block; font-size: 10px; background-color: white;">
                ${sub.midMax} | ${(sub.midMax * sub.midPassPct) / 100}
            </div>
            <div style="font-size: 10px; border-top: 1px dotted #ccc; padding-top: 2px;">
                จ | ก
            </div>
        </th>`;
         
         finHtml = `<th class="px-1 py-2 text-center bg-blue-50 border-r border-black min-w-[80px] font-bold align-top" style="border: 1px solid black;">
            <div style="font-size: 11px; margin-bottom: 2px; color: #1e40af;">ปลายภาค</div>
            <div style="border: 1px solid #0a0a0a; border-radius: 4px; padding: 1px 4px; margin: 0 auto 2px auto; display: inline-block; font-size: 10px; background-color: white;">
                ${sub.finMax} | ${(sub.finMax * sub.finPassPct) / 100}
            </div>
            <div style="font-size: 10px; border-top: 1px dotted #ccc; padding-top: 2px;">
                จ | ก
            </div>
        </th>`;
    }

    // ข้อมูลวันที่พิมพ์
    const currentAdvisor = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
    const now = new Date();
    const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
    const printDate = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;

    // --- ประกอบร่าง HTML ทั้งหมด ---
    header.innerHTML = `
        <tr class="print-table-header-info">
            <th colspan="${4 + sub.units.length + 8}" class="p-4 border-b-2 border-black bg-white" style="border:none;">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1"></div>
                    <div class="flex-1 text-center">
                        <h2 class="text-xl font-bold text-black">${sub.schoolName || 'โรงเรียนปากช่อง'}</h2>
                    </div>
                    <div class="flex-1 text-right text-[10px] text-black font-normal">
                        <div Style="display:none;" >หน้าที่ ${currentGradingPage}</div>
                        <div>พิมพ์วันที่ ${printDate}</div>
                    </div>
                </div>
                <div class="text-center text-[13px] text-black space-y-1 font-['Sarabun'] font-bold">
                    <div>
                        วิชา <span class="text-blue-900">${sub.code}</span> 
                        <span class="text-blue-900">${sub.name}</span> 
                        ระดับชั้น <span>${activeClassName.split('/')[0]}</span> 
                        กลุ่มที่ <span>${activeClassName.split('/')[1] || activeClassName}</span>
                    </div>
                    <div class="pt-1">
                        ครูผู้สอน <span>${sub.teacher}</span> 
                        <span class="inline-block w-8"></span>
                        ครูที่ปรึกษา <span>${currentAdvisor}</span>
                    </div>
                </div>
            </th>
        </tr>
        <tr class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-black font-bold">
            <th class="px-2 py-4 text-center w-8 border-r border-black text-sm font-bold align-middle" style="border: 1px solid black;">ที่</th>
            <th class="px-2 py-4 w-10 text-center border-r border-black text-sm font-bold print:hidden align-middle">รูป</th>
            <th class="px-2 py-4 w-20 border-r border-black text-center text-sm font-bold align-middle" style="border: 1px solid black;">รหัส</th>
            <th class="px-2 py-4 w-48 border-r border-black text-center text-sm font-bold align-middle" style="border: 1px solid black;">ชื่อ-นามสกุล</th>
            
            ${unitsHtml}
            ${taskHtml}
            ${midHtml}
            ${finHtml}

            <th class="px-2 py-4 text-center bg-yellow-50 font-bold border-r border-black text-sm align-middle" style="border: 1px solid black;">รวม<br>(${totalSubjectMax})</th>
            <th class="px-2 py-4 text-center bg-blue-50 font-bold border-r border-black text-sm align-middle" style="border: 1px solid black;">%</th>
            <th class="px-2 py-4 text-center bg-blue-50 font-bold border-r border-black text-sm no-print align-middle min-w-[100px]">ความก้าวหน้า</th>
            <th class="px-2 py-4 text-center bg-green-50 font-bold border-r border-black text-sm align-middle" style="border: 1px solid black;">เกรด</th>
            <th class="px-2 py-4 text-center bg-gray-50 font-bold text-sm border-r border-black no-print align-middle">Remark</th>
        </tr>`;
}
			
	function renderRows(sub, list) {
		const tbody = document.getElementById('studentTableBody');
		if (list.length === 0) {
			tbody.innerHTML = `<tr><td colspan="100%" class="text-center py-8 text-red-500 font-bold">...ไม่พบข้อมูลนักเรียนในห้องนี้...</td></tr>`;
			return;
		}

		// Logic การตัดแบ่งหน้า (Slicing)
		let start = (currentGradingPage - 1) * rowsPerPage;
		let limit = rowsPerPage;

		if (typeof isShowAllRows !== 'undefined' && isShowAllRows) {
			start = 0;
			limit = list.length;
		}

		const paginated = list.slice(start, start + limit);

		tbody.innerHTML = paginated.map((s, local) => {
			const globalIdx = start + local; 
			const currentRow = local; 
			
			// -----------------------------------------------------------
			// 1. ส่วนคะแนนรายหน่วย (Units) : แก้ไขเพิ่มเงื่อนไข 'max'
			// -----------------------------------------------------------
			let units = '';
			sub.units.forEach(u => {
				const r = getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_r`);
				const e = getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_e`);
				
				// --- [แก้ไข] เพิ่มการตรวจสอบโหมดพิมพ์ ---
				if (currentPrintMode === 'max') {
					// ถ้าเป็นโหมดพิมพ์ค่าสูงสุด ให้แสดงเฉพาะตัวเลขที่มากที่สุด
					const maxVal = Math.max(parseFloat(r) || 0, parseFloat(e) || 0);
					units += `<td class="px-0.5 py-1 text-center border-r font-bold text-slate-700 text-[12px]">${maxVal}</td>`;
				} else {
					// โหมดปกติ แสดงช่องกรอก 2 ช่อง
					const passMark = (u.max * u.passPct) / 100;
					const rNum = parseFloat(r);
					const rBg = (r !== "" && !isNaN(rNum) && rNum < passMark) ? 'bg-yellow-300' : 'bg-white';
					
					units += `<td class="px-0.5 py-1 text-center border-r"><div class="flex justify-center items-center gap-1 font-bold">
						<input type="number" value="${r}" 
							data-row="${currentRow}" data-col="u${u.id}_r" data-uid="${s.uid}" data-idx="${globalIdx}"
							onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)"
							onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'u${u.id}_r', this.value, ${globalIdx})" 
							class="input-score text-center border rounded-full ${rBg} w-[28px] h-[24px] font-bold shadow-sm outline-none">
						<span class="text-slate-300">|</span>
						<input type="number" value="${e}" 
							data-row="${currentRow}" data-col="u${u.id}_e" data-uid="${s.uid}" data-idx="${globalIdx}"
							onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)"
							onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'u${u.id}_e', this.value, ${globalIdx})" 
							class="input-score text-center border rounded-full bg-red-500 text-white w-[28px] h-[24px] font-bold shadow-sm placeholder-white/50 outline-none">
					</div></td>`;
				}
			});

			// 2. คำนวณคะแนนงานรวม (Tasks)
			let rawTaskSum = 0;
			let maxTaskSum = 0;
			if(sub.tasks) {
				sub.tasks.forEach(t => {
					const tr = parseFloat(getStoredScore(activeSubjectId, activeClassName, s.uid, `t${t.id}_r`)) || 0;
					const te = parseFloat(getStoredScore(activeSubjectId, activeClassName, s.uid, `t${t.id}_e`)) || 0;
					rawTaskSum += Math.max(tr, te);
					maxTaskSum += t.max;
				});
			}
			
			let displayTaskScore = rawTaskSum;
			if(sub.weightTask > 0 && maxTaskSum > 0) {
				displayTaskScore = (rawTaskSum / maxTaskSum) * sub.weightTask;
			}
			displayTaskScore = parseFloat(displayTaskScore.toFixed(2));

			const taskCell = `<td class="col-task-sum px-0.5 py-1 text-center border-r font-bold text-orange-700 bg-orange-50/50 text-[12px]" style="${typeof isShowTaskCol !== 'undefined' && isShowTaskCol ? '' : 'display:none'}">
				${displayTaskScore}
			</td>`;

			// 3. คำนวณผลลัพธ์รวม (Total)
			const t = (typeof calculateStudentTotalBySub === 'function') 
					  ? calculateStudentTotalBySub(sub, s.uid, activeClassName) 
					  : calculateStudentTotal(sub, s.uid); 

			const p = calculateStudentPct(sub, t);
			const rem = getStoredScore(activeSubjectId, activeClassName, s.uid, 'remark', "");
			const grd = rem || computeGrade(sub, t);
			
			let rowBgClass = "odd:bg-white even:bg-[#FFFF99]"; 
			let txtIdxClass = "text-gray-400"; 
			
			if (rem === 'ร') { rowBgClass = "bg-fuchsia-400"; txtIdxClass = "text-black font-extrabold"; } 
			else if (rem === 'มส') { rowBgClass = "bg-rose-500"; txtIdxClass = "text-white font-extrabold"; }
			
			// Icon สถานะ
			let passedUnitsCount = 0;
			if(sub.units){
				sub.units.forEach(u => {
					const r = parseFloat(getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_r`)) || 0;
					const e = parseFloat(getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_e`)) || 0;
					if (Math.max(r, e) >= (u.max * u.passPct / 100)) passedUnitsCount++;
				});
			}
			const statusIconHtml = generateStatusIcon(passedUnitsCount, sub.units ? sub.units.length : 0);

			// ดึงคะแนนกลางภาค/ปลายภาค
			const midR = getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_r');
			const midE = getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_e');
			const finR = getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_r');
			const finE = getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_e');
			const midPassMark = (sub.midMax * sub.midPassPct) / 100;
			const finPassMark = (sub.finMax * sub.finPassPct) / 100;
			const midRNum = parseFloat(midR);
			const finRNum = parseFloat(finR);

			// -----------------------------------------------------------
			// 4. ส่วนคะแนนกลางภาค/ปลายภาค : แก้ไขเพิ่มเงื่อนไข 'max'
			// -----------------------------------------------------------
			let midHtml, finHtml;

			if (currentPrintMode === 'max') {
				 // โหมดพิมพ์ค่าสูงสุด: แสดงเลขเดียว
				 const midMaxVal = Math.max(parseFloat(midR) || 0, parseFloat(midE) || 0);
				 const finMaxVal = Math.max(parseFloat(finR) || 0, parseFloat(finE) || 0);
				 
				 midHtml = `<td class="px-0.5 py-1 text-center border-r font-bold text-slate-700 text-[12px]">${midMaxVal}</td>`;
				 finHtml = `<td class="px-0.5 py-1 text-center border-r font-bold text-slate-700 text-[12px]">${finMaxVal}</td>`;
			} else {
				 // โหมดปกติ: แสดง 2 ช่อง
				 midHtml = `<td class="px-0.5 py-1 text-center border-r border-indigo-50"><div class="flex justify-center items-center gap-1 font-bold">
					<input type="number" value="${midR}" 
						data-row="${currentRow}" data-col="mid_r" data-uid="${s.uid}" data-idx="${globalIdx}"
						onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)"
						onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'mid_r', this.value, ${globalIdx})" 
						class="input-score text-center border rounded-full ${midR !== "" && !isNaN(midRNum) && midRNum < midPassMark ? 'bg-yellow-300' : 'bg-white'} w-[28px] h-[24px] font-bold shadow-sm outline-none">
					<span class="text-slate-300">|</span>
					<input type="number" value="${midE}" 
						data-row="${currentRow}" data-col="mid_e" data-uid="${s.uid}" data-idx="${globalIdx}"
						onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)"
						onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'mid_e', this.value, ${globalIdx})" 
						class="input-score text-center border rounded-full bg-red-500 text-white w-[28px] h-[24px] font-bold shadow-sm outline-none">
				</div></td>`;

				finHtml = `<td class="px-0.5 py-1 text-center border-r border-indigo-50"><div class="flex justify-center items-center gap-1 font-bold">
					<input type="number" value="${finR}" 
						data-row="${currentRow}" data-col="fin_r" data-uid="${s.uid}" data-idx="${globalIdx}"
						onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)"
						onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'fin_r', this.value, ${globalIdx})" 
						class="input-score text-center border rounded-full ${finR !== "" && !isNaN(finRNum) && finRNum < finPassMark ? 'bg-yellow-300' : 'bg-white'} w-[28px] h-[24px] font-bold shadow-sm outline-none">
					<span class="text-slate-300">|</span>
					<input type="number" value="${finE}" 
						data-row="${currentRow}" data-col="fin_e" data-uid="${s.uid}" data-idx="${globalIdx}"
						onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)"
						onfocus="this.select()" oninput="updateScore(this, '${s.uid}', 'fin_e', this.value, ${globalIdx})" 
						class="input-score text-center border rounded-full bg-red-500 text-white w-[28px] h-[24px] font-bold shadow-sm outline-none">
				</div></td>`;
			}
			// -----------------------------------------------------------

			return `<tr class="grading-row border-b ${rowBgClass} transition-colors">
				<td class="px-2 py-1 text-center ${txtIdxClass} border-r text-[11px] font-bold">${globalIdx + 1}</td>
				<td class="px-1 py-1 border-r text-center print:hidden"><div onclick="viewStudentPhoto('${s.uid}')" class="student-photo-container w-6 h-6 bg-slate-100 rounded-full mx-auto overflow-hidden border cursor-pointer transition-transform">${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user text-[10px] text-slate-300 mt-1"></i>'}</div></td>
				<td class="px-2 py-1 text-gray-600 border-r text-[11px] text-center font-bold">${s.id}</td>
				<td class="px-2 py-1 text-gray-700 border-r text-[11px] truncate max-w-[140px] font-bold"><span id="status-icon-wrapper-${globalIdx}">${statusIconHtml}</span> ${s.name}</td>
				
				${units}
				${taskCell} 
				
				${midHtml}
				
				${finHtml}
				
				<td class="px-2 py-1 text-center font-bold bg-yellow-50/40 border-r text-[12px]" id="total-${globalIdx}">${t}</td>
				<td class="px-2 py-1 text-center font-bold text-[#0d6efd] bg-blue-50/40 border-r text-[11px]" id="pct-${globalIdx}">${p}%</td>
				
				<td class="px-2 py-1 border-r align-middle no-print">
					<div class="w-full bg-gray-200 rounded-full dark:bg-gray-700 h-3.5 shadow-inner border border-gray-100">
						<div id="progress-${globalIdx}" class="${getProgressColor(p)} text-[9px] font-bold text-white text-center p-0 leading-none rounded-full h-3.5 flex items-center justify-center transition-all duration-500 shadow-sm" style="width: ${p}%">${p}%</div>
					</div>
				</td>

				<td class="px-2 py-1 text-center font-bold bg-green-50/30 border-r text-[12px] ${getGradeColor(grd)}" id="grade-${globalIdx}">${grd}</td>
				<td class="px-1 py-1 text-center border-r no-print"><span class="hidden print:inline-block font-bold">${rem}</span><select onchange="updateScore(this, '${s.uid}', 'remark', this.value, ${globalIdx})" class="no-print text-[10px] border border-slate-200 rounded bg-white py-0.5 outline-none"><option value="" ${rem === "" ? "selected" : ""}>-</option><option value="ร" ${rem === "ร" ? "selected" : ""}>ร</option><option value="มส" ${rem === "มส" ? "selected" : ""}>มส</option><option value="ผ" ${rem === "ผ" ? "selected" : ""}>ผ</option><option value="มผ" ${rem === "มผ" ? "selected" : ""}>มผ</option></select></td>
			</tr>`;
		}).join('');
		
		if(typeof syncInputWidth === 'function') {
			setTimeout(() => { document.querySelectorAll('.input-score').forEach(el => syncInputWidth(el)); }, 0);
		}
	}


	// ฟังก์ชันช่วยเปลี่ยนสีแถวทันทีเมื่อเปลี่ยน Remark
    function updateRowAppearance(row, rem) {
        if (!row) return;

        // 1. ล้างสีพื้นหลัง Remark เดิมออก (ต้องลบทั้งแบบมี ! และไม่มี ! เผื่อไว้)
        row.classList.remove('!bg-fuchsia-400', '!bg-rose-500', 'bg-fuchsia-400', 'bg-rose-500');

        // 2. เตรียม Cells ที่จะเปลี่ยนสีตัวอักษร
        const cellIndex = row.cells[0]; // ลำดับ
        const cellId = row.cells[2];    // รหัส
        const cellName = row.cells[3];  // ชื่อ

        const targetCells = [cellIndex, cellId, cellName];

        // 3. ล้าง Class สีตัวอักษร "ทั้งหมด" ออกก่อน (ทั้งสีปกติและสี Remark)
        targetCells.forEach(c => {
            if(c) c.classList.remove(
                'text-black', 'text-white', 'font-extrabold', // Style ของ Remark
                'text-gray-400', 'text-gray-600', 'text-gray-700' // Style ปกติ
            );
        });

        // 4. ใส่สีใหม่ตามเงื่อนไข (ใช้ ! นำหน้า bg เพื่อบังคับทับสี odd/even)
        if (rem === 'ร') {
            row.classList.add('!bg-fuchsia-400'); 
            targetCells.forEach(c => { if(c) c.classList.add('text-black', 'font-extrabold'); });
        } else if (rem === 'มส') {
            row.classList.add('!bg-rose-500');
            targetCells.forEach(c => { if(c) c.classList.add('text-white', 'font-extrabold'); });
        } else {
            // กรณีไม่มี Remark หรือเป็นค่าอื่น -> คืนค่าสีตัวอักษรปกติ (พื้นหลังจะกลับเป็น odd/even อัตโนมัติเพราะลบ class bg ออกแล้ว)
            if(cellIndex) cellIndex.classList.add('text-gray-400');
            if(cellId) cellId.classList.add('text-gray-600');
            if(cellName) cellName.classList.add('text-gray-700');
        }
    }




    function generateStatusIcon(passedCount, totalCount) {
        let colorClass = 'text-red-500';
        let pingClass = 'bg-red-400';
        let iconClass = 'fa-circle-xmark';
        let title = 'ไม่ผ่านเกณฑ์ทุกหน่วย';
        if (passedCount === totalCount) {
            colorClass = 'text-green-500';
            pingClass = 'bg-green-400';
            iconClass = 'fa-circle-check';
            title = 'ผ่านเกณฑ์ทุกหน่วย';
        } else if (passedCount > 0) {
            colorClass = 'text-yellow-500';
            pingClass = 'bg-yellow-400';
            iconClass = 'fa-circle-exclamation';
            title = 'ผ่านเกณฑ์บางหน่วย';
        }
        return `
            <span class="relative inline-flex mr-1.5">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full ${pingClass} opacity-75"></span>
                <i class="fa-solid ${iconClass} ${colorClass} relative text-[10px]" title="${title}"></i>
            </span>
        `;
    }

    function renderGeneralPagination(prefix, total, current, callback) {
        const totalPages = Math.ceil(total / rowsPerPage) || 1; 
        const infoEl = document.getElementById(prefix + '-info'); 
        if (infoEl) infoEl.innerText = `แสดง ${total === 0 ? 0 : ((current-1)*rowsPerPage)+1}-${Math.min(current*rowsPerPage, total)} จาก ${total}`;
        
        const ctrlEl = document.getElementById(prefix + '-controls'); 
        if (!ctrlEl) return;

        let h = `<button onclick="(${callback})(${current - 1})" ${current === 1 ? 'disabled' : ''} class="pagination-btn px-3 py-1 border rounded bg-white shadow-sm font-bold hover:bg-slate-50 text-xs flex items-center gap-1">
                    <i class="fa-solid fa-chevron-left text-[10px]"></i> ก่อนหน้า
                </button>`;

        for (let i = 1; i <= totalPages; i++) { 
            if (i === 1 || i === totalPages || (i >= current - 1 && i <= current + 1)) {
                h += `<button onclick="(${callback})(${i})" class="px-3 py-1 border rounded ${current === i ? 'bg-[#0d6efd] text-white font-bold' : 'bg-white shadow-sm hover:bg-slate-50'} font-bold text-xs">${i}</button>`; 
            } else if (Math.abs(i - current) === 2) {
                h += `<span class="px-1 text-slate-400">...</span>`; 
            }
        }

        h += `<button onclick="(${callback})(${current + 1})" ${current === totalPages ? 'disabled' : ''} class="pagination-btn px-3 py-1 border rounded bg-white shadow-sm font-bold hover:bg-slate-50 text-xs flex items-center gap-1">
                    ถัดไป <i class="fa-solid fa-chevron-right text-[10px]"></i>
            </button>`;
            
        ctrlEl.innerHTML = h;
    }

    function getStoredScore(sid, r, uid, fid, def = 0) { return scoreData[sid]?.[r]?.[uid]?.[fid] ?? def; }

	function updateScore(el, uid, col, val, idx) {
		// 1. อัปเดตข้อมูลใน Memory
		const cls = activeClassName;
		if (!scoreData[activeSubjectId]) scoreData[activeSubjectId] = {};
		if (!scoreData[activeSubjectId][cls]) scoreData[activeSubjectId][cls] = {};
		if (!scoreData[activeSubjectId][cls][uid]) scoreData[activeSubjectId][cls][uid] = {};
		
		scoreData[activeSubjectId][cls][uid][col] = val; 

		// 2. คำนวณ (ส่วนเดิมของหน้า Grading หลัก) ...
		const sub = subjects.find(s => s.id === activeSubjectId);
		const total = calculateStudentTotal(sub, uid);
		const pct = calculateStudentPct(sub, total);
		const rem = getStoredScore(activeSubjectId, activeClassName, uid, 'remark', "");
		const grade = rem || computeGrade(sub, total); 

		// 3. อัปเดต UI หน้าหลัก (ถ้า element มีอยู่จริง)
		const totalEl = document.getElementById(`total-${idx}`);
		if (totalEl) {
			totalEl.innerText = total;
			// ... (โค้ดอัปเดตเกรด/Progress Bar เดิม) ...
			const pctEl = document.getElementById(`pct-${idx}`); if (pctEl) pctEl.innerText = `${pct}%`;
			const gradeEl = document.getElementById(`grade-${idx}`); if (gradeEl) { gradeEl.innerText = grade; gradeEl.className = `px-2 py-1 text-center font-bold bg-green-50/30 border-r text-[12px] ${getGradeColor(grade)}`; }
			const progEl = document.getElementById(`progress-${idx}`); if (progEl) { progEl.style.width = `${pct}%`; progEl.innerText = `${pct}%`; progEl.className = `${getProgressColor(pct)} text-[9px] font-bold text-white text-center p-0 leading-none rounded-full h-3.5 flex items-center justify-center transition-all duration-500 shadow-sm`; }
		}
		
		// 4. บันทึกลง Backend (Debounce)
		if(typeof debouncedSaveScores === 'function') {
			debouncedSaveScores();
		}
		
		// -----------------------------------------------------------
		// 5. จัดการเปลี่ยนสีช่องกรอก (Color Logic)
		// -----------------------------------------------------------

		// กรณี: คะแนนรายหน่วย (Unit)
		if (el && col.includes('u') && col.endsWith('_r')) {
			const uId = col.split('_')[0].replace('u', '');
			const u = sub.units.find(x => x.id == uId);
			if (u) {
				const passMark = (u.max * u.passPct) / 100;
				if (val !== "" && parseFloat(val) < passMark) {
					el.classList.remove('bg-white'); el.classList.add('bg-yellow-300');
				} else {
					el.classList.remove('bg-yellow-300'); el.classList.add('bg-white');
				}
			}
		}
		
		// กรณี: คะแนนงาน (Task) - [ส่วนที่เพิ่มใหม่ให้รองรับ _r]
		else if (el && col.startsWith('t') && col.endsWith('_r')) {
			const tId = col.split('_')[0].replace('t', ''); // แยก t1_r -> 1
			const task = sub.tasks ? sub.tasks.find(t => t.id == tId) : null;
			
			if (task) {
				const passMark = (task.max * (task.passPct || 50)) / 100;
				const numVal = parseFloat(val);
				
				// ถ้าค่าว่าง หรือ มากกว่าเท่ากับเกณฑ์ -> สีขาว
				if (val === "" || numVal >= passMark) {
					el.classList.remove('bg-yellow-300');
					el.classList.add('bg-white');
				} else {
					// ถ้าน้อยกว่าเกณฑ์ -> สีเหลือง
					el.classList.remove('bg-white');
					el.classList.add('bg-yellow-300');
				}
			}
		}
	}
	
	function renderAchievementTable(sub, list) {
		// หา Element ตาราง (รองรับทั้งหน้าพิมพ์และหน้า View)
		let tbody = document.getElementById('ach-table-body'); // สำหรับหน้าพิมพ์
		let tfoot = document.getElementById('ach-table-foot');
		
		// ถ้าไม่เจอให้ลองหาของหน้า View
		if (!tbody) {
			tbody = document.getElementById('view-ach-table-body');
			tfoot = document.getElementById('view-ach-table-foot');
		}
		
		if (!tbody) return;

		// เตรียมตัวแปรนับจำนวน
		const gradesCount = {
			"4.0": 0, "3.5": 0, "3.0": 0, "2.5": 0, 
			"2.0": 0, "1.5": 0, "1.0": 0, "0": 0, 
			"ร": 0, "มส": 0, "ผ": 0, "มผ": 0
		};
		
		let totalStudents = 0;
		let passed = 0;
		let good = 0; // เกรด 3 ขึ้นไป
		let fail = 0; // เกรด 0, ร, มส
		let totalScore = 0;
		let scoreCount = 0;
		let scoreList = [];

		// วนลูปนักเรียนเพื่อคำนวณ
		list.forEach(s => {
			// ข้ามถ้านักเรียนไม่อยู่ในสถานะปกติ (ถ้าต้องการนับทุกคนให้ลบบรรทัดนี้)
			// if (s.status !== 'ปกติ' && s.status !== '') return;

			totalStudents++;
			const t = calculateStudentTotal(sub, s.uid);
			const rem = getStoredScore(activeSubjectId, activeClassName, s.uid, 'remark', "");
			let grd = rem || computeGrade(sub, t);
			
			// แปลงรูปแบบเกรดให้ตรงกับ Key (เช่น 4 -> 4.0, 0 -> 0)
			if (grd === '4') grd = '4.0';
			if (grd === '3') grd = '3.0';
			if (grd === '2') grd = '2.0';
			if (grd === '1') grd = '1.0';
			
			if (gradesCount.hasOwnProperty(grd)) {
				gradesCount[grd]++;
			} else {
				// กรณีเกรดแปลกๆ ให้ปัดลงกลุ่ม 0 หรือตามความเหมาะสม
				if (!isNaN(parseFloat(grd))) gradesCount["0"]++;
			}

			// เก็บสถิติเพื่อคำนวณค่าเฉลี่ย
			if (!rem) {
				const val = parseFloat(grd);
				if (!isNaN(val)) {
					scoreList.push(val);
					totalScore += val;
					scoreCount++;
					if (val >= 1.0) passed++;
					if (val >= 3.0) good++;
					if (val === 0) fail++;
				}
			} else if (rem === 'ผ') {
				passed++;
			} else {
				fail++; // ร, มส ถือว่าไม่ผ่าน
			}
		});

		// คำนวณค่าสถิติ
		const avg = scoreCount > 0 ? (totalScore / scoreCount).toFixed(2) : "0.00";
		const sd = calculateSD(scoreList).toFixed(2);
		const passPct = totalStudents > 0 ? ((passed / totalStudents) * 100).toFixed(1) : "0.0";
		const goodPct = totalStudents > 0 ? ((good / totalStudents) * 100).toFixed(1) : "0.0";
		const failPct = totalStudents > 0 ? ((fail / totalStudents) * 100).toFixed(1) : "0.0";
		
		// กำหนดผลสรุป
		const targetGPA = sub.targetDeptGPA || 2.55;
		const conclusionHtml = parseFloat(avg) >= targetGPA 
			? '<span class="text-green-600 font-bold">ผ่านเกณฑ์</span>' 
			: '<span class="text-red-600 font-bold">ไม่ผ่านเกณฑ์</span>';

		// สร้าง HTML แถวเดียว (สำหรับรายวิชาเดียว/ห้องเดียว)
		let rowHtml = `<tr class="text-center text-sm">
			<td class="p-1">${sub.code}</td>
			<td class="p-1">${activeClassName}</td>
			<td class="p-1 font-bold">${totalStudents}</td>`;
		
		// จำนวนรายเกรด
		['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => {
			rowHtml += `<td class="p-1">${gradesCount[g]}</td>`;
		});
		
		rowHtml += `<td class="p-1 font-bold bg-slate-50">${totalStudents}</td>`;
		
		// ร้อยละรายเกรด
		['4.0','3.5','3.0','2.5','2.0','1.5','1.0','0','ร','มส'].forEach(g => {
			const pct = totalStudents > 0 ? ((gradesCount[g] / totalStudents) * 100).toFixed(1) : "0.0";
			rowHtml += `<td class="p-1">${pct}</td>`;
		});

		rowHtml += `<td class="p-1 font-bold bg-slate-50">100.0</td>
			<td class="p-1">${avg}</td>
			<td class="p-1">${sd}</td>
			<td class="p-1">${passPct}</td>
			<td class="p-1">${goodPct}</td>
			<td class="p-1">${failPct}</td>
			<td class="p-1">${conclusionHtml}</td>
		</tr>`;

		tbody.innerHTML = rowHtml;
		
		// ถ้ามี Footer (สรุปรวม) ให้ใส่ค่าเดียวกัน (เพราะดูทีละห้อง)
		if (tfoot) {
			tfoot.innerHTML = rowHtml.replace('<td>' + sub.code + '</td><td>' + activeClassName + '</td>', '<td colspan="2" class="text-center">รวม</td>');
		}
	}
	
	
	
	
	
	
	
    function updateScoreDisplay(uid, idx, sub, fid, el, maxScore, passPct) {
        const t = calculateStudentTotal(sub, uid);
        const p = calculateStudentPct(sub, t);
        const rem = scoreData[activeSubjectId][activeClassName][uid]?.remark || "";
        const g = rem || computeGrade(sub, t); 

        const tEl = document.getElementById(`total-${idx}`);
        const pEl = document.getElementById(`pct-${idx}`);
        const gEl = document.getElementById(`grade-${idx}`);

        if (tEl) tEl.innerText = t; 
        if (pEl) pEl.innerText = p + "%"; 
        if (gEl) { 
            gEl.innerText = g; 
            gEl.className = `px-2 py-1 text-center font-bold bg-green-50/30 border-r text-[12px] ${getGradeColor(g)}`; 
        }

        if (el && fid.endsWith('_r')) {
            const numericVal = scoreData[activeSubjectId][activeClassName][uid][fid] || 0;
            const passMark = (maxScore * passPct) / 100;
            if (numericVal < passMark) {
                el.classList.remove('bg-white');
                el.classList.add('bg-yellow-300'); 
            } else {
                el.classList.remove('bg-yellow-300');
                el.classList.add('bg-white');
            }
        }

        const iconWrapper = document.getElementById(`status-icon-wrapper-${idx}`);
        if (iconWrapper) {
            let passedUnitsCount = 0;
            sub.units.forEach(u => {
                const r = getStoredScore(activeSubjectId, activeClassName, uid, `u${u.id}_r`);
                const e = getStoredScore(activeSubjectId, activeClassName, uid, `u${u.id}_e`);
                if (Math.max(r, e) >= (u.max * u.passPct / 100)) passedUnitsCount++;
            });
            iconWrapper.innerHTML = generateStatusIcon(passedUnitsCount, sub.units.length);
        }

        updateAchievementSummary(sub, getActiveStudentsInClass(activeClassName));
    }

	function updateAchievementSummary(sub, classStudents) {
        const counts = { '4': 0, '3.5': 0, '3': 0, '2.5': 0, '2': 0, '1.5': 0, '1': 0, '0': 0, 'ร': 0, 'มส': 0, 'ผ': 0, 'มผ': 0 };
        let totalPct = 0; let goodCount = 0;
        
        classStudents.forEach(stu => {
            const t = calculateStudentTotal(sub, stu.uid); 
            const p = calculateStudentPct(sub, t); 
            const rem = getStoredScore(activeSubjectId, activeClassName, stu.uid, 'remark', ""); 
            const g = rem || computeGrade(sub, t);
            
            if (counts.hasOwnProperty(g)) counts[g]++; 
            totalPct += p; 
            if (!rem && parseFloat(computeGrade(sub, t)) >= 3) goodCount++;
        });

        const totalStu = classStudents.length;
        const avgPct = totalStu > 0 ? (totalPct / totalStu).toFixed(2) : "0.00";
        const goodPct = totalStu > 0 ? (goodCount / totalStu * 100).toFixed(2) : "0.00";
        
        const totalStuEl = document.getElementById('sum-total-stu');
        const avgPctEl = document.getElementById('sum-avg-pct');
        const goodPctEl = document.getElementById('sum-good-pct');
        
        if(totalStuEl) totalStuEl.innerText = totalStu; 
        if(avgPctEl) avgPctEl.innerText = avgPct; 
        if(goodPctEl) goodPctEl.innerText = goodPct;
        
        Object.keys(counts).forEach(g => { 
            // อัปเดตจำนวน
            const el = document.getElementById(`stat-${g}`); 
            if (el) el.innerText = counts[g] > 0 ? counts[g] : "-"; 
            
            // [เพิ่มใหม่] อัปเดตร้อยละ
            const pctEl = document.getElementById(`stat-pct-${g}`);
            if (pctEl) {
                const percentage = totalStu > 0 ? ((counts[g] / totalStu) * 100).toFixed(2) : "0.00";
                pctEl.innerText = (percentage === "0.00" && counts[g] === 0) ? "-" : percentage;
            }
        });
    }

    function calculateStudentTotal(sub, uid) { return calculateStudentTotalBySub(sub, uid, activeClassName); }
    function calculateStudentPct(sub, s) { let m = 0; sub.units.forEach(u => m += u.max); m += sub.midMax + sub.finMax; return m === 0 ? 0 : parseFloat(((s/m)*100).toFixed(2)); }
    function computeGrade(sub, s) { return computeGradeBySub(sub, s); }
    function getGradeColor(g) { if (g === "ร") return "text-purple-600"; if (g === "มส") return "text-red-800"; if (g === "ผ") return "text-emerald-700"; if (g === "มผ") return "text-rose-700"; return (parseFloat(g) < 1) ? "text-[#dc3545]" : "text-[#198754]"; }
    function syncInputWidth(el) { el.style.width = ((el.value?.toString().length || 1) * 7 + 15) + 'px'; }
    
	function saveScores() {
		showLoading(); 
		const sub = subjects.find(s => s.id === activeSubjectId);
		if (!sub) {
			hideLoading(); Swal.fire('Error', 'ไม่พบข้อมูลรายวิชา', 'error'); return;
		}

		const activeView = document.querySelector('.view-section.view-active')?.id;
		const roomData = scoreData[activeSubjectId]?.[activeClassName];

		if (roomData) {
			for (const uid in roomData) {
				// ... (RW Logic) ...
				
				// 3. หน้าคุณลักษณะอันพึงประสงค์ (Attribute)
				if (activeView === 'attribute-view') {
					let sum = 0;
					let hasZero = false;
					let countCore = 0;
					let countExtra = 0;
					
					for (let i = 1; i <= 10; i++) {
						const valStr = roomData[uid][`attr_${i}`];
						const val = (valStr === "" || valStr === undefined) ? 0 : parseInt(valStr);
						
						if (i <= 8) {
							if (valStr !== "" && valStr !== undefined) {
								countCore++;
								if (val === 0) hasZero = true;
							}
						} else {
							if (valStr !== "" && valStr !== undefined) countExtra++;
						}
						sum += val;
					}
					
					// ต้องครบ 8 ข้อถึงจะบันทึกผล
					if (countCore === 8) {
						let divisor = 8 + countExtra;
						const avg = parseFloat((sum / divisor).toFixed(2));
						let res = calEvalLevel(avg);
						if (hasZero) res = 0;

						roomData[uid]['attr_result'] = res;
						roomData[uid]['attr_assess'] = (res === 3 ? 'ดีเยี่ยม' : (res === 2 ? 'ดี' : (res === 1 ? 'ผ่าน' : 'ไม่ผ่าน')));
					} else {
						// ถ้าไม่ครบ อาจจะล้างค่า หรือปล่อยไว้ (เลือกปล่อยไว้เพื่อความปลอดภัย)
						// roomData[uid]['attr_result'] = ""; 
					}
				}
			}
		}

		callBackend('saveScores', scoreData)
			.then(function(res) {
				if(res.result === 'error') throw new Error(res.message);
				hideLoading();
				Swal.fire({ title: 'สำเร็จ', text: 'บันทึกข้อมูลเรียบร้อย', icon: 'success', timer: 1500, showConfirmButton: false });
			})
			.catch(function(e) {
				hideLoading();
				Swal.fire('Error', 'บันทึกไม่สำเร็จ: ' + e.message, 'error');
			});
	}

    /* --- New Functions: Refresh Room, Enter Navigation, Paste --- */

    function refreshGrades() {
        if(!activeSubjectId || !activeClassName) return;

        Swal.fire({
            title: 'รีเฟรชคะแนนห้อง ' + activeClassName + '?',
            text: "ระบบจะดึงคะแนนล่าสุดจาก Server เฉพาะห้องนี้ (ข้อมูลที่ยังไม่บันทึกจะหายไป)",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ดึงข้อมูล',
            confirmButtonColor: '#0891b2',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading();
                callBackend('getRoomScore', { subjectId: activeSubjectId, room: activeClassName })
                .then(res => {
                    if (res.result === 'success') {
                        if (!scoreData[activeSubjectId]) scoreData[activeSubjectId] = {};
                        scoreData[activeSubjectId][activeClassName] = res.data;
                        
                        initTable();
                        showNotification('อัปเดตข้อมูลเรียบร้อย');
                    } else {
                        Swal.fire('Error', res.message || 'ไม่สามารถดึงข้อมูลได้', 'error');
                    }
                    hideLoading();
                })
                .catch(err => {
                    hideLoading();
                    Swal.fire('Error', err.message, 'error');
                });
            }
        });
    }

    function handleInputKeydown(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            const currentInput = e.target;
            const currentRow = parseInt(currentInput.getAttribute('data-row'));
            const colType = currentInput.getAttribute('data-col');
            const nextRow = currentRow + 1;
            const nextInput = document.querySelector(`input[data-row="${nextRow}"][data-col="${colType}"]`);
            if (nextInput) {
                nextInput.focus();
                nextInput.select();
            }
        }
    }

    function handlePaste(e) {
        e.preventDefault();
        const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
        if (!clipboardData) return;
        const rows = clipboardData.split(/\r\n|\n|\r/).filter(row => row.trim() !== '');
        const startInput = e.target;
        const startRowIdx = parseInt(startInput.getAttribute('data-row'));
        const colType = startInput.getAttribute('data-col');

        rows.forEach((rowVal, i) => {
            const targetRowIdx = startRowIdx + i;
            const targetInput = document.querySelector(`input[data-row="${targetRowIdx}"][data-col="${colType}"]`);
            if (targetInput) {
                const val = rowVal.trim();
                const uid = targetInput.getAttribute('data-uid');
                const globalIdx = parseInt(targetInput.getAttribute('data-idx'));
                targetInput.value = val;
                updateScore(targetInput, uid, colType, val, globalIdx);
                syncInputWidth(targetInput);
            }
        });
    }

    /* --- End New Functions --- */

    function downloadStudentTemplate() {
        let csvContent = "\uFEFFเลขบัตรประชาชน,เลขประจำตัว,ชื่อ สกุล,ชั้น,เลขที่,เพศ,รูป,สถานะนักเรียน,ปีที่เข้าศึกษา\n";
        csvContent += "1234567890123,99999,ตัวอย่าง ชื่อ-สกุล,ม.4/1,1,ชาย,,ปกติ,2568";
        downloadFile(csvContent, 'Template_Students.csv', 'text/csv;charset=utf-8;');
    }

    function exportToCSV() {
        const sub = subjects.find(s => s.id === activeSubjectId); if (!sub) return;
        const classStudents = getActiveStudentsInClass(activeClassName);
        let csvContent = "\uFEFF"; csvContent += `"${sub.schoolName} - วิชา ${sub.code} ${sub.name} ห้อง ${activeClassName}"\n`;
        let headers = ["เลขที่", "รหัส", "ชื่อ-นามสกุล"]; sub.units.forEach(u => headers.push(`หน่วย ${u.id}`)); headers.push("กลางภาค", "ปลายภาค", "รวม", "ร้อยละ", "เกรด", "หมายเหตุ");
        csvContent += headers.join(",") + "\n";
        classStudents.forEach((s, index) => {
            let row = [index + 1, s.id, `"${s.name}"`]; sub.units.forEach(u => { const r = getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_r`), e = getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_e`); row.push(Math.max(r, e)); });
            const mid = Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_r'), getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_e')), fin = Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_r'), getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_e')), total = calculateStudentTotal(sub, s.uid), pct = calculateStudentPct(sub, total), rem = getStoredScore(activeSubjectId, activeClassName, s.uid, 'remark', ""), grade = rem || computeGrade(sub, total);
            row.push(mid, fin, total, pct, grade, rem); csvContent += row.join(",") + "\n";
        });
        downloadFile(csvContent, `Score_${sub.code}_${activeClassName}.csv`, 'text/csv;charset=utf-8;');
    }

    function exportToExcel() {
        const sub = subjects.find(s => s.id === activeSubjectId); if (!sub) return;
        const classStudents = getActiveStudentsInClass(activeClassName);
        let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><table><thead><tr><th colspan="${6+sub.units.length}" style="text-align:center;">${sub.schoolName} - วิชา ${sub.code} ${sub.name} ห้อง ${activeClassName}</th></tr><tr><th>เลขที่</th><th>รหัส</th><th>ชื่อ-นามสกุล</th>`;
        sub.units.forEach(u => html += `<th>หน่วย ${u.id}</th>`); html += `<th>กลางภาค</th><th>ปลายภาค</th><th>รวม</th><th>ร้อยละ</th><th>เกรด</th><th>หมายเหตุ</th></tr></thead><tbody>`;
        classStudents.forEach((s, index) => {
            const total = calculateStudentTotal(sub, s.uid), pct = calculateStudentPct(sub, total), rem = getStoredScore(activeSubjectId, activeClassName, s.uid, 'remark', ""), grade = rem || computeGrade(sub, total);
            html += `<tr><td>${index+1}</td><td>${s.id}</td><td>${s.name}</td>`;
            sub.units.forEach(u => { const val = Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_r`), getStoredScore(activeSubjectId, activeClassName, s.uid, `u${u.id}_e`)); html += `<td>${val}</td>`; });
            html += `<td>${Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_r'), getStoredScore(activeSubjectId, activeClassName, s.uid, 'mid_e'))}</td><td>${Math.max(getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_r'), getStoredScore(activeSubjectId, activeClassName, s.uid, 'fin_e'))}</td><td>${total}</td><td>${pct}</td><td>${grade}</td><td>${rem}</td></tr>`;
        });
        html += `</tbody></table></body></html>`;
        downloadFile(html, `Score_${sub.code}_${activeClassName}.xls`, 'application/vnd.ms-excel');
    }

    function downloadFile(content, fileName, mimeType) { const blob = new Blob([content], { type: mimeType }); const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

    let generatedCaptcha = '';
    let currentUser = null;

    function generateCaptcha() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let result = '';
        for (let i = 0; i < 6; i++) {
            result += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        generatedCaptcha = result;
        const capEl = document.getElementById('captcha-text');
        if(capEl) capEl.innerText = result;
        const capIn = document.getElementById('login-captcha');
        if(capIn) capIn.value = '';
    }

	function clearLoginForm() {
        const inputs = ['login-username', 'login-password', 'login-captcha'];
        inputs.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.value = '';
                // แก้ไข: ลบทั้ง Class สีแดง (Error) และสีพื้นหลังเทา (Slate) ออก
                el.classList.remove('border-red-500', 'bg-red-50', 'bg-slate-50');
                
                // แก้ไข: คืนค่าเป็นสีพื้นหลังเขียว (bg-lime-200) ตามต้นฉบับ
                el.classList.add('border-slate-200', 'bg-lime-200');
            }
        });
        generateCaptcha();
    }

	// ฟังก์ชันสำหรับสลับการแสดงผลรหัสผ่าน
    function togglePasswordVisibility() {
        const passInput = document.getElementById('login-password');
        const toggleIcon = document.getElementById('toggle-password-icon');

        if (passInput.type === 'password') {
            passInput.type = 'text';
            toggleIcon.classList.remove('fa-eye');
            toggleIcon.classList.add('fa-eye-slash');
        } else {
            passInput.type = 'password';
            toggleIcon.classList.remove('fa-eye-slash');
            toggleIcon.classList.add('fa-eye');
        }
    }

	function performLogin(btn) {
		const userEl = document.getElementById('login-username');
		const passEl = document.getElementById('login-password');
		const captEl = document.getElementById('login-captcha');
		
		const userIn = userEl.value.trim();
		const passIn = passEl.value.trim();
		const captIn = captEl.value.trim().toUpperCase();

		// --- รีเซ็ต Style ให้กลับเป็นสีปกติ (เขียวอ่อน) ---
		[userEl, passEl, captEl].forEach(el => {
			el.classList.remove('border-red-500', 'bg-red-50', 'bg-slate-50');
			el.classList.add('border-slate-200', 'bg-lime-200');
		});
		// -----------------------------------------------------------

		let isValid = true;
		if (!userIn) { userEl.classList.add('border-red-500', 'bg-red-50'); isValid = false; }
		if (!passIn) { passEl.classList.add('border-red-500', 'bg-red-50'); isValid = false; }
		if (!captIn) { captEl.classList.add('border-red-500', 'bg-red-50'); isValid = false; }

		if (!isValid) {
			Swal.fire({ icon: 'warning', title: 'ข้อมูลไม่ครบถ้วน', text: 'กรุณาระบุ ชื่อผู้ใช้, รหัสผ่าน และรหัส CAPTCHA ให้ครบ', confirmButtonColor: '#0d6efd' });
			return;
		}

		if (captIn !== generatedCaptcha) {
			captEl.classList.add('border-red-500', 'bg-red-50');
			Swal.fire({ icon: 'error', title: 'รหัส CAPTCHA ไม่ถูกต้อง', text: 'กรุณาตรวจสอบรหัสความปลอดภัยอีกครั้ง', confirmButtonColor: '#dc3545' }).then(() => { generateCaptcha(); captEl.value = ''; captEl.focus(); });
			return;
		}

		// เก็บข้อความปุ่มเดิม และแสดงสถานะกำลังโหลด
		const originalText = btn.innerHTML;
		btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> กำลังตรวจสอบ...';
		btn.disabled = true;
		
		showLoading(); 

		callBackend('login', { username: userIn, password: passIn })
		.then(res => {
			// คืนค่าปุ่มกลับสู่สภาพเดิม
			btn.innerHTML = originalText;
			btn.disabled = false;

			if (res.result === 'success') {
				currentUser = res.user;

				// จัดการ Checkbox จดจำการเข้าสู่ระบบ
				const rememberMe = document.getElementById('login-remember').checked;
				if (rememberMe) {
					localStorage.setItem('saved_username', userIn);
					localStorage.setItem('saved_password', passIn);
					localStorage.setItem('saved_remember', 'true');
				} else {
					localStorage.removeItem('saved_username');
					localStorage.removeItem('saved_password');
					localStorage.removeItem('saved_remember');
				}

				// บันทึกข้อมูลผู้ใช้ปัจจุบันลง LocalStorage
				localStorage.setItem('currentUser', JSON.stringify(currentUser));

				// --- [เพิ่มเติม] สั่งให้อัปเดตชื่อบนหัวเว็บทันที ---
				if (typeof updateHeaderUserName === 'function') {
					updateHeaderUserName(); 
				}
				// ---------------------------------------------

				document.getElementById('login-modal').classList.add('hidden'); 
				
				Swal.fire({ 
					icon: 'success', 
					title: 'เข้าสู่ระบบสำเร็จ', 
					text: `ยินดีต้อนรับ ${currentUser.name}`, 
					timer: 1500, 
					showConfirmButton: false 
				}).then(() => {
					loadSystemData(); 
				});
				
			} else {
				hideLoading();
				userEl.classList.add('border-red-500', 'bg-red-50');
				passEl.classList.add('border-red-500', 'bg-red-50');

				Swal.fire({ icon: 'error', title: 'เข้าสู่ระบบไม่สำเร็จ', text: res.message || 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง', confirmButtonColor: '#dc3545' }).then(() => { generateCaptcha(); passEl.value = ''; });
			}
		})
		.catch(err => {
			hideLoading();
			btn.innerHTML = originalText;
			btn.disabled = false;
			Swal.fire('System Error', err.message, 'error');
		});
	}

	window.onload = function() {
        // ---------------------------------------------------------
        // ส่วนที่ 2: ตรวจสอบและเติมข้อมูล User/Pass ถ้าเคยเลือก 'จดจำ' ไว้
        // ---------------------------------------------------------
        const savedUser = localStorage.getItem('saved_username');
        const savedPass = localStorage.getItem('saved_password');
        const isRemember = localStorage.getItem('saved_remember');

        if (isRemember === 'true' && savedUser && savedPass) {
            const userInput = document.getElementById('login-username');
            const passInput = document.getElementById('login-password');
            const rememberCheck = document.getElementById('login-remember');

            if (userInput) userInput.value = savedUser;
            if (passInput) passInput.value = savedPass;
            if (rememberCheck) rememberCheck.checked = true;
        }
        // ---------------------------------------------------------

        // ตรวจสอบว่ามีข้อมูล Session ผู้ใช้ค้างอยู่ใน LocalStorage หรือไม่ (Login ค้างไว้)
        const storedUser = localStorage.getItem('currentUser');
        
        if (storedUser) {
            // ถ้ามี: ให้โหลดข้อมูลผู้ใช้และเข้าสู่ระบบอัตโนมัติ
            currentUser = JSON.parse(storedUser);
            document.getElementById('login-modal').classList.add('hidden');
            
            // แสดงข้อความต้อนรับเล็กน้อย
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
            Toast.fire({ icon: 'success', title: `ยินดีต้อนรับ ${currentUser.name}` });
            
            // โหลดข้อมูลระบบทันที
            loadSystemData();
        } else {
            // ถ้าไม่มี: ให้แสดงหน้า Login ปกติ และสร้าง Captcha
            generateCaptcha();
            document.getElementById('login-modal').classList.remove('hidden');
        }
    };
	
function convertThaiDateToISO(dateVal) {
    if (!dateVal) return "";
    // ถ้าเป็น Date object จากระบบ
    if (dateVal instanceof Date) {
        return dateVal.toISOString().split('T')[0];
    }
    // ถ้าเป็น String YYYY-MM-DD อยู่แล้ว ให้ส่งคืนเลย
    if (typeof dateVal === 'string' && dateVal.includes('-')) {
        return dateVal.split('T')[0]; 
    }
    return dateVal;
}

 // -------------------------------------------------------------------------
    // 2. ฟังก์ชัน loadSystemData (ฉบับสมบูรณ์ + รองรับวันหยุดจาก Google Calendar)
    // -------------------------------------------------------------------------
    function loadSystemData() {
        showLoading();
        
        // ส่ง timestamp ไปด้วยเพื่อป้องกัน Browser Cache
        callBackend('getBackendData', { ts: new Date().getTime() })
        .then(function(data) {
            
            // 1. รับข้อมูลนักเรียน
            students = data.students || [];

            // 2. รับข้อมูลครู/บุคลากร
            teachers = data.teachers || []; 
            if (typeof updateStaffPositionDropdown === 'function') {
                updateStaffPositionDropdown();
            }

            // 3. รับข้อมูลวิชา
            if (data.subjects && data.subjects.length > 0) {
                subjects = data.subjects;
                // ตั้งค่าวิชาเริ่มต้นถ้ายังไม่มีการเลือก
                if(!activeSubjectId) {
                     activeSubjectId = subjects[0].id;
                     if(subjects[0].classes.length > 0) {
                         activeClassName = subjects[0].classes[0];
                     }
                }
            } else {
                // Mock Data กรณีเริ่มระบบครั้งแรก (ไม่มีข้อมูลใน Sheet)
                subjects = [{ 
                    id: "s1", name: "เคมี 2", code: "ว31222", type: "พื้นฐาน", credits: 1.5, hours: 3.0,
                    schoolName: "โรงเรียนปากช่อง", affiliation: "สพม. นครราชสีมา",
                    teacher: "นายธนสาร สีรักษ์", departmentName: "วิทยาศาสตร์และเทคโนโลยี",
                    advisors: { "ม.4/1": "นางสาวสมหญิง ใจดี" },
                    semester: 1, year: 2568, gradeLevel: "ม.4", classes: ["ม.4/1"], 
                    units: [{ id: 1, max: 10, passPct: 50 }], 
                    midMax: 20, midPassPct: 50, finMax: 20, finPassPct: 50,
                    targetSchoolPct: 60, targetDeptPct: 55, targetSubjectPct: 50,
                    targetSchoolGPA: 3.00, targetDeptGPA: 2.55, targetSubjectGPA: 2.50
                }];
                activeSubjectId = "s1";
                activeClassName = "ม.4/1";
            }

            // -----------------------------------------------------------
            // [ส่วนที่แก้ไข] การจัดการปฏิทินและวันหยุด
            // -----------------------------------------------------------
            
            // 4.1 รับกิจกรรมโรงเรียน (School Events)
            let backendEvents = [];
            if(data.calendarEvents && Array.isArray(data.calendarEvents)) {
                backendEvents = data.calendarEvents.map(evt => ({
                    ...evt,
                    // แปลงวันที่ให้เป็น ISO Format (YYYY-MM-DD)
                    date: convertThaiDateToISO(evt.date),      
                    endDate: convertThaiDateToISO(evt.endDate) 
                }));
            }

            // 4.2 รับวันหยุดราชการ (Google Holidays) ที่ส่งมาจาก Backend
            let googleHolidays = [];
            if(data.holidays && Array.isArray(data.holidays)) {
                // ข้อมูลจาก Google Calendar ผ่าน Backend พร้อมใช้งานได้เลย
                googleHolidays = data.holidays; 
            }

            // 4.3 รวมกิจกรรมโรงเรียนและวันหยุดราชการเข้าด้วยกัน
            // หมายเหตุ: วันหยุดจะแสดงอัตโนมัติโดยไม่ต้องคำนวณใน Frontend
            academicEvents = [...googleHolidays, ...backendEvents];
            
            // -----------------------------------------------------------

            // 5. รับข้อมูลคะแนน
            scoreData = data.scoreData || {};

            // Refresh หน้าจอหลังจากโหลดข้อมูลเสร็จ
            setTimeout(() => {
                updateGradingFilters(); 
                updateDisplayHeader(); 
                updateStudentFilters(); 
                
                // เรียกฟังก์ชันวาดตารางและ UI ต่างๆ
                if(typeof initTable === 'function') initTable(); 
                if(typeof initStudentTable === 'function') initStudentTable(); 
                if(typeof initStaffTable === 'function') initStaffTable(); 
                
                // วาดปฏิทินใหม่ (ข้อมูลวันหยุดจะถูกแสดงรวมไปแล้ว)
                if(typeof renderCalendar === 'function') {
                    renderCalendar();
                }
                
                hideLoading();
            }, 500);

        })
        .catch(function(e) {
            hideLoading();
            console.error("Load System Data Error:", e);
            Swal.fire('Error', 'กรุณาตรวจสอบอินเทอร์เน็ต', 'error');
        });
    }

	function logoutSystem() {
		Swal.fire({
			title: 'ยืนยันการออกจากระบบ?',
			text: "คุณต้องการออกจากระบบใช่หรือไม่",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonColor: '#d33',
			cancelButtonColor: '#3085d6',
			confirmButtonText: 'ใช่, ออกจากระบบ',
			cancelButtonText: 'ยกเลิก'
		}).then((result) => {
			if (result.isConfirmed) {
				if (currentUser && currentUser.username) {
					callBackend('logout', { username: currentUser.username });
				}
				
				currentUser = null;
				localStorage.removeItem('currentUser'); // ลบ session ปัจจุบัน

				document.getElementById('login-modal').classList.remove('hidden');
				
				// ล้างค่าในฟอร์มและ Error Style เดิมออกก่อน
				clearLoginForm();

                // --- [ส่วนที่เพิ่มใหม่: เติมข้อมูลกลับเข้าไปทันทีหากมีการบันทึกไว้] ---
                const isRemember = localStorage.getItem('saved_remember');
                const savedUser = localStorage.getItem('saved_username');
                const savedPass = localStorage.getItem('saved_password');

                if (isRemember === 'true' && savedUser && savedPass) {
                    const userInput = document.getElementById('login-username');
                    const passInput = document.getElementById('login-password');
                    const rememberCheck = document.getElementById('login-remember');

                    if (userInput) userInput.value = savedUser;
                    if (passInput) passInput.value = savedPass;
                    if (rememberCheck) rememberCheck.checked = true;
                }
                // ---------------------------------------------------------------

				Swal.fire({ icon: 'success', title: 'ออกจากระบบสำเร็จ', showConfirmButton: false, timer: 1500 });
			}
		});
	}
</script>

<script>
    // ป้องกันการคลิกขวา
    document.addEventListener('contextmenu', event => event.preventDefault());

    // ป้องกันปุ่มลัด (F12, Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+U, Ctrl+S)
    document.onkeydown = function(e) {
        // F12
        if(e.keyCode == 123) {
            return false;
        }
        // Ctrl+Shift+I (Inspect)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) {
            return false;
        }
        // Ctrl+Shift+J (Console)
        if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) {
            return false;
        }
        // Ctrl+U (View Source)
        if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) {
            return false;
        }
        // Ctrl+S (Save)
        if(e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) {
            return false;
        }
    }
	
/* =========================================
   4. Function: แสดงรายละเอียด (Card View)
   ========================================= */
/* =========================================
   ฟังก์ชัน: แสดงรายละเอียด (Card View)
   - รองรับข้อมูล 20 คอลัมน์ (วันเกิด/วันเกษียณ)
   - สีสถานะตามเงื่อนไข (ไม่ขาวล้วน)
   - คลิกรูปเพื่อดูภาพขยาย
   ========================================= */
function viewStaffDetails(uid) {
    const t = teachers.find(x => x.uid === uid);
    if (!t) return;
    
    const statusClass = getStaffStatusStyle(t.status);
    const placeholderImg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23cbd5e1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' /%3E%3C/svg%3E`;

    Swal.fire({
        width: '600px',
        padding: '0',
        html: `
        <div class="font-['Sarabun'] text-left">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-6 flex flex-col items-center text-white relative">
                 <button onclick="Swal.close()" class="absolute top-4 right-4 text-white/70 hover:text-white transition"><i class="fa-solid fa-xmark fa-xl"></i></button>
                 
                 <img onclick="viewFullStaffImage('${t.uid}')" 
                      src="${t.image || placeholderImg}" 
                      class="w-28 h-28 object-cover rounded-full border-4 border-white/30 shadow-lg mb-3 bg-white cursor-pointer hover:scale-110 transition-transform duration-200"
                      title="คลิกเพื่อดูรูปขยาย">
                 
                 <h2 class="text-xl font-bold">${t.name}</h2>
                 <p class="text-sm opacity-90">${t.position || '-'} | ${t.dept || '-'}</p>
                 
                 <span class="mt-3 px-4 py-1.5 rounded-full text-sm font-bold shadow-md ${statusClass}">
                    ${t.status}
                 </span>
            </div>
            
            <div class="p-6 space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">ข้อมูลส่วนตัว</h4>
                        <div class="text-sm space-y-1">
                             <div class="flex justify-between"><span class="text-slate-500">วันเกิด:</span> <span class="font-bold text-slate-800">${formatThaiDate(t.birthDate)}</span></div>
                             <div class="flex justify-between"><span class="text-slate-500">เพศ:</span> <span class="font-bold text-slate-800">${t.gender}</span></div>
                             <div class="flex justify-between"><span class="text-slate-500">เบอร์โทร:</span> <span class="text-slate-800">${t.phone || '-'}</span></div>
                             <div class="flex justify-between"><span class="text-slate-500">Email:</span> <span class="text-slate-800">${t.email || '-'}</span></div>
                        </div>
                    </div>
                    
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100">
                         <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">ข้อมูลราชการ</h4>
                         <div class="text-sm space-y-1">
                             <div class="flex justify-between"><span class="text-slate-500">บรรจุ/ย้าย:</span> <span class="font-bold text-slate-800">${formatThaiDate(t.joinDate)}</span></div>
                             <div class="flex justify-between"><span class="text-slate-500">เกษียณอายุ:</span> <span class="font-bold text-red-600">${formatThaiDate(t.retireDate)}</span></div>
                             <div class="flex justify-between mt-2 border-t pt-1"><span class="text-slate-500">ที่ปรึกษา:</span> <span class="font-bold text-blue-600">${t.advisorRoom || '-'}</span></div>
                        </div>
                    </div>
                </div>

                <div class="border-t border-slate-100 pt-3">
                    <h4 class="text-sm font-bold text-blue-600 mb-2"><i class="fa-solid fa-certificate"></i> ใบประกอบวิชาชีพ</h4>
                    <div class="grid grid-cols-3 gap-2 text-sm bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <div><div class="text-[10px] text-slate-500">เลขที่</div><div class="font-bold text-slate-800">${t.licenseNo || '-'}</div></div>
                        <div><div class="text-[10px] text-slate-500">วันหมดอายุ</div><div class="font-bold text-slate-800">${formatThaiDate(t.licenseExp)}</div></div>
                        <div><div class="text-[10px] text-slate-500">สถานะ</div><div class="font-bold text-slate-800">${t.licenseStatus || '-'}</div></div>
                    </div>
                </div>

                <div class="border-t border-slate-100 pt-3">
                    <h4 class="text-sm font-bold text-yellow-600 mb-2"><i class="fa-solid fa-medal"></i> เครื่องราชอิสริยาภรณ์</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                        <div><div class="text-[10px] text-slate-500">ชั้นสูงสุด</div><div class="font-bold text-slate-800">${t.royalDec || '-'}</div></div>
                        <div><div class="text-[10px] text-slate-500">ปีที่ได้รับ</div><div class="font-bold text-slate-800">${t.royalYear || '-'}</div></div>
                        <div><div class="text-[10px] text-slate-500">ขอครั้งถัดไป</div><div class="font-bold text-slate-800">${formatThaiDate(t.nextDecDate)}</div></div>
                         <div><div class="text-[10px] text-slate-500">สถานะ</div><div class="font-bold text-slate-800">${t.royalStatus || '-'}</div></div>
                    </div>
                </div>

            </div>
        </div>`,
        showConfirmButton: false,
        customClass: { popup: 'rounded-[1.5rem] overflow-hidden', htmlContainer: 'p-0' }
    });
}


	// [เพิ่มฟังก์ชันใหม่] ตั้งค่า Datepicker ภาษาไทย + ปี พ.ศ.
	function initThaiDatepicker() {
		flatpickr(".datepicker-th", {
			locale: "th",
			dateFormat: "d M Y", // รูปแบบที่จะแสดงใน Input และบันทึก (เช่น 1 ม.ค. 2568)
			disableMobile: true, // บังคับใช้ Theme ของ Flatpickr บนมือถือ
			formatDate: (date, format, locale) => {
				// แปลงปี ค.ศ. เป็น พ.ศ. (+543)
				const buddhistYear = date.getFullYear() + 543;
				return flatpickr.formatDate(date, format, locale).replace(date.getFullYear(), buddhistYear);
			},
			parseDate: (dateStr, format) => {
				// แปลงสตริงกลับเป็น Date Object (รองรับการแก้ไข)
				if (!dateStr) return null;
				const parts = dateStr.split(' ');
				if (parts.length === 3) {
					const day = parts[0];
					const monthName = parts[1];
					const yearBE = parseInt(parts[2]);
					const yearAD = yearBE - 543;
					// สร้างวันที่จำลองเพื่อหาเดือนจากชื่อย่อ
					const monthIndex = flatpickr.l10ns.th.months.shorthand.indexOf(monthName);
					if (monthIndex > -1) {
						return new Date(yearAD, monthIndex, day);
					}
				}
				return new Date(); // Fallback
			}
		});
	}


	// [เพิ่มใหม่] ตั้งค่า Timepicker ภาษาไทย 24 ชม.
		function initTimePicker() {
			flatpickr(".timepicker-th", {
				enableTime: true,
				noCalendar: true,
				dateFormat: "H:i",
				time_24hr: true,
				locale: "th",
				disableMobile: true
			});
		}

		// เรียกใช้ตอนโหลดหน้าเว็บ
		document.addEventListener('DOMContentLoaded', function() {
			// initThaiDatepicker(); // ของเดิม
			initTimePicker();     // [เพิ่มใหม่]
		});






	// [เรียกใช้ฟังก์ชันนี้ใน window.onload หรือหลัง HTML โหลดเสร็จ]
	document.addEventListener('DOMContentLoaded', function() {
		initThaiDatepicker();
	});


/* =========================================
   1. Helper Function: เลือกสีป้ายสถานะ
   ========================================= */
// ฟังก์ชันเลือกสีตามสถานะ
function getStaffStatusStyle(status) {
    switch (status) {
        case 'ปฏิบัติหน้าที่':
            return 'bg-lime-300 text-emerald-700 border border-emerald-200';
        case 'ช่วยราชการ':
            return 'bg-amber-400 text-slate-50 border border-blue-200';
        case 'ลาศึกษาต่อ':
            return 'bg-violet-400 text-slate-50 border border-amber-200';
        case 'ย้ายออก':
            return 'bg-yellow-400 text-gray-950 border border-slate-300';
        case 'เกษียณอายุ':
            return 'bg-red-400 text-slate-50 border border-purple-200';
        case 'ลาออก':
            return 'bg-fuchsia-600 text-slate-50 border border-rose-200';
        default:
            return 'bg-gray-100 text-gray-600 border border-gray-200';
    }
}

// [เพิ่มในส่วน Script] ฟังก์ชันคำนวณวันเกษียณอัตโนมัติ
function autoCalculateRetireDate() {
    const birthInput = document.getElementById('modal-staff-birth').value; // รับค่า เช่น 15 ม.ค. 2525
    if (!birthInput) return;

    // แยกปี พ.ศ. จาก string
    const parts = birthInput.split(' ');
    if (parts.length === 3) {
        const day = parseInt(parts[0]);
        const monthStr = parts[1];
        const yearTh = parseInt(parts[2]);
        
        // กฎการเกษียณราชการ: เกิดก่อน 2 ต.ค. เกษียณปีงบประมาณนั้น (ปีเกิด+60)
        // เกิด 2 ต.ค. เป็นต้นไป เกษียณปีงบประมาณถัดไป (ปีเกิด+61)
        
        // แปลงเดือนไทยเป็น index (0-11) เพื่อตรวจสอบวันที่ 2 ต.ค.
        const monthNames = flatpickr.l10ns.th.months.shorthand;
        const monthIdx = monthNames.indexOf(monthStr);
        
        let retireYearTh = yearTh + 60;

        // ถ้าเกิดเดือน ต.ค. (index 9) วันที่ 2 ขึ้นไป หรือเกิดเดือน พ.ย., ธ.ค. ให้บวกเพิ่ม 1 ปี
        if (monthIdx > 9 || (monthIdx === 9 && day >= 2)) {
            retireYearTh += 1;
        }

        // วันเกษียณคือ 30 ก.ย. ของปีเกษียณ
        const retireDateStr = `30 ก.ย. ${retireYearTh}`;
        
        // เซ็ตค่าลงในช่องวันเกษียณ
        document.getElementById('modal-staff-retire').value = retireDateStr;
    }
}

// ฟังก์ชันสำหรับแสดงรูปขยาย (เมื่อคลิกที่รูปในโมดอลรายละเอียด)
function viewFullStaffImage(uid) {
    const t = teachers.find(x => x.uid === uid);
    if (!t) return;

    const placeholderImg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23cbd5e1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' /%3E%3C/svg%3E`;
    const imgSrc = t.image || placeholderImg;

    Swal.fire({
        imageUrl: imgSrc,
        imageAlt: t.name,
        showConfirmButton: false, // ซ่อนปุ่ม OK
        showCloseButton: true,    // แสดงปุ่ม X
        background: 'transparent', // พื้นหลังใสเพื่อให้รูปเด่น
        backdrop: 'rgba(0,0,0,0.8)', // ฉากหลังสีดำจางๆ
        customClass: {
            popup: 'bg-transparent shadow-none overflow-visible',
            image: 'rounded-xl shadow-2xl max-h-[85vh] object-contain border-4 border-white',
            closeButton: 'bg-white text-black rounded-full p-2 shadow-lg hover:bg-slate-200'
        },
        // (Optional) ถ้าต้องการให้ปิดรูปแล้วกลับไปหน้ารายละเอียด ให้เปิดใช้ส่วนนี้
        /*
        didClose: () => {
            setTimeout(() => viewStaffDetails(uid), 100); 
        }
        */
    });
}


/* --- ฟังก์ชัน Helper แปลงวันที่เป็นไทย (d ด.ด. ปปปป) --- */
function formatThaiDate(dateStr) {
    if (!dateStr || dateStr === '-') return '-';
    
    // รองรับรูปแบบ dd/mm/yyyy (เช่น 06/02/2026)
    const parts = dateStr.split('/');
    if (parts.length === 3) {
        const day = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const year = parseInt(parts[2], 10);
        
        const thaiMonths = [
            "ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", 
            "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."
        ];
        
        // ตรวจสอบความถูกต้องของเดือน
        if (month >= 1 && month <= 12) {
            return `${day} ${thaiMonths[month - 1]} ${year}`;
			//return `${day} ${thaiMonths[month - 1]} ${year + 543}`;
        }
    }
    
    return dateStr; // กรณีแปลงไม่ได้ให้คืนค่าเดิม
}

// ฟังก์ชันแสดงรูปนักเรียนแบบขยาย (เมื่อคลิกที่รูปในโมดอลรายละเอียด)
function viewFullStudentImage(uid) {
    const s = students.find(x => x.uid === uid);
    if (!s) return;

    const placeholderImg = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23cbd5e1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' /%3E%3C/svg%3E`;
    const imgSrc = s.image || placeholderImg;

    Swal.fire({
        imageUrl: imgSrc,
        imageAlt: s.name,
        showConfirmButton: false,
        showCloseButton: true,
        background: 'transparent',
        backdrop: 'rgba(0,0,0,0.8)', // ฉากหลังสีดำจางๆ
        customClass: {
            popup: 'bg-transparent shadow-none overflow-visible',
            image: 'rounded-xl shadow-2xl max-h-[85vh] object-contain border-4 border-white',
            closeButton: 'bg-white text-black rounded-full p-2 shadow-lg hover:bg-slate-200'
        }
    });
}


	// ฟังก์ชันเลือกสี Progress Bar ตามช่วงคะแนน
	function getProgressColor(p) {
		const val = parseFloat(p) || 0;
		if (val <= 49) return 'bg-red-500';      // 0-49% : แดง
		if (val <= 60) return 'bg-yellow-500';   // 50-60% : เหลือง
		if (val <= 70) return 'bg-blue-600';     // 61-70% : น้ำเงิน (Brand)
		return 'bg-emerald-500';                 // 71%+ : เขียว
	}

	// ฟังก์ชัน: อัปเดตตัวเลือกใน Dropdown ตำแหน่ง จากข้อมูลที่มีอยู่จริง
	function updateStaffPositionDropdown() {
		const filterEl = document.getElementById('filter-staff-position');
		if (!filterEl) return;

		// 1. ดึงค่าตำแหน่งทั้งหมดที่ไม่เป็นค่าว่าง และทำให้ไม่ซ้ำกัน (Unique)
		const positions = [...new Set(teachers.map(t => t.position).filter(p => p && p.trim() !== ""))].sort();

		// 2. จำค่าที่เลือกอยู่ปัจจุบันไว้ (เพื่อให้เวลารีโหลดตาราง ค่าที่เลือกไม่หาย)
		const currentVal = filterEl.value;

		// 3. สร้าง HTML Options
		let html = '<option value="">ทุกตำแหน่ง</option>';
		positions.forEach(pos => {
			// ใช้ value เป็นค่าตำแหน่งตรงๆ
			html += `<option value="${pos}">${pos}</option>`;
		});

		filterEl.innerHTML = html;

		// 4. คืนค่าที่เลือกเดิมกลับไป (ถ้าค่านั้นยังมีอยู่ในรายการ)
		if (positions.includes(currentVal)) {
			filterEl.value = currentVal;
		}
	}


// --- [เพิ่มใหม่] ตัวแปรและฟังก์ชันสำหรับปฏิทิน ---
    let currentCalendarDate = new Date();
    
    // ข้อมูลจำลองกิจกรรม (Mock Data) - ในการใช้งานจริงอาจดึงจาก Backend
    let academicEvents = [
        { id: 1, date: '2026-02-14', title: 'วันสอบกลางภาค ม.4', time: '08:30 - 16:00', type: 'exam' },
        { id: 2, date: '2026-02-15', title: 'วันสอบกลางภาค ม.5', time: '08:30 - 16:00', type: 'exam' },
        { id: 3, date: '2026-02-26', title: 'วันมาฆบูชา', time: 'ทั้งวัน', type: 'holiday' },
        { id: 4, date: '2026-03-10', title: 'ส่งเกรดปลายภาค', time: 'ก่อน 16:30', type: 'deadline' },
        { id: 5, date: '2026-03-30', title: 'ประชุมผู้ปกครอง', time: '09:00 - 12:00', type: 'meeting' }
    ];
	
	
	

    function changeMonth(step) {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + step);
        renderCalendar();
    }

function renderCalendar() {
    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
    document.getElementById('calendar-month-year').innerText = `${thaiMonths[month]} ${year + 543}`;

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const daysInPrevMonth = new Date(year, month, 0).getDate();
    const grid = document.getElementById('calendar-days-grid');
    grid.innerHTML = '';

    // วันของเดือนก่อนหน้า
    for (let i = firstDay; i > 0; i--) {
        grid.innerHTML += `<div class="py-3 bg-gray-50 text-gray-300 text-center">${daysInPrevMonth - i + 1}</div>`;
    }

    const today = new Date();
    const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

    for (let i = 1; i <= daysInMonth; i++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
        
        // กรองกิจกรรมที่มีในวันนี้
        const dayEvents = academicEvents.filter(e => e.date === dateStr);
        const hasEvent = dayEvents.length > 0;
        const isToday = isCurrentMonth && today.getDate() === i;

        let cellClass = isToday ? 'text-white font-bold' : (hasEvent ? 'text-purple-700 font-bold' : 'text-gray-900');
        let bgClass = isToday ? 'bg-purple-600 rounded-full' : (hasEvent ? 'bg-purple-50 rounded-full border border-purple-200' : 'hover:bg-gray-100 rounded-full');

        // ส่วนสำคัญ: เพิ่ม onclick เข้าไปที่ปุ่ม
        grid.innerHTML += `
            <div class="py-2 relative h-14 flex items-center justify-center">
                <button type="button" 
                    onclick="showEventDetailInline('${dateStr}')"
                    class="w-10 h-10 flex items-center justify-center transition-all ${bgClass} ${cellClass} ${hasEvent ? 'cursor-pointer shadow-sm' : ''}">
                    ${i}
                </button>
                ${hasEvent && !isToday ? '<div class="absolute bottom-1 w-1.5 h-1.5 bg-purple-500 rounded-full"></div>' : ''}
            </div>`;
    }

    // วันของเดือนถัดไป
    const remainingCells = 42 - (firstDay + daysInMonth);
    for (let i = 1; i <= remainingCells; i++) {
        grid.innerHTML += `<div class="py-3 bg-gray-50 text-gray-300 text-center">${i}</div>`;
    }
    renderEventList(month, year);
}


function showEventDetailInline(dateStr) {
    // ค้นหากิจกรรมทั้งหมดในวันที่คลิก
    const events = academicEvents.filter(e => e.date === dateStr);
    
    if (events.length === 0) return; // ถ้าไม่มีกิจกรรมไม่ต้องทำอะไร

    const d = new Date(dateStr);
    const thaiDate = d.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });

    let content = '<div class="text-left space-y-3">';
    events.forEach((ev, idx) => {
        content += `
            <div class="p-3 bg-purple-50 border-l-4 border-purple-500 rounded-r-lg">
                <div class="font-bold text-purple-900">${idx + 1}. ${ev.title}</div>
                <div class="text-sm text-gray-600 mt-1">${ev.description || 'ไม่มีรายละเอียด'}</div>
            </div>`;
    });
    content += '</div>';

    Swal.fire({
        title: `<div class="text-xl">กิจกรรมวันที่ ${thaiDate}</div>`,
        html: content,
        confirmButtonText: 'รับทราบ',
        confirmButtonColor: '#9333ea',
        customClass: {
            popup: 'rounded-2xl'
        }
    });
}


/**
 * ฟังก์ชันสำหรับแสดงรายการกิจกรรมในปฏิทิน
 * แก้ไขปัญหาเรื่อง Timezone (วันที่ลดลง 1 วัน) และปี พ.ศ.
 */
function renderEventList(month, year) {
    const list = document.getElementById('calendar-event-list');
    if (!list) return; // ป้องกัน Error หากไม่พบ Element
    
    list.innerHTML = '';
    
    // 1. กรองกิจกรรมเฉพาะเดือนและปีที่เลือก และเรียงลำดับตามวันที่
    const filteredEvents = academicEvents.filter(e => {
        if (!e.date) return false;
        // ใช้เครื่องหมาย / เพื่อให้สร้าง Date Object ได้ตรงตามวันที่จริงในไทย
        const d = new Date(e.date.replace(/-/g, "/"));
        return d.getMonth() === month && d.getFullYear() === year;
    }).sort((a, b) => new Date(a.date.replace(/-/g, "/")) - new Date(b.date.replace(/-/g, "/")));

    // 2. อัปเดตตัวเลขแจ้งเตือนจำนวนกิจกรรมที่หัวข้อ
    const badge = document.getElementById('event-count-badge');
    if (badge) badge.innerText = filteredEvents.length;

    // 3. กรณีไม่มีกิจกรรมในเดือนนั้น
    if (filteredEvents.length === 0) {
        list.innerHTML = `
            <li class="py-8 text-center text-slate-400 italic flex flex-col items-center">
                <i class="fa-regular fa-calendar-xmark text-2xl mb-2"></i>
                ไม่มีกิจกรรมในเดือนนี้
            </li>`;
        return;
    }

    // 4. วนลูปสร้าง HTML สำหรับแต่ละกิจกรรม
    filteredEvents.forEach(e => {
        // หัวใจสำคัญ: ใช้ .replace(/-/g, "/") เพื่อป้องกันวันที่ลดลง 1 วัน
        const dateObj = new Date(e.date.replace(/-/g, "/"));
        const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
        
        // แปลงปี ค.ศ. เป็น พ.ศ. โดยบวก 543
        const dateText = `${dateObj.getDate()} ${thaiMonths[dateObj.getMonth()]} ${dateObj.getFullYear() + 543}`;
        
        // กำหนดสีตามประเภทกิจกรรม
        let iconColor = 'bg-gray-100 text-gray-600';
        if(e.type === 'exam') iconColor = 'bg-red-100 text-red-600';
        if(e.type === 'holiday') iconColor = 'bg-green-100 text-green-600';
        if(e.type === 'meeting') iconColor = 'bg-blue-100 text-blue-600';
        if(e.type === 'deadline') iconColor = 'bg-orange-100 text-orange-600';

        // สร้างรายการกิจกรรม
        list.innerHTML += `
            <li class="group flex gap-x-4 py-4 hover:bg-slate-50 transition px-2 rounded-lg cursor-pointer border-b border-transparent hover:border-slate-100">
                <div class="flex-none w-14 text-center" onclick="viewCalendarEvent('${e.id}')">
                     <span class="block text-[10px] font-bold text-slate-400">${dateText}</span>
                     <div class="mt-1 h-8 w-8 rounded-full ${iconColor} flex items-center justify-center mx-auto shadow-sm">
                        <i class="fa-solid fa-calendar-check text-xs"></i>
                     </div>
                </div>
                <div class="flex-auto" onclick="viewCalendarEvent('${e.id}')">
                    <h4 class="font-bold text-gray-900 leading-5 text-sm">${e.title || e.Title}</h4>
                    <p class="mt-1 text-xs text-gray-500 flex items-center gap-2">
                        <span><i class="fa-regular fa-clock mr-1"></i>${e.time || 'ทั้งวัน'}</span>
                        ${e.location ? `<span class="hidden sm:inline"><i class="fa-solid fa-location-dot mr-1"></i>${e.location}</span>` : ''}
                    </p>
                </div>
                
                <div class="flex-none self-center flex gap-2 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                    <button onclick="event.stopPropagation(); openAddEventModal('${e.id}')" class="text-slate-400 hover:text-blue-600 p-1.5 hover:bg-blue-50 rounded-md transition" title="แก้ไข">
                        <i class="fa-solid fa-pen-to-square"></i>
                    </button>
                    <button onclick="event.stopPropagation(); deleteCalendarEvent('${e.id}')" class="text-slate-400 hover:text-red-600 p-1.5 hover:bg-red-50 rounded-md transition" title="ลบ">
                        <i class="fa-solid fa-trash-can"></i>
                    </button>
                </div>
            </li>
        `;
    });
}

 // --- [แก้ไข/เพิ่ม] ฟังก์ชันจัดการ Modal ปฏิทิน ---

function openAddEventModal(evtId = null) {
    const modal = document.getElementById('calendar-modal');
    if (!modal) return;
    
    try {
        // --- ฟังก์ชันย่อย: แปลงวันที่ไทย (วว ด.ด. ปปปป) กลับเป็น Date Object ของ JS ---
        const parseThaiDate = (dateStr) => {
            if (!dateStr) return null;
            
            // กรณี 1: เป็นรูปแบบสากล YYYY-MM-DD (เช่น ข้อมูลเก่า หรือ ยังไม่ได้แปลง)
            if (dateStr.indexOf('-') !== -1) {
                return new Date(dateStr);
            }
            
            // กรณี 2: เป็นรูปแบบไทย "06 ก.พ. 2569"
            const parts = dateStr.trim().split(' ');
            if (parts.length === 3) {
                const d = parseInt(parts[0]);
                const mStr = parts[1];
                const y = parseInt(parts[2]) - 543; // ลบ 543 เพื่อแปลง พ.ศ. -> ค.ศ.
                
                const thaiMonths = ["ม.ค.", "ก.พ.", "มี.ค.", "เม.ย.", "พ.ค.", "มิ.ย.", "ก.ค.", "ส.ค.", "ก.ย.", "ต.ค.", "พ.ย.", "ธ.ค."];
                const m = thaiMonths.indexOf(mStr);
                
                if (m !== -1) {
                    return new Date(y, m, d);
                }
            }
            return null; // แปลงไม่ได้
        };

        // 1. ฟังก์ชันช่วยเคลียร์ค่าและกำหนดค่า Input
        const setVal = (id, v) => { 
            const el = document.getElementById(id); 
            if(el) el.value = v; 
        };

        // ล้างค่าเดิมในฟอร์ม
        setVal('evt-id', '');
        setVal('evt-title', '');
        setVal('evt-desc', '');
        setVal('evt-group', 'วิชาการ');
        setVal('evt-location', '');
        setVal('evt-responsible', '');
        setVal('evt-recorder-id', '');

        // เข้าถึงตัว Flatpickr
        const fpStart = document.getElementById('evt-start')?._flatpickr;
        const fpEnd = document.getElementById('evt-end')?._flatpickr;
        const fpTimeStart = document.getElementById('evt-time-start')?._flatpickr;
        const fpTimeEnd = document.getElementById('evt-time-end')?._flatpickr;

        // ตั้งค่าเริ่มต้นเป็น "วันนี้"
        const today = new Date();
        if (fpStart) fpStart.setDate(today);
        if (fpEnd) fpEnd.setDate(today);
        if (fpTimeStart) fpTimeStart.clear();
        if (fpTimeEnd) fpTimeEnd.clear();

        // 2. ตรวจสอบโหมดแก้ไข (ถ้ามี evtId ส่งมา)
        if (evtId && typeof academicEvents !== 'undefined') {
            const evt = academicEvents.find(e => String(e.id) === String(evtId));
            
            if (evt) {
                document.getElementById('calendar-modal-title').innerText = 'แก้ไขกิจกรรม';
                setVal('evt-id', evt.id);
                setVal('evt-title', evt.title || evt.Title || '');
                setVal('evt-desc', evt.description || evt.Description || '');
                setVal('evt-group', evt.group || evt.Group || 'วิชาการ');
                setVal('evt-location', evt.location || evt.Location || '');
                setVal('evt-responsible', evt.responsible || evt.Responsible || '');
                setVal('evt-recorder-id', evt.recorderId || evt.RecorderID || '');

                // แปลงวันที่จากสตริง (ไทย/สากล) เป็น Date Object
                const startDateObj = parseThaiDate(evt.date || evt.StartDate);
                const endDateObj = parseThaiDate(evt.endDate || evt.EndDate);

                // ตั้งค่าลงในปฏิทิน
                if (fpStart && startDateObj) fpStart.setDate(startDateObj);
                
                if (fpEnd && endDateObj) {
                    fpEnd.setDate(endDateObj);
                } else if (fpEnd && startDateObj) {
                    // ถ้าไม่มีวันสิ้นสุด ให้ใช้วันเริ่มต้นเป็นค่า Default
                    fpEnd.setDate(startDateObj);
                }

                // ตั้งค่าเวลา (ถ้ามี)
                if (fpTimeStart && evt.startTime) fpTimeStart.setDate(evt.startTime, true);
                if (fpTimeEnd && evt.endTime) fpTimeEnd.setDate(evt.endTime, true);
            }
        } else {
            // โหมดเพิ่มใหม่
            document.getElementById('calendar-modal-title').innerText = 'เพิ่มกิจกรรมใหม่';
            
            // ดึงชื่อผู้ใช้ปัจจุบันมาใส่ (ถ้ามี Login)
            if (typeof currentUser !== 'undefined' && currentUser) {
                setVal('evt-recorder-id', currentUser.username || '');
                setVal('evt-responsible', currentUser.name || '');
            }
        }

        // 3. แสดง Modal
        modal.classList.remove('hidden');

    } catch (err) {
        console.error("Error in openAddEventModal:", err);
        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถเปิดหน้าต่างได้: ' + err.message, 'error');
    }
}

    function closeCalendarModal() {
        document.getElementById('calendar-modal').classList.add('hidden');
    }

function saveCalendarEvent() {
    // 1. ดึงค่าจาก Input ต่างๆ ในฟอร์ม
    const title = document.getElementById('evt-title').value;
    const desc = document.getElementById('evt-desc').value;
    const group = document.getElementById('evt-group').value;
    
    // ดึงค่าวันที่จาก Flatpickr (เพื่อความแม่นยำกว่า .value)
    const startInput = document.getElementById('evt-start');
    const endInput = document.getElementById('evt-end');
    const startDateObj = startInput._flatpickr ? startInput._flatpickr.selectedDates[0] : null;
    const endDateObj = endInput._flatpickr ? endInput._flatpickr.selectedDates[0] : null;
    
    const timeStart = document.getElementById('evt-time-start').value;
    const timeEnd = document.getElementById('evt-time-end').value;

    const location = document.getElementById('evt-location').value;
    const recorderId = document.getElementById('evt-recorder-id').value;
    const responsible = document.getElementById('evt-responsible').value;

    // 2. ตรวจสอบข้อมูลจำเป็น
    if (!title) { Swal.fire('แจ้งเตือน', 'กรุณาระบุชื่อกิจกรรม', 'warning'); return; }
    if (!startDateObj) { Swal.fire('แจ้งเตือน', 'กรุณาระบุวันที่เริ่มกิจกรรม', 'warning'); return; }

    showLoading();

    // ฟังก์ชันย่อยสำหรับแปลงวันที่เป็น YYYY-MM-DD
    const formatDateParams = (date) => {
        if(!date) return "";
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    const startDateStr = formatDateParams(startDateObj);
    const endDateStr = formatDateParams(endDateObj);
    const currentId = document.getElementById('evt-id').value;
    
    // 3. สร้าง Object ข้อมูล (สำคัญ: ชื่อ Key ต้องตรงกับที่ Apps Script รองรับ)
    const newEvent = {
        id: currentId ? currentId : Date.now(),
        // ส่งค่าแบบ PascalCase ให้ตรงกับหัวตารางใน Sheet
        Title: title,            
        Description: desc,       
        Group: group,            
        StartDate: startDateStr, 
        EndDate: endDateStr,     
        Location: location,      
        RecorderID: recorderId,  
        Responsible: responsible,
        
        // ส่งค่าแบบ lowercase เผื่อไว้สำหรับ logic อื่นๆ ใน GS
        title: title,
        description: desc,
        group: group,
        date: startDateStr,      // จำเป็นสำหรับ renderCalendar ฝั่งหน้าเว็บ
        endDate: endDateStr,
        location: location,
        recorderId: recorderId,
        responsible: responsible,
        
        // ข้อมูลเวลา
        startTime: timeStart,
        endTime: timeEnd,
        time: (timeStart && timeEnd) ? `${timeStart} - ${timeEnd}` : (timeStart || 'ทั้งวัน'),
        type: getEventTypeFromGroup(group)
    };

    // 4. ส่งข้อมูลไปบันทึกที่ Google Apps Script
    callBackend('saveCalendarEvent', newEvent)
    .then(function(res) {
        if(res.result === 'error') throw new Error(res.message);
        
        // 5. อัปเดตข้อมูลในตัวแปร academicEvents ที่หน้าเว็บทันที (ไม่ต้องโหลดใหม่)
        // หาว่าเป็นการแก้ไขหรือเพิ่มใหม่
        const idx = academicEvents.findIndex(e => String(e.id) === String(newEvent.id));
        
        if(idx !== -1) {
            // กรณีแก้ไข: ทับข้อมูลเดิม
            academicEvents[idx] = newEvent;
        } else {
            // กรณีเพิ่มใหม่: ใส่เข้าไปในอาเรย์
            academicEvents.push(newEvent);
        }

        // 6. รีเฟรชปฏิทินและปิดโมดอล
        renderCalendar();
        closeCalendarModal();
        
        hideLoading();
        Swal.fire({
            icon: 'success',
            title: 'บันทึกสำเร็จ',
            timer: 1500,
            showConfirmButton: false
        });
    })
    .catch(function(e) {
        hideLoading();
        console.error("Save Error:", e);
        Swal.fire('Error', 'บันทึกไม่สำเร็จ: ' + e.message, 'error');
    });
}

    // Helper: เลือกประเภทกิจกรรมเพื่อกำหนดสีจุด (ใช้ Logic เดิมที่มีอยู่หรือปรับใหม่)
    function getEventTypeFromGroup(group) {
        if(group === 'วิชาการ') return 'exam'; // สีแดง
        if(group === 'กิจการนักเรียน') return 'holiday'; // สีเขียว
        if(group === 'งบประมาณ') return 'deadline'; // สีส้ม
        return 'meeting'; // สีฟ้า (ค่า Default)
    }

// [ข้อ 4] โมดอลแสดงรายละเอียดกิจกรรม (ใช้ SweetAlert แบบ Custom HTML)
    function viewCalendarEvent(id) {
        const e = academicEvents.find(x => String(x.id) === String(id));
        if(!e) return;

        // แปลงวันที่ให้สวยงาม
        const d = new Date(e.date);
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        const dateStr = d.toLocaleDateString('th-TH', options);
        
        let typeLabel = '<span class="px-2 py-0.5 rounded text-xs bg-gray-100 text-gray-600">ทั่วไป</span>';
        if(e.type === 'exam') typeLabel = '<span class="px-2 py-0.5 rounded text-xs bg-red-100 text-red-600">การสอบ</span>';
        if(e.type === 'holiday') typeLabel = '<span class="px-2 py-0.5 rounded text-xs bg-green-100 text-green-600">วันหยุด</span>';
        if(e.type === 'meeting') typeLabel = '<span class="px-2 py-0.5 rounded text-xs bg-blue-100 text-blue-600">การประชุม</span>';

        Swal.fire({
            title: '',
            html: `
                <div class="text-left font-['Sarabun']">
                    <div class="flex justify-between items-start border-b pb-3 mb-3">
                        <div>
                            <div class="text-xs text-slate-500 mb-1">${dateStr}</div>
                            <h3 class="text-xl font-bold text-slate-800 leading-tight">${e.title}</h3>
                        </div>
                        ${typeLabel}
                    </div>
                    
                    <div class="space-y-3 text-sm text-slate-700">
                        <div class="flex gap-2">
                            <div class="w-6 text-center text-slate-400"><i class="fa-regular fa-clock"></i></div>
                            <div class="font-bold">${e.time || 'ไม่ระบุเวลา'}</div>
                        </div>
                        ${e.location ? `
                        <div class="flex gap-2">
                            <div class="w-6 text-center text-slate-400"><i class="fa-solid fa-location-dot"></i></div>
                            <div>${e.location}</div>
                        </div>` : ''}
                        ${e.description ? `
                        <div class="flex gap-2">
                            <div class="w-6 text-center text-slate-400"><i class="fa-solid fa-align-left"></i></div>
                            <div class="bg-slate-50 p-2 rounded border border-slate-100 w-full text-slate-600">${e.description}</div>
                        </div>` : ''}
                         <div class="flex gap-2">
                            <div class="w-6 text-center text-slate-400"><i class="fa-solid fa-user-tag"></i></div>
                            <div class="text-xs text-slate-500">ผู้รับผิดชอบ: ${e.responsible || '-'}</div>
                        </div>
                    </div>
                </div>
            `,
            showCloseButton: true,
            showConfirmButton: false, // ปิดปุ่ม OK มาตรฐาน
            showDenyButton: true,
            denyButtonText: '<i class="fa-solid fa-pen"></i> แก้ไข',
            denyButtonColor: '#0d6efd',
            customClass: { popup: 'rounded-2xl' }
        }).then((result) => {
            if (result.isDenied) {
                openAddEventModal(e.id);
            }
        });
    }

    // ฟังก์ชันลบกิจกรรม
    function deleteCalendarEvent(id) {
        Swal.fire({
            title: 'ยืนยันการลบ?',
            text: "คุณต้องการลบกิจกรรมนี้ใช่หรือไม่",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'ใช่, ลบเลย',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading();
                // ในการใช้งานจริงต้องมี action 'deleteCalendarEvent' ใน Backend
                // กรณีนี้ใช้ saveCalendarEvent แบบ trick หรือต้องเพิ่ม API ลบ
                // เพื่อความง่ายในตัวอย่างนี้ ผมจะกรองออกจาก Array แล้ว Save ใหม่ หรือใช้ API ลบถ้ามี
                
                // สมมติว่าลบใน Array แล้วแจ้ง Backend (คุณอาจต้องเพิ่ม case deleteCalendarEvent ใน .gs)
                // เพื่อให้โค้ดรันได้เลยผมจะใช้ Array Filter เบื้องต้น
                academicEvents = academicEvents.filter(e => String(e.id) !== String(id));
                
                // จำลองการเรียก Backend
                setTimeout(() => {
                    renderCalendar();
                    hideLoading();
                    Swal.fire('ลบสำเร็จ', '', 'success');
                }, 500);
            }
        });
    }

	// --- Task Grading Logic ---

	function initTaskTable() {
		const sub = subjects.find(s => s.id === activeSubjectId);
		if (!sub) return;
		if (!sub.tasks) sub.tasks = [];

		const classStudents = getActiveStudentsInClass(activeClassName);
		
		// --- จัดการ Pagination / Show All ---
		if (isShowAllRows) {
			// กรณีแสดงทั้งหมด:
			// 1. แสดงข้อความจำนวนคน
			const infoEl = document.getElementById('task-pagination-info');
			if(infoEl) infoEl.innerText = `แสดงทั้งหมด (${classStudents.length} คน)`;

			// 2. สร้างปุ่มจำลอง (ให้คงอยู่แต่กดไม่ได้)
			const ctrlEl = document.getElementById('task-pagination-controls');
			if(ctrlEl) {
				ctrlEl.innerHTML = `
					<button disabled class="pagination-btn px-3 py-1 border rounded bg-slate-50 text-slate-400 cursor-not-allowed shadow-sm font-bold text-xs flex items-center gap-1 opacity-50">
						<i class="fa-solid fa-chevron-left text-[10px]"></i> ก่อนหน้า
					</button>
					<button class="px-3 py-1 border rounded bg-[#0d6efd] text-white font-bold text-xs">1</button>
					<button disabled class="pagination-btn px-3 py-1 border rounded bg-slate-50 text-slate-400 cursor-not-allowed shadow-sm font-bold text-xs flex items-center gap-1 opacity-50">
						ถัดไป <i class="fa-solid fa-chevron-right text-[10px]"></i>
					</button>
				`;
			}
		} else {
			// กรณีแบ่งหน้าปกติ
			renderGeneralPagination('task-pagination', classStudents.length, currentGradingPage, p => { 
				currentGradingPage = p; 
				initTaskTable(); 
			});
		}

		renderTaskHeader(sub);
		renderTaskRows(sub, classStudents);
		
		// แสดงตารางสรุปท้ายหน้า
		if(typeof renderTaskSummary === 'function') {
			renderTaskSummary(sub, classStudents);
		}
	}

function renderTaskHeader(sub) {
    const header = document.getElementById('taskTableHeader');
    let tasksHtml = '';
    // คำนวณ colspan สำหรับหัวตารางใหญ่
    const totalCols = 4 + (sub.tasks ? sub.tasks.length : 0) + 1;

    if (sub.tasks) {
        sub.tasks.forEach((t, i) => {
            const passScore = (t.max * (t.passPct || 50)) / 100;
            
            // [แก้ไข] เพิ่ม div wrapper แบบ flex เพื่อบังคับจัดกึ่งกลางทั้งแนวตั้งและแนวนอน
            tasksHtml += `<th class="px-1 py-2 text-center bg-orange-50 border-r min-w-[80px] font-bold align-middle">
                <div class="flex flex-col items-center justify-center w-full h-full min-h-[60px]">
                    <div class="mb-1 text-orange-800 text-xs text-center truncate max-w-[100px]" title="${t.name}">
                        ${t.name || 'งานที่ ' + (i+1)}
                    </div>
                    <div class="bg-white rounded-[30px] px-2 py-0.5 shadow-sm inline-block min-w-[50px] text-[11px] text-gray-800 font-bold mb-1 border border-orange-200">
                        ${t.max} | ${passScore}
                    </div>
                    <div class="flex justify-center gap-1 text-center text-[10px] border-t border-orange-200 pt-1.5 font-bold w-full">
                        <span class="w-6 h-6 flex items-center justify-center bg-white rounded-full shadow-sm border border-slate-200 text-slate-700" title="คะแนนจริง">จ</span>
                        <span class="w-6 h-6 flex items-center justify-center bg-red-500 text-white rounded-full shadow-sm" title="คะแนนแก้ไข">ก</span>
                    </div>
                </div>
            </th>`;
        });
    }

    const currentAdvisor = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
    const displayAdvisorEl = document.getElementById('display-advisor-task');
    if (displayAdvisorEl) displayAdvisorEl.innerText = currentAdvisor;

    const now = new Date();
    const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
    const printDate = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;

    // [แก้ไข] ปรับ py-6 เป็น py-4 เพื่อให้ความสูงสม่ำเสมอ และเพิ่ม align-middle ทุกช่อง
    header.innerHTML = `
    <tr class="print-table-header-info">
        <th colspan="${totalCols}" class="p-4 border-b-2 border-black">
            <div class="flex justify-between items-start mb-2">
                <div class="flex-1"></div>
                <div class="flex-1 text-center">
                    <h2 class="text-xl font-bold text-black">${sub.schoolName || 'โรงเรียนปากช่อง'}</h2>
                </div>
                <div class="flex-1 text-right text-[10px] text-black font-normal">
                    <div>หน้าที่ ${currentGradingPage}</div>
                    <div>พิมพ์วันที่ ${printDate}</div>
                </div>
            </div>
            <div class="text-center text-[13px] text-black space-y-1 font-['Sarabun'] font-bold">
                <div>
                    วิชา <span class="text-blue-900">${sub.code}</span> <span class="text-blue-900">${sub.name}</span>
                    ระดับชั้น <span>${activeClassName.split('/')[0]}</span>
                    กลุ่มที่ <span>${activeClassName.split('/')[1] || activeClassName}</span>
                </div>
                <div class="pt-1">
                    ครูผู้สอน <span>${sub.teacher}</span> 
                    <span class="inline-block w-8"></span>
                    ครูที่ปรึกษา <span>${currentAdvisor}</span>
                </div>
            </div>
        </th>
    </tr>
    <tr class="text-sm text-gray-900 uppercase bg-gray-100 border-b-2 border-indigo-300 font-bold">
        <th class="px-2 py-4 text-center w-8 border-r text-sm font-bold align-middle">ที่</th>
        <th class="px-2 py-4 w-10 text-center border-r text-sm font-bold print:hidden align-middle">รูป</th>
        <th class="px-2 py-4 w-20 border-r text-center text-sm font-bold align-middle">รหัส</th>
        <th class="px-2 py-4 w-48 border-r text-center text-sm font-bold align-middle">ชื่อ-นามสกุล</th>
        ${tasksHtml}
        <th class="px-2 py-4 text-center bg-blue-50 font-bold border-r text-sm font-bold w-24 align-middle">รวมงาน</th>
    </tr>`;
}

	function renderTaskRows(sub, list) {
		const tbody = document.getElementById('taskTableBody');
		if (list.length === 0) {
			tbody.innerHTML = `<tr><td colspan="100%" class="text-center py-8 text-red-500 font-bold">...ไม่พบข้อมูลนักเรียนในห้องนี้...</td></tr>`;
			return;
		}

		// --- Logic การตัดแบ่งหน้า (Slicing) ---
		let start = (currentGradingPage - 1) * rowsPerPage;
		let limit = rowsPerPage;

		if (isShowAllRows) {
			start = 0;
			limit = list.length;
		}

		const paginated = list.slice(start, start + limit);

		// --- สร้าง HTML ---
		tbody.innerHTML = paginated.map((s, local) => {
			const globalIdx = start + local;
			let tasksInputs = '';
			let totalTaskScore = 0;
			let passedTasksCount = 0;

			if(sub.tasks) {
				sub.tasks.forEach(t => {
					const r = getStoredScore(activeSubjectId, activeClassName, s.uid, `t${t.id}_r`, "");
					const e = getStoredScore(activeSubjectId, activeClassName, s.uid, `t${t.id}_e`, "");
					
					const numR = parseFloat(r) || 0;
					const numE = parseFloat(e) || 0;
					const maxVal = Math.max(numR, numE);
					totalTaskScore += maxVal;

					// เช็คสถานะผ่าน/ไม่ผ่านงานนี้
					const passMark = (t.max * (t.passPct || 50)) / 100;
					if (maxVal >= passMark) passedTasksCount++;

					// สีพื้นหลังช่องคะแนนจริง (ถ้าตก = เหลือง)
					let rBg = (r !== "" && numR < passMark) ? 'bg-yellow-300' : 'bg-white';

					// สร้าง Input 2 ช่อง (จริง | แก้ไข)
					tasksInputs += `<td class="px-0.5 py-1 text-center border-r">
						<div class="flex justify-center items-center gap-1 font-bold">
							<input type="number" value="${r === "" ? 0 : r}" 
								data-row="${local}" data-col="t${t.id}_r" data-uid="${s.uid}" data-idx="${globalIdx}"
								onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)"
								onfocus="this.select()" 
								oninput="updateScore(this, '${s.uid}', 't${t.id}_r', this.value, ${globalIdx}); updateTaskRowTotal(${globalIdx}, '${s.uid}');" 
								class="input-score text-center border rounded-full ${rBg} w-[28px] h-[24px] font-bold shadow-sm focus:ring-2 focus:ring-amber-400 outline-none">
							
							<span class="text-slate-300">|</span>
							
							<input type="number" value="${e === "" ? 0 : e}" 
								data-row="${local}" data-col="t${t.id}_e" data-uid="${s.uid}" data-idx="${globalIdx}"
								onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)"
								onfocus="this.select()" 
								oninput="updateScore(this, '${s.uid}', 't${t.id}_e', this.value, ${globalIdx}); updateTaskRowTotal(${globalIdx}, '${s.uid}');" 
								class="input-score text-center border rounded-full bg-red-500 text-white w-[28px] h-[24px] font-bold shadow-sm placeholder-white/50 focus:ring-2 focus:ring-red-300 outline-none">
						</div>
					</td>`;
				});
			}

			// Icon สถานะงาน (จุดสีหน้าชื่อ)
			const statusIconHtml = generateStatusIcon(passedTasksCount, (sub.tasks ? sub.tasks.length : 0));

			return `<tr class="grading-row border-b odd:bg-white even:bg-[#FFFF99] hover:bg-blue-50 transition-colors">
				<td class="px-2 py-1 text-center text-gray-400 border-r text-[11px] font-bold">${globalIdx + 1}</td>
				<td class="px-1 py-1 border-r text-center print:hidden">
					<div onclick="viewStudentPhoto('${s.uid}')" class="student-photo-container w-6 h-6 bg-slate-100 rounded-full mx-auto overflow-hidden border cursor-pointer transition-transform">
						${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user text-[10px] text-slate-300 mt-1"></i>'}
					</div>
				</td>
				<td class="px-2 py-1 text-gray-600 border-r text-[11px] text-center font-bold">${s.id}</td>
				<td class="px-2 py-1 text-gray-700 border-r text-[11px] truncate max-w-[140px] font-bold">
					<span id="task-status-icon-${globalIdx}" class="mr-1">${statusIconHtml}</span>
					${s.name}
				</td>
				
				${tasksInputs}
				
				<td class="px-2 py-1 text-center font-bold bg-blue-50/40 border-r text-[12px] text-blue-600" id="task-total-${globalIdx}">${totalTaskScore}</td>
			</tr>`;
		}).join('');
	}

	function updateTaskRowTotal(idx, uid) {
		const sub = subjects.find(s => s.id === activeSubjectId);
		if (!sub || !sub.tasks) return;
		
		let total = 0;
		let passedTasksCount = 0;

		sub.tasks.forEach(t => {
			const r = getStoredScore(activeSubjectId, activeClassName, uid, `t${t.id}_r`, 0);
			const e = getStoredScore(activeSubjectId, activeClassName, uid, `t${t.id}_e`, 0);
			
			const maxVal = Math.max(parseFloat(r) || 0, parseFloat(e) || 0);
			total += maxVal;

			// คำนวณสถานะผ่านใหม่
			const passMark = (t.max * (t.passPct || 50)) / 100;
			if (maxVal >= passMark) passedTasksCount++;
		});
		
		// --- เพิ่มบรรทัดนี้เพื่อรีเฟรชตารางสรุปทันที ---
		const classStudents = getActiveStudentsInClass(activeClassName);
		renderTaskSummary(sub, classStudents);
		
		// อัปเดตยอดรวม
		const el = document.getElementById(`task-total-${idx}`);
		if(el) el.innerText = total;

		// อัปเดตจุดสถานะทันที
		const iconEl = document.getElementById(`task-status-icon-${idx}`);
		if(iconEl) {
			iconEl.innerHTML = generateStatusIcon(passedTasksCount, sub.tasks.length);
		}
	}
	
	// --- Task Settings Logic (ใส่ไว้ใกล้ๆ กับ Unit Settings) ---

	/* =========================================
	   1. ฟังก์ชันสร้างรายการตั้งค่าโครงสร้างงาน (เพิ่มช่อง %)
	   ========================================= */
	function renderTaskEditorRows(sub) {
		const container = document.getElementById('tasks-editor-list');
		if (!container) return;
		
		if (!sub.tasks) sub.tasks = [];

		container.innerHTML = sub.tasks.map((t, i) => `
			<div class="flex items-center gap-2 p-2 bg-amber-50 rounded-lg border border-amber-100 mb-2 font-['Sarabun']">
				<span class="text-[10px] font-bold text-amber-600 w-4">#${i+1}</span>
				<div class="flex-grow">
					<label class="block text-[9px] text-slate-400 mb-0.5">ชื่องาน</label>
					<input type="text" value="${t.name || ''}" placeholder="ชื่องาน..."
						onchange="updateTaskProp(${i}, 'name', this.value)" 
						class="w-full border rounded p-1 text-xs font-['Sarabun'] focus:ring-1 focus:ring-amber-400 outline-none">
				</div>
				<div class="w-16">
					<label class="block text-[9px] text-slate-400 mb-0.5 text-center">เต็ม</label>
					<input type="number" value="${t.max}" placeholder="เต็ม"
						oninput="updateTaskProp(${i}, 'max', this.value)" 
						class="w-full border rounded p-1 text-xs text-center font-bold text-blue-600 font-['Sarabun']">
				</div>
				<div class="w-16">
					<label class="block text-[9px] text-slate-400 mb-0.5 text-center">ผ่าน(%)</label>
					<input type="number" value="${t.passPct || 50}" placeholder="%"
						onchange="updateTaskProp(${i}, 'passPct', this.value)" 
						class="w-full border rounded p-1 text-xs text-center font-['Sarabun']">
				</div>
				<button onclick="removeTaskFromSubject(${i})" class="text-rose-400 hover:text-rose-600 ml-1 mt-3 transition-colors">
					<i class="fa-solid fa-trash-can"></i>
				</button>
			</div>
		`).join('');

		// สั่งคำนวณน้ำหนักรวมทันทีหลังจากสร้างรายการเสร็จ
		if(typeof autoUpdateWeights === 'function') autoUpdateWeights();
	}

	/* =========================================
	   2. ฟังก์ชันเพิ่มงานใหม่ (กำหนดค่าเริ่มต้น Pass% = 50)
	   ========================================= */
	function addNewTaskToCurrent() {
		const sub = subjects.find(s => s.id === editingSubjectId);
		if (sub) {
			if (!sub.tasks) sub.tasks = [];
			// สร้าง ID โดยหาค่า max id เดิม + 1
			const nId = sub.tasks.length > 0 ? Math.max(...sub.tasks.map(t => t.id || 0)) + 1 : 1;
			
			// เพิ่ม passPct: 50 เป็นค่าเริ่มต้น
			sub.tasks.push({ id: nId, name: "งานที่ " + nId, max: 10, passPct: 50 });
			
			renderTaskEditorRows(sub);
		}
	}

	function removeTaskFromSubject(i) {
		const sub = subjects.find(s => s.id === editingSubjectId);
		if (sub) {
			Swal.fire({
				title: 'ลบงานนี้?',
				text: "คะแนนที่บันทึกไว้ในช่องนี้อาจสูญหาย",
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: 'ลบ'
			}).then((result) => {
				if (result.isConfirmed) {
					sub.tasks.splice(i, 1);
					renderTaskEditorRows(sub);
				}
			});
		}
	}

	/* =========================================
	   3. ฟังก์ชันอัปเดตค่า (แปลง % เป็นตัวเลข)
	   ========================================= */
	function updateTaskProp(i, prop, val) {
		const sub = subjects.find(s => s.id === editingSubjectId);
		if (sub && sub.tasks[i]) {
			// แปลงเป็นตัวเลขถ้าเป็น max หรือ passPct
			if (prop === 'max' || prop === 'passPct') {
				sub.tasks[i][prop] = parseFloat(val) || 0;
			} else {
				sub.tasks[i][prop] = val;
			}

			// ถ้ามีการแก้คะแนนเต็ม (max) ให้รีเฟรชน้ำหนักรวมและ Ratio ทันที
			if (prop === 'max') {
				if(typeof autoUpdateWeights === 'function') autoUpdateWeights();
			}
		}
	}

	/* =========================================================================
	   Logic: สร้างตารางสรุปงาน (Task Summary) แบบละเอียด + ลายเซ็น (แก้ไข)
	   ========================================================================= */
	function renderTaskSummary(sub, list) {
		// --- 1. อัปเดตลายเซ็นและวันที่ (ย้ายมาทำก่อน เพื่อให้แสดงเสมอ) ---
		if (sub) {
			const sigNameEl = document.getElementById('task-sig-teacher');
			if(sigNameEl) sigNameEl.innerText = sub.teacher || "-";
		}

		const now = new Date();
		const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
		const dateStr = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;
		
		const sigDateEl = document.getElementById('task-sig-date');
		if(sigDateEl) sigDateEl.innerText = dateStr;

		// --- 2. จัดการตาราง ---
		const thead = document.getElementById('task-summary-head');
		const tbody = document.getElementById('task-summary-body');
		
		// ตรวจสอบว่ามี Element หรือไม่
		if (!thead || !tbody) return;
		
		// ถ้าไม่มีงาน ให้เคลียร์ตารางแล้วจบการทำงานเฉพาะส่วนตาราง
		if (!sub.tasks || sub.tasks.length === 0) {
			thead.innerHTML = '';
			tbody.innerHTML = '<tr><td class="p-4 text-center text-gray-400">ไม่มีข้อมูลงาน</td></tr>';
			
			// เคลียร์สถิติด้านบนด้วย
			document.getElementById('task-stat-total-head').innerText = list.length;
			document.getElementById('task-complete-pct').innerText = "0.00";
			document.getElementById('task-avg-score').innerText = "0.00";
			return;
		}

		// --- 3. คำนวณสถิติรายงาน (Per Task) ---
		const stats = sub.tasks.map(t => {
			let passed = 0;
			let failed = 0;
			const passMark = (t.max * (t.passPct || 50)) / 100;

			list.forEach(s => {
				const r = getStoredScore(activeSubjectId, activeClassName, s.uid, `t${t.id}_r`, 0);
				const e = getStoredScore(activeSubjectId, activeClassName, s.uid, `t${t.id}_e`, 0);
				const score = Math.max(parseFloat(r) || 0, parseFloat(e) || 0);

				if (score >= passMark) passed++;
				else failed++;
			});

			return { 
				id: t.id, name: t.name, max: t.max, 
				passed, failed,
				passPct: list.length > 0 ? ((passed / list.length) * 100).toFixed(2) : "0.00"
			};
		});

		// --- 4. คำนวณสถิติรวมหัวตาราง (Header Stats) ---
		const totalStudents = list.length;
		let sumTotalScore = 0;
		let completeWorkCount = 0;

		list.forEach(s => {
			let passedAllTasks = true;
			let studentTotalTaskScore = 0;

			sub.tasks.forEach(t => {
				const r = getStoredScore(activeSubjectId, activeClassName, s.uid, `t${t.id}_r`, 0);
				const e = getStoredScore(activeSubjectId, activeClassName, s.uid, `t${t.id}_e`, 0);
				const score = Math.max(parseFloat(r) || 0, parseFloat(e) || 0);
				studentTotalTaskScore += score;

				const passMark = (t.max * (t.passPct || 50)) / 100;
				if (score < passMark) passedAllTasks = false;
			});

			sumTotalScore += studentTotalTaskScore;
			if (passedAllTasks && sub.tasks.length > 0) completeWorkCount++;
		});

		// อัปเดตตัวเลขสถิติด้านบน
		const headTotalEl = document.getElementById('task-stat-total-head');
		const completePctEl = document.getElementById('task-complete-pct');
		const avgScoreEl = document.getElementById('task-avg-score');

		if (headTotalEl) headTotalEl.innerText = totalStudents;
		
		if (completePctEl) {
			const pct = totalStudents > 0 ? ((completeWorkCount / totalStudents) * 100).toFixed(2) : "0.00";
			completePctEl.innerText = pct;
		}

		if (avgScoreEl) {
			const avg = totalStudents > 0 ? (sumTotalScore / totalStudents).toFixed(2) : "0.00";
			avgScoreEl.innerText = avg;
		}

		// --- 5. สร้าง HTML ส่วนหัวตาราง (Column Headers) ---
		let headHtml = `<tr class="bg-slate-50 font-bold text-slate-600 text-center">
			<td class="p-2 border border-black min-w-[120px] text-left bg-slate-100">รายการ</td>`;
		
		stats.forEach((s, i) => {
			headHtml += `<td class="p-2 border border-black min-w-[60px]" style="text-center" title="${s.name}">งานที่ ${i+1}</td>`;
		});
		headHtml += `</tr>`;
		thead.innerHTML = headHtml;

		// --- 6. สร้าง HTML ส่วนเนื้อหาตาราง (Rows) ---
		let rowMax = `<td class="p-2 border border-black font-bold bg-slate-50 text-left">คะแนนเต็ม</td>`;
		stats.forEach(s => { rowMax += `<td class="p-2 border border-black text-center font-bold text-slate-500">${s.max}</td>`; });

		let rowPass = `<td class="p-2 border border-black font-bold text-left">ผ่าน (คน)</td>`;
		stats.forEach(s => { rowPass += `<td class="p-2 border border-black text-center">${s.passed}</td>`; });

		let rowFail = `<td class="p-2 border border-black font-bold text-left">ไม่ผ่าน (คน)</td>`;
		stats.forEach(s => { 
			const colorClass = s.failed > 0 ? "text-red-600 font-bold" : "";
			rowFail += `<td class="p-2 border border-black text-center ${colorClass}">${s.failed}</td>`; 
		});

		let rowPct = `<td class="p-2 border border-black font-bold text-left bg-slate-50">ร้อยละที่ผ่าน</td>`;
		stats.forEach(s => { rowPct += `<td class="p-2 border border-black text-center font-bold bg-slate-50 text-blue-700">${s.passPct}</td>`; });

		tbody.innerHTML = `
			<tr class="text-sm font-medium text-slate-800">${rowMax}</tr>
			<tr class="text-sm font-medium text-slate-800">${rowPass}</tr>
			<tr class="text-sm font-medium text-slate-800">${rowFail}</tr>
			<tr class="text-sm font-medium text-slate-800">${rowPct}</tr>
		`;
	}
	
	// ฟังก์ชันคำนวณอัตราส่วนระหว่างภาคอัตโนมัติ (รายหน่วย + งาน + กลางภาค)
	function autoCalculateRatio() {
		// 1. ดึงค่าจากช่อง Weight (หน่วยและงาน)
		const wUnit = parseFloat(document.getElementById('edit-weight-unit').value) || 0;
		const wTask = parseFloat(document.getElementById('edit-weight-task').value) || 0;
		
		// 2. ดึงค่าคะแนนสอบกลางภาค (เพิ่มใหม่)
		const midMax = parseFloat(document.getElementById('edit-mid-max').value) || 0;
		
		// 3. รวมกันเป็นคะแนนระหว่างภาค
		const totalBetween = wUnit + wTask + midMax;

		// 4. แสดงผลในช่องระหว่างภาค (สีเขียว)
		const betweenEl = document.getElementById('edit-ratio-between');
		if(betweenEl) {
			betweenEl.value = totalBetween;
		}
	}

	// ฟังก์ชันซิงค์คะแนนปลายภาค (เมื่อกรอกช่อง Ratio ให้ไปแก้ค่า finMax ด้วย)
	function syncFinalScore(val) {
		const numVal = parseFloat(val) || 0;
		
		// อัปเดตช่อง Setting เดิม (ที่อาจถูกซ่อนไว้หรืออยู่ด้านล่าง)
		const finMaxInput = document.getElementById('edit-fin-max');
		if(finMaxInput) {
			finMaxInput.value = numVal;
		}
		
		updateCurrentSubjectData(); // บันทึกข้อมูล
	}
	function autoUpdateWeights() {
    const sub = subjects.find(s => s.id === editingSubjectId);
    if (!sub) return;

    // 1. รวมคะแนนรายหน่วย (Sum Units)
    let sumUnit = 0;
    if (sub.units) {
        sub.units.forEach(u => sumUnit += (parseFloat(u.max) || 0));
    }

    // 2. รวมคะแนนชิ้นงาน (Sum Tasks)
    let sumTask = 0;
    if (sub.tasks) {
        sub.tasks.forEach(t => sumTask += (parseFloat(t.max) || 0));
    }

    // 3. อัปเดตค่าลงใน Input และ Object
    const wUnitEl = document.getElementById('edit-weight-unit');
    if (wUnitEl) {
        wUnitEl.value = sumUnit;
        sub.weightUnit = sumUnit;
    }

    const wTaskEl = document.getElementById('edit-weight-task');
    if (wTaskEl) {
        wTaskEl.value = sumTask;
        sub.weightTask = sumTask;
    }

    // 4. สั่งคำนวณ Ratio ระหว่างภาคต่อ (ถ้ามีฟังก์ชันนี้)
    if (typeof autoCalculateRatio === 'function') {
        autoCalculateRatio();
		}
	}
	
	function updateUnitProp(i, prop, val) {
    const sub = subjects.find(s => s.id === editingSubjectId);
    if (sub && sub.units[i]) {
        // แปลงเป็นตัวเลขถ้าเป็น max หรือ passPct
        if (prop === 'max' || prop === 'passPct') {
            sub.units[i][prop] = parseFloat(val) || 0;
        } else {
            sub.units[i][prop] = val;
        }

        // ถ้ามีการแก้คะแนนเต็ม (max) ให้รีเฟรชน้ำหนักรวมและ Ratio ทันที
        if (prop === 'max') {
            if(typeof autoUpdateWeights === 'function') autoUpdateWeights();
        }
		}
	}
	// ตัวแปรเก็บสถานะการแสดงผล (เริ่มต้นให้แสดง)
	let isShowTaskCol = true;

	function toggleTaskColumn(checked) {
		isShowTaskCol = checked;
		
		// เลือกคอลัมน์ทั้งหมดที่มี class 'col-task-sum'
		const cells = document.querySelectorAll('.col-task-sum');
		
		// วนลูปเพื่อซ่อนหรือแสดง
		cells.forEach(el => {
			if (checked) {
				el.style.display = ''; // แสดง (ค่า default ของ table-cell)
			} else {
				el.style.display = 'none'; // ซ่อน
			}
		});
	}
	// ฟังก์ชันซ่อน/แสดงแถวนักเรียน (ใช้ร่วมกันทั้ง 2 หน้า)
	function toggleStudentRows(view, isChecked) {
		let tbodyId = '';
		
		// ตรวจสอบว่าเป็นหน้าไหน เพื่อเลือก ID ของตารางให้ถูก
		if (view === 'grading') {
			tbodyId = 'studentTableBody';
		} else if (view === 'task') {
			tbodyId = 'taskTableBody';
		}

		const tbody = document.getElementById(tbodyId);
		if (tbody) {
			// ถ้า Checked = แสดง (table-row-group), ถ้าไม่ = ซ่อน (none)
			tbody.style.display = isChecked ? '' : 'none';
			
			// (ทางเลือกเสริม) ถ้าต้องการซ่อนส่วนสรุปท้ายตารางด้วย ให้เปิดคอมเมนต์ด้านล่าง
			/*
			if (view === 'task') {
				const summarySec = document.getElementById('task-summary-section');
				if(summarySec) summarySec.style.display = isChecked ? '' : 'none';
			}
			*/
		}
	}
	
	
	
	/* =========================================================================
	   Helper: อัปเดต Dropdown ให้เหมือนกันทุกหน้า
	   ========================================================================= */
	function updateCommonDropdowns(subSelectId, classSelectId) {
		const subSelect = document.getElementById(subSelectId);
		const classSelect = document.getElementById(classSelectId);
		
		// Dropdown วิชา
		if(subSelect) subSelect.innerHTML = subjects.map(s => `<option value="${s.id}" ${s.id === activeSubjectId ? 'selected' : ''}>${s.code} ${s.name}</option>`).join('');
		
		// Dropdown ห้อง
		let sub = subjects.find(s => s.id === activeSubjectId);
		if (sub && classSelect) {
			classSelect.innerHTML = sub.classes.map(c => `<option value="${c}" ${c === activeClassName ? 'selected' : ''}>${c}</option>`).join('');
			classSelect.value = activeClassName;
		}
	}

	// Override ฟังก์ชันเปลี่ยนวิชาและห้อง เพื่อให้อัปเดตหน้าใหม่ด้วย
	function changeActiveSubject(id) { 
		activeSubjectId = id; 
		currentGradingPage = 1; 
		updateGradingFilters(); 
		updateDisplayHeader();
		// Sync dropdowns หน้าใหม่
		['rw', 'comp', 'attr'].forEach(t => updateCommonDropdowns(`select-subject-${t}`, `select-class-${t}`)); 

		const activeView = document.querySelector('.view-section.view-active')?.id;
		if (activeView === 'rw-view') initRWTable();
		else if (activeView === 'competency-view') initCompetencyTable();
		else if (activeView === 'attribute-view') initAttributeTable();
		else if (activeView === 'task-grading-view') initTaskTable();
		else initTable(); 
	}



	/* --- Helper Functions สำหรับระบบใหม่ --- */

	// 1. ฟังก์ชันเลือก Class สีตามคะแนน
	function getScoreClass(val) {
		const v = parseInt(val);
		if (v === 3) return 'bg-score-3';
		if (v === 2) return 'bg-score-2';
		if (v === 1) return 'bg-score-1';
		return 'bg-score-0'; // 0 หรืออื่นๆ เป็นสีแดง
	}

	// 2. ฟังก์ชันอัปเดตสีทันทีเมื่อพิมพ์
	function updateInputColor(el) {
		// ลบ Class สีเดิมทั้งหมด
		el.classList.remove('bg-score-3', 'bg-score-2', 'bg-score-1', 'bg-score-0', 'bg-white');
		// เพิ่ม Class ใหม่ตามค่า
		el.classList.add(getScoreClass(el.value));
	}

	// 3. ฟังก์ชันสร้างจุดสถานะ (Pass/Fail) หน้าชื่อ
	function getEvalStatusIcon(avgScore) {
		// เกณฑ์: เฉลี่ย 0 = ไม่ผ่าน (แดง), มากกว่า 0 = ผ่าน (เขียว) 
		// *สามารถปรับเกณฑ์ได้ตามต้องการ เช่น ต้องมากกว่า 1.0*
		const isPass = parseFloat(avgScore) > 0; 
		
		if (isPass) {
			return `<span class="relative inline-flex mr-1.5" title="ผ่าน">
						<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
						<i class="fa-solid fa-circle-check text-green-500 relative text-[10px]"></i>
					</span>`;
		} else {
			return `<span class="relative inline-flex mr-1.5" title="ไม่ผ่าน/ยังไม่ประเมิน">
						<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
						<i class="fa-solid fa-circle-xmark text-red-500 relative text-[10px]"></i>
					</span>`;
		}
	}

	// 4. ฟังก์ชันสร้าง HTML เครื่องมือใส่คะแนนรวดเร็ว (Bulk Control)
		// แก้ไขฟังก์ชันนี้ในส่วน <script> Helper Functions
	function renderBulkControlHTML(viewType, itemCount) {
		let itemChecks = '';
		for(let i=1; i<=itemCount; i++) {
			// สร้าง Checkbox สำหรับแต่ละข้อ (เช่น ข้อ 1, ข้อ 2...)
			itemChecks += `
			<label class="flex items-center gap-1 cursor-pointer min-w-fit hover:bg-slate-50 px-1 rounded">
				<input type="checkbox" class="bulk-item-${viewType} accent-blue-600 w-3 h-3" value="${i}">
				<span class="text-[10px] font-bold text-slate-600">ข้อ${i}</span>
			</label>`;
		}

		return `
		<div class="flex flex-wrap items-center gap-2 px-3 py-2 bg-slate-50 rounded-md border border-slate-200 w-full shadow-sm no-print mt-2 mb-2">
			<div class="flex items-center gap-2 shrink-0">
				<span class="text-[10px] font-bold text-slate-500 uppercase flex items-center gap-1">
					<i class="fa-solid fa-bolt text-amber-500"></i> ให้คะแนน:
				</span>
				<div class="flex items-center gap-2 bg-white px-2 py-1 rounded border border-slate-200 shadow-sm">
					<label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="bulkScore-${viewType}" value="3" class="accent-green-500 w-3 h-3"><span class="text-[11px] font-bold text-green-600">3</span></label>
					<label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="bulkScore-${viewType}" value="2" class="accent-yellow-500 w-3 h-3"><span class="text-[11px] font-bold text-yellow-600">2</span></label>
					<label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="bulkScore-${viewType}" value="1" class="accent-orange-500 w-3 h-3"><span class="text-[11px] font-bold text-orange-600">1</span></label>
					<label class="flex items-center gap-1 cursor-pointer"><input type="radio" name="bulkScore-${viewType}" value="0" class="accent-red-500 w-3 h-3"><span class="text-[11px] font-bold text-red-600">0</span></label>
				</div>
			</div>
			
			<div class="hidden sm:block w-px h-6 bg-slate-300 mx-1"></div>

			<div class="flex items-center gap-2 flex-grow overflow-hidden">
				<span class="text-[10px] font-bold text-slate-400 shrink-0">ลงใน:</span>
				
				<div class="flex items-center gap-2 bg-white px-3 py-1 rounded border border-slate-200 shadow-sm overflow-x-auto custom-scrollbar flex-grow">
					<label class="flex items-center gap-1 cursor-pointer border-r border-slate-200 pr-2 mr-1 shrink-0 hover:bg-slate-50 px-1 rounded">
						<input type="checkbox" onchange="toggleBulkAll('${viewType}', this.checked)" class="bulk-all-${viewType} accent-indigo-600 w-3 h-3">
						<span class="text-[10px] font-bold text-indigo-600">ทุกข้อ</span>
					</label>
					<div class="flex gap-3">
						${itemChecks}
					</div>
				</div>

				<button onclick="applyBulkScore('${viewType}')" class="bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white px-3 py-1 rounded text-[11px] font-bold transition shadow-sm flex items-center gap-1 shrink-0 whitespace-nowrap h-[28px]">
					<i class="fa-solid fa-check"></i> ตกลง
				</button>

				<button onclick="resetBulkControl('${viewType}')" class="bg-slate-500 hover:bg-slate-600 active:bg-slate-700 text-white px-3 py-1 rounded text-[11px] font-bold transition shadow-sm flex items-center gap-1 shrink-0 whitespace-nowrap h-[28px]">
					<i class="fa-solid fa-rotate-left"></i> รีเซ็ต
				</button>
			</div>
		</div>`;
	}



	// 5. ฟังก์ชัน Check All ในเครื่องมือ
	function toggleBulkAll(viewType, checked) {
		document.querySelectorAll(`.bulk-item-${viewType}`).forEach(cb => cb.checked = checked);
	}

	// 6. ฟังก์ชันประมวลผลการใส่คะแนนรวดเร็ว
function applyBulkScore(viewType) {
    // 1. ตรวจสอบว่าเลือกคะแนนหรือยัง
    const scoreEl = document.querySelector(`input[name="bulkScore-${viewType}"]:checked`);
    if (!scoreEl) { Swal.fire('แจ้งเตือน', 'กรุณาเลือกคะแนน (3, 2, 1, 0)', 'warning'); return; }
    
    const scoreVal = parseInt(scoreEl.value);
    
    // 2. ตรวจสอบว่าเลือกข้อหรือยัง
    const selectedItems = Array.from(document.querySelectorAll(`.bulk-item-${viewType}:checked`)).map(cb => cb.value);
    if (selectedItems.length === 0) { Swal.fire('แจ้งเตือน', 'กรุณาเลือกข้อที่ต้องการให้คะแนน', 'warning'); return; }

    showLoading();
    
    setTimeout(() => {
        const students = getActiveStudentsInClass(activeClassName);
        let prefix = '';
        if (viewType === 'rw') prefix = 'rw_';
        else if (viewType === 'comp') prefix = 'comp_';
        else if (viewType === 'attr') prefix = 'attr_';

        students.forEach(s => {
            // เตรียมพื้นที่เก็บข้อมูล (Memory)
            if (!scoreData[activeSubjectId]) scoreData[activeSubjectId] = {};
            if (!scoreData[activeSubjectId][activeClassName]) scoreData[activeSubjectId][activeClassName] = {};
            if (!scoreData[activeSubjectId][activeClassName][s.uid]) scoreData[activeSubjectId][activeClassName][s.uid] = {};
            
            const studentData = scoreData[activeSubjectId][activeClassName][s.uid];

            // 3. บันทึกคะแนนลง Memory (ตามข้อที่ติ๊กเลือก)
            selectedItems.forEach(itemIdx => {
                studentData[`${prefix}${itemIdx}`] = scoreVal;
            });

            // ==========================================================
            // 4. สั่งคำนวณผลประเมินทันที (Real-time Calculation)
            // ==========================================================
            if (viewType === 'attr') {
                let sum = 0;
                let hasZeroCore = false; // ตัวแปรเช็ค 0 เฉพาะข้อ 1-8
                let countCore = 0;       // นับข้อ 1-8
                let countExtra = 0;      // นับข้อ 9-10

                // วนลูป 1-10 เพื่อดึงคะแนนทั้งหมด (ทั้งที่เพิ่งใส่และที่มีอยู่เดิม)
                for (let i = 1; i <= 10; i++) {
                    let val = studentData[`attr_${i}`];
                    
                    if (val !== undefined && val !== "") {
                        val = parseInt(val);
                        sum += val; // บวกคะแนนรวมทั้งหมดที่มี

                        if (i <= 8) {
                            countCore++;
                            // เช็คเงื่อนไขตก (0) เฉพาะข้อ 1-8
                            if (val === 0) hasZeroCore = true;
                        } else {
                            countExtra++;
                            // ข้อ 9-10: ไม่ต้องเช็ค hasZero (เป็น 0 ได้ ไม่ตก)
                        }
                    }
                }

                // --- เงื่อนไขสำคัญ: ถ้ากรอกข้อ 1-8 ครบ ให้ประมวลผลทันที ---
                if (countCore === 8) {
                    // ตัวหาร = 8 + ข้อเสริมที่มีคะแนน (ถ้าข้อ 9-10 ว่าง ก็หาร 8)
                    let divisor = 8 + countExtra;
                    
                    let avg = parseFloat((sum / divisor).toFixed(2));
                    let res = calEvalLevel(avg);

                    // ถ้ามี 0 ในข้อ 1-8 ให้ปรับตกทันที
                    if (hasZeroCore) res = 0;

                    // บันทึกผลลัพธ์ลง Memory (เพื่อให้ initAttributeTable ดึงไปแสดง)
                    studentData['attr_result'] = res;
                    studentData['attr_assess'] = (res === 3 ? 'ดีเยี่ยม' : (res === 2 ? 'ดี' : (res === 1 ? 'ผ่าน' : 'ไม่ผ่าน')));
                }
            } 
            
            // --- ส่วนของ RW และ Comp (คำนวณตามปกติ) ---
            else if (viewType === 'rw' || viewType === 'comp') {
                let sum = 0, count = 0, max = 5;
                for(let i=1; i<=max; i++) {
                    let v = studentData[`${prefix}${i}`];
                    if(v !== undefined && v !== "") { sum += parseInt(v); count++; }
                }
                // ถ้ามีคะแนนอย่างน้อย 1 ช่อง หรือครบตามต้องการ
                if(count > 0) { 
                    let avg = parseFloat((sum / max).toFixed(2)); // หารด้วยจำนวนเต็มเสมอ
                    let res = calEvalLevel(avg);
                    studentData[`${viewType}_result`] = res;
                }
            }
        });

        // 5. รีเฟรชตาราง (ตารางจะดึงผลลัพธ์จาก Memory มาแสดงทันที)
        if (viewType === 'rw') initRWTable();
        else if (viewType === 'comp') initCompetencyTable();
        else if (viewType === 'attr') initAttributeTable();

        hideLoading();
    }, 200);
}




	/* =========================================================================
	   Logic 1: หน้าอ่าน คิดวิเคราะห์ เขียน (RW)
	   ========================================================================= */
function initRWTable() {
    const sub = subjects.find(s => s.id === activeSubjectId);
    if (!sub) return;
    const currentAdvisor = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
    document.getElementById('display-advisor-rw').innerText = currentAdvisor;
    const students = getActiveStudentsInClass(activeClassName);

    // --- ส่วนจัดการปุ่มควบคุม (แก้ไขเพิ่ม Switch ใหม่) ---
    const controlsContainer = document.getElementById('rw-pagination-controls')?.parentElement;
    if (controlsContainer) {
        const btnGroup = controlsContainer.querySelector('.flex.items-center.gap-2');
        if (btnGroup) {
            // 1. Switch แสดงทั้งหมด (ของเดิม)
            if (!btnGroup.querySelector('.switch-show-all')) {
                btnGroup.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8 no-print switch-show-all">
                        <label class="relative inline-flex items-center cursor-pointer group">
                            <input type="checkbox" class="sr-only peer" onchange="toggleShowAllRows(this.checked)" ${typeof isShowAllRows !== 'undefined' && isShowAllRows ? 'checked' : ''}>
                            <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-blue-600 transition-colors">แสดงทั้งหมด</span>
                        </label>
                    </div>
                `);
            }

			// ค้นหาใน initRWTable() ช่วงที่จัดการปุ่ม btnGroup
			if (!btnGroup.querySelector('.switch-auto-grade-rw')) {
				btnGroup.insertAdjacentHTML('beforeend', `
					<div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8 no-print switch-auto-grade-rw">
						<label class="relative inline-flex items-center cursor-pointer group" title="บันทึกคะแนนทุกข้อโดยอิงจากเกรดเฉลี่ย">
							<input type="checkbox" class="sr-only peer" onchange="if(this.checked) { autoFillByGrade('rw'); this.checked = false; }">
							<div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-pink-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-pink-600"></div>
							<span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-pink-600 transition-colors">ประมวลผลด่วน (อิงเกรด)</span>
						</label>
					</div>
				`);
			}
        }
        // ... (ส่วน Bulk Control เดิม) ...
        const oldBulk = document.getElementById('bulk-rw-container');
        if (oldBulk) oldBulk.remove();
        const bulkDiv = document.createElement('div');
        bulkDiv.id = 'bulk-rw-container';
        bulkDiv.className = "w-full bg-white px-4";
        bulkDiv.innerHTML = renderBulkControlHTML('rw', 5);
        controlsContainer.after(bulkDiv);
    }

    // ... (โค้ดส่วน Pagination และการ Render ตารางเดิมทั้งหมด ให้คงไว้เหมือนเดิม) ...
    let start = (currentGradingPage - 1) * rowsPerPage;
    let limit = rowsPerPage;
    if (typeof isShowAllRows !== 'undefined' && isShowAllRows) {
        start = 0;
        limit = students.length;
        const infoEl = document.getElementById('rw-pagination-info');
        if (infoEl) infoEl.innerText = `แสดงทั้งหมด (${students.length} คน)`;
        const ctrlEl = document.getElementById('rw-pagination-controls');
        if (ctrlEl) {
             ctrlEl.innerHTML = `
                <button disabled class="pagination-btn px-3 py-1 border rounded bg-slate-50 text-slate-400 cursor-not-allowed shadow-sm font-bold text-xs flex items-center gap-1 opacity-50"><i class="fa-solid fa-chevron-left text-[10px]"></i> ก่อนหน้า</button>
                <button class="px-3 py-1 border rounded bg-[#0d6efd] text-white font-bold text-xs">1</button>
                <button disabled class="pagination-btn px-3 py-1 border rounded bg-slate-50 text-slate-400 cursor-not-allowed shadow-sm font-bold text-xs flex items-center gap-1 opacity-50">ถัดไป <i class="fa-solid fa-chevron-right text-[10px]"></i></button>
            `;
        }
    } else {
        renderGeneralPagination('rw-pagination', students.length, currentGradingPage, p => {
            currentGradingPage = p;
            initRWTable();
        });
    }

    const list = students.slice(start, start + limit);
    // ... (ส่วน Render Header และ Body คงเดิม) ...
    const header = document.getElementById('rwTableHeader');
    let cols = '';
    for(let i=1; i<=5; i++) {
        cols += `<th class="px-2 py-3 text-center border-r bg-pink-50 min-w-[50px]"><div class="text-pink-800 text-xs mb-1">ข้อ ${i}</div><div class="bg-white rounded-full text-[10px] border border-pink-200 shadow-sm mx-auto w-8">3</div></th>`;
    }
    header.innerHTML = `<tr><th class="px-2 py-6 text-center w-8 border-r text-sm font-bold">ที่</th><th class="px-2 py-6 w-10 text-center border-r text-sm font-bold print:hidden">รูป</th><th class="px-2 py-6 w-20 border-r text-center text-sm font-bold">รหัส</th><th class="px-2 py-6 w-48 border-r text-center text-sm font-bold">ชื่อ-นามสกุล</th>${cols}<th class="px-2 py-6 w-16 text-center border-r bg-gray-50 font-bold">รวม</th><th class="px-2 py-6 w-16 text-center border-r bg-purple-50 font-bold text-purple-900">เฉลี่ย</th><th class="px-2 py-6 w-20 text-center border-r bg-gray-50 font-bold">ผลประเมิน</th><th class="px-2 py-6 w-24 text-center border-r bg-gray-50 font-bold">ระดับคุณภาพ</th></tr>`;

    const tbody = document.getElementById('rwTableBody');
    if(list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="100%" class="text-center py-8 text-red-500 font-bold">...ไม่พบข้อมูลนักเรียนในห้องนี้...</td></tr>`;
        return;
    }
    tbody.innerHTML = list.map((s, idx) => {
        const globalIdx = start + idx;
        let inputs = '';
        let sum = 0;
        for(let i=1; i<=5; i++) {
            let rawVal = getStoredScore(activeSubjectId, activeClassName, s.uid, `rw_${i}`, "");
            let val = rawVal === "" ? 0 : rawVal;
            const num = parseInt(val) || 0;
            sum += num;
            inputs += `<td class="p-1 text-center border-r"><input type="number" min="0" max="3" value="${val}" data-row="${idx}" data-col="rw_${i}" data-uid="${s.uid}" data-idx="${globalIdx}" onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)" onfocus="this.select()" oninput="updateInputColor(this); updateScore(this, '${s.uid}', 'rw_${i}', this.value, ${globalIdx}); autoSumRW('${s.uid}', ${globalIdx})" class="input-score text-center border rounded-full w-[32px] h-[28px] font-bold shadow-sm focus:ring-2 focus:ring-pink-300 outline-none ${getScoreClass(val)}"></td>`;
        }
        let avg = (sum / 5).toFixed(2);
        let result = calEvalLevel(parseFloat(avg));
        let qText = result===3?'ดีเยี่ยม':(result===2?'ระดับดี':(result===1?'ระดับผ่าน':'ไม่ผ่าน'));
        let qColor = result===3?'text-green-600':(result===0?'text-red-600':'text-gray-800');
        return `<tr class="grading-row border-b odd:bg-white even:bg-[#FFFF99] hover:bg-pink-50 transition-colors"><td class="px-2 py-1 text-center text-gray-400 border-r text-[11px] font-bold">${globalIdx + 1}</td><td class="px-1 py-1 border-r text-center print:hidden"><div onclick="viewStudentPhoto('${s.uid}')" class="student-photo-container w-6 h-6 bg-slate-100 rounded-full mx-auto overflow-hidden border cursor-pointer transition-transform">${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user text-[10px] text-slate-300 mt-1"></i>'}</div></td><td class="px-2 py-1 text-gray-600 border-r text-[11px] text-center font-bold">${s.id}</td><td class="px-2 py-1 text-gray-700 border-r text-[11px] truncate max-w-[200px] font-bold text-left">${s.name}</td>${inputs}<td class="text-center font-bold bg-gray-50 text-slate-600 border-r" id="rw-sum-${globalIdx}">${sum}</td><td class="text-center font-bold text-purple-700 bg-purple-50 border-r" id="rw-avg-${globalIdx}">${avg}</td><td class="text-center border-r font-bold ${result===3?'text-green-600 bg-green-50/20':(result===0?'text-red-600 bg-red-50/20':'text-blue-600 bg-blue-50/20')}" id="rw-result-${globalIdx}">${result}</td><td class="text-center border-r text-sm font-bold ${qColor}" id="rw-quality-${globalIdx}">${qText}</td></tr>`;
    }).join('');
    
    refreshRoomSummary('rw');
}

function autoSumRW(uid, idx) {
    let sum = 0;
    // 1. คำนวณผลรวมจากข้อ 1-5
    for(let i=1; i<=5; i++) {
        sum += parseInt(scoreData[activeSubjectId][activeClassName][uid][`rw_${i}`] || 0);
    }
    
    // 2. คำนวณค่าเฉลี่ยและระดับผลประเมิน
    const avg = parseFloat((sum / 5).toFixed(2));
    const result = calEvalLevel(avg);
    const qText = result === 3 ? 'ดีเยี่ยม' : (result === 2 ? 'ดี' : (result === 1 ? 'ผ่าน' : 'ไม่ผ่าน'));
    const qColor = result === 3 ? 'text-green-600' : (result === 0 ? 'text-red-600' : 'text-gray-800');

    // 3. บันทึกลง Memory (เพื่อให้ข้อมูลในชีตตรงกับที่แสดงผล)
    if (scoreData[activeSubjectId][activeClassName][uid]) {
        scoreData[activeSubjectId][activeClassName][uid]['rw_result'] = result; // บันทึกเลข 0-3
        scoreData[activeSubjectId][activeClassName][uid]['rw_assess'] = qText;  // บันทึกข้อความ "ดีเยี่ยม/ดี..."
    }

    // 4. อัปเดตการแสดงผลในตาราง (UI)
    const sumEl = document.getElementById(`rw-sum-${idx}`);
    if(sumEl) sumEl.innerText = sum;

    const avgEl = document.getElementById(`rw-avg-${idx}`);
    if(avgEl) avgEl.innerText = avg.toFixed(2);

    const resEl = document.getElementById(`rw-result-${idx}`);
    if (resEl) resEl.innerText = result;

    const qualEl = document.getElementById(`rw-quality-${idx}`);
    if(qualEl) {
        qualEl.innerText = qText;
        qualEl.className = `text-center border-r text-sm font-bold ${qColor}`;
    }

    // 5. อัปเดตตารางสรุปท้ายหน้า
    updateEvalSummary('rw', getActiveStudentsInClass(activeClassName), 'rw_result');
}

	/* =========================================================================
	   Logic 2: หน้าสมรรถนะ (Competency)
	   ========================================================================= */
function initCompetencyTable() {
    const sub = subjects.find(s => s.id === activeSubjectId);
    if (!sub) return;
    document.getElementById('display-advisor-comp').innerText = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
    const students = getActiveStudentsInClass(activeClassName);
    const comps = ['สื่อสาร', 'การคิด', 'แก้ปัญหา', 'ทักษะชีวิต', 'เทคโนโลยี'];

    // --- ส่วนจัดการปุ่มควบคุม (แก้ไขเพิ่ม Switch ใหม่) ---
    const controlsContainer = document.getElementById('comp-pagination-controls')?.parentElement;
    if (controlsContainer) {
        const btnGroup = controlsContainer.querySelector('.flex.items-center.gap-2');
        if (btnGroup) {
            // 1. Switch แสดงทั้งหมด
            if (!btnGroup.querySelector('.switch-show-all')) {
                btnGroup.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8 no-print switch-show-all">
                        <label class="relative inline-flex items-center cursor-pointer group">
                            <input type="checkbox" class="sr-only peer" onchange="toggleShowAllRows(this.checked)" ${typeof isShowAllRows !== 'undefined' && isShowAllRows ? 'checked' : ''}>
                            <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-blue-600 transition-colors">แสดงทั้งหมด</span>
                        </label>
                    </div>
                `);
            }
			// ค้นหาใน initCompetencyTable()
			if (!btnGroup.querySelector('.switch-auto-grade-comp')) {
				btnGroup.insertAdjacentHTML('beforeend', `
					<div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8 no-print switch-auto-grade-comp">
						<label class="relative inline-flex items-center cursor-pointer group" title="บันทึกคะแนนทุกข้อโดยอิงจากเกรดเฉลี่ย">
							<input type="checkbox" class="sr-only peer" onchange="if(this.checked) { autoFillByGrade('comp'); this.checked = false; }">
							<div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-teal-600"></div>
							<span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-teal-600 transition-colors">ประมวลผลด่วน (อิงเกรด)</span>
						</label>
					</div>
				`);
			}
        }
        // ... (Bulk Control) ...
        const oldBulk = document.getElementById('bulk-comp-container');
        if (oldBulk) oldBulk.remove();
        const bulkDiv = document.createElement('div');
        bulkDiv.id = 'bulk-comp-container';
        bulkDiv.className = "w-full bg-white px-4";
        bulkDiv.innerHTML = renderBulkControlHTML('comp', 5);
        controlsContainer.after(bulkDiv);
    }

    // ... (ส่วน Pagination และ Render ตาราง คงเดิม) ...
    let start = (currentGradingPage - 1) * rowsPerPage;
    let limit = rowsPerPage;
    if (typeof isShowAllRows !== 'undefined' && isShowAllRows) {
        start = 0; limit = students.length;
        const infoEl = document.getElementById('comp-pagination-info');
        if(infoEl) infoEl.innerText = `แสดงทั้งหมด (${students.length} คน)`;
        const ctrlEl = document.getElementById('comp-pagination-controls');
        if(ctrlEl) {
             ctrlEl.innerHTML = `<button disabled class="pagination-btn px-3 py-1 border rounded bg-slate-50 text-slate-400 cursor-not-allowed shadow-sm font-bold text-xs flex items-center gap-1 opacity-50"><i class="fa-solid fa-chevron-left text-[10px]"></i> ก่อนหน้า</button><button class="px-3 py-1 border rounded bg-[#0d6efd] text-white font-bold text-xs">1</button><button disabled class="pagination-btn px-3 py-1 border rounded bg-slate-50 text-slate-400 cursor-not-allowed shadow-sm font-bold text-xs flex items-center gap-1 opacity-50">ถัดไป <i class="fa-solid fa-chevron-right text-[10px]"></i></button>`;
        }
    } else {
        renderGeneralPagination('comp-pagination', students.length, currentGradingPage, p => {
            currentGradingPage = p;
            initCompetencyTable();
        });
    }

    const list = students.slice(start, start + limit);
    const header = document.getElementById('compTableHeader');
    let cols = '';
    comps.forEach((c, i) => {
        cols += `<th class="px-2 py-3 text-center border-r bg-teal-50 min-w-[50px]"><div class="text-teal-800 text-xs mb-1">${c}</div><div class="bg-white rounded-full text-[10px] border border-teal-200 shadow-sm mx-auto w-8">3</div></th>`;
    });
    header.innerHTML = `<tr><th class="px-2 py-6 text-center w-8 border-r text-sm font-bold">ที่</th><th class="px-2 py-6 w-10 text-center border-r text-sm font-bold print:hidden">รูป</th><th class="px-2 py-6 w-20 border-r text-center text-sm font-bold">รหัส</th><th class="px-2 py-6 w-48 border-r text-center text-sm font-bold">ชื่อ-นามสกุล</th>${cols}<th class="px-2 py-6 w-16 text-center border-r bg-gray-50 font-bold">รวม</th><th class="px-2 py-6 w-16 text-center border-r bg-purple-50 font-bold text-purple-900">เฉลี่ย</th><th class="px-2 py-6 w-20 text-center border-r bg-gray-50 font-bold">ผลประเมิน</th><th class="px-2 py-6 w-24 text-center border-r bg-gray-50 font-bold">ระดับคุณภาพ</th></tr>`;

    const tbody = document.getElementById('compTableBody');
    if(list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="100%" class="text-center py-8 text-red-500 font-bold">...ไม่พบข้อมูลนักเรียนในห้องนี้...</td></tr>`;
        return;
    }
    tbody.innerHTML = list.map((s, idx) => {
        const globalIdx = start + idx;
        let inputs = '';
        let sum = 0;
        for(let i=1; i<=5; i++) {
            let rawVal = getStoredScore(activeSubjectId, activeClassName, s.uid, `comp_${i}`, "");
            let val = rawVal === "" ? 0 : parseInt(rawVal);
            sum += val;
            inputs += `<td class="p-1 text-center border-r"><input type="number" min="0" max="3" value="${rawVal}" data-row="${idx}" data-col="comp_${i}" data-uid="${s.uid}" data-idx="${globalIdx}" onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)" onfocus="this.select()" oninput="updateInputColor(this); updateScore(this, '${s.uid}', 'comp_${i}', this.value, ${globalIdx}); autoSumComp('${s.uid}', ${globalIdx})" class="input-score text-center border rounded-full w-[32px] h-[28px] font-bold shadow-sm focus:ring-2 focus:ring-teal-300 outline-none ${getScoreClass(rawVal)}"></td>`;
        }
        let avg = (sum / 5).toFixed(2);
        let result = calEvalLevel(parseFloat(avg));
        let qText = result===3?'ดีเยี่ยม':(result===2?'ระดับดี':(result===1?'ระดับผ่าน':'ไม่ผ่าน'));
        let qColor = result===3?'text-green-600':(result===0?'text-red-600':'text-gray-800');
        return `<tr class="grading-row border-b odd:bg-white even:bg-[#E0F2F1] hover:bg-teal-50 transition-colors"><td class="px-2 py-1 text-center text-gray-400 border-r text-[11px] font-bold">${globalIdx + 1}</td><td class="px-1 py-1 border-r text-center print:hidden"><div onclick="viewStudentPhoto('${s.uid}')" class="student-photo-container w-6 h-6 bg-slate-100 rounded-full mx-auto overflow-hidden border cursor-pointer transition-transform">${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user text-[10px] text-slate-300 mt-1"></i>'}</div></td><td class="px-2 py-1 text-gray-600 border-r text-[11px] text-center font-bold">${s.id}</td><td class="px-2 py-1 text-gray-700 border-r text-[11px] truncate max-w-[200px] font-bold text-left">${s.name}</td>${inputs}<td class="text-center font-bold bg-gray-50 text-slate-600 border-r" id="comp-sum-${globalIdx}">${sum}</td><td class="text-center font-bold text-purple-700 bg-purple-50 border-r" id="comp-avg-${globalIdx}">${avg}</td><td class="text-center border-r font-bold text-teal-600 bg-teal-50/20" id="comp-result-${globalIdx}">${result}</td><td class="text-center border-r text-sm font-bold ${qColor}" id="comp-quality-${globalIdx}">${qText}</td></tr>`;
    }).join('');
    
    refreshRoomSummary('comp');
}

function autoSumComp(uid, idx) {
    let sum = 0;
    for(let i=1; i<=5; i++) {
        let val = parseInt(getStoredScore(activeSubjectId, activeClassName, uid, `comp_${i}`, 0));
        sum += val;
    }
    const avg = (sum / 5).toFixed(2);
    const result = calEvalLevel(parseFloat(avg));
    
    document.getElementById(`comp-sum-${idx}`).innerText = sum;
    document.getElementById(`comp-avg-${idx}`).innerText = avg;
    
    const resCell = document.getElementById(`comp-result-${idx}`); // แก้ไข ID
    if(resCell) {
        resCell.innerText = result;
        resCell.className = `text-center border-r font-bold ${result===3?'text-green-600 bg-green-50/20':(result===0?'text-red-600 bg-red-50/20':'text-blue-600 bg-blue-50/20')}`;
    }
    
    const qCell = document.getElementById(`comp-quality-${idx}`); // แก้ไข ID
    if(qCell) {
        let qText = result===3?'ดีเยี่ยม':(result===2?'ระดับดี':(result===1?'ระดับผ่าน':'ไม่ผ่าน'));
        let qColor = result===3?'text-green-600':(result===0?'text-red-600':'text-gray-800');
        qCell.innerText = qText;
        qCell.className = `text-center border-r text-sm font-bold ${qColor}`;
    }

    // บันทึกผลลง memory ทันที
    if (!scoreData[activeSubjectId][activeClassName][uid]) scoreData[activeSubjectId][activeClassName][uid] = {};
    scoreData[activeSubjectId][activeClassName][uid]['comp_result'] = result;
    
    updateEvalSummary('comp', getActiveStudentsInClass(activeClassName), 'comp_result');
}
	


/* =========================================================================
   แก้ไข: initAttributeTable (คำนวณผล + บันทึกทันที + เช็คคะแนน 0 ตก)
   ========================================================================= */
function initAttributeTable() {
    const sub = subjects.find(s => s.id === activeSubjectId);
    if (!sub) return;
    
    // แสดงชื่อครูที่ปรึกษา
    document.getElementById('display-advisor-attr').innerText = (sub.advisors && sub.advisors[activeClassName]) ? sub.advisors[activeClassName] : "-";
    
    const students = getActiveStudentsInClass(activeClassName);

    // --- [1] ส่วนจัดการปุ่มควบคุม (Pagination & Quick Controls) ---
    const controlsContainer = document.getElementById('attr-pagination-controls')?.parentElement;
    if (controlsContainer) {
        const btnGroup = controlsContainer.querySelector('.flex.items-center.gap-2');
        if(btnGroup) {
            // สวิตช์: แสดงทั้งหมด
            if (!btnGroup.querySelector('.switch-show-all')) {
                btnGroup.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8 no-print switch-show-all">
                        <label class="relative inline-flex items-center cursor-pointer group">
                            <input type="checkbox" class="sr-only peer" onchange="toggleShowAllRows(this.checked)" ${typeof isShowAllRows !== 'undefined' && isShowAllRows ? 'checked' : ''}>
                            <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-blue-600 transition-colors">แสดงทั้งหมด</span>
                        </label>
                    </div>
                `);
            }
            
            // สวิตช์: ประมวลผลด่วน (อิงเกรด) - **เพิ่มใหม่ที่นี่**
            if (!btnGroup.querySelector('.switch-auto-grade-attr')) {
                btnGroup.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center ml-4 pl-4 border-l border-slate-300 h-8 no-print switch-auto-grade-attr">
                        <label class="relative inline-flex items-center cursor-pointer group" title="ประมวลผลคะแนน 1-10 อัตโนมัติโดยอิงจากเกรดเฉลี่ยของนักเรียน">
                            <input type="checkbox" class="sr-only peer" onchange="if(this.checked) { autoFillByGrade('attr'); this.checked = false; }">
                            <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-amber-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-amber-600"></div>
                            <span class="ml-2 text-sm font-bold text-slate-600 group-hover:text-amber-600 transition-colors">ประมวลผลด่วน (อิงเกรด)</span>
                        </label>
                    </div>
                `);
            }
        }
        
        // แถบให้คะแนนแบบเร็ว (Bulk Score)
        const oldBulk = document.getElementById('bulk-attr-container');
        if(oldBulk) oldBulk.remove();
        const bulkDiv = document.createElement('div');
        bulkDiv.id = 'bulk-attr-container';
        bulkDiv.className = "w-full bg-white px-4";
        bulkDiv.innerHTML = renderBulkControlHTML('attr', 10);
        controlsContainer.after(bulkDiv);
    }

    // --- [2] ส่วนจัดการการแบ่งหน้า (Pagination) ---
    let start = (currentGradingPage - 1) * rowsPerPage;
    let limit = rowsPerPage;
    if (typeof isShowAllRows !== 'undefined' && isShowAllRows) {
        start = 0;
        limit = students.length;
        const infoEl = document.getElementById('attr-pagination-info');
        if(infoEl) infoEl.innerText = `แสดงทั้งหมด (${students.length} คน)`;
    } else {
        renderGeneralPagination('attr-pagination', students.length, currentGradingPage, p => {
            currentGradingPage = p;
            initAttributeTable();
        });
    }

    const list = students.slice(start, start + limit);

    // --- [3] วาดส่วนหัวตาราง (Header) ---
    const header = document.getElementById('attrTableHeader');
    let cols = '';
    for(let i=1; i<=10; i++) {
        let bgColor = i > 8 ? 'bg-amber-50' : 'bg-pink-50';
        let textColor = i > 8 ? 'text-amber-800' : 'text-pink-800';
        cols += `<th class="px-2 py-3 text-center border-r ${bgColor} min-w-[40px]"><div class="${textColor} text-[10px] mb-1">ข้อ ${i} ${i>8?'(เสริม)':''}</div><div class="bg-white rounded-full text-[10px] border border-pink-200 shadow-sm mx-auto w-6">3</div></th>`;
    }
    header.innerHTML = `<tr><th class="px-2 py-6 text-center w-8 border-r text-sm font-bold">ที่</th><th class="px-2 py-6 w-10 text-center border-r text-sm font-bold print:hidden">รูป</th><th class="px-2 py-6 w-20 border-r text-center text-sm font-bold">รหัส</th><th class="px-2 py-6 w-48 border-r text-center text-sm font-bold">ชื่อ-นามสกุล</th>${cols}<th class="px-2 py-6 w-16 text-center border-r bg-gray-50 font-bold">รวม</th><th class="px-2 py-6 w-16 text-center border-r bg-purple-50 font-bold text-purple-900">เฉลี่ย(1-8)</th><th class="px-2 py-6 w-20 text-center border-r bg-gray-50 font-bold">ผลประเมิน</th><th class="px-2 py-6 w-24 text-center border-r bg-gray-50 font-bold">ระดับคุณภาพ</th></tr>`;

    // --- [4] วาดส่วนเนื้อหาตาราง (Body) ---
    const tbody = document.getElementById('attrTableBody');
    if(list.length === 0) {
        tbody.innerHTML = `<tr><td colspan="100%" class="text-center py-8 text-red-500 font-bold">...ไม่พบข้อมูลนักเรียนในห้องนี้...</td></tr>`;
        return;
    }

    tbody.innerHTML = list.map((s, idx) => {
        const globalIdx = start + idx;
        let inputs = '';
        let sumTotal = 0;      // รวมข้อ 1-10
        let sumCore = 0;       // รวมข้อ 1-8 (เพื่อนำไปเฉลี่ย)
        let hasZeroCore = false; // เช็ค 0 ในข้อ 1-8

        for(let i=1; i<=10; i++) {
            let rawVal = getStoredScore(activeSubjectId, activeClassName, s.uid, `attr_${i}`, "");
            let val = rawVal === "" ? 0 : parseInt(rawVal);
            
            sumTotal += val;

            if (i <= 8) {
                sumCore += val;
                if (rawVal !== "" && val === 0) hasZeroCore = true;
            }

            inputs += `<td class="p-1 text-center border-r"><input type="number" min="0" max="3" value="${rawVal}" data-row="${idx}" data-col="attr_${i}" data-uid="${s.uid}" data-idx="${globalIdx}" onkeydown="handleInputKeydown(event)" onpaste="handlePaste(event)" onfocus="this.select()" oninput="updateInputColor(this); updateScore(this, '${s.uid}', 'attr_${i}', this.value, ${globalIdx}); autoSumAttr('${s.uid}', ${globalIdx})" class="input-score text-center border rounded-full w-[28px] h-[26px] text-xs font-bold shadow-sm focus:ring-2 focus:ring-pink-300 outline-none ${getScoreClass(rawVal)}"></td>`;
        }

        // คำนวณค่าเฉลี่ย (คิดเฉพาะข้อบังคับ 8 ข้อ)
        let avg = (sumCore / 8).toFixed(2);
        
        // ตัดเกรด (3, 2, 1, 0)
        let result = calEvalLevel(parseFloat(avg));
        
        // เงื่อนไข: ถ้าข้อ 1-8 มีใครได้ 0 แม้แต่ข้อเดียว ให้ตก (0) ทันที
        if (hasZeroCore) result = 0;

        let qText = result === 3 ? 'ดีเยี่ยม' : (result === 2 ? 'ดี' : (result === 1 ? 'ผ่าน' : 'ไม่ผ่าน'));
        let qColor = result === 3 ? 'text-green-600' : (result === 0 ? 'text-red-600' : 'text-gray-800');

        return `<tr class="grading-row border-b odd:bg-white even:bg-[#FCE4EC] hover:bg-pink-50 transition-colors">
            <td class="px-2 py-1 text-center text-gray-400 border-r text-[11px] font-bold">${globalIdx + 1}</td>
            <td class="px-1 py-1 border-r text-center print:hidden"><div onclick="viewStudentPhoto('${s.uid}')" class="student-photo-container w-6 h-6 bg-slate-100 rounded-full mx-auto overflow-hidden border cursor-pointer transition-transform">${s.image ? `<img src="${s.image}" class="w-full h-full object-cover">` : '<i class="fa-solid fa-user text-[10px] text-slate-300 mt-1"></i>'}</div></td>
            <td class="px-2 py-1 text-gray-600 border-r text-[11px] text-center font-bold">${s.id}</td>
            <td class="px-2 py-1 text-gray-700 border-r text-[11px] truncate max-w-[200px] font-bold text-left">${s.name}</td>
            ${inputs}
            <td class="text-center font-bold bg-gray-50 text-slate-600 border-r" id="attr-sum-${globalIdx}">${sumTotal}</td>
            <td class="text-center font-bold text-purple-700 bg-purple-50 border-r" id="attr-avg-${globalIdx}">${avg}</td>
            <td class="text-center border-r font-bold ${result === 3 ? 'text-green-600 bg-green-50/20' : (result === 0 ? 'text-red-600 bg-red-50/20' : 'text-blue-600 bg-blue-50/20')}" id="attr-result-${globalIdx}">${result}</td>
            <td class="text-center border-r text-sm font-bold ${qColor}" id="attr-quality-${globalIdx}">${qText}</td>
        </tr>`;
    }).join('');

    // อัปเดตสรุปผลท้ายห้อง
    refreshRoomSummary('attr');
}

function autoSumAttr(uid, idx) {
    let sum = 0;
    let hasZero = false;
    let countCore = 0;   // นับจำนวนข้อ 1-8 ที่กรอกแล้ว
    let countExtra = 0;  // นับจำนวนข้อ 9-10 ที่กรอกแล้ว

    for(let i=1; i<=10; i++) {
        let valStr = getStoredScore(activeSubjectId, activeClassName, uid, `attr_${i}`, "");
        let val = (valStr === "" || valStr === undefined) ? 0 : parseInt(valStr);
        
        if (i <= 8) {
            // เช็คข้อหลัก 1-8
            if (valStr !== "") countCore++;
            if (valStr !== "" && val === 0) hasZero = true; // กฎ 0 ตก
        } else {
            // เช็คข้อเสริม 9-10
            if (valStr !== "") countExtra++;
        }
        
        sum += val;
    }

    // --- เงื่อนไขการแสดงผล: ต้องกรอกข้อ 1-8 ให้ครบก่อน ---
    if (countCore === 8) {
        // ตัวหารคิดตามจริง: พื้นฐาน 8 + จำนวนข้อเสริมที่กรอกเพิ่ม (9 หรือ 10)
        let divisor = 8 + countExtra; 
        
        const avg = (sum / divisor).toFixed(2);
        let result = calEvalLevel(parseFloat(avg));
        
        if(hasZero) result = 0;

        // แสดงผล
        document.getElementById(`attr-sum-${idx}`).innerText = sum;
        document.getElementById(`attr-avg-${idx}`).innerText = avg;
        
        const resCell = document.getElementById(`attr-result-${idx}`); 
        if(resCell) {
            resCell.innerText = result;
            resCell.className = `text-center border-r font-bold ${result===3?'text-green-600 bg-green-50/20':(result===0?'text-red-600 bg-red-50/20':'text-blue-600 bg-blue-50/20')}`;
        }
        
        const qCell = document.getElementById(`attr-quality-${idx}`);
        if(qCell) {
            let qText = result===3?'ดีเยี่ยม':(result===2?'ระดับดี':(result===1?'ระดับผ่าน':'ไม่ผ่าน'));
            let qColor = result===3?'text-green-600':(result===0?'text-red-600':'text-gray-800');
            qCell.innerText = qText;
            qCell.className = `text-center border-r text-sm font-bold ${qColor}`;
        }

        // บันทึกผลลัพธ์ลง Memory
        if (!scoreData[activeSubjectId][activeClassName][uid]) scoreData[activeSubjectId][activeClassName][uid] = {};
        scoreData[activeSubjectId][activeClassName][uid]['attr_result'] = result;
        
    } else {
        // ถ้ายังกรอก 1-8 ไม่ครบ ให้เคลียร์ค่าหรือแสดงว่าเป็นค่าว่าง
        document.getElementById(`attr-sum-${idx}`).innerText = sum; // ยังโชว์ผลรวมได้
        document.getElementById(`attr-avg-${idx}`).innerText = "-";
        
        const resCell = document.getElementById(`attr-result-${idx}`);
        if(resCell) { resCell.innerText = "-"; resCell.className = "text-center border-r"; }
        
        const qCell = document.getElementById(`attr-quality-${idx}`);
        if(qCell) { qCell.innerText = "-"; qCell.className = "text-center border-r"; }
    }
    
    // อัปเดตตารางสรุปท้ายหน้า
    updateEvalSummary('attr', getActiveStudentsInClass(activeClassName), 'attr_result');
}
	
/* =========================================================================
   FIXED: ระบบสรุปผลแบบคำนวณสด (Real-time Calculation)
   ใช้สำหรับหน้า สมรรถนะ (comp), คุณลักษณะ (attr) และ อ่านคิดเขียน (rw)
   ========================================================================= */
	function updateEvalSummary(prefix, students, scoreKey) {
		const counts = { 3: 0, 2: 0, 1: 0, 0: 0 };
		let total = 0;
		let sumScore = 0; // ตัวแปรสำหรับคำนวณคะแนนเฉลี่ย

		// 1. นับจำนวนและรวมคะแนน
		students.forEach(s => {
			let result = getStoredScore(activeSubjectId, activeClassName, s.uid, scoreKey, "");
			if (result !== "") {
				result = parseInt(result);
				if ([0, 1, 2, 3].includes(result)) {
					counts[result]++;
					total++;
					sumScore += result;
				}
			}
		});

		// 2. อัปเดตจำนวนและร้อยละในตาราง (3, 2, 1, 0)
		[3, 2, 1, 0].forEach(lvl => {
			// จำนวน
			const countEl = document.getElementById(`${prefix}-stat-${lvl}`);
			if (countEl) countEl.innerText = counts[lvl] > 0 ? counts[lvl] : "-";
			
			// ร้อยละ
			const pctEl = document.getElementById(`${prefix}-pct-${lvl}`);
			if (pctEl) {
				const pct = total > 0 ? ((counts[lvl] / total) * 100).toFixed(2) : "0.00";
				pctEl.innerText = (pct === "0.00" && counts[lvl] === 0) ? "-" : pct;
			}
		});

		// 3. อัปเดตยอดรวมในตาราง
		const totalEl = document.getElementById(`${prefix}-stat-total`);
		if(totalEl) totalEl.innerText = total;

		// 4. คำนวณและอัปเดตสถิติด้านบน (Header Stats)
		const headTotalEl = document.getElementById(`${prefix}-stat-total-head`);
		const goodPctEl = document.getElementById(`${prefix}-good-pct`);
		const avgScoreEl = document.getElementById(`${prefix}-avg-score`);

		if(headTotalEl) headTotalEl.innerText = total;

		// คำนวณร้อยละระดับดีขึ้นไป (ระดับ 3 + 2)
		const goodCount = counts[3] + counts[2];
		const goodPct = total > 0 ? ((goodCount / total) * 100).toFixed(2) : "0.00";
		if(goodPctEl) goodPctEl.innerText = goodPct;

		// คำนวณผลประเมินเฉลี่ย (คะแนนรวม / จำนวนคน)
		const avgScore = total > 0 ? (sumScore / total).toFixed(2) : "0.00";
		if(avgScoreEl) avgScoreEl.innerText = avgScore;

		// 5. อัปเดตส่วนลายเซ็น (Signature) - ส่วนที่ขาดหายไป
		const sub = subjects.find(s => s.id === activeSubjectId);
		if (sub) {
			const sigNameEl = document.getElementById(`${prefix}-sig-teacher`);
			if(sigNameEl) sigNameEl.innerText = sub.teacher || "-";
		}

		// วันที่ปัจจุบันแบบไทย
		const now = new Date();
		const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
		const dateStr = `${now.getDate()} ${thaiMonths[now.getMonth()]} ${now.getFullYear() + 543}`;
		
		const sigDateEl = document.getElementById(`${prefix}-sig-date`);
		if(sigDateEl) sigDateEl.innerText = dateStr;
	}
	
	
   
	/* =========================================================================
	   Helper: คำนวณผลประเมินของนักเรียน "ทุกคน" ในห้อง (เพื่อให้ตารางสรุปครบถ้วน)
	   ดึงคะแนนดิบที่บันทึกไว้มาคำนวณ แล้วเก็บผลลัพธ์ลงตัวแปรระบบ
	   ========================================================================= */
	function refreshRoomSummary(type) {
		const students = getActiveStudentsInClass(activeClassName);
		let resultKey = '';
		let scorePrefix = '';
		let maxCount = 0;

		if (type === 'rw') { resultKey = 'rw_result'; scorePrefix = 'rw_'; maxCount = 5; } 
		else if (type === 'comp') { resultKey = 'comp_result'; scorePrefix = 'comp_'; maxCount = 5; } 
		else if (type === 'attr') { resultKey = 'attr_result'; scorePrefix = 'attr_'; maxCount = 10; }

		students.forEach(s => {
			let sum = 0;
			let hasZero = false;
			let countCore = 0;  // สำหรับ attr 1-8
			let countExtra = 0; // สำหรับ attr 9-10
			let countTotal = 0; // สำหรับ rw, comp

			for (let i = 1; i <= maxCount; i++) {
				let valStr = getStoredScore(activeSubjectId, activeClassName, s.uid, scorePrefix + i, "");
				let val = (valStr === "" || valStr === undefined) ? 0 : parseInt(valStr);

				if (valStr !== "") {
					countTotal++; // นับรวมทุกประเภท
					
					// เช็คเฉพาะ Attribute
					if (type === 'attr') {
						if (i <= 8) {
							countCore++;
							if (val === 0) hasZero = true;
						} else {
							countExtra++;
						}
					} else {
						// ประเภทอื่น (RW, Comp) เช็ค 0 ปกติถ้ามีเงื่อนไข
						if (val === 0) hasZero = true; 
					}
					
					sum += val;
				}
			}

			// --- Logic การตัดสินผล ---
			let canCalculate = false;
			let divisor = maxCount;

			if (type === 'attr') {
				// คุณลักษณะ: ต้องครบ 8 ข้อถึงจะคิด
				if (countCore === 8) {
					canCalculate = true;
					divisor = 8 + countExtra;
				}
			} else {
				// อ่านคิดเขียน/สมรรถนะ: ต้องครบทุกข้อ (5 ข้อ)
				if (countTotal === maxCount) canCalculate = true;
			}

			if (canCalculate) {
				let avg = sum / divisor;
				let res = calEvalLevel(avg);

				if (type === 'attr' && hasZero) res = 0;

				if (!scoreData[activeSubjectId][activeClassName][s.uid]) {
					scoreData[activeSubjectId][activeClassName][s.uid] = {};
				}
				scoreData[activeSubjectId][activeClassName][s.uid][resultKey] = res;
			}
		});

		updateEvalSummary(type, students, resultKey);
	}
   
   
   

	// เกณฑ์การประเมิน: 2.50-3.00=3, 1.50-2.49=2, 1.00-1.49=1, <1.00=0

	function calEvalLevel(avg) {
		// ปรับให้เป็นตัวเลขทศนิยม 2 ตำแหน่งที่แน่นอนก่อนเทียบ
		const score = parseFloat(Number(avg).toFixed(2)); 
		
		if (score >= 2.50) return 3; // 2.50 - 3.00
		if (score >= 1.50) return 2; // 1.50 - 2.49
		if (score >= 1.00) return 1; // 1.00 - 1.49
		return 0;                    // ต่ำกว่า 1.00
	}


/* =========================================================================
   Helper: อัปเดตตารางสรุปผล (ฉบับสมบูรณ์: รวมชื่อครู + สถิติหัวตาราง)
   ========================================================================= */


	
	// ฟังก์ชันอัปเดตชื่อผู้ใช้ (ฉบับแก้ไข: รองรับ JSON และ Log เพื่อตรวจสอบ)
function updateHeaderUserName() {
    let displayText = 'คุณครู (Guest)'; // ค่าเริ่มต้น

    // 1. ลองดึงจากตัวแปร Global (กรณีเพิ่ง Login เสร็จ)
    if (typeof currentUser !== 'undefined' && currentUser && currentUser.name) {
        displayText = `${currentUser.name}`;
    } 
    // 2. ถ้าไม่มี ให้ลองแกะจาก LocalStorage (กรณี Refresh หน้า)
    else {
        const storedUserJson = localStorage.getItem('currentUser');
        if (storedUserJson) {
            try {
                const parsedUser = JSON.parse(storedUserJson);
                if(parsedUser.name) {
                    displayText = `${parsedUser.name}`;
                    // กู้คืนค่าตัวแปร Global เพื่อให้ระบบอื่นใช้ต่อได้
                    window.currentUser = parsedUser; 
                }
            } catch (e) {
                console.error("Error parsing user data:", e);
            }
        }
    }
    
    // 3. แสดงผลที่หน้าจอ
    const userDisplay = document.getElementById('current-user-name');
    if(userDisplay) {
        userDisplay.innerText = displayText;
        console.log("Updated user name to:", displayText); // ดู Log ใน Console ได้
    } else {
        console.error("ไม่พบ Element id='current-user-name' ในหน้าเว็บ");
    }
}

// สั่งให้ทำงาน 2 รอบเพื่อความชัวร์ (ตอนโหลด DOM และตอนโหลดหน้าเสร็จสมบูรณ์)
document.addEventListener('DOMContentLoaded', updateHeaderUserName);
window.addEventListener('load', updateHeaderUserName);
	
	
function resetBulkControl(viewType) {
    // 1. ล้างการเลือกคะแนน (Radio)
    const radios = document.querySelectorAll(`input[name="bulkScore-${viewType}"]`);
    radios.forEach(r => r.checked = false);
    
    // 2. ล้างการเลือกข้อ (Checkbox)
    const items = document.querySelectorAll(`.bulk-item-${viewType}`);
    items.forEach(i => i.checked = false);
    
    // 3. ล้างปุ่ม "ทุกข้อ"
    const allCheck = document.querySelector(`.bulk-all-${viewType}`);
    if(allCheck) allCheck.checked = false;
    
    showNotification('ล้างการตั้งค่าตัวช่วยเรียบร้อย', 'info');
}	
function resetAchievementFilter() {
    // 1. ตั้งค่าตัวแปรกลับเป็น 'all'
    achFilterSubject = 'all';
    achFilterRoom = 'all';
    
    // 2. อัปเดต Dropdown ให้แสดงคำว่า 'ทุกรายวิชา' และ 'ทุกห้องเรียน'
    const subSelect = document.getElementById('ach-filter-subject');
    const roomSelect = document.getElementById('ach-filter-room');
    if(subSelect) subSelect.value = 'all';
    if(roomSelect) roomSelect.value = 'all';
    
    // 3. สั่งโหลดข้อมูลใหม่
    updateAchFilters();
    initAchievementView();
    
    // 4. แจ้งเตือนผู้ใช้
    showNotification('รีเซ็ตตัวกรองเรียบร้อย', 'info');
}	
</script>
<script>
/**
 * ------------------------------------------------------------------
 * Smart Connectivity System & Offline Manager (Updated: Human Readable)
 * ------------------------------------------------------------------
 */

const ConnManager = {
    isOnline: navigator.onLine,
    checkInterval: null,
    queueKey: 'kt_offline_queue',
    draftKey: 'kt_autosave_draft',
    lastSpeedCheck: 0,

    init: function() {
        // 1. Event Listeners
        window.addEventListener('online', () => {
            this.updateStatus(true);
            this.processQueue();
            showNotification('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success');
        });
        window.addEventListener('offline', () => {
            this.updateStatus(false);
            showNotification('เน็ตหลุด! เข้าสู่โหมด Offline', 'warning');
        });

        // 2. Start Monitoring
        this.startMonitoring();
        this.updateQueueUI();
        
        // 3. Auto-Save Setup
        this.setupAutoSave();
        
        // 4. Restore Draft if exists
        this.restoreDraft();
    },

    startMonitoring: function() {
        this.checkInterval = setInterval(() => {
            this.measureConnection();
        }, 5000); // ตรวจสอบทุก 5 วินาที
        this.measureConnection();
    },

    measureConnection: async function() {
        if (!navigator.onLine) {
            this.updateUI('ออฟไลน์', '--', 'offline');
            return;
        }

        const start = performance.now();
        try {
            // ยิง Request เล็กๆ เพื่อวัดความเร็วตอบสนอง
            await fetch(window.location.href + '?t=' + Date.now(), { method: 'HEAD', mode: 'no-cors' });
            
            const duration = performance.now() - start;
            const ping = Math.round(duration);
            
            // คำนวณความเร็วคร่าวๆ (Simulated)
            let estSpeed = (2000 / ping * 2).toFixed(1); 
            if(ping < 50) estSpeed = '>100'; // ถ้า ping ต่ำมาก ให้ speed เยอะ

            // --- เปลี่ยน Ping เป็นข้อความคุณภาพ ---
            let quality = 'good';
            let qualityText = 'สัญญาณ: ดีเยี่ยม';

            if (ping > 500) {
                quality = 'poor';
                qualityText = 'สัญญาณ: แย่';
            } else if (ping > 200) {
                quality = 'fair';
                qualityText = 'สัญญาณ: พอใช้';
            }

            this.updateUI(qualityText, estSpeed, quality);

        } catch (e) {
            this.updateStatus(false);
        }
    },

    updateStatus: function(online) {
        this.isOnline = online;
        const alertBar = document.getElementById('offline-alert-bar');
        
        if (online) {
            if(alertBar) alertBar.classList.remove('show');
            // รีเช็คคุณภาพอีกครั้ง
            this.measureConnection();
        } else {
            if(alertBar) alertBar.classList.add('show');
            this.updateUI('ออฟไลน์', '', 'offline');
        }
    },

    updateUI: function(text, speed, quality) {
        const dot = document.getElementById('conn-status-dot');
        const pingEl = document.getElementById('conn-ping'); // ตรงนี้จะแสดงข้อความแทน Ping
        const speedEl = document.getElementById('conn-speed');

        // ตั้งค่าสีปุ่มสถานะ
        dot.className = `conn-dot conn-${quality}`;
        
        // แสดงข้อความคุณภาพแทนตัวเลข Ping
        pingEl.innerText = text;
        
        // แสดงความเร็ว (ถ้าออฟไลน์ ไม่ต้องแสดง)
        if (quality === 'offline') {
            pingEl.style.color = '#64748b';
            speedEl.innerText = '';
        } else {
            pingEl.style.color = (quality === 'good') ? '#15803d' : (quality === 'fair') ? '#b45309' : '#b91c1c';
            speedEl.innerText = speed ? `ความเร็ว ~${speed} Mbps` : '';
        }
    },

    // --- Offline Queue System (เหมือนเดิม) ---
    addToQueue: function(action, data) {
        let queue = JSON.parse(localStorage.getItem(this.queueKey) || '[]');
        queue.push({
            id: Date.now(),
            action: action,
            data: data,
            timestamp: new Date().toLocaleString()
        });
        localStorage.setItem(this.queueKey, JSON.stringify(queue));
        this.updateQueueUI();
        showNotification('บันทึกข้อมูลลงคิวรอส่ง (Offline)', 'info');
    },

    processQueue: async function() {
        let queue = JSON.parse(localStorage.getItem(this.queueKey) || '[]');
        if (queue.length === 0) return;

        showNotification(`กำลังส่งข้อมูลค้างส่ง ${queue.length} รายการ...`, 'info');
        document.getElementById('sync-queue-badge').innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Sync...`;

        const failed = [];
        for (const item of queue) {
            try {
                // เรียกฟังก์ชันเดิมเพื่อส่งข้อมูล
                if(typeof google !== 'undefined' && google.script) {
                     // กรณีรันบน Apps Script จริง
                     await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            [item.action](item.data); // เรียกชื่อฟังก์ชันตาม action
                     });
                } else {
                     // กรณี Test Local หรือฟังก์ชันอื่น
                     console.log('Mock sending:', item);
                }
            } catch (e) {
                console.error(`Sync failed`, e);
                failed.push(item);
            }
        }

        localStorage.setItem(this.queueKey, JSON.stringify(failed));
        this.updateQueueUI();

        if (failed.length === 0) {
            showNotification('ส่งข้อมูลครบถ้วนแล้ว', 'success');
        }
    },

    updateQueueUI: function() {
        const queue = JSON.parse(localStorage.getItem(this.queueKey) || '[]');
        const badge = document.getElementById('sync-queue-badge');
        const count = document.getElementById('queue-count');
        
        if (queue && queue.length > 0) {
            badge.style.display = 'inline-flex';
            count.innerText = queue.length;
        } else {
            badge.style.display = 'none';
        }
    },

    // --- Auto-Save Draft (เหมือนเดิม) ---
    setupAutoSave: function() {
        let saveTimeout;
        document.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    this.saveDraft();
                }, 2000);
            }
        });
    },

    saveDraft: function() {
        // ตัวอย่างการเก็บ Draft (ปรับตามตัวแปรจริงของคุณ)
        // สมมติว่าเก็บค่าทั้งหมดในฟอร์ม หรือตัวแปร scoreData
        // const currentData = collectFormData(); 
        // localStorage.setItem(this.draftKey, JSON.stringify(currentData));
    },

    restoreDraft: function() {
        // const draft = localStorage.getItem(this.draftKey);
        // if(draft) { showNotification('กู้คืนแบบร่างล่าสุด', 'info'); }
    }
};

// Start System
document.addEventListener('DOMContentLoaded', () => ConnManager.init());

// --- ฟังก์ชันประมวลผลด่วน (อิงเกรด) ---
function autoFillByGrade(type) {
    Swal.fire({
        title: 'ยืนยันการประมวลผลด่วน?',
        text: "ระบบจะบันทึกคะแนน " + (type==='rw'?'อ่าน คิด เขียน':(type==='comp'?'สมรรถนะ':'คุณลักษณะ')) + " ทุกข้อให้อัตโนมัติ โดยอิงจากเกรดเฉลี่ยของผู้เรียน",
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ยืนยัน (บันทึกทับ)',
        cancelButtonText: 'ยกเลิก',
        confirmButtonColor: '#0891b2'
    }).then((result) => {
        if (result.isConfirmed) {
            showLoading();
            setTimeout(() => {
                const sub = subjects.find(s => s.id === activeSubjectId);
                const students = getActiveStudentsInClass(activeClassName);
                
                let prefix = '', count = 0;
                if(type === 'rw') { prefix = 'rw_'; count = 5; }
                else if(type === 'comp') { prefix = 'comp_'; count = 5; }
                else if(type === 'attr') { prefix = 'attr_'; count = 10; }

                students.forEach(s => {
                    // 1. คำนวณเกรดปัจจุบัน
                    const totalScore = calculateStudentTotalBySub(sub, s.uid, activeClassName);
                    let gradeStr = computeGradeBySub(sub, totalScore);
                    
                    // แปลงเกรดเป็นตัวเลข
                    let grade = parseFloat(gradeStr);
                    if(isNaN(grade)) grade = 0; // กรณี ร, มส ให้เป็น 0

                    // 2. เทียบระกับคะแนนประเมิน (3, 2, 1, 0)
                    let score = 0;
                    if(grade >= 3.0) score = 3;      // เกรด 3-4 ได้ 3
                    else if(grade >= 2.0) score = 2; // เกรด 2-2.5 ได้ 2
                    else if(grade >= 1.0) score = 1; // เกรด 1-1.5 ได้ 1
                    else score = 0;                  // เกรด 0 ได้ 0

                    // 3. บันทึกลง Memory
                    if (!scoreData[activeSubjectId]) scoreData[activeSubjectId] = {};
                    if (!scoreData[activeSubjectId][activeClassName]) scoreData[activeSubjectId][activeClassName] = {};
                    if (!scoreData[activeSubjectId][activeClassName][s.uid]) scoreData[activeSubjectId][activeClassName][s.uid] = {};

                    for(let i=1; i<=count; i++) {
                        scoreData[activeSubjectId][activeClassName][s.uid][prefix + i] = score;
                    }
                });

                // 4. รีเฟรชตาราง
                if(type === 'rw') initRWTable();
                else if(type === 'comp') initCompetencyTable();
                else if(type === 'attr') initAttributeTable();

                hideLoading();
                showNotification('ประมวลผลเรียบร้อย');
            }, 500);
        }
    });
}

// --- ฟังก์ชันบันทึกผลสัมฤทธิ์ (ส่งรูปแบบ JSON) ---
    function saveAchievements() {
        Swal.fire({
            title: 'ยืนยันการบันทึก?',
            text: "ระบบจะทำการประมวลผลและบันทึกข้อมูลสรุปผลสัมฤทธิ์ (ทุกรายวิชา) ลงในฐานข้อมูล",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ยืนยันการบันทึก',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#0d6efd'
        }).then((result) => {
            if (result.isConfirmed) {
                showLoading();
                
                // ใช้ setTimeout เพื่อให้ Loading แสดงผลก่อนเริ่มคำนวณ
                setTimeout(() => {
                    try {
                        let allAchievementData = [];

                        // 1. วนลูปทุกวิชา
                        subjects.forEach(sub => {
                            // 2. วนลูปทุกห้องในวิชานั้น
                            sub.classes.forEach(cls => {
                                const clsStudents = getActiveStudentsInClass(cls);
                                if (clsStudents.length === 0) return;

                                // ตัวแปรเก็บสถิติ
                                const total = clsStudents.length;
                                let counts = { '4.0':0, '3.5':0, '3.0':0, '2.5':0, '2.0':0, '1.5':0, '1.0':0, '0':0, 'ร':0, 'มส':0 };
                                let passedCount = 0, goodCount = 0, failCount = 0;
                                let classScores = [];
                                let classTotalScore = 0;

                                // 3. คำนวณคะแนนนักเรียนรายคน
                                clsStudents.forEach(stu => {
                                    const totalScore = calculateStudentTotalBySub(sub, stu.uid, cls);
                                    const rem = getStoredScore(sub.id, cls, stu.uid, 'remark', "");
                                    let grade = rem || computeGradeBySub(sub, totalScore);
                                    
                                    // จัดรูปแบบเกรด
                                    if (grade === '4') grade = '4.0';
                                    else if (grade === '3') grade = '3.0';
                                    else if (grade === '2') grade = '2.0';
                                    else if (grade === '1') grade = '1.0';
                                    
                                    if (counts.hasOwnProperty(grade)) counts[grade]++;
                                    
                                    // เก็บสถิติคะแนน (ไม่รวม ร, มส)
                                    if (!rem) {
                                        const gVal = parseFloat(grade);
                                        if(!isNaN(gVal)) {
                                            classScores.push(gVal);
                                            classTotalScore += gVal;
                                            if (gVal >= 1.0) passedCount++;
                                            if (gVal >= 3.0) goodCount++;
                                            if (gVal === 0) failCount++;
                                        }
                                    } else if (rem === 'ผ') {
                                        passedCount++;
                                    }
                                });

                                // 4. คำนวณค่าทางสถิติ
                                const classAvg = classScores.length > 0 ? (classTotalScore / classScores.length).toFixed(2) : '0.00';
                                const classSD = calculateSD(classScores).toFixed(2);
                                const passPct = total > 0 ? ((passedCount / total) * 100).toFixed(2) : '0.00';
                                const goodPct = total > 0 ? ((goodCount / total) * 100).toFixed(2) : '0.00';
                                const failPct = total > 0 ? ((failCount / total) * 100).toFixed(2) : '0.00';

                                // 5. สร้าง Object ข้อมูล (รูปแบบ JSON ที่จะบันทึก)
                                let dataObj = {
                                    subject_id: sub.id,
                                    subject_code: sub.code,
                                    subject_name: sub.name,
                                    teacher: sub.teacher,
                                    room: cls,
                                    total_students: total,
                                    grade_counts: counts, // Object จำนวนเกรด
                                    stats: {
                                        average_gpa: classAvg,
                                        sd: classSD,
                                        pass_percentage: passPct,
                                        good_percentage: goodPct,
                                        fail_percentage: failPct
                                    }
                                };
                                
                                allAchievementData.push(dataObj);
                            });
                        });

                        // 6. ส่งข้อมูลไปบันทึกที่ Backend
                        callBackend('saveAchievementData', allAchievementData)
                            .then(res => {
                                hideLoading();
                                if(res.result === 'success') {
                                    showNotification('บันทึกข้อมูลผลสัมฤทธิ์เรียบร้อย');
                                } else {
                                    Swal.fire('เกิดข้อผิดพลาด', res.message, 'error');
                                }
                            })
                            .catch(err => {
                                hideLoading();
                                Swal.fire('Error', err.message, 'error');
                            });

                    } catch (e) {
                        hideLoading();
                        console.error(e);
                        Swal.fire('Error', 'เกิดข้อผิดพลาดในการประมวลผล: ' + e.message, 'error');
                    }
                }, 500);
            }
        });
    }
</script>
</body>
</html>
